name: ğŸ”’ Security Scan

on:
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  schedule:
    # Run security scan weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write # For GitHub Advanced Security
  pull-requests: write # For PR comments

jobs:
  gitleaks:
    name: ğŸ” Secret Scanning (Gitleaks)
    timeout-minutes: 5
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft || github.event_name == 'push' || github.event_name == 'schedule' }}
    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for accurate secret scanning

      - name: ğŸ” Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional: for Gitleaks Enterprise features
        with:
          # Scan all commits in PR, or last 10 commits on push
          args: --verbose --redact

      - name: ğŸ“Š Upload Gitleaks results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

  npm-audit:
    name: ğŸ”’ Dependency Audit (npm)
    timeout-minutes: 5
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft || github.event_name == 'push' || github.event_name == 'schedule' }}
    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: ğŸ“¥ Install dependencies
        run: npm ci # Use 'ci' for faster, more reliable builds in CI

      - name: ğŸ”’ Run npm audit
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ NPM Security Audit"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Run audit and capture output, but don't exit on failure immediately
          if npm_audit_output=$(npm audit --audit-level=high --production --json); then
            echo "âœ… No high or critical vulnerabilities found"
          else
            echo "âŒ High or critical vulnerabilities detected"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$npm_audit_output" > npm-audit-report.json
            npm audit --audit-level=high --production # Print human-readable report to logs
            exit 1
          fi

      - name: ğŸ“Š Upload npm audit results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30

  security-summary:
    name: ğŸ“‹ Security Summary
    timeout-minutes: 2
    runs-on: ubuntu-latest
    needs: [gitleaks, npm-audit]
    if: always() && (github.event_name == 'pull_request' || github.event_name == 'push')
    steps:
      - name: ğŸ“Š Check security scan results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ Phase 1 Security Scan Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          gitleaks_status="${{ needs.gitleaks.result }}"
          npm_audit_status="${{ needs.npm-audit.result }}"

          echo "ğŸ” Gitleaks (Secret Scanning): $gitleaks_status"
          echo "ğŸ”’ npm audit (Dependencies):    $npm_audit_status"
          echo

          if [ "$gitleaks_status" = "success" ] && [ "$npm_audit_status" = "success" ]; then
            echo "âœ… All security checks passed!"
            echo
            echo "Phase 1 Security Controls:"
            echo "  âœ“ No secrets committed (Gitleaks)"
            echo "  âœ“ No high/critical dependency vulnerabilities (npm audit)"
            echo "  âœ“ Pre-commit hook blocks .env files"
            echo "  âœ“ CSV upload validation active"
            echo "  âœ“ Auth bypass vulnerability fixed"
            echo "  âœ“ Filter preferences use sessionStorage"
            echo
            echo "See /docs/SECURITY_MODEL.md for complete security architecture"
            exit 0
          else
            echo "âŒ Security checks failed!"
            echo
            if [ "$gitleaks_status" != "success" ]; then
              echo "  âœ— Gitleaks detected potential secrets"
              echo "    Action: Review commits, rotate keys if needed"
              echo "    See: /docs/SECURITY_KEY_ROTATION.md"
            fi
            if [ "$npm_audit_status" != "success" ]; then
              echo "  âœ— npm audit found high/critical vulnerabilities"
              echo "    Action: Update dependencies with 'npm audit fix'"
            fi
            exit 1
          fi
