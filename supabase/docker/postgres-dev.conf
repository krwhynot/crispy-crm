# ============================================================================
# PostgreSQL Development Configuration - Optimized for 2GB Container
# ============================================================================
# This configuration is tuned for local development with Supabase
# Container memory limit: 2GB (set in docker-compose.override.yml)
# ============================================================================

# ============================================================================
# MEMORY SETTINGS (Total Container: 2GB)
# ============================================================================

# Shared Buffers: 25% of container memory (industry standard)
# 2GB * 0.25 = 512MB - Used for caching frequently accessed data
shared_buffers = 512MB

# Effective Cache Size: Hint for query planner (doesn't allocate memory)
# 75% of container memory = 1.5GB - Helps optimize query plans
effective_cache_size = 1536MB

# Work Memory: Per-operation memory for sorts/hashes
# Conservative setting to prevent OOM with multiple connections
# Formula: (Total RAM - shared_buffers) / (max_connections * 4)
# (2048MB - 512MB) / (100 * 4) â‰ˆ 4MB
work_mem = 4MB

# Maintenance Work Memory: For VACUUM, CREATE INDEX, ALTER TABLE
# 128MB is sufficient for development databases
maintenance_work_mem = 128MB

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================

# Max Connections: 100 is plenty for development
# Each connection uses ~10MB, so 100 connections = ~1GB max
max_connections = 100

# ============================================================================
# WRITE-AHEAD LOG (WAL) SETTINGS
# ============================================================================

# WAL Buffers: -1 = automatic (1/32 of shared_buffers = 16MB)
wal_buffers = -1

# Checkpoint Settings: Less aggressive for development
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
max_wal_size = 1GB
min_wal_size = 80MB

# ============================================================================
# QUERY TUNING
# ============================================================================

# Random Page Cost: 1.1 for SSD (Docker volumes use host SSD)
random_page_cost = 1.1

# Effective IO Concurrency: Good for SSDs
effective_io_concurrency = 200

# Default Statistics Target: Balance between accuracy and ANALYZE time
default_statistics_target = 100

# ============================================================================
# LOGGING (Development-friendly)
# ============================================================================

# Log slow queries over 1 second
log_min_duration_statement = 1000

# Log connections and disconnections
log_connections = on
log_disconnections = on

# Log lock waits longer than 1 second
log_lock_waits = on
deadlock_timeout = 1s

# Log temporary file usage (helps identify queries needing more work_mem)
log_temp_files = 0

# Statement logging level
log_statement = 'mod'  # Log all DDL and data-modifying statements

# ============================================================================
# AUTOVACUUM TUNING
# ============================================================================

# More aggressive autovacuum for development (keeps statistics fresh)
autovacuum = on
autovacuum_max_workers = 2
autovacuum_naptime = 30s
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# ============================================================================
# DEVELOPMENT OPTIMIZATIONS
# ============================================================================

# Disable JIT for development (saves memory, speeds up simple queries)
jit = off

# Enable timing in EXPLAIN ANALYZE
track_io_timing = on

# Track function call counts and time
track_functions = all

# ============================================================================
# Notes:
# - Apply by mounting this file in docker-compose.override.yml
# - Monitor with: docker exec supabase_db_crispy-crm pg_top
# - Check settings: SHOW shared_buffers; SHOW work_mem;
# ============================================================================