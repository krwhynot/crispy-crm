# ============================================================================
# Docker Compose Override - Resource Limits for Supabase Local Development
# ============================================================================
# Optimized for: 32GB System RAM, Docker in WSL2, 1-2 Claude Sessions
# Total container memory: ~4.5GB (leaves 10GB free in 14GB WSL2 allocation)
# ============================================================================

version: "3.8"

services:
  # ============================================================================
  # PostgreSQL Database - Most memory-intensive service
  # Memory: 2GB, CPUs: 2 (needs resources for queries and indexing)
  # ============================================================================
  postgres:
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
        reservations:
          memory: 1G
          cpus: "0.5"
    # Mount custom PostgreSQL configuration
    volumes:
      - ./docker/postgres-dev.conf:/etc/postgresql/postgresql.conf:ro
    # Apply custom configuration
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
    # Shared memory size must be >= shared_buffers (512MB in our config)
    shm_size: 1gb
    environment:
      POSTGRES_INITDB_ARGS: "--data-checksums"

  # ============================================================================
  # Kong API Gateway - Routes all HTTP requests
  # Memory: 512MB, CPUs: 1 (handles routing, not heavy processing)
  # ============================================================================
  kong:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.25"

  # ============================================================================
  # Edge Functions Runtime - For Supabase Functions development
  # Memory: 512MB, CPUs: 1 (you use Core + Functions)
  # ============================================================================
  edge-runtime:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.25"
    profiles:
      - default
      - functions # Part of default since you use Functions

  # ============================================================================
  # Supabase Studio - Web Dashboard (optional for headless dev)
  # Memory: 512MB, CPUs: 1
  # ============================================================================
  studio:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
        reservations:
          memory: 256M
          cpus: "0.25"
    profiles:
      - default
      - full # Can be excluded with --profile minimal

  # ============================================================================
  # Core Services - Essential for development
  # Memory: 256MB each, CPUs: 0.5
  # ============================================================================

  # PostgREST - REST API generation
  rest:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.1"

  # Authentication service (GoTrue)
  auth:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.1"

  # Realtime WebSocket service
  realtime:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.1"

  # PostgreSQL Meta introspection API
  pg-meta:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.1"

  # ============================================================================
  # Optional Services - Only start when needed
  # ============================================================================

  # Mailpit/Inbucket - Email testing (disabled in config.toml)
  inbucket:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.1"
    profiles:
      - email-testing # Only starts with: --profile email-testing

# ============================================================================
# Resource Summary:
# - PostgreSQL:      2.0 GB
# - Kong:            512 MB
# - Edge Functions:  512 MB
# - Studio:          512 MB
# - Core Services:   1.0 GB (4 Ã— 256MB)
# - Email (if used): 256 MB
# ----------------------
# Total (default):   ~4.5 GB
# Total (minimal):   ~3.5 GB (without Studio)
# ============================================================================

# Usage:
# - Normal start:     npx supabase start
# - Minimal mode:     docker compose --profile minimal up
# - With email:       docker compose --profile email-testing up
