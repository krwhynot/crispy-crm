<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Troubleshooting Tool - Atomic CRM</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 8px;
        }

        .status-bar {
            display: flex;
            gap: 16px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #48bb78;
        }

        .status-dot.error {
            background: #f56565;
        }

        .status-dot.warning {
            background: #ed8936;
        }

        .status-dot.checking {
            background: #4299e1;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .panel.full-width {
            grid-column: 1 / -1;
        }

        .panel h2 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .control-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        button.danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        button.success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .log-container {
            background: #1a202c;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .log-entry {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .log-success {
            color: #68d391;
        }

        .log-error {
            color: #fc8181;
        }

        .log-warning {
            color: #f6ad55;
        }

        .log-info {
            color: #63b3ed;
        }

        .log-debug {
            color: #a0aec0;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .metric-card {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .metric-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
        }

        .test-grid {
            display: grid;
            gap: 12px;
            margin-top: 16px;
        }

        .test-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .test-name {
            font-weight: 500;
            color: #2d3748;
        }

        .test-result {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        input, select {
            flex: 1;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #718096;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .error-monitor {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            display: none;
        }

        .error-monitor.show {
            display: block;
        }

        .error-monitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .error-count {
            background: #f56565;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .rls-matrix {
            overflow-x: auto;
            margin-top: 16px;
        }

        .rls-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rls-table th,
        .rls-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .rls-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }

        .rls-table .allowed {
            background: #c6f6d5;
            color: #22543d;
        }

        .rls-table .denied {
            background: #fed7d7;
            color: #742a2a;
        }

        .rls-table .unknown {
            background: #feebc8;
            color: #7c2d12;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .metric-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- STEP-BY-STEP GUIDE - SUPER CLEAR -->
        <div class="panel" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 24px; border: 3px solid #FFD700;">
            <h1 style="color: white; border-bottom-color: rgba(255,255,255,0.5); font-size: 32px; text-align: center;">
                🚦 START HERE - FOLLOW THESE STEPS IN ORDER 🚦
            </h1>

            <!-- STEP 1 -->
            <div style="background: rgba(255,255,255,0.95); color: #1a202c; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 8px solid #48bb78;">
                <h2 style="color: #1a202c; margin-bottom: 12px;">✅ STEP 1: Check Your Authentication Status</h2>
                <ol style="margin-left: 20px; line-height: 2; font-size: 16px;">
                    <li><strong>LOOK AT THE TOP</strong> - See the colored dots at the top of the page</li>
                    <li><strong>CLICK</strong> the blue button labeled <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px;">Check Auth</span></li>
                    <li><strong>WHAT YOU SHOULD SEE:</strong>
                        <ul style="margin-top: 8px;">
                            <li>🟢 <strong>Green dot</strong> next to "Auth: Connected" = GOOD!</li>
                            <li>🔴 <strong>Red dot</strong> next to "Auth: Error" = BAD - You need to login first</li>
                        </ul>
                    </li>
                    <li><strong>IF RED:</strong> Enter email "test@gmail.com" and your password, then click <span style="background: #48bb78; color: white; padding: 4px 8px; border-radius: 4px;">Test Login</span></li>
                </ol>
                <div style="background: #f0fff4; padding: 12px; border-radius: 6px; margin-top: 12px;">
                    <strong>✅ SUCCESS LOOKS LIKE:</strong> Green dot + "Connected" + User ID shows "abc123..." (not just "-")
                </div>
            </div>

            <!-- STEP 2 -->
            <div style="background: rgba(255,255,255,0.95); color: #1a202c; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 8px solid #4299e1;">
                <h2 style="color: #1a202c; margin-bottom: 12px;">📊 STEP 2: Test Database Permissions</h2>
                <ol style="margin-left: 20px; line-height: 2; font-size: 16px;">
                    <li><strong>FIND</strong> the "Database Diagnostics" box (right side)</li>
                    <li><strong>CLICK</strong> <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px;">Test All RLS Policies</span></li>
                    <li><strong>WHAT YOU SHOULD SEE:</strong>
                        <ul style="margin-top: 8px;">
                            <li>A list appears below the button</li>
                            <li>Each line shows a table name (contacts, opportunities, etc.)</li>
                            <li>✅ = That operation works</li>
                            <li>❌ = That operation is blocked</li>
                        </ul>
                    </li>
                </ol>
                <div style="background: #e6f7ff; padding: 12px; border-radius: 6px; margin-top: 12px;">
                    <strong>📊 EXPECTED RESULTS:</strong><br>
                    • contacts RLS: ✅ SELECT OK<br>
                    • opportunities RLS: ✅ SELECT OK<br>
                    • If you see ❌ SELECT denied = You're not logged in properly
                </div>
            </div>

            <!-- STEP 3 -->
            <div style="background: rgba(255,255,255,0.95); color: #1a202c; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 8px solid #f56565;">
                <h2 style="color: #1a202c; margin-bottom: 12px;">🔥 STEP 3: Test The Known Error (nb_tasks)</h2>
                <ol style="margin-left: 20px; line-height: 2; font-size: 16px;">
                    <li><strong>CLICK</strong> the RED button <span style="background: #f56565; color: white; padding: 4px 8px; border-radius: 4px;">Test nb_tasks Error</span></li>
                    <li><strong>WHAT WILL HAPPEN:</strong>
                        <ul style="margin-top: 8px;">
                            <li>An error will appear in the black log box below</li>
                            <li>This is EXPECTED - we're testing a known problem</li>
                            <li>The error proves the field "nb_tasks" doesn't exist</li>
                        </ul>
                    </li>
                    <li><strong>WHAT YOU'LL SEE IN THE LOG:</strong>
                        <div style="background: #1a202c; color: #fc8181; padding: 8px; border-radius: 4px; margin-top: 8px; font-family: monospace;">
                            ✅ Expected error caught: column contacts_summary.nb_tasks does not exist
                        </div>
                    </li>
                </ol>
                <div style="background: #fff5f5; padding: 12px; border-radius: 6px; margin-top: 12px;">
                    <strong>🔴 THIS ERROR IS GOOD!</strong> It confirms the bug we're tracking. The fix would be to either:
                    <br>• Add the nb_tasks field to the database view, OR
                    <br>• Stop the frontend from requesting this field
                </div>
            </div>

            <!-- STEP 4 -->
            <div style="background: rgba(255,255,255,0.95); color: #1a202c; padding: 20px; border-radius: 8px; margin-bottom: 16px; border-left: 8px solid #9f7aea;">
                <h2 style="color: #1a202c; margin-bottom: 12px;">🏥 STEP 4: Run Full Health Check</h2>
                <ol style="margin-left: 20px; line-height: 2; font-size: 16px;">
                    <li><strong>SCROLL DOWN</strong> to find "System Health Check" section</li>
                    <li><strong>CLICK</strong> <span style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px;">Run Full Health Check</span></li>
                    <li><strong>WHAT YOU SHOULD SEE:</strong>
                        <ul style="margin-top: 8px;">
                            <li>6 tests will run automatically</li>
                            <li>Each test gets ✅ (pass) or ❌ (fail)</li>
                            <li>Bottom line shows "Passed: 6/6" if everything works</li>
                        </ul>
                    </li>
                </ol>
                <div style="background: #f3e8ff; padding: 12px; border-radius: 6px; margin-top: 12px;">
                    <strong>🎯 PERFECT SCORE:</strong> All 6 tests should pass:
                    <br>✅ Authentication ✅ Database ✅ RLS Policies
                    <br>✅ Storage ✅ Network ✅ JWT Token
                </div>
            </div>

            <!-- UNDERSTANDING COLORS -->
            <div style="background: rgba(255,255,255,0.95); color: #1a202c; padding: 20px; border-radius: 8px; border-left: 8px solid #ed8936;">
                <h2 style="color: #1a202c; margin-bottom: 12px;">🎨 UNDERSTANDING THE COLORS & SYMBOLS</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Status Dots (Top of Page):</h4>
                        <ul style="line-height: 1.8;">
                            <li>🟢 <strong>Green</strong> = Working correctly</li>
                            <li>🔴 <strong>Red</strong> = Error/Problem</li>
                            <li>🟡 <strong>Yellow</strong> = Warning/Caution</li>
                            <li>🔵 <strong>Blue</strong> = Checking/Loading</li>
                        </ul>
                    </div>
                    <div>
                        <h4>Test Results:</h4>
                        <ul style="line-height: 1.8;">
                            <li>✅ = Test passed/allowed</li>
                            <li>❌ = Test failed/denied</li>
                            <li>⚠️ = Warning/Partial issue</li>
                            <li>⏳ = Test is running</li>
                        </ul>
                    </div>
                </div>

                <h4 style="margin-top: 16px;">Log Messages (Black Boxes):</h4>
                <ul style="line-height: 1.8;">
                    <li><span style="color: #48bb78;">Green text</span> = Success messages</li>
                    <li><span style="color: #f56565;">Red text</span> = Error messages (sometimes expected!)</li>
                    <li><span style="color: #ed8936;">Orange text</span> = Warnings</li>
                    <li><span style="color: #4299e1;">Blue text</span> = Information</li>
                </ul>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>🔧 Advanced Troubleshooting Tool</h1>
            <p style="color: #718096;">Comprehensive diagnostics for Atomic CRM</p>
            <div class="status-bar">
                <div class="status-indicator">
                    <div class="status-dot" id="authStatus"></div>
                    <span>Auth: <span id="authText">Checking...</span></span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="dbStatus"></div>
                    <span>Database: <span id="dbText">Checking...</span></span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="rlsStatus"></div>
                    <span>RLS: <span id="rlsText">Checking...</span></span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="uiStatus"></div>
                    <span>UI: <span id="uiText">Monitoring...</span></span>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Authentication Panel -->
            <div class="panel">
                <h2>🔐 Authentication Diagnostics</h2>
                <div class="control-group">
                    <button id="checkAuthBtn" class="secondary">Check Auth</button>
                    <button id="clearSessionBtn" class="danger">Clear Sessions</button>
                    <button id="loginBtn" class="success">Test Login</button>
                    <button id="refreshTokenBtn">Refresh Token</button>
                </div>
                <div class="input-group">
                    <input type="email" id="testEmail" placeholder="test@gmail.com" value="test@gmail.com">
                    <input type="password" id="testPassword" placeholder="Password">
                </div>
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-label">User ID</div>
                        <div class="metric-value" id="userId">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Session Age</div>
                        <div class="metric-value" id="sessionAge">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Token Type</div>
                        <div class="metric-value" id="tokenType">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Expires In</div>
                        <div class="metric-value" id="expiresIn">-</div>
                    </div>
                </div>
                <div class="log-container" id="authLog"></div>
            </div>

            <!-- Database Panel -->
            <div class="panel">
                <h2>🗄️ Database Diagnostics</h2>
                <div class="tabs">
                    <button class="tab active" data-tab="rls">RLS Policies</button>
                    <button class="tab" data-tab="permissions">Permissions</button>
                    <button class="tab" data-tab="schema">Schema</button>
                    <button class="tab" data-tab="queries">Test Queries</button>
                </div>

                <div class="tab-content active" id="rls-tab">
                    <div class="control-group">
                        <button id="testRlsBtn">Test All RLS Policies</button>
                        <button id="rlsMatrixBtn">Show RLS Matrix</button>
                        <button id="testNbTasksBtn" class="danger">Test nb_tasks Error</button>
                    </div>
                    <div class="test-grid" id="rlsTests"></div>
                    <div class="rls-matrix" id="rlsMatrix"></div>
                </div>

                <div class="tab-content" id="permissions-tab">
                    <div class="control-group">
                        <button id="testPermissionsBtn">Test Permissions Matrix</button>
                        <button id="grantAnalysisBtn">Analyze Grants</button>
                    </div>
                    <div class="test-grid" id="permissionTests"></div>
                </div>

                <div class="tab-content" id="schema-tab">
                    <div class="control-group">
                        <button id="schemaCheckBtn">Validate Schema</button>
                        <button id="indexHealthBtn">Check Indexes</button>
                        <button id="fkCheckBtn">Validate Foreign Keys</button>
                    </div>
                    <div class="test-grid" id="schemaTests"></div>
                </div>

                <div class="tab-content" id="queries-tab">
                    <div class="input-group">
                        <select id="testTable">
                            <option value="contacts">contacts</option>
                            <option value="opportunities">opportunities</option>
                            <option value="companies">companies</option>
                            <option value="activities">activities</option>
                            <option value="tasks">tasks</option>
                            <option value="notes">notes</option>
                        </select>
                        <select id="testOperation">
                            <option value="select">SELECT</option>
                            <option value="insert">INSERT</option>
                            <option value="update">UPDATE</option>
                            <option value="delete">DELETE</option>
                        </select>
                        <button id="runQueryTestBtn">Run Test</button>
                    </div>
                    <div class="test-grid" id="queryTests"></div>
                </div>

                <div class="log-container" id="dbLog"></div>
            </div>

            <!-- UI Error Monitor -->
            <div class="panel full-width">
                <h2>🖥️ UI Error Detection & Analysis</h2>
                <div class="control-group">
                    <button id="startMonitorBtn">Start Error Monitor</button>
                    <button id="stopMonitorBtn" disabled>Stop Monitor</button>
                    <button id="clearErrorsBtn">Clear Errors</button>
                    <button id="simulateErrorBtn">Simulate React Error</button>
                    <button id="networkTestBtn">Test Network Requests</button>
                    <button id="consoleHijackBtn">Hijack Console</button>
                </div>

                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-label">Console Errors</div>
                        <div class="metric-value" id="consoleErrorCount">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Network Failures</div>
                        <div class="metric-value" id="networkErrorCount">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">React Errors</div>
                        <div class="metric-value" id="reactErrorCount">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Promise Rejections</div>
                        <div class="metric-value" id="promiseErrorCount">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">localStorage Usage</div>
                        <div class="metric-value" id="storageUsage">0 KB</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Memory Usage</div>
                        <div class="metric-value" id="memoryUsage">- MB</div>
                    </div>
                </div>

                <div class="tabs" style="margin-top: 24px;">
                    <button class="tab active" data-tab="errors">Captured Errors</button>
                    <button class="tab" data-tab="network">Network Log</button>
                    <button class="tab" data-tab="storage">Storage Analysis</button>
                    <button class="tab" data-tab="performance">Performance</button>
                </div>

                <div class="tab-content active" id="errors-tab">
                    <div class="log-container" id="errorLog"></div>
                </div>

                <div class="tab-content" id="network-tab">
                    <div class="log-container" id="networkLog"></div>
                </div>

                <div class="tab-content" id="storage-tab">
                    <div class="log-container" id="storageLog"></div>
                </div>

                <div class="tab-content" id="performance-tab">
                    <div class="log-container" id="performanceLog"></div>
                </div>
            </div>

            <!-- System Health Panel -->
            <div class="panel full-width">
                <h2>📊 System Health Check</h2>
                <div class="control-group">
                    <button id="fullHealthCheckBtn">Run Full Health Check</button>
                    <button id="exportReportBtn">Export Report</button>
                    <button id="autoFixBtn" class="success">Attempt Auto-Fix</button>
                </div>
                <div class="test-grid" id="healthChecks"></div>
                <div class="log-container" id="healthLog"></div>
            </div>
        </div>
    </div>

    <!-- RESULTS INTERPRETER - Shows what results mean -->
    <div id="resultsInterpreter" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 600px; z-index: 9999; border: 3px solid #667eea;">
        <h2 style="color: #1a202c; margin-bottom: 20px; text-align: center; font-size: 24px;">
            📖 WHAT YOUR RESULTS MEAN
        </h2>
        <div id="interpretationContent" style="line-height: 1.8; font-size: 16px;">
            <!-- Content will be added dynamically -->
        </div>
        <button onclick="document.getElementById('resultsInterpreter').style.display='none'" style="margin-top: 20px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
            Got it! Close this window
        </button>
    </div>

    <!-- Floating Error Monitor -->
    <div class="error-monitor" id="errorMonitor">
        <div class="error-monitor-header">
            <h3>⚠️ Live Errors</h3>
            <span class="error-count" id="liveErrorCount">0</span>
        </div>
        <div id="liveErrorList" style="max-height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://aaqnanddcqvfiwhshndl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhcW5hbmRkY3F2Zml3aHNobmRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1ODIxODUsImV4cCI6MjA3NDE1ODE4NX0.wJi2sGLrvrI5OQUujTByVWjdyCT7Prjlpsx9LC_CUzU';

        const { createClient } = supabase;
        const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State
        let monitoring = false;
        let errorCounts = {
            console: 0,
            network: 0,
            react: 0,
            promise: 0
        };
        let capturedErrors = [];
        let networkRequests = [];
        let originalConsoleError = console.error;
        let originalConsoleWarn = console.warn;
        let fetchInterceptor = null;

        // Utility Functions
        function showResultInterpretation(title, content) {
            const interpreter = document.getElementById('resultsInterpreter');
            const contentDiv = document.getElementById('interpretationContent');

            contentDiv.innerHTML = `<h3 style="color: #667eea; margin-bottom: 16px;">${title}</h3>${content}`;
            interpreter.style.display = 'block';
        }

        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            if (!container) return;

            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function updateStatus(statusId, textId, status, text) {
            const statusDot = document.getElementById(statusId);
            const statusText = document.getElementById(textId);

            statusDot.className = 'status-dot ' + status;
            statusText.textContent = text;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function decodeJWT(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) return null;

                const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));
                return payload;
            } catch (e) {
                return null;
            }
        }

        // Tab Handling
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                const parent = e.target.closest('.panel');

                parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                e.target.classList.add('active');
                const content = parent.querySelector(`#${tabName}-tab`);
                if (content) content.classList.add('active');
            });
        });

        // Authentication Functions
        async function checkAuth() {
            log('authLog', 'Checking authentication status...', 'info');

            try {
                const { data: { session }, error } = await client.auth.getSession();

                if (error) {
                    log('authLog', `Error: ${error.message}`, 'error');
                    updateStatus('authStatus', 'authText', 'error', 'Error');
                    return null;
                }

                if (session) {
                    log('authLog', `✓ Authenticated as: ${session.user.email}`, 'success');
                    log('authLog', `User ID: ${session.user.id}`, 'info');

                    // Decode JWT to check role
                    const decoded = decodeJWT(session.access_token);
                    if (decoded) {
                        log('authLog', `Token Role: ${decoded.role}`, decoded.role === 'authenticated' ? 'success' : 'warning');
                        if (decoded.role !== 'authenticated') {
                            log('authLog', '⚠️ Token role is not "authenticated" - this will cause RLS issues!', 'error');
                        }
                    }

                    // Update metrics
                    document.getElementById('userId').textContent = session.user.id.substring(0, 8) + '...';

                    const sessionCreated = new Date(session.user.created_at);
                    const now = new Date();
                    const ageHours = Math.floor((now - sessionCreated) / (1000 * 60 * 60));
                    document.getElementById('sessionAge').textContent = `${ageHours}h`;

                    document.getElementById('tokenType').textContent = session.access_token ? 'JWT' : 'None';

                    const expiresAt = new Date(session.expires_at * 1000);
                    const expiresIn = Math.floor((expiresAt - now) / (1000 * 60));
                    document.getElementById('expiresIn').textContent = `${expiresIn}m`;

                    updateStatus('authStatus', 'authText', 'connected', 'Connected');

                    // Check refresh token
                    if (session.refresh_token) {
                        log('authLog', '✓ Refresh token present', 'success');
                    } else {
                        log('authLog', '⚠ No refresh token', 'warning');
                    }

                    return session;
                } else {
                    log('authLog', '✗ Not authenticated', 'warning');
                    updateStatus('authStatus', 'authText', 'warning', 'Not authenticated');
                    return null;
                }
            } catch (err) {
                log('authLog', `Exception: ${err.message}`, 'error');
                updateStatus('authStatus', 'authText', 'error', 'Error');
                return null;
            }
        }

        // Database Test Functions
        // New test function for the nb_tasks error
        async function testNbTasksError() {
            log('dbLog', '=== Testing nb_tasks field error ===', 'warning');
            log('dbLog', 'This test will deliberately trigger the known schema error...', 'info');

            try {
                // This is the exact query that causes the error
                const { data, error } = await client
                    .from('contacts_summary')
                    .select('*')
                    .filter('nb_tasks', 'gt', 0)
                    .order('last_seen', { ascending: false, nullsFirst: false })
                    .range(0, 24);

                if (error) {
                    log('dbLog', `✅ Expected error caught: ${error.message}`, 'error');
                    log('dbLog', `Error code: ${error.code}`, 'info');
                    log('dbLog', 'This confirms the nb_tasks field does not exist in contacts_summary', 'warning');

                    // Show suggestion
                    log('dbLog', '💡 Solution: To count tasks per contact, you need to:', 'success');
                    log('dbLog', '1. Join with tasks table, OR', 'info');
                    log('dbLog', '2. Create a computed column in the view, OR', 'info');
                    log('dbLog', '3. Use a separate aggregation query', 'info');
                } else {
                    log('dbLog', '⚠️ Unexpected: Query succeeded (field might have been added)', 'warning');
                }
            } catch (err) {
                log('dbLog', `Exception: ${err.message}`, 'error');
            }

            log('dbLog', '=== nb_tasks error test complete ===', 'info');

            // Show interpretation
            showResultInterpretation(
                '🔥 nb_tasks Error Test Results',
                `
                <div style="background: #fff5f5; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                    <strong>What just happened:</strong><br>
                    We tested a KNOWN BUG where the app tries to use a field called "nb_tasks" that doesn't exist.
                </div>

                <div style="background: #f0fff4; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                    <strong>What this means:</strong><br>
                    ✅ If you saw an error = GOOD! The test worked correctly<br>
                    ❌ If no error = The field might have been added to fix the bug
                </div>

                <div style="background: #e6f7ff; padding: 16px; border-radius: 8px;">
                    <strong>How to fix this:</strong><br>
                    1. Add a "nb_tasks" column to the contacts_summary view, OR<br>
                    2. Update the frontend code to stop requesting this field, OR<br>
                    3. Create a different query that counts tasks properly
                </div>
                `
            );
        }

        async function testRLSPolicies() {
            log('dbLog', 'Testing RLS policies...', 'info');
            const testsContainer = document.getElementById('rlsTests');
            testsContainer.innerHTML = '';

            const tables = ['contacts', 'opportunities', 'companies', 'activities', 'tasks', 'notes'];

            for (const table of tables) {
                const testItem = document.createElement('div');
                testItem.className = 'test-item';
                testItem.innerHTML = `
                    <span class="test-name">${table} RLS</span>
                    <span class="test-result">
                        <span class="test-icon">⏳</span>
                        <span>Testing...</span>
                    </span>
                `;
                testsContainer.appendChild(testItem);

                try {
                    // Test SELECT
                    const { data: selectData, error: selectError } = await client
                        .from(table)
                        .select('id')
                        .limit(1);

                    if (selectError) {
                        log('dbLog', `${table}: SELECT failed - ${selectError.message}`, 'error');
                        testItem.querySelector('.test-result').innerHTML = `
                            <span class="test-icon">❌</span>
                            <span style="color: #f56565;">SELECT denied</span>
                        `;
                    } else {
                        log('dbLog', `${table}: SELECT allowed (${selectData?.length || 0} rows)`, 'success');
                        testItem.querySelector('.test-result').innerHTML = `
                            <span class="test-icon">✅</span>
                            <span style="color: #48bb78;">SELECT OK</span>
                        `;
                    }
                } catch (err) {
                    log('dbLog', `${table}: Exception - ${err.message}`, 'error');
                    testItem.querySelector('.test-result').innerHTML = `
                        <span class="test-icon">❌</span>
                        <span style="color: #f56565;">Error</span>
                    `;
                }
            }
        }

        async function showRLSMatrix() {
            log('dbLog', 'Building RLS permission matrix...', 'info');
            const matrixContainer = document.getElementById('rlsMatrix');

            const tables = ['contacts', 'opportunities', 'companies', 'activities', 'tasks', 'notes'];
            const operations = ['SELECT', 'INSERT', 'UPDATE', 'DELETE'];

            let html = '<table class="rls-table"><thead><tr><th>Table</th>';
            operations.forEach(op => {
                html += `<th>${op}</th>`;
            });
            html += '</tr></thead><tbody>';

            for (const table of tables) {
                html += `<tr><td><strong>${table}</strong></td>`;

                for (const op of operations) {
                    try {
                        let result = 'unknown';
                        let error = null;

                        switch(op) {
                            case 'SELECT':
                                ({ error } = await client.from(table).select('id').limit(1));
                                break;
                            case 'INSERT':
                                ({ error } = await client.from(table).insert({}).select());
                                break;
                            case 'UPDATE':
                                ({ error } = await client.from(table)
                                    .update({})
                                    .eq('id', '00000000-0000-0000-0000-000000000000')
                                    .select());
                                break;
                            case 'DELETE':
                                ({ error } = await client.from(table)
                                    .delete()
                                    .eq('id', '00000000-0000-0000-0000-000000000000'));
                                break;
                        }

                        if (!error || error.code === 'PGRST116') {
                            result = 'allowed';
                        } else {
                            result = 'denied';
                        }

                        html += `<td class="${result}">${result === 'allowed' ? '✅' : '❌'}</td>`;
                    } catch (err) {
                        html += `<td class="unknown">⚠️</td>`;
                    }
                }

                html += '</tr>';
            }

            html += '</tbody></table>';
            matrixContainer.innerHTML = html;
            log('dbLog', 'RLS matrix complete', 'success');
        }

        async function testPermissions() {
            log('dbLog', 'Testing permission matrix...', 'info');
            const testsContainer = document.getElementById('permissionTests');
            testsContainer.innerHTML = '';

            const operations = [
                { name: 'SELECT', query: (table) => client.from(table).select('id').limit(1) },
                { name: 'INSERT', query: (table) => client.from(table).insert({}).select() },
                { name: 'UPDATE', query: (table) => client.from(table).update({}).eq('id', '00000000-0000-0000-0000-000000000000').select() },
                { name: 'DELETE', query: (table) => client.from(table).delete().eq('id', '00000000-0000-0000-0000-000000000000') }
            ];

            const tables = ['contacts', 'opportunities'];

            for (const table of tables) {
                for (const op of operations) {
                    const testItem = document.createElement('div');
                    testItem.className = 'test-item';
                    testItem.innerHTML = `
                        <span class="test-name">${table}.${op.name}</span>
                        <span class="test-result">
                            <span class="test-icon">⏳</span>
                            <span>Testing...</span>
                        </span>
                    `;
                    testsContainer.appendChild(testItem);

                    try {
                        const { data, error } = await op.query(table);

                        if (error && error.code !== 'PGRST116') { // PGRST116 is "no rows found" which is OK
                            testItem.querySelector('.test-result').innerHTML = `
                                <span class="test-icon">❌</span>
                                <span style="color: #f56565;">Denied</span>
                            `;
                            log('dbLog', `${table}.${op.name}: Denied - ${error.code}`, 'error');
                        } else {
                            testItem.querySelector('.test-result').innerHTML = `
                                <span class="test-icon">✅</span>
                                <span style="color: #48bb78;">Allowed</span>
                            `;
                            log('dbLog', `${table}.${op.name}: Allowed`, 'success');
                        }
                    } catch (err) {
                        testItem.querySelector('.test-result').innerHTML = `
                            <span class="test-icon">⚠️</span>
                            <span style="color: #ed8936;">Error</span>
                        `;
                        log('dbLog', `${table}.${op.name}: ${err.message}`, 'warning');
                    }
                }
            }
        }

        async function validateSchema() {
            log('dbLog', 'Validating database schema...', 'info');
            const testsContainer = document.getElementById('schemaTests');
            testsContainer.innerHTML = '';

            const schemaChecks = [
                {
                    name: 'Table Existence',
                    test: async () => {
                        const tables = ['contacts', 'opportunities', 'companies'];
                        for (const table of tables) {
                            const { error } = await client.from(table).select('id').limit(0);
                            if (error && error.code !== 'PGRST116') return false;
                        }
                        return true;
                    }
                },
                {
                    name: 'Required Columns',
                    test: async () => {
                        const { data, error } = await client
                            .from('contacts')
                            .select('id, first_name, last_name, created_at')
                            .limit(0);
                        return !error || error.code === 'PGRST116';
                    }
                },
                {
                    name: 'JSONB Fields',
                    test: async () => {
                        const { data, error } = await client
                            .from('contacts')
                            .select('email_addresses, phone_numbers')
                            .limit(0);
                        return !error || error.code === 'PGRST116';
                    }
                },
                {
                    name: 'Foreign Keys',
                    test: async () => {
                        // Try to select with a join to test FK relationships
                        const { data, error } = await client
                            .from('opportunities')
                            .select('*, company:company_id(*)')
                            .limit(0);
                        return !error || error.code === 'PGRST116';
                    }
                },
                {
                    name: 'RLS Enabled',
                    test: async () => {
                        // This will fail if RLS is not enabled
                        const { data, error } = await client
                            .from('contacts')
                            .select('id')
                            .limit(1);
                        return true; // If we got here, RLS is working
                    }
                }
            ];

            for (const check of schemaChecks) {
                const testItem = document.createElement('div');
                testItem.className = 'test-item';
                testItem.innerHTML = `
                    <span class="test-name">${check.name}</span>
                    <span class="test-result">
                        <span class="test-icon">⏳</span>
                        <span>Checking...</span>
                    </span>
                `;
                testsContainer.appendChild(testItem);

                try {
                    const result = await check.test();
                    if (result) {
                        testItem.querySelector('.test-result').innerHTML = `
                            <span class="test-icon">✅</span>
                            <span style="color: #48bb78;">Valid</span>
                        `;
                        log('dbLog', `${check.name}: Passed`, 'success');
                    } else {
                        testItem.querySelector('.test-result').innerHTML = `
                            <span class="test-icon">❌</span>
                            <span style="color: #f56565;">Invalid</span>
                        `;
                        log('dbLog', `${check.name}: Failed`, 'error');
                    }
                } catch (err) {
                    testItem.querySelector('.test-result').innerHTML = `
                        <span class="test-icon">⚠️</span>
                        <span style="color: #ed8936;">Error</span>
                    `;
                    log('dbLog', `${check.name}: ${err.message}`, 'warning');
                }
            }
        }

        async function runQueryTest() {
            const table = document.getElementById('testTable').value;
            const operation = document.getElementById('testOperation').value;

            log('dbLog', `Running ${operation} test on ${table}...`, 'info');

            const testsContainer = document.getElementById('queryTests');
            testsContainer.innerHTML = '';

            const testItem = document.createElement('div');
            testItem.className = 'test-item';
            testItem.innerHTML = `
                <span class="test-name">${operation} ${table}</span>
                <span class="test-result">
                    <span class="test-icon">⏳</span>
                    <span>Running...</span>
                </span>
            `;
            testsContainer.appendChild(testItem);

            try {
                let result;
                const startTime = performance.now();

                switch (operation) {
                    case 'select':
                        result = await client.from(table).select('*').limit(5);
                        break;
                    case 'insert':
                        // Create minimal test data
                        const testData = table === 'contacts'
                            ? { first_name: 'Test', last_name: 'User' }
                            : { name: 'Test Item' };
                        result = await client.from(table).insert(testData).select();
                        // Clean up test data
                        if (result.data && result.data[0]) {
                            await client.from(table).delete().eq('id', result.data[0].id);
                        }
                        break;
                    case 'update':
                        result = await client.from(table)
                            .update({ updated_at: new Date().toISOString() })
                            .eq('id', '00000000-0000-0000-0000-000000000000')
                            .select();
                        break;
                    case 'delete':
                        result = await client.from(table)
                            .delete()
                            .eq('id', '00000000-0000-0000-0000-000000000000');
                        break;
                }

                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);

                if (result.error) {
                    testItem.querySelector('.test-result').innerHTML = `
                        <span class="test-icon">❌</span>
                        <span style="color: #f56565;">${result.error.code}</span>
                    `;
                    log('dbLog', `Failed: ${result.error.message} (${duration}ms)`, 'error');
                } else {
                    const rowCount = result.data ? result.data.length : 0;
                    testItem.querySelector('.test-result').innerHTML = `
                        <span class="test-icon">✅</span>
                        <span style="color: #48bb78;">${rowCount} rows (${duration}ms)</span>
                    `;
                    log('dbLog', `Success: ${rowCount} rows affected (${duration}ms)`, 'success');
                }
            } catch (err) {
                testItem.querySelector('.test-result').innerHTML = `
                    <span class="test-icon">⚠️</span>
                    <span style="color: #ed8936;">Exception</span>
                `;
                log('dbLog', `Exception: ${err.message}`, 'error');
            }
        }

        // UI Error Monitoring
        function startErrorMonitoring() {
            if (monitoring) return;
            monitoring = true;

            log('errorLog', 'Started error monitoring', 'success');
            document.getElementById('startMonitorBtn').disabled = true;
            document.getElementById('stopMonitorBtn').disabled = false;

            // Console error hijacking
            console.error = function(...args) {
                originalConsoleError.apply(console, args);
                errorCounts.console++;
                document.getElementById('consoleErrorCount').textContent = errorCounts.console;
                log('errorLog', `Console Error: ${args.join(' ')}`, 'error');
                addLiveError('Console', args.join(' '));
            };

            console.warn = function(...args) {
                originalConsoleWarn.apply(console, args);
                log('errorLog', `Console Warning: ${args.join(' ')}`, 'warning');
            };

            // Global error handler
            window.addEventListener('error', handleGlobalError);
            window.addEventListener('unhandledrejection', handleUnhandledRejection);

            // Network monitoring
            interceptFetch();

            updateStatus('uiStatus', 'uiText', 'connected', 'Monitoring');
        }

        function stopErrorMonitoring() {
            if (!monitoring) return;
            monitoring = false;

            log('errorLog', 'Stopped error monitoring', 'info');
            document.getElementById('startMonitorBtn').disabled = false;
            document.getElementById('stopMonitorBtn').disabled = true;

            // Restore console
            console.error = originalConsoleError;
            console.warn = originalConsoleWarn;

            // Remove listeners
            window.removeEventListener('error', handleGlobalError);
            window.removeEventListener('unhandledrejection', handleUnhandledRejection);

            updateStatus('uiStatus', 'uiText', 'warning', 'Stopped');
        }

        function handleGlobalError(event) {
            errorCounts.react++;
            document.getElementById('reactErrorCount').textContent = errorCounts.react;
            log('errorLog', `Global Error: ${event.error?.message || event.message}`, 'error');
            addLiveError('Global', event.error?.message || event.message);
        }

        function handleUnhandledRejection(event) {
            errorCounts.promise++;
            document.getElementById('promiseErrorCount').textContent = errorCounts.promise;
            log('errorLog', `Unhandled Promise: ${event.reason}`, 'error');
            addLiveError('Promise', event.reason);
        }

        function addLiveError(type, message) {
            capturedErrors.push({ type, message, timestamp: new Date() });

            const errorMonitor = document.getElementById('errorMonitor');
            const errorList = document.getElementById('liveErrorList');
            const errorCount = document.getElementById('liveErrorCount');

            errorMonitor.classList.add('show');
            errorCount.textContent = capturedErrors.length;

            const errorItem = document.createElement('div');
            errorItem.style.padding = '8px';
            errorItem.style.borderBottom = '1px solid #e2e8f0';
            errorItem.innerHTML = `
                <div style="font-weight: bold; color: #f56565;">${type}</div>
                <div style="font-size: 12px; color: #718096;">${message.substring(0, 100)}...</div>
            `;
            errorList.appendChild(errorItem);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (capturedErrors.length === 0) {
                    errorMonitor.classList.remove('show');
                }
            }, 5000);
        }

        function interceptFetch() {
            const originalFetch = window.fetch;
            window.fetch = async function(...args) {
                const startTime = performance.now();
                const [url, options] = args;

                try {
                    const response = await originalFetch.apply(this, args);
                    const duration = Math.round(performance.now() - startTime);

                    if (!response.ok) {
                        errorCounts.network++;
                        document.getElementById('networkErrorCount').textContent = errorCounts.network;
                        log('networkLog', `❌ ${response.status} ${url} (${duration}ms)`, 'error');
                    } else {
                        log('networkLog', `✅ ${response.status} ${url} (${duration}ms)`, 'success');
                    }

                    return response;
                } catch (error) {
                    errorCounts.network++;
                    document.getElementById('networkErrorCount').textContent = errorCounts.network;
                    log('networkLog', `❌ Network Error: ${url} - ${error.message}`, 'error');
                    throw error;
                }
            };
        }

        function simulateError() {
            log('errorLog', 'Simulating React error...', 'info');

            // Simulate different types of errors
            const errorTypes = [
                () => { throw new Error('Simulated React Component Error'); },
                () => { JSON.parse('invalid json'); },
                () => { null.someProperty; },
                () => { Promise.reject('Simulated Promise Rejection'); }
            ];

            const randomError = errorTypes[Math.floor(Math.random() * errorTypes.length)];

            try {
                randomError();
            } catch (err) {
                console.error('Simulated error:', err);
            }
        }

        async function analyzeStorage() {
            log('storageLog', 'Analyzing localStorage...', 'info');

            const storageData = {};
            let totalSize = 0;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                const size = new Blob([value]).size;
                totalSize += size;

                storageData[key] = {
                    size: size,
                    preview: value.substring(0, 100)
                };

                log('storageLog', `${key}: ${formatBytes(size)}`, 'debug');

                // Check for Supabase keys
                if (key.includes('supabase') || key.includes('sb-')) {
                    log('storageLog', `✓ Found Supabase key: ${key}`, 'success');

                    // Try to parse as JSON and extract useful info
                    try {
                        const parsed = JSON.parse(value);
                        if (parsed.access_token) {
                            const decoded = decodeJWT(parsed.access_token);
                            log('storageLog', `  Token role: ${decoded?.role}`, decoded?.role === 'authenticated' ? 'success' : 'warning');
                        }
                    } catch (e) {
                        // Not JSON or doesn't have expected structure
                    }
                }
            }

            document.getElementById('storageUsage').textContent = formatBytes(totalSize);
            log('storageLog', `Total storage: ${formatBytes(totalSize)}`, 'info');

            // Check session storage
            log('storageLog', '\nAnalyzing sessionStorage...', 'info');
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                log('storageLog', `Session: ${key}`, 'debug');
            }
        }

        async function analyzePerformance() {
            log('performanceLog', 'Analyzing performance metrics...', 'info');

            // Memory usage (if available)
            if (performance.memory) {
                const used = performance.memory.usedJSHeapSize;
                const limit = performance.memory.jsHeapSizeLimit;
                const percentage = ((used / limit) * 100).toFixed(2);

                document.getElementById('memoryUsage').textContent = `${formatBytes(used)}`;
                log('performanceLog', `Memory: ${formatBytes(used)} / ${formatBytes(limit)} (${percentage}%)`, 'info');
            }

            // Navigation timing
            const timing = performance.getEntriesByType('navigation')[0];
            if (timing) {
                log('performanceLog', `Page Load: ${Math.round(timing.loadEventEnd - timing.fetchStart)}ms`, 'info');
                log('performanceLog', `DOM Interactive: ${Math.round(timing.domInteractive - timing.fetchStart)}ms`, 'info');
                log('performanceLog', `DOM Complete: ${Math.round(timing.domComplete - timing.fetchStart)}ms`, 'info');
            }

            // Resource timing
            const resources = performance.getEntriesByType('resource');
            const slowResources = resources
                .filter(r => r.duration > 500)
                .sort((a, b) => b.duration - a.duration)
                .slice(0, 5);

            if (slowResources.length > 0) {
                log('performanceLog', '\nSlowest resources:', 'warning');
                slowResources.forEach(r => {
                    log('performanceLog', `${r.name.split('/').pop()}: ${Math.round(r.duration)}ms`, 'debug');
                });
            }
        }

        async function runFullHealthCheck() {
            log('healthLog', '=== Starting Full System Health Check ===', 'info');
            const healthChecks = document.getElementById('healthChecks');
            healthChecks.innerHTML = '';

            const checks = [
                {
                    name: 'Authentication',
                    test: async () => {
                        const session = await checkAuth();
                        return session !== null;
                    }
                },
                {
                    name: 'Database Connection',
                    test: async () => {
                        const { error } = await client.from('tasks').select('id').limit(1);
                        return !error || error.code === 'PGRST116';
                    }
                },
                {
                    name: 'RLS Policies',
                    test: async () => {
                        const { data, error } = await client.from('contacts').select('id').limit(1);
                        return !error || error.code === 'PGRST116';
                    }
                },
                {
                    name: 'Storage Access',
                    test: () => {
                        try {
                            localStorage.setItem('health_check', 'test');
                            localStorage.removeItem('health_check');
                            return true;
                        } catch {
                            return false;
                        }
                    }
                },
                {
                    name: 'Network Connectivity',
                    test: async () => {
                        try {
                            const response = await fetch(SUPABASE_URL + '/rest/v1/', { method: 'HEAD' });
                            return response.ok;
                        } catch {
                            return false;
                        }
                    }
                },
                {
                    name: 'JWT Token Valid',
                    test: async () => {
                        const { data: { session } } = await client.auth.getSession();
                        if (!session) return false;
                        const decoded = decodeJWT(session.access_token);
                        return decoded && decoded.role === 'authenticated' && decoded.exp * 1000 > Date.now();
                    }
                }
            ];

            let passedCount = 0;
            let failedCount = 0;

            for (const check of checks) {
                const checkItem = document.createElement('div');
                checkItem.className = 'test-item';
                checkItem.innerHTML = `
                    <span class="test-name">${check.name}</span>
                    <span class="test-result">
                        <span class="test-icon">⏳</span>
                        <span>Checking...</span>
                    </span>
                `;
                healthChecks.appendChild(checkItem);

                try {
                    const result = await check.test();
                    if (result) {
                        passedCount++;
                        checkItem.querySelector('.test-result').innerHTML = `
                            <span class="test-icon">✅</span>
                            <span style="color: #48bb78;">Healthy</span>
                        `;
                        log('healthLog', `✅ ${check.name}: Passed`, 'success');
                    } else {
                        failedCount++;
                        checkItem.querySelector('.test-result').innerHTML = `
                            <span class="test-icon">❌</span>
                            <span style="color: #f56565;">Failed</span>
                        `;
                        log('healthLog', `❌ ${check.name}: Failed`, 'error');
                    }
                } catch (err) {
                    failedCount++;
                    checkItem.querySelector('.test-result').innerHTML = `
                        <span class="test-icon">⚠️</span>
                        <span style="color: #ed8936;">Error</span>
                    `;
                    log('healthLog', `⚠️ ${check.name}: ${err.message}`, 'warning');
                }
            }

            log('healthLog', `\n=== Health Check Complete ===`, 'info');
            log('healthLog', `Passed: ${passedCount}/${checks.length}`, passedCount === checks.length ? 'success' : 'warning');

            if (failedCount > 0) {
                log('healthLog', `\nRecommendation: Click "Attempt Auto-Fix" to resolve issues`, 'info');
            }
        }

        async function attemptAutoFix() {
            log('healthLog', '=== Attempting Auto-Fix ===', 'info');

            // Clear problematic localStorage keys
            log('healthLog', 'Clearing problematic storage keys...', 'info');
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('supabase') || key.includes('sb-'))) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log('healthLog', `Removed: ${key}`, 'debug');
            });

            // Sign out and sign in
            log('healthLog', 'Refreshing authentication...', 'info');
            await client.auth.signOut();

            // Attempt re-authentication with stored credentials
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            if (email && password) {
                const { data, error } = await client.auth.signInWithPassword({
                    email,
                    password
                });

                if (!error) {
                    log('healthLog', '✅ Re-authenticated successfully', 'success');

                    // Force a token refresh
                    const { data: refreshData, error: refreshError } = await client.auth.refreshSession();
                    if (!refreshError) {
                        log('healthLog', '✅ Token refreshed', 'success');
                    }
                } else {
                    log('healthLog', '❌ Re-authentication failed. Please login manually.', 'error');
                }
            } else {
                log('healthLog', '⚠️ No credentials available for auto-login', 'warning');
            }

            // Clear error counts
            errorCounts = { console: 0, network: 0, react: 0, promise: 0 };
            document.getElementById('consoleErrorCount').textContent = '0';
            document.getElementById('networkErrorCount').textContent = '0';
            document.getElementById('reactErrorCount').textContent = '0';
            document.getElementById('promiseErrorCount').textContent = '0';

            log('healthLog', '✅ Auto-fix complete. Please refresh the app.', 'success');
        }

        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                auth: {
                    status: document.getElementById('authText').textContent,
                    userId: document.getElementById('userId').textContent
                },
                database: {
                    status: document.getElementById('dbText').textContent
                },
                errors: capturedErrors,
                errorCounts: errorCounts,
                storage: {
                    usage: document.getElementById('storageUsage').textContent
                },
                logs: {
                    auth: document.getElementById('authLog').textContent,
                    db: document.getElementById('dbLog').textContent,
                    error: document.getElementById('errorLog').textContent,
                    health: document.getElementById('healthLog').textContent
                }
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `atomic-crm-diagnostic-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log('healthLog', '✅ Report exported', 'success');
        }

        // Event Listeners
        document.getElementById('checkAuthBtn').addEventListener('click', checkAuth);
        document.getElementById('clearSessionBtn').addEventListener('click', async () => {
            log('authLog', 'Clearing all sessions...', 'info');

            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && (key.includes('supabase') || key.includes('sb-'))) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                log('authLog', `Removed: ${key}`, 'debug');
            });

            await client.auth.signOut();
            log('authLog', '✅ All sessions cleared', 'success');
            updateStatus('authStatus', 'authText', 'warning', 'Cleared');
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            if (!password) {
                log('authLog', 'Password required', 'warning');
                return;
            }

            log('authLog', `Attempting login as ${email}...`, 'info');

            const { data, error } = await client.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                log('authLog', `Login failed: ${error.message}`, 'error');
            } else {
                log('authLog', `✅ Login successful!`, 'success');
                await checkAuth();
            }
        });

        document.getElementById('refreshTokenBtn').addEventListener('click', async () => {
            log('authLog', 'Refreshing token...', 'info');
            const { data, error } = await client.auth.refreshSession();

            if (error) {
                log('authLog', `Refresh failed: ${error.message}`, 'error');
            } else {
                log('authLog', '✅ Token refreshed successfully', 'success');
                await checkAuth();
            }
        });

        document.getElementById('testRlsBtn').addEventListener('click', testRLSPolicies);
        document.getElementById('rlsMatrixBtn').addEventListener('click', showRLSMatrix);
        document.getElementById('testNbTasksBtn').addEventListener('click', testNbTasksError);
        document.getElementById('testPermissionsBtn').addEventListener('click', testPermissions);
        document.getElementById('schemaCheckBtn').addEventListener('click', validateSchema);
        document.getElementById('runQueryTestBtn').addEventListener('click', runQueryTest);
        document.getElementById('startMonitorBtn').addEventListener('click', startErrorMonitoring);
        document.getElementById('stopMonitorBtn').addEventListener('click', stopErrorMonitoring);
        document.getElementById('simulateErrorBtn').addEventListener('click', simulateError);
        document.getElementById('clearErrorsBtn').addEventListener('click', () => {
            capturedErrors = [];
            errorCounts = { console: 0, network: 0, react: 0, promise: 0 };
            document.getElementById('consoleErrorCount').textContent = '0';
            document.getElementById('networkErrorCount').textContent = '0';
            document.getElementById('reactErrorCount').textContent = '0';
            document.getElementById('promiseErrorCount').textContent = '0';
            document.getElementById('errorLog').innerHTML = '';
            document.getElementById('networkLog').innerHTML = '';
            document.getElementById('errorMonitor').classList.remove('show');
            log('errorLog', 'Cleared all errors', 'info');
        });
        document.getElementById('networkTestBtn').addEventListener('click', async () => {
            log('networkLog', 'Testing network requests...', 'info');

            const endpoints = [
                { name: 'Supabase API', url: SUPABASE_URL + '/rest/v1/' },
                { name: 'Auth Service', url: SUPABASE_URL + '/auth/v1/health' },
                { name: 'Storage Service', url: SUPABASE_URL + '/storage/v1/status' }
            ];

            for (const endpoint of endpoints) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(endpoint.url, { method: 'GET' });
                    const duration = Math.round(performance.now() - startTime);

                    if (response.ok) {
                        log('networkLog', `✅ ${endpoint.name}: ${response.status} (${duration}ms)`, 'success');
                    } else {
                        log('networkLog', `❌ ${endpoint.name}: ${response.status} (${duration}ms)`, 'error');
                    }
                } catch (err) {
                    log('networkLog', `❌ ${endpoint.name}: ${err.message}`, 'error');
                }
            }
        });
        document.getElementById('consoleHijackBtn').addEventListener('click', () => {
            log('errorLog', 'Console hijacking enabled', 'info');
            startErrorMonitoring();
        });

        // Storage analysis button
        document.querySelector('[data-tab="storage"]').addEventListener('click', analyzeStorage);

        // Performance analysis button
        document.querySelector('[data-tab="performance"]').addEventListener('click', analyzePerformance);

        document.getElementById('fullHealthCheckBtn').addEventListener('click', runFullHealthCheck);
        document.getElementById('autoFixBtn').addEventListener('click', attemptAutoFix);
        document.getElementById('exportReportBtn').addEventListener('click', exportReport);

        // Initial checks
        (async () => {
            await checkAuth();

            // Quick DB test
            const { error } = await client.from('tasks').select('id').limit(1);
            if (error && error.code !== 'PGRST116') {
                updateStatus('dbStatus', 'dbText', 'error', 'Error');
                updateStatus('rlsStatus', 'rlsText', 'error', 'Error');
            } else {
                updateStatus('dbStatus', 'dbText', 'connected', 'Connected');
                updateStatus('rlsStatus', 'rlsText', 'connected', 'Active');
            }

            // Start basic monitoring
            startErrorMonitoring();
        })();
    </script>
</body>
</html>