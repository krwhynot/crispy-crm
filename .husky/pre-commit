#!/bin/bash
# Pre-commit hook - Fast & Focused
# Only checks staged files, not entire codebase

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# ═══════════════════════════════════════════════════════════════
# 1. SECURITY: Block .env files (CRITICAL - always run)
# ═══════════════════════════════════════════════════════════════
env_files=$(echo "$STAGED_FILES" | grep -E '\.env$|\.env\.' || true)

if [ -n "$env_files" ]; then
  echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${RED}❌ COMMIT BLOCKED: .env file(s) detected${NC}"
  echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo
  echo -e "${YELLOW}The following .env files are staged for commit:${NC}"
  echo "$env_files" | sed 's/^/  - /'
  echo
  echo "To fix: git reset HEAD $env_files"
  echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  exit 1
fi

# ═══════════════════════════════════════════════════════════════
# 2. QUICK CHECKS: TypeScript type-check (only if TS files staged)
# ═══════════════════════════════════════════════════════════════
ts_files=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

if [ -n "$ts_files" ]; then
  echo "⚡ Type-checking staged files..."
  npx tsc --noEmit 2>/dev/null
  if [ $? -ne 0 ]; then
    echo -e "${RED}❌ TypeScript errors found. Run 'npx tsc --noEmit' for details.${NC}"
    exit 1
  fi
  echo -e "${GREEN}✓ Types OK${NC}"
fi

# ═══════════════════════════════════════════════════════════════
# 3. SKIP heavy checks - run manually or in CI
# ═══════════════════════════════════════════════════════════════
# Semantic colors: Run 'npm run validate:semantic-colors' manually
# Full test suite: Run 'npm test' manually or rely on CI

echo -e "${GREEN}✓ Pre-commit checks passed${NC}"
