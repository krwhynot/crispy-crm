<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Debug Tool</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .section {
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            background: #0a0a0a;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
        }
        button:hover {
            background: #00ff00;
            color: #000;
        }
        input {
            background: #222;
            color: #00ff00;
            border: 1px solid #333;
            padding: 8px;
            margin: 5px;
            font-family: monospace;
        }
        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
            border: 1px solid #333;
        }
        h2 { color: #00aaff; }
        h3 { color: #ffaa00; }
    </style>
</head>
<body>
    <h1>üîç Supabase Diagnostic Tool</h1>

    <div class="section">
        <h2>Step 1: Environment Check</h2>
        <button onclick="checkEnvironment()">Check Environment</button>
        <pre id="env-output"></pre>
    </div>

    <div class="section">
        <h2>Step 2: Supabase Connection</h2>
        <button onclick="testConnection()">Test Connection</button>
        <pre id="connection-output"></pre>
    </div>

    <div class="section">
        <h2>Step 3: Authentication</h2>
        <div>
            <input type="email" id="email" placeholder="Email" value="admin@test.com">
            <input type="password" id="password" placeholder="Password" value="password123">
            <button onclick="testLogin()">Login</button>
            <button onclick="testLogout()">Logout</button>
        </div>
        <pre id="auth-output"></pre>
    </div>

    <div class="section">
        <h2>Step 4: Session Info</h2>
        <button onclick="checkSession()">Check Session</button>
        <button onclick="decodeToken()">Decode JWT</button>
        <pre id="session-output"></pre>
    </div>

    <div class="section">
        <h2>Step 5: Test API Calls</h2>
        <button onclick="testSalesQuery()">Test Sales Query</button>
        <button onclick="testContactsQuery()">Test Contacts Query</button>
        <button onclick="testOrganizationsQuery()">Test Organizations Query</button>
        <button onclick="testOpportunitiesQuery()">Test Opportunities Query</button>
        <pre id="api-output"></pre>
    </div>

    <div class="section">
        <h2>Step 6: RLS Policy Test</h2>
        <button onclick="testRLS()">Test RLS Policies</button>
        <pre id="rls-output"></pre>
    </div>

    <div class="section">
        <h2>Step 7: Clear Browser Data</h2>
        <button onclick="clearStorage()">Clear All Storage</button>
        <button onclick="showStorage()">Show Storage Contents</button>
        <pre id="storage-output"></pre>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Read from meta tags or use defaults
        const SUPABASE_URL = 'http://127.0.0.1:54321';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0';

        window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        window.checkEnvironment = function() {
            clear('env-output');
            log('env-output', '=== Environment Variables ===', 'info');
            log('env-output', `SUPABASE_URL: ${SUPABASE_URL}`, 'success');
            log('env-output', `SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY.substring(0, 50)}...`, 'success');
            log('env-output', `\nWindow Location: ${window.location.href}`, 'info');
            log('env-output', `User Agent: ${navigator.userAgent}`, 'info');
        }

        window.testConnection = async function() {
            clear('connection-output');
            log('connection-output', '=== Testing Supabase Connection ===', 'info');

            try {
                // Test basic connection with a simple query
                const { data, error } = await supabase
                    .from('sales')
                    .select('count')
                    .limit(1);

                if (error) {
                    log('connection-output', `‚ùå Connection Error: ${error.message}`, 'error');
                    log('connection-output', JSON.stringify(error, null, 2), 'error');
                } else {
                    log('connection-output', '‚úÖ Connection successful!', 'success');
                    log('connection-output', `Response: ${JSON.stringify(data, null, 2)}`, 'success');
                }
            } catch (err) {
                log('connection-output', `‚ùå Exception: ${err.message}`, 'error');
                log('connection-output', err.stack, 'error');
            }
        }

        window.testLogin = async function() {
            clear('auth-output');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            log('auth-output', '=== Testing Login ===', 'info');
            log('auth-output', `Email: ${email}`, 'info');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    log('auth-output', `‚ùå Login Error: ${error.message}`, 'error');
                    log('auth-output', JSON.stringify(error, null, 2), 'error');
                } else {
                    log('auth-output', '‚úÖ Login successful!', 'success');
                    log('auth-output', `User ID: ${data.user.id}`, 'success');
                    log('auth-output', `Email: ${data.user.email}`, 'success');
                    log('auth-output', `Session expires: ${new Date(data.session.expires_at * 1000).toLocaleString()}`, 'info');
                    log('auth-output', `\nFull User Object:`, 'info');
                    log('auth-output', JSON.stringify(data.user, null, 2), 'info');
                }
            } catch (err) {
                log('auth-output', `‚ùå Exception: ${err.message}`, 'error');
            }
        }

        window.testLogout = async function() {
            clear('auth-output');
            log('auth-output', '=== Testing Logout ===', 'info');

            try {
                const { error } = await supabase.auth.signOut();

                if (error) {
                    log('auth-output', `‚ùå Logout Error: ${error.message}`, 'error');
                } else {
                    log('auth-output', '‚úÖ Logout successful!', 'success');
                }
            } catch (err) {
                log('auth-output', `‚ùå Exception: ${err.message}`, 'error');
            }
        }

        window.checkSession = async function() {
            clear('session-output');
            log('session-output', '=== Checking Session ===', 'info');

            try {
                const { data, error } = await supabase.auth.getSession();

                if (error) {
                    log('session-output', `‚ùå Session Error: ${error.message}`, 'error');
                } else if (!data.session) {
                    log('session-output', '‚ö†Ô∏è  No active session', 'warning');
                } else {
                    log('session-output', '‚úÖ Active session found!', 'success');
                    log('session-output', `User ID: ${data.session.user.id}`, 'success');
                    log('session-output', `Email: ${data.session.user.email}`, 'success');
                    log('session-output', `Expires: ${new Date(data.session.expires_at * 1000).toLocaleString()}`, 'info');
                    log('session-output', `\nAccess Token (first 100 chars):`, 'info');
                    log('session-output', data.session.access_token.substring(0, 100) + '...', 'info');
                }
            } catch (err) {
                log('session-output', `‚ùå Exception: ${err.message}`, 'error');
            }
        }

        window.decodeToken = async function() {
            clear('session-output');
            log('session-output', '=== Decoding JWT Token ===', 'info');

            try {
                const { data } = await supabase.auth.getSession();

                if (!data.session) {
                    log('session-output', '‚ö†Ô∏è  No session to decode', 'warning');
                    return;
                }

                const token = data.session.access_token;
                const parts = token.split('.');

                if (parts.length !== 3) {
                    log('session-output', '‚ùå Invalid JWT format', 'error');
                    return;
                }

                const payload = JSON.parse(atob(parts[1]));

                log('session-output', '‚úÖ JWT Decoded:', 'success');
                log('session-output', JSON.stringify(payload, null, 2), 'info');
                log('session-output', `\nüîë Key Info:`, 'info');
                log('session-output', `User ID (sub): ${payload.sub}`, 'success');
                log('session-output', `Email: ${payload.email}`, 'success');
                log('session-output', `Role: ${payload.role}`, 'success');
                log('session-output', `Issued At: ${new Date(payload.iat * 1000).toLocaleString()}`, 'info');
                log('session-output', `Expires At: ${new Date(payload.exp * 1000).toLocaleString()}`, 'info');

            } catch (err) {
                log('session-output', `‚ùå Exception: ${err.message}`, 'error');
            }
        }

        window.testSalesQuery = async function() {
            clear('api-output');
            log('api-output', '=== Testing Sales Query ===', 'info');

            try {
                const { data: session } = await supabase.auth.getSession();

                if (!session.session) {
                    log('api-output', '‚ö†Ô∏è  Not logged in', 'warning');
                    return;
                }

                const userId = session.session.user.id;
                log('api-output', `Querying for user_id: ${userId}`, 'info');

                const { data, error, count } = await supabase
                    .from('sales')
                    .select('*', { count: 'exact' })
                    .eq('user_id', userId);

                if (error) {
                    log('api-output', `‚ùå Query Error: ${error.message}`, 'error');
                    log('api-output', JSON.stringify(error, null, 2), 'error');
                } else {
                    log('api-output', `‚úÖ Query successful! Found ${count} record(s)`, 'success');
                    log('api-output', JSON.stringify(data, null, 2), 'success');

                    // Store sales_id for next queries
                    if (data && data.length > 0) {
                        window.currentSalesId = data[0].id;
                        log('api-output', `\nüíæ Stored sales_id: ${window.currentSalesId}`, 'info');
                    }
                }
            } catch (err) {
                log('api-output', `‚ùå Exception: ${err.message}`, 'error');
            }
        }

        window.testContactsQuery = async function() {
            clear('api-output');
            log('api-output', '=== Testing Contacts Query ===', 'info');
            log('api-output', 'üìã Shared Team Access: All team members can see all contacts', 'info');

            try {
                const { data, error, count } = await supabase
                    .from('contacts')
                    .select('id, first_name, last_name, email, sales_id', { count: 'exact' })
                    .limit(10);

                if (error) {
                    log('api-output', `‚ùå Query Error: ${error.message}`, 'error');
                    log('api-output', JSON.stringify(error, null, 2), 'error');
                } else {
                    log('api-output', `‚úÖ Query successful! Found ${count} contact(s)`, 'success');
                    log('api-output', JSON.stringify(data, null, 2), 'success');
                }
            } catch (err) {
                log('api-output', `‚ùå Exception: ${err.message}`, 'error');
            }
        }

        window.testOrganizationsQuery = async function() {
            clear('api-output');
            log('api-output', '=== Testing Organizations Query ===', 'info');
            log('api-output', 'üìã Shared Team Access: All team members can see all organizations', 'info');

            try {
                const { data, error, count } = await supabase
                    .from('organizations')
                    .select('id, name, sales_id', { count: 'exact' })
                    .limit(10);

                if (error) {
                    log('api-output', `‚ùå Query Error: ${error.message}`, 'error');
                    log('api-output', JSON.stringify(error, null, 2), 'error');
                } else {
                    log('api-output', `‚úÖ Query successful! Found ${count} organization(s)`, 'success');
                    log('api-output', JSON.stringify(data, null, 2), 'success');
                }
            } catch (err) {
                log('api-output', `‚ùå Exception: ${err.message}`, 'error');
            }
        }

        window.testOpportunitiesQuery = async function() {
            clear('api-output');
            log('api-output', '=== Testing Opportunities Query ===', 'info');
            log('api-output', 'üìã Shared Team Access: All team members can see all opportunities', 'info');

            try {
                const { data, error, count } = await supabase
                    .from('opportunities')
                    .select('id, name, opportunity_owner_id', { count: 'exact' })
                    .limit(10);

                if (error) {
                    log('api-output', `‚ùå Query Error: ${error.message}`, 'error');
                    log('api-output', JSON.stringify(error, null, 2), 'error');
                } else {
                    log('api-output', `‚úÖ Query successful! Found ${count} opportunit(ies)`, 'success');
                    log('api-output', JSON.stringify(data, null, 2), 'success');
                }
            } catch (err) {
                log('api-output', `‚ùå Exception: ${err.message}`, 'error');
            }
        }

        window.testRLS = async function() {
            clear('rls-output');
            log('rls-output', '=== Testing RLS Policies ===', 'info');
            log('rls-output', 'üìã Shared Team Architecture:', 'info');
            log('rls-output', '  ‚Ä¢ Contacts, Organizations, Opportunities, Products: SHARED (everyone)', 'info');
            log('rls-output', '  ‚Ä¢ Tasks: PERSONAL (only creator can see)', 'info');

            try {
                const { data: session } = await supabase.auth.getSession();

                if (!session.session) {
                    log('rls-output', '‚ö†Ô∏è  Not logged in - RLS will block all queries', 'warning');
                    return;
                }

                const userId = session.session.user.id;
                log('rls-output', `\nCurrent user_id: ${userId}`, 'info');

                // Get sales_id for this user
                const { data: salesData } = await supabase
                    .from('sales')
                    .select('id')
                    .eq('user_id', userId)
                    .single();

                if (!salesData) {
                    log('rls-output', '‚ùå No sales record found for user', 'error');
                    return;
                }

                const salesId = salesData.id;
                log('rls-output', `Sales ID: ${salesId}\n`, 'info');

                // Test shared tables (no filter - everyone sees all)
                const sharedTableTests = [
                    { table: 'contacts', description: 'Shared - All Contacts' },
                    { table: 'organizations', description: 'Shared - All Organizations' },
                    { table: 'opportunities', description: 'Shared - All Opportunities' },
                    { table: 'products', description: 'Shared - Product Catalog' },
                    { table: 'contactNotes', description: 'Shared - Contact Notes' },
                    { table: 'opportunityNotes', description: 'Shared - Opportunity Notes' }
                ];

                log('rls-output', '=== Testing Shared Tables (No Filters) ===', 'info');
                for (const test of sharedTableTests) {
                    log('rls-output', `\nüìã ${test.description}...`, 'info');

                    const { error, count } = await supabase
                        .from(test.table)
                        .select('*', { count: 'exact', head: true });

                    if (error) {
                        log('rls-output', `  ‚ùå ${test.table}: ${error.message}`, 'error');
                    } else {
                        log('rls-output', `  ‚úÖ ${test.table}: ${count} accessible records`, 'success');
                    }
                }

                // Test personal tasks (filtered by sales_id)
                log('rls-output', '\n\n=== Testing Personal Tables (With Filters) ===', 'info');
                log('rls-output', `\nüìã Personal Tasks (sales_id=${salesId})...`, 'info');

                const { error: tasksError, count: tasksCount } = await supabase
                    .from('tasks')
                    .select('*', { count: 'exact', head: true })
                    .eq('sales_id', salesId);

                if (tasksError) {
                    log('rls-output', `  ‚ùå tasks: ${tasksError.message}`, 'error');
                } else {
                    log('rls-output', `  ‚úÖ tasks: ${tasksCount} accessible records (personal only)`, 'success');
                }

                // Test that user can't see other users' tasks
                log('rls-output', '\n\n=== Testing RLS Protection ===', 'info');
                log('rls-output', `\nüìã Trying to access ALL tasks (should only see own)...`, 'info');

                const { error: allTasksError, count: allTasksCount } = await supabase
                    .from('tasks')
                    .select('*', { count: 'exact', head: true });

                if (allTasksError) {
                    log('rls-output', `  ‚ùå Error: ${allTasksError.message}`, 'error');
                } else {
                    log('rls-output', `  ‚úÖ Query succeeded: ${allTasksCount} tasks visible`, 'success');
                    if (allTasksCount === tasksCount) {
                        log('rls-output', `  ‚úÖ RLS working correctly: Can only see own tasks`, 'success');
                    } else {
                        log('rls-output', `  ‚ö†Ô∏è  Unexpected: Seeing more tasks than expected!`, 'warning');
                    }
                }

            } catch (err) {
                log('rls-output', `‚ùå Exception: ${err.message}`, 'error');
            }
        }

        window.clearStorage = function() {
            clear('storage-output');
            log('storage-output', '=== Clearing Browser Storage ===', 'warning');

            const localStorageKeys = Object.keys(localStorage);
            const sessionStorageKeys = Object.keys(sessionStorage);

            log('storage-output', `Clearing ${localStorageKeys.length} localStorage items...`, 'info');
            log('storage-output', `Clearing ${sessionStorageKeys.length} sessionStorage items...`, 'info');

            localStorage.clear();
            sessionStorage.clear();

            log('storage-output', '‚úÖ All storage cleared!', 'success');
            log('storage-output', '\n‚ö†Ô∏è  Please refresh the page to continue', 'warning');
        }

        window.showStorage = function() {
            clear('storage-output');
            log('storage-output', '=== Browser Storage Contents ===', 'info');

            log('storage-output', '\nüì¶ LocalStorage:', 'info');
            if (localStorage.length === 0) {
                log('storage-output', '  (empty)', 'info');
            } else {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    log('storage-output', `  ${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`, 'info');
                }
            }

            log('storage-output', '\nüì¶ SessionStorage:', 'info');
            if (sessionStorage.length === 0) {
                log('storage-output', '  (empty)', 'info');
            } else {
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    const value = sessionStorage.getItem(key);
                    log('storage-output', `  ${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`, 'info');
                }
            }
        }

        // Auto-run environment check on load
        setTimeout(() => {
            checkEnvironment();
            log('env-output', '\n‚ú® Diagnostic tool ready! Click buttons to test each step.', 'success');
        }, 100);
    </script>
</body>
</html>
