/**
 * Organizations Resource Lifecycle Callbacks
 *
 * Resource-specific logic for organizations using React Admin's withLifecycleCallbacks pattern.
 * Follows the same structure as contactsCallbacks for consistency.
 *
 * Key behaviors:
 * 1. Soft delete - Sets deleted_at instead of hard delete
 * 2. Filter cleaning - Adds soft delete filter by default
 * 3. Data transformation - Strips computed fields before save
 * 4. Logo handling - Preserves logo for storage service
 *
 * Engineering Constitution: Resource-specific logic extracted for single responsibility
 */

import type { DataProvider, RaRecord, GetListParams, DeleteParams } from "ra-core";

/**
 * Computed fields that should be stripped before saving to database
 * These are generated by views or aggregations
 */
const COMPUTED_FIELDS = [
  "contact_count",
  "opportunity_count",
  "total_revenue",
  "last_activity_date",
  "primary_contact_name",
] as const;

/**
 * Lifecycle callback type for React Admin withLifecycleCallbacks
 */
interface ResourceCallbacks {
  resource: string;
  beforeDelete?: (params: DeleteParams, dataProvider: DataProvider) => Promise<DeleteParams & { meta?: { skipDelete?: boolean } }>;
  afterRead?: (record: RaRecord, dataProvider: DataProvider) => Promise<RaRecord>;
  beforeGetList?: (params: GetListParams, dataProvider: DataProvider) => Promise<GetListParams>;
  beforeSave?: (data: Partial<RaRecord>, dataProvider: DataProvider, resource: string) => Promise<Partial<RaRecord>>;
}

/**
 * Strip computed fields that shouldn't be sent to database
 *
 * @param data - The data being saved
 * @returns Data without computed fields
 */
function stripComputedFields(data: Partial<RaRecord>): Partial<RaRecord> {
  const cleaned = { ...data };

  for (const field of COMPUTED_FIELDS) {
    delete cleaned[field];
  }

  return cleaned;
}

/**
 * Organizations lifecycle callbacks for React Admin withLifecycleCallbacks
 *
 * Usage:
 * ```typescript
 * import { withLifecycleCallbacks } from 'react-admin';
 * import { organizationsCallbacks } from './callbacks/organizationsCallbacks';
 *
 * const dataProvider = withLifecycleCallbacks(baseProvider, [
 *   organizationsCallbacks,
 * ]);
 * ```
 */
export const organizationsCallbacks: ResourceCallbacks = {
  resource: "organizations",

  /**
   * Convert hard delete to soft delete
   * Sets deleted_at timestamp instead of removing the record
   */
  beforeDelete: async (params, dataProvider) => {
    const deletedAt = new Date().toISOString();

    // Perform soft delete via update
    await dataProvider.update("organizations", {
      id: params.id,
      data: { deleted_at: deletedAt },
      previousData: params.previousData,
    });

    // Return params with meta flag to skip actual delete
    return {
      ...params,
      meta: { ...params.meta, skipDelete: true },
    };
  },

  /**
   * Normalize data after reading from database
   * Organizations don't have JSONB arrays like contacts, but we keep this
   * for consistency and future extensibility
   */
  afterRead: async (record, _dataProvider) => {
    // No transformation needed for organizations
    // Logo URLs are already properly formatted by storage service
    return record;
  },

  /**
   * Add soft delete filter and clean filters before getList
   * Excludes soft-deleted records by default
   */
  beforeGetList: async (params, _dataProvider) => {
    const { includeDeleted, ...otherFilters } = params.filter || {};

    // Add soft delete filter unless explicitly including deleted
    const softDeleteFilter = includeDeleted ? {} : { "deleted_at@is": null };

    return {
      ...params,
      filter: {
        ...otherFilters,
        ...softDeleteFilter,
      },
    };
  },

  /**
   * Strip computed fields before save (create/update)
   * Removes fields that are generated by views or aggregations
   * Preserves logo field for storage service to handle
   */
  beforeSave: async (data, _dataProvider, _resource) => {
    return stripComputedFields(data);
  },
};

/**
 * Export helper functions for testing
 */
export { stripComputedFields, COMPUTED_FIELDS };
