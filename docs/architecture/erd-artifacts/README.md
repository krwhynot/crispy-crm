# ERD Artifacts

This directory contains automated analysis outputs for the database schema and UI component mapping.

## Files

### ui-mapping.json

**Purpose:** Maps database tables to React Admin resources and their corresponding UI components.

**Generated by:** `node scripts/generate-ui-mapping.cjs`

**Update frequency:** Run after adding new resources, components, or database tables.

**Key Metrics (as of 2026-02-09):**
- **Total database tables:** 34
- **Resources with UI:** 14
- **Total UI components:** 75
- **Unmapped tables:** 20 (junction tables, system tables, supporting tables)

**Schema:**
```json
{
  "generated_at": "ISO timestamp",
  "summary": {
    "total_database_tables": 34,
    "total_resources": 21,
    "total_components": 75,
    "unmapped_tables": 20
  },
  "resources": [
    {
      "resource_name": "contacts",
      "database_table": "contacts",
      "summary_view": "contacts_summary",
      "feature_directory": "src/atomic-crm/contacts",
      "components": [...],
      "relationships_rendered": [...],
      "resource_config": {...}
    }
  ],
  "unmapped_tables": [...]
}
```

**Component Features Detected:**
- `PremiumDatagrid` - Enterprise datagrid with keyboard navigation
- `TabbedForm` / `SimpleForm` - Form layouts
- `Filters` - List filtering UI
- `BulkActions` - Bulk operations
- `ReferenceManyField` / `ReferenceField` - Relationship displays

**Usage:**

```bash
# Regenerate mapping
node scripts/generate-ui-mapping.cjs

# Find all components for a resource
cat docs/architecture/erd-artifacts/ui-mapping.json | jq '.resources[] | select(.resource_name == "contacts") | .components'

# List all unmapped tables
cat docs/architecture/erd-artifacts/ui-mapping.json | jq '.unmapped_tables[] | "\(.resource_name): \(.reason)"'

# View relationship renderings
cat docs/architecture/erd-artifacts/ui-mapping.json | jq '.resources[] | {resource: .resource_name, relationships: .relationships_rendered}'
```

**When to regenerate:**
- After adding a new resource to `composedDataProvider.ts`
- After creating new UI components (List, Create, Edit, Show, SlideOver)
- After adding new database tables via migrations
- After modifying relationship displays

---

### schema-metadata.json

**Purpose:** Complete PostgreSQL schema introspection for ERD generation and validation.

**Generated by:** `npm run schema:metadata` (local) or `npm run schema:metadata:cloud` (cloud)

**Source:** `scripts/generate-schema-metadata.js`

**Key Metrics (as of 2026-02-09):**
- **Total tables:** 28
- **Foreign keys:** 78
- **Indexes:** 192
- **RLS policies:** 107
- **Tables with soft delete:** 23/28 (82%)

**Contains:**
- **Tables**: All tables in `public` schema with row counts
- **Columns**: Full metadata (name, type, nullable, default, max_length, position)
- **Primary Keys**: Primary key constraints
- **Foreign Keys**: Relationships with referential actions (ON DELETE, ON UPDATE)
- **Indexes**: All indexes with definitions
- **RLS Policies**: Row Level Security policies with commands and roles
- **Soft Delete Detection**: Flags tables with `deleted_at` columns

**Schema:**

```json
{
  "generated_at": "ISO timestamp",
  "summary": {
    "total_tables": 28,
    "total_foreign_keys": 78,
    "total_indexes": 192,
    "total_rls_policies": 107
  },
  "tables": [
    {
      "name": "table_name",
      "row_count": 0,
      "has_soft_delete": true,
      "columns": [...],
      "primary_key": ["id"],
      "foreign_keys": [...],
      "indexes": [...],
      "rls_policies": [...]
    }
  ]
}
```

**Requirements:**
- `DATABASE_URL` environment variable in `.env` or `.env.local`
- Direct PostgreSQL connection (port 5432, not REST API)
- System catalog read access

**Usage:**

```bash
# Generate from local database
npm run schema:metadata

# Generate from cloud database
npm run schema:metadata:cloud

# Programmatic usage
import schemaMetadata from './docs/architecture/erd-artifacts/schema-metadata.json' assert { type: 'json' };

const contactsTable = schemaMetadata.tables.find(t => t.name === 'contacts');
console.log('Has soft delete:', contactsTable.has_soft_delete);
console.log('Foreign keys:', contactsTable.foreign_keys);
```

**Use Cases:**
- **ERD Generation**: Convert to Mermaid (`erDiagram`), PlantUML, or DBML
- **Schema Validation**: Detect drift between local/cloud environments
- **Type Generation**: Auto-generate TypeScript interfaces from columns
- **Documentation**: API contract and database documentation
- **Audit**: Verify RLS policy coverage and soft delete compliance

**Maintenance:**
- Regenerate after applying migrations
- Add to CI/CD to detect schema drift: `npm run schema:metadata:cloud && git diff --exit-code docs/architecture/erd-artifacts/schema-metadata.json`
- Compare before/after major refactoring

---

### orphan-analysis.json

**Purpose:** Detects data integrity issues in the database.

**Generated by:** `npm run analyze:orphans` (runs `scripts/orphan-analysis.ts`)

**Requirements:**
- `DATABASE_URL` environment variable in `.env` or `.env.local`
- Direct PostgreSQL connection (port 5432 for local, pooler port for cloud)
- Format: `postgresql://postgres:[PASSWORD]@127.0.0.1:54322/postgres`

**Detection Strategy:**

1. **Orphaned Tables** - Tables with no foreign key relationships (incoming or outgoing)
2. **Orphaned Records** - Two types:
   - `soft_deleted_parent`: Active records pointing to soft-deleted parents (parent.deleted_at IS NOT NULL)
   - `missing_parent`: Foreign keys pointing to non-existent IDs
3. **Empty Tables** - Tables with zero rows

**Schema:**

```json
{
  "generated_at": "ISO timestamp",
  "database_url": "postgresql://postgres:****@...",
  "summary": {
    "total_tables": number,
    "total_foreign_keys": number,
    "orphaned_tables": number,
    "tables_with_orphaned_records": number,
    "empty_tables": number,
    "total_orphaned_records": number
  },
  "orphaned_tables": ["table_name", ...],
  "orphaned_records": [
    {
      "table_name": "opportunities",
      "foreign_key_column": "principal_id",
      "references_table": "principals",
      "orphaned_count": number,
      "orphan_type": "soft_deleted_parent | missing_parent"
    }
  ],
  "empty_tables": ["table_name", ...],
  "table_row_counts": { "table_name": number, ... }
}
```

**How it works:**

1. Connects directly to PostgreSQL using `pg.Client` with `DATABASE_URL`
2. Queries `information_schema.tables` to discover all base tables in the `public` schema
3. Queries `information_schema.columns` to detect which tables have `deleted_at` columns
4. Queries `information_schema.table_constraints` and related views to extract all foreign key relationships
5. For each foreign key, runs 2 checks:
   - **Soft-deleted parents:** Active child records pointing to parents where `parent.deleted_at IS NOT NULL` (only checked when parent table has `deleted_at` column)
   - **Missing parents:** FK values that do not exist in the parent table
6. Uses `client.escapeIdentifier()` for safe SQL identifier quoting (prevents SQL injection)
7. Applies conditional soft-delete filtering: only filters by `deleted_at IS NULL` on child records when the child table has a `deleted_at` column
8. Outputs JSON report to `docs/architecture/erd-artifacts/orphan-analysis.json`

**Advantages over previous implementation:**

- **Full catalog visibility:** Uses direct `pg.Client` connection instead of Supabase anon key, bypassing RLS restrictions
- **Dynamic table discovery:** Queries `information_schema` for tables and FKs instead of relying on hardcoded lists or regex parsing
- **Accurate FK detection:** Reads actual database constraints instead of parsing migration files
- **Safe SQL generation:** Uses `client.escapeIdentifier()` for all dynamic table/column names
- **Conditional soft-delete:** Only applies `deleted_at IS NULL` filters when the column actually exists

**Usage:**

```bash
# Run the analysis
npm run analyze:orphans

# View results
cat docs/architecture/erd-artifacts/orphan-analysis.json

# View summary only
cat docs/architecture/erd-artifacts/orphan-analysis.json | jq '.summary'

# View orphaned records grouped by type
cat docs/architecture/erd-artifacts/orphan-analysis.json | jq '.orphaned_records | group_by(.orphan_type)'
```

**When to run:**

- After migrations to verify data integrity
- Before major refactoring to identify cleanup tasks
- During database audits
- When investigating data quality issues

**Interpreting results:**

- **Orphaned tables:** May indicate unused tables or missing relationships
- **soft_deleted_parent:** Active records pointing to soft-deleted parents - indicates cascade delete logic is missing
- **missing_parent:** Critical data integrity violation - foreign key constraint should prevent this in most cases
- **Empty tables:** Could indicate unused features or missing seed data

**Example output interpretation:**

```json
{
  "orphaned_tables": ["tags"],
  "orphaned_records": [],
  "empty_tables": ["contacts", "organizations"]
}
```

This indicates:
- `tags` table has no foreign key relationships (may need junction tables)
- No orphaned records detected (good data integrity)
- Development database is empty (needs seed data)
