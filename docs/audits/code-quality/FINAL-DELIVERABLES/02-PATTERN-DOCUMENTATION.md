# Canonical Pattern Documentation

**Generated By:** Agent 21 - Forensic Aggregator
**Date:** 2025-12-21
**Sources:** 20 audit reports (Agents 1-20)
**Purpose:** Single source of truth for architectural patterns

---

## Overview

This document establishes the **canonical patterns** for Crispy CRM development, synthesized from comprehensive code audits. Each pattern includes:
- ‚úÖ **Correct Implementation** - The approved approach
- ‚ùå **Anti-Patterns** - What to avoid
- üìç **Reference Files** - Examples in the codebase
- üîç **Verification** - How to check compliance

---

## 1. Data Provider Pattern

### Principle
**All database access through `unifiedDataProvider.ts` - no direct Supabase imports in components.**

### ‚úÖ Correct Implementation

```typescript
// In component
import { useDataProvider } from 'react-admin';

const MyComponent = () => {
  const dataProvider = useDataProvider();

  const fetchData = async () => {
    const { data } = await dataProvider.getList('contacts', {
      pagination: { page: 1, perPage: 25 },
      sort: { field: 'created_at', order: 'DESC' },
      filter: {}
    });
    return data;
  };
};
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: Direct Supabase import
import { supabase } from '@/lib/supabase';
const { data } = await supabase.from('contacts').select('*');

// WRONG: Bypassing data provider in hooks
const result = await supabaseClient.rpc('my_function');
```

### üìç Reference Files
- `src/atomic-crm/providers/supabase/unifiedDataProvider.ts` (canonical)
- `src/atomic-crm/opportunities/OpportunityList.tsx` (correct usage)

### üîç Verification
```bash
# Should return 0 results outside providers/
grep -rn "from '@/lib/supabase'" src/atomic-crm/ --include="*.tsx" | grep -v providers
```

### Documented Exceptions
| File | Reason |
|------|--------|
| `authProvider.ts:53` | Auth flow requires direct session access |
| `unifiedDataProvider.ts` internal | Provider IS the abstraction layer |

---

## 2. Zod Validation Pattern

### Principle
**Zod validation at API boundary only, with security constraints on all fields.**

### ‚úÖ Correct Implementation

```typescript
// In validation/resource.ts
import { z } from 'zod';

export const resourceSchema = z.strictObject({
  // String fields: ALWAYS have .max()
  name: z.string().min(1).max(255),
  description: z.string().max(5000).optional(),

  // URL fields: .url() + .max()
  website: z.string().url().max(2048).optional(),

  // Numbers: Use coercion for form inputs
  quantity: z.coerce.number().positive().max(1000000),

  // Dates: Use coercion
  due_date: z.coerce.date().optional(),

  // Enums: Allowlist pattern
  status: z.enum(['active', 'inactive', 'pending']),

  // Arrays: Constrain elements
  tags: z.array(z.string().max(100)).max(20).optional(),
});
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: Missing .max() (DoS vulnerability)
name: z.string()

// WRONG: Using z.object() at API boundary
export const schema = z.object({...}); // Use z.strictObject()

// WRONG: Form-level validation
<TextInput validate={required()} /> // Validate at API boundary only

// WRONG: Denylist pattern
status: z.string().refine(s => s !== 'admin') // Use enum allowlist
```

### üìç Reference Files
- `src/atomic-crm/validation/opportunities.ts` (good example)
- `src/atomic-crm/validation/organizations.ts` (has issues with isValidUrl)

### üîç Verification
```bash
# Find unbounded strings
grep -rE "z\.string\(\)" src/atomic-crm/validation/ | grep -v "\.max\|\.min\|\.email\|\.url\|\.uuid"

# Find z.object at API boundary
grep -rE "z\.object\(" src/atomic-crm/validation/
```

### Security Constraints Required

| Field Type | Required Constraints |
|------------|---------------------|
| Text (short) | `.max(255)` |
| Text (long) | `.max(5000)` |
| URL | `.url().max(2048)` |
| Email | `.email().max(320)` |
| Array | `.max(N)` on array + `.max(M)` on elements |
| Number | `.positive()` or `.min(0)`, `.max(N)` |

---

## 3. Module Structure Pattern

### Principle
**Consistent file organization with resource.tsx separation and lazy loading.**

### ‚úÖ Correct Implementation

```
src/atomic-crm/opportunities/
‚îú‚îÄ‚îÄ index.tsx              # Exports + lazy loading + error boundaries
‚îú‚îÄ‚îÄ resource.tsx           # Resource definition for react-admin
‚îú‚îÄ‚îÄ OpportunityList.tsx    # List view component
‚îú‚îÄ‚îÄ OpportunityCreate.tsx  # Create form
‚îú‚îÄ‚îÄ OpportunityEdit.tsx    # Edit form
‚îú‚îÄ‚îÄ OpportunityShow.tsx    # Show view (optional)
‚îú‚îÄ‚îÄ OpportunitySlideOver.tsx # Side panel detail view
‚îî‚îÄ‚îÄ forms/
    ‚îî‚îÄ‚îÄ Inputs.tsx         # Shared form inputs
```

### index.tsx Template

```typescript
import { lazy, Suspense } from 'react';
import { ErrorBoundary } from '@/components/ErrorBoundary';
import { ListSkeleton } from '@/components/ui/list-skeleton';

const OpportunityList = lazy(() => import('./OpportunityList'));
const OpportunityCreate = lazy(() => import('./OpportunityCreate'));
const OpportunityEdit = lazy(() => import('./OpportunityEdit'));

export const OpportunitiesList = () => (
  <ErrorBoundary>
    <Suspense fallback={<ListSkeleton />}>
      <OpportunityList />
    </Suspense>
  </ErrorBoundary>
);

export const OpportunitiesCreate = () => (
  <ErrorBoundary>
    <Suspense fallback={<div>Loading...</div>}>
      <OpportunityCreate />
    </Suspense>
  </ErrorBoundary>
);

// ... similar for Edit
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: Everything in index.tsx (organizations, activities)
export const OrganizationList = () => { /* 200+ lines */ };
export const OrganizationEdit = () => { /* 150+ lines */ };

// WRONG: No lazy loading
import { OpportunityList } from './OpportunityList'; // Not lazy

// WRONG: No error boundary
export const List = () => <OpportunityList />; // Missing ErrorBoundary
```

### üìç Reference Files
- `src/atomic-crm/opportunities/` (canonical structure)
- `src/atomic-crm/contacts/` (good, missing forms/)

### üîç Verification
```bash
# Check for resource.tsx
ls src/atomic-crm/*/resource.tsx

# Check for lazy loading
grep -rn "lazy(" src/atomic-crm/*/index.tsx
```

---

## 4. Component Declaration Pattern

### Principle
**Arrow function components for consistency, with React.memo for performance-critical components.**

### ‚úÖ Correct Implementation

```typescript
// Standard component
const ContactCard = ({ contact }: ContactCardProps) => {
  return (
    <Card>
      <CardHeader>{contact.name}</CardHeader>
    </Card>
  );
};

// Performance-critical (badges, list items)
const ContactBadge = React.memo(({ status }: { status: string }) => {
  return <Badge variant={status}>{status}</Badge>;
});

// With display name for debugging
ContactBadge.displayName = 'ContactBadge';
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: Function declarations (inconsistent)
function TaskList() {
  return <List>...</List>;
}

// WRONG: Nested component definitions
const ParentComponent = () => {
  // This recreates on every render!
  const ChildComponent = () => <div>...</div>;
  return <ChildComponent />;
};

// WRONG: Badge without memo (in list context)
const StatusBadge = ({ status }) => <Badge>{status}</Badge>;
```

### üìç Reference Files
- `src/atomic-crm/opportunities/OpportunityList.tsx` (arrow functions)
- `src/atomic-crm/tasks/TaskList.tsx` (needs conversion)

### üîç Verification
```bash
# Find function declarations
grep -rn "^function\|^export function" src/atomic-crm/ --include="*.tsx"

# Find nested components
grep -rn "const.*=.*=>.*{" src/ -A3 | grep "const.*=.*=>"
```

---

## 5. Form State Pattern

### Principle
**Schema-derived defaults, onSubmit validation mode, useWatch for subscriptions.**

### ‚úÖ Correct Implementation

```typescript
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { opportunitySchema } from '@/validation/opportunities';

const OpportunityCreate = () => {
  // Defaults from schema
  const defaultValues = opportunitySchema.partial().parse({});

  const { control, handleSubmit, formState: { isSubmitting } } = useForm({
    resolver: zodResolver(opportunitySchema),
    defaultValues,
    mode: 'onSubmit', // NOT onChange
  });

  // Isolated field subscriptions
  const status = useWatch({ control, name: 'status' });

  return (
    <Form onSubmit={handleSubmit(onSubmit)}>
      <TextInput source="name" />
      <Button type="submit" disabled={isSubmitting}>Save</Button>
    </Form>
  );
};
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: Hardcoded defaults
const defaultValues = {
  status: 'new_lead',
  priority: 'medium',
};

// WRONG: onChange mode (re-render storm)
const form = useForm({
  mode: 'onChange', // Validates on every keystroke
});

// WRONG: watch() instead of useWatch (causes parent re-renders)
const { watch } = useForm();
const status = watch('status'); // Re-renders entire form
```

### üìç Reference Files
- `src/atomic-crm/opportunities/OpportunityCreate.tsx` (schema defaults)
- `src/atomic-crm/contacts/ContactCreate.tsx` (good pattern)

### üîç Verification
```bash
# Find hardcoded defaults
grep -rn "defaultValues.*{" src/atomic-crm/ --include="*.tsx" | grep -v "schema"

# Find watch() usage
grep -rn "\.watch\(" src/atomic-crm/ --include="*.tsx"
```

---

## 6. Cache Invalidation Pattern

### Principle
**Invalidate related queries after mutations to prevent stale data.**

### ‚úÖ Correct Implementation

```typescript
import { useQueryClient } from '@tanstack/react-query';
import { useNotify, useRefresh } from 'react-admin';

const OpportunityEdit = () => {
  const queryClient = useQueryClient();
  const notify = useNotify();
  const refresh = useRefresh();

  const onSuccess = () => {
    // Invalidate related queries
    queryClient.invalidateQueries({ queryKey: ['opportunities'] });
    queryClient.invalidateQueries({ queryKey: ['activities'] });

    notify('Opportunity updated');
    refresh();
  };

  return (
    <Edit mutationOptions={{ onSuccess }}>
      ...
    </Edit>
  );
};
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: No cache invalidation
const onSuccess = () => {
  notify('Saved!');
  // User sees stale data until page refresh
};

// WRONG: Only invalidating current resource
queryClient.invalidateQueries({ queryKey: ['opportunities'] });
// Misses related activities, tasks, etc.
```

### üìç Reference Files
- `src/atomic-crm/opportunities/OpportunityEdit.tsx` (correct pattern)
- `src/atomic-crm/contacts/ContactEdit.tsx` (missing pattern)

### üîç Verification
```bash
# Check for invalidateQueries usage
grep -rn "invalidateQueries" src/atomic-crm/*Edit.tsx
```

---

## 7. Context Value Pattern

### Principle
**Memoize context provider values to prevent unnecessary re-renders.**

### ‚úÖ Correct Implementation

```typescript
const ConfigurationProvider = ({ children }) => {
  const [config, setConfig] = useState(defaultConfig);
  const [isLoading, setIsLoading] = useState(true);

  // Memoize the context value
  const contextValue = useMemo(
    () => ({ config, setConfig, isLoading }),
    [config, isLoading] // setConfig is stable
  );

  return (
    <ConfigurationContext.Provider value={contextValue}>
      {children}
    </ConfigurationContext.Provider>
  );
};
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: New object every render
<ConfigContext.Provider value={{ config, setConfig, isLoading }}>
  {children}
</ConfigContext.Provider>

// WRONG: Missing dependencies in useMemo
const value = useMemo(() => ({ config, setConfig }), []); // Stale config!
```

### üìç Reference Files
- `src/components/sidebar/sidebar.utils.ts` (correct useMemo)
- `src/root/ConfigurationContext.tsx` (needs fix)

### üîç Verification
```bash
# Find Context Providers without useMemo
grep -rn "Provider value={{" src/ --include="*.tsx"
```

---

## 8. Error Handling Pattern

### Principle
**Fail-fast: Let errors throw, provide context in catch blocks.**

### ‚úÖ Correct Implementation

```typescript
// At component level: ErrorBoundary
<ErrorBoundary fallback={<ErrorFallback />}>
  <MyComponent />
</ErrorBoundary>

// In async operations: Catch and provide context
try {
  await dataProvider.update('opportunities', { id, data });
} catch (error) {
  console.error('Failed to update opportunity:', error);
  notify(`Update failed: ${error.message}`, { type: 'error' });
  throw error; // Re-throw for error boundary if needed
}

// Promise.allSettled: Always check results
const results = await Promise.allSettled(operations);
const failures = results.filter(r => r.status === 'rejected');
if (failures.length > 0) {
  notify(`${failures.length} operations failed`, { type: 'error' });
}
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: Empty catch
try { await save(); } catch {} // Silent failure

// WRONG: Ignored error variable
catch (_error) {
  notify('Something went wrong'); // No context
}

// WRONG: Retry logic (pre-launch)
for (let i = 0; i < 3; i++) {
  try { await save(); break; } catch { continue; }
}

// WRONG: Promise.allSettled without result check
await Promise.allSettled(updates);
refetch(); // Did any fail? Unknown!
```

### üìç Reference Files
- `src/components/ErrorBoundary.tsx` (boundary pattern)
- `src/atomic-crm/opportunities/OpportunityEdit.tsx` (good error handling)

### üîç Verification
```bash
# Find empty catch blocks
grep -rn "catch.*{}" src/ --include="*.tsx"

# Find ignored errors
grep -rn "catch.*_error\|catch.*_err" src/ --include="*.tsx"
```

---

## 9. Import Layer Pattern

### Principle
**Strict layering: Feature ‚Üí Admin ‚Üí Base ‚Üí Libraries**

```
Feature Layer (src/atomic-crm/*)
    ‚Üì can import
Admin Layer (src/components/admin/*)
    ‚Üì can import
Base Layer (src/components/ui/*, src/lib/*)
    ‚Üì can import
Libraries (react, react-admin, etc.)
```

### ‚úÖ Correct Implementation

```typescript
// In src/atomic-crm/contacts/ContactList.tsx (Feature layer)
import { TextInput } from '@/components/admin/text-input'; // ‚úÖ Admin layer
import { Badge } from '@/components/ui/badge'; // ‚úÖ Base layer
import { cn } from '@/lib/utils'; // ‚úÖ Base layer
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: Admin importing from Feature
// In src/components/admin/file-input.tsx
import { fileSchema } from '@/atomic-crm/validation/files'; // ‚ùå Layer violation

// WRONG: Base importing from Admin
// In src/components/ui/custom-button.tsx
import { useDataProvider } from '@/components/admin/hooks'; // ‚ùå Layer violation
```

### üìç Reference Files
- `src/components/admin/` (should not import from atomic-crm/)

### üîç Verification
```bash
# Find Admin ‚Üí Feature violations
grep -rn "from.*atomic-crm" src/components/admin/ --include="*.tsx"

# Find Base ‚Üí Admin violations
grep -rn "from.*components/admin" src/components/ui/ --include="*.tsx"
```

---

## 10. Accessibility Pattern

### Principle
**WCAG 2.1 AA compliance with ARIA attributes on form controls.**

### ‚úÖ Correct Implementation

```typescript
const FormField = ({ error, id, children }) => {
  const errorId = `${id}-error`;

  return (
    <div>
      <label htmlFor={id}>Name</label>
      <input
        id={id}
        aria-invalid={!!error}
        aria-describedby={error ? errorId : undefined}
      />
      {error && (
        <span id={errorId} role="alert">
          {error.message}
        </span>
      )}
    </div>
  );
};

// Touch targets: 44x44px minimum
<Button className="h-11 w-11">
  <Icon />
</Button>
```

### ‚ùå Anti-Patterns

```typescript
// WRONG: No aria-invalid on error
<input className={error ? 'border-red-500' : ''} />

// WRONG: Error not linked to input
<input /><span className="error">{error}</span>

// WRONG: Small touch targets
<Button className="h-6 w-6">X</Button> // 24px is too small
```

### üìç Reference Files
- `src/components/admin/text-input.tsx` (should have ARIA)
- Design system: Use `h-11 w-11` for interactive elements

### üîç Verification
```bash
# Check for aria-invalid usage
grep -rn "aria-invalid" src/components/admin/ --include="*.tsx"

# Check touch target sizes
grep -rn "h-6\|h-8\|w-6\|w-8" src/components/admin/ --include="*.tsx"
```

---

## Pattern Compliance Matrix

| Pattern | Compliance | Gap |
|---------|------------|-----|
| Data Provider | 95% | 1 documented exception |
| Zod Validation | 70% | Missing .max() on activities |
| Module Structure | 60% | 2 modules inline, 4 missing forms/ |
| Component Style | 72% | 11 files use function declarations |
| Form State | 85% | Some watch() usage |
| Cache Invalidation | 25% | 3 Edit views missing |
| Context Values | 50% | 3 contexts unmemoized |
| Error Handling | 60% | 5 unhandled Promise chains |
| Import Layers | 68% | 8 layer violations |
| Accessibility | 50% | ARIA attributes incomplete |

---

## Enforcement Strategy

### ESLint Rules to Add

```javascript
// .eslintrc.js additions
{
  rules: {
    // Prevent nested components
    'react/no-unstable-nested-components': 'error',

    // Enforce arrow functions
    'react/function-component-definition': [
      'error',
      { namedComponents: 'arrow-function' }
    ],

    // Prevent direct Supabase imports
    'no-restricted-imports': [
      'error',
      {
        patterns: [
          {
            group: ['@supabase/supabase-js'],
            message: 'Use unifiedDataProvider instead'
          }
        ]
      }
    ]
  }
}
```

### Pre-Commit Hooks

```bash
# In .husky/pre-commit
npm run lint:patterns
npm run typecheck
```

### CI Checks

```yaml
# In .github/workflows/ci.yml
- name: Pattern Compliance
  run: |
    npm run lint:patterns
    npm run check:layer-violations
    npm run check:zod-constraints
```

---

*Canonical patterns extracted from 20 audit reports*
*Reference implementation: src/atomic-crm/opportunities/*
