# Prioritized Fix List

**Generated By:** Agent 21 - Forensic Aggregator
**Date:** 2025-12-21
**Sources:** 20 audit reports (14 Tier 1 + 3 Tier 2 + 3 Tier 3)
**Deduplication:** 47 unique findings from 120+ raw issues

---

## Executive Summary

| Priority | Count | Category Breakdown |
|----------|-------|-------------------|
| **P0 - Critical** | 8 | Security: 3, Performance: 3, Data Integrity: 2 |
| **P1 - High** | 12 | Architecture: 5, Performance: 4, UX: 3 |
| **P2 - Medium** | 15 | Quality: 8, UX: 4, Consistency: 3 |
| **P3 - Low** | 12 | Polish: 7, Style: 5 |
| **Total** | **47** | |

**Estimated Total Effort:** 45-55 hours
**Recommended Sprint Allocation:** 2 sprints (P0+P1 in Sprint 1, P2 in Sprint 2)

---

## P0 - Critical (Must Fix Before Launch)

### P0-1: Nested Component Definitions (Performance)

**Found By:** Agents 6, 9, 14 (Tier 1), Agent 16 (Tier 2)
**Impact:** Components remount on every parent render, losing state and causing performance degradation

| File | Line | Component | Parent |
|------|------|-----------|--------|
| `ContactEdit.tsx` | 89 | `ContactEditForm` | `ContactEdit` |
| `ContactList.tsx` | 156 | `ContactFilters` | `ContactList` |
| `OpportunityCreate.tsx` | 112 | `OpportunityForm` | `OpportunityCreate` |
| `OpportunityEdit.tsx` | 98 | `EditFormContent` | `OpportunityEdit` |
| `OrganizationEdit.tsx` | 67 | `OrgEditForm` | `OrganizationEdit` |
| `TaskCreate.tsx` | 45 | `TaskFormContent` | `TaskCreate` |
| `ActivityCreate.tsx` | 78 | `ActivityFormContent` | `ActivityCreate` |
| `SalesCreate.tsx` | 52 | `SalesFormContent` | `SalesCreate` |
| `SalesEdit.tsx` | 61 | `SalesEditForm` | `SalesEdit` |
| `Dashboard.tsx` | 134 | `DashboardWidgets` | `Dashboard` |
| `ReportsPage.tsx` | 89 | `ReportFilters` | `ReportsPage` |
| `Settings.tsx` | 56 | `SettingsTabs` | `Settings` |
| + 18 more | | | |

**Fix:** Extract to module-level or separate files
**Effort:** L (4-6 hours) - 30+ components across 15+ files
**Dependencies:** None

```typescript
// BEFORE (inside parent component)
const ParentComponent = () => {
  const NestedComponent = () => <div>...</div>; // ❌ Recreated every render
  return <NestedComponent />;
};

// AFTER (module level)
const ExtractedComponent = () => <div>...</div>; // ✅ Stable reference
const ParentComponent = () => <ExtractedComponent />;
```

---

### P0-2: Missing .max() on Activity Schema Fields (Security - DoS)

**Found By:** Agent 11 (Tier 1 - missed), Agent 18 (Tier 3 - found), Agent 19 (Tier 3 - confirmed)
**Impact:** Unbounded strings allow DoS attacks via memory exhaustion

| File | Line | Field | Current | Required |
|------|------|-------|---------|----------|
| `validation/activities.ts` | 75 | `description` | `z.string()` | `.max(5000)` |
| `validation/activities.ts` | 89 | `follow_up_notes` | `z.string()` | `.max(5000)` |
| `validation/activities.ts` | 102 | `outcome` | `z.string()` | `.max(2000)` |
| `validation/activities.ts` | 108 | `tags` (array elements) | `z.string()` | `.max(100)` |
| `validation/notes.ts` | 16 | `src` (URL) | `z.string().url()` | `.max(2048)` |
| `validation/organizations.ts` | 50 | `isValidUrl` helper | `z.string().url()` | `.max(2048)` |

**Fix:** Add `.max()` constraints to all unbounded strings
**Effort:** S (30 min)
**Dependencies:** None

```typescript
// BEFORE
description: z.string().optional()

// AFTER
description: z.string().max(5000).optional()
```

---

### P0-3: Soft-Delete Cascade Function Not Called (Data Integrity)

**Found By:** Agent 1 (Tier 1), Agent 19 (Tier 3)
**Impact:** Deleting opportunities leaves orphan activities, tasks, and notes active

| File | Line | Issue |
|------|------|-------|
| `unifiedDataProvider.ts` | 970 | `delete()` method sets `deleted_at` but doesn't call `archive_opportunity_with_relations()` RPC |

**Fix:** Call cascade RPC function from data provider delete method
**Effort:** M (1-2 hours) - Requires testing cascade behavior
**Dependencies:** Verify RPC function exists in `20251028213032_add_soft_delete_cascade_functions.sql`

```typescript
// In unifiedDataProvider.ts delete method for opportunities
const result = await supabase.rpc('archive_opportunity_with_relations', {
  opportunity_id: params.id
});
```

---

### P0-4: Activity Trigger References Deprecated Table (Data Integrity)

**Found By:** Agent 19 (Tier 3)
**Impact:** Activity INSERT may fail with "table does not exist" error

| File | Line | Issue |
|------|------|-------|
| `migrations/20251029022918_add_activity_contact_validation.sql` | 12 | References `contact_organizations` table |

**Fix:** Verify migration `20251102212250` properly replaces the function
**Effort:** S (30 min) - Verify migration chain
**Dependencies:** Run `npx supabase db reset` to test

---

### P0-5: Unhandled Promise Chains (Error Handling)

**Found By:** Agent 12 (Tier 1 - missed), Agent 18 (Tier 3 - found)
**Impact:** Silent failures - users see success when operations fail

| File | Line | Pattern | Issue |
|------|------|---------|-------|
| `NotificationDropdown.tsx` | 78-88 | `Promise.allSettled()` | Results never validated |
| `TransformService.ts` | 52 | `Promise.all()` | No try-catch, single failure crashes all |
| `TransformService.ts` | 66 | `Promise.all()` | Same pattern |
| `TransformService.ts` | 80 | `Promise.all()` | Same pattern |
| `useContactImport.tsx` | 334 | `Promise.all()` | No error handling |

**Fix:** Validate `Promise.allSettled` results, wrap `Promise.all` in try-catch
**Effort:** M (1-2 hours)
**Dependencies:** None

```typescript
// BEFORE
await Promise.allSettled(updates);
refetch(); // No check if updates succeeded

// AFTER
const results = await Promise.allSettled(updates);
const failures = results.filter(r => r.status === 'rejected');
if (failures.length > 0) {
  notify(`${failures.length} updates failed`, { type: 'error' });
}
refetch();
```

---

### P0-6: ConfigurationContext Value Not Memoized (Performance)

**Found By:** Agent 9 (Tier 1), Agent 16 (Tier 2)
**Impact:** 14+ components re-render on every parent render

| File | Line | Issue |
|------|------|-------|
| `ConfigurationContext.tsx` | 67-84 | `value={{...}}` creates new object every render |
| `TutorialProvider.tsx` | 256-264 | Same pattern |
| `CurrentSaleContext.tsx` | 69 | Same pattern |

**Fix:** Wrap context values in `useMemo`
**Effort:** S (15 min per context = 45 min total)
**Dependencies:** None

```typescript
// BEFORE
<ConfigContext.Provider value={{ config, setConfig, isLoading }}>

// AFTER
const contextValue = useMemo(() => ({ config, setConfig, isLoading }), [config, isLoading]);
<ConfigContext.Provider value={contextValue}>
```

---

### P0-7: Auth Provider Direct Supabase Access (Security)

**Found By:** Agent 1 (Tier 1 - noted as exception), Agent 18 (Tier 3 - flagged as violation)
**Impact:** Security-critical auth flow bypasses data provider validation

| File | Line | Call |
|------|------|------|
| `authProvider.ts` | 53 | `supabase.auth.getSession()` |

**Fix:** Document as intentional exception with security justification, OR route through data provider
**Effort:** S (30 min) - Add JSDoc explaining why this is necessary
**Dependencies:** Architecture decision needed

---

### P0-8: No FK Constraint on principal_organization_id (Data Integrity)

**Found By:** Agent 19 (Tier 3)
**Impact:** Can create opportunities with invalid/deleted principal references

| Table | Column | Issue |
|-------|--------|-------|
| `opportunities` | `principal_organization_id` | No foreign key constraint |

**Fix:** Add FK constraint via migration
**Effort:** M (1 hour) - Migration + testing
**Dependencies:** Verify no orphan records exist first

```sql
ALTER TABLE opportunities
ADD CONSTRAINT fk_opportunities_principal
FOREIGN KEY (principal_organization_id)
REFERENCES organizations(id);
```

---

## P1 - High (Fix This Sprint)

### P1-1: 284+ `any` Types in Production Code (Type Safety)

**Found By:** Agent 15 (Tier 2 - reported ~95), Agent 18 (Tier 3 - found 284+)
**Impact:** Type safety gaps, runtime errors possible

| Pattern | Production Count | Test Count |
|---------|-----------------|------------|
| `: any` | 171 | 238 |
| `as any` | 35 | 298 |
| `any[]` | 18 | - |
| `Record<string, any>` | 45 | - |
| `<any>` | 10 | - |
| `Promise<any>` | 5 | - |
| **Total** | **284** | **536+** |

**High-Density Files:**
- `boolean-input.tsx` (4+)
- `file-input.tsx` (6+)
- `unifiedDataProvider.ts` (5+)
- `toggle-filter-button.tsx` (6)
- Report generation files (10+)

**Fix:** Replace with proper types incrementally
**Effort:** XL (8-12 hours) - Many files, requires understanding each context
**Dependencies:** None, can be done incrementally

---

### P1-2: Missing Cache Invalidation in Edit Views (UX)

**Found By:** Agent 3 (Tier 1), Agent 16 (Tier 2)
**Impact:** Stale data after edits until page refresh

| File | Pattern Missing |
|------|-----------------|
| `ContactEdit.tsx` | `useQueryClient` + `invalidateQueries` |
| `OrganizationEdit.tsx` | Same |
| `TaskEdit.tsx` | Same |

**Fix:** Add cache invalidation on mutation success
**Effort:** S (30 min) - 3 files, simple pattern
**Dependencies:** None

```typescript
const queryClient = useQueryClient();
// In onSuccess callback:
queryClient.invalidateQueries({ queryKey: ['contacts'] });
```

---

### P1-3: 89% of Badge Components Missing React.memo (Performance)

**Found By:** Agent 6 (Tier 1), Agent 16 (Tier 2)
**Impact:** Lists with 25-100 rows re-render all badges on any change

| Component | File | Memoized? |
|-----------|------|-----------|
| ContactStatusBadge | ContactBadges.tsx | ❌ |
| RoleBadge | ContactBadges.tsx | ❌ |
| InfluenceBadge | ContactBadges.tsx | ❌ |
| OrganizationTypeBadge | OrganizationBadges.tsx | ❌ |
| PriorityBadge | OrganizationBadges.tsx | ❌ |
| SampleStatusBadge | SampleStatusBadge.tsx | ❌ |
| StageBadgeWithHealth | StageBadgeWithHealth.tsx | ❌ |
| Avatar | Avatar.tsx | ❌ |
| NextTaskBadge | NextTaskBadge.tsx | ✅ |
| CompletionCheckbox | TaskList.tsx | ✅ |

**Fix:** Wrap all badge exports in `React.memo()`
**Effort:** S (30 min) - 8 components, simple pattern
**Dependencies:** None

---

### P1-4: Admin → Feature Layer Violations (Architecture)

**Found By:** Agent 13 (Tier 1 - found 6), Agent 18 (Tier 3 - found 8 with dynamic imports)
**Impact:** Breaks layered architecture, creates circular dependency risk

| File | Imports From |
|------|-------------|
| `src/components/admin/file-input.tsx` | `src/atomic-crm/validation/` |
| `src/components/admin/boolean-input.tsx` | `src/atomic-crm/types/` |
| `src/components/admin/linked-record-input.tsx` | `src/atomic-crm/contacts/` |
| `src/components/admin/select-input.tsx` | `src/atomic-crm/constants/` |
| + 4 more via dynamic imports | |

**Fix:** Move shared types/constants to `src/shared/` or `src/types/`
**Effort:** M (2-3 hours) - Restructure + update imports
**Dependencies:** None

---

### P1-5: Slide-Over Shows Stale Data After Mutations (UX)

**Found By:** Agent 19 (Tier 3)
**Impact:** User sees outdated information after saving

| File | Issue |
|------|-------|
| `ResourceSlideOver.tsx` | No auto-refetch after mutations |

**Fix:** Add `useRefresh()` call or cache invalidation after mutations
**Effort:** S (30 min)
**Dependencies:** None

---

### P1-6: Missing Filtered Empty State UI (UX)

**Found By:** Agent 19 (Tier 3)
**Impact:** Users see blank table, unclear if loading/error/no results

| View | Has Empty State? |
|------|------------------|
| All lists with filters applied | ❌ Blank datagrid |

**Fix:** Integrate `ListNoResults.tsx` component (already exists, unused)
**Effort:** M (1-2 hours) - Apply to all list views
**Dependencies:** None

---

### P1-7: Response Schemas Use z.object() Instead of z.strictObject() (Security)

**Found By:** Agent 11 (Tier 1 - noted), Agent 18 (Tier 3 - flagged)
**Impact:** Mass assignment vulnerability at API boundary

| File | Line | Schema |
|------|------|--------|
| `validation/rpc.ts` | 90 | `checkAuthorizationResponseSchema` |
| `validation/rpc.ts` | 132 | `checkAuthorizationBatchResponseSchema` |

**Fix:** Change to `z.strictObject()` or document exception
**Effort:** S (15 min)
**Dependencies:** Verify no extra fields expected from API

---

### P1-8: Ignored Error Variables in Catch Blocks (Error Handling)

**Found By:** Agent 18 (Tier 3)
**Impact:** Debugging impossible for user-facing errors

| File | Line | Pattern |
|------|------|---------|
| `ActivityNoteForm.tsx` | 113 | `catch (_error)` |
| `ActivityNoteForm.tsx` | 135 | `catch (_error)` |
| `useBulkActionsState.ts` | 85-92 | `catch (_error)` |
| `useExportOpportunities.ts` | 102-103 | `catch (_error)` |

**Fix:** Log error details or include in user message
**Effort:** S (30 min)
**Dependencies:** None

---

### P1-9: Organization Deletion Orphans Contacts (Data Integrity)

**Found By:** Agent 19 (Tier 3)
**Impact:** Contacts with NULL org_id break RLS and summary views

| Current Behavior | Issue |
|------------------|-------|
| `ON DELETE SET NULL` | Orphaned contacts remain |

**Fix:** Change to soft-delete cascade via trigger
**Effort:** M (1-2 hours) - Migration + testing
**Dependencies:** P0-3 (cascade function)

---

### P1-10: Parent Org Soft-Delete Allows Orphan Branches (Data Integrity)

**Found By:** Agent 19 (Tier 3)
**Impact:** Trigger only fires on hard DELETE, not soft-delete

| File | Issue |
|------|-------|
| `migrations/20251110142650_add_organization_deletion_protection.sql` | Trigger doesn't check soft-delete |

**Fix:** Modify trigger to also fire on UPDATE where deleted_at becomes non-null
**Effort:** M (1 hour)
**Dependencies:** None

---

### P1-11: No Optimistic Locking (Concurrent Edit Conflict)

**Found By:** Agent 19 (Tier 3)
**Impact:** Last write wins - user changes silently overwritten

**Fix:** Add `version` column and check in update handler
**Effort:** L (3-4 hours) - Schema change + provider logic + UI feedback
**Dependencies:** Migration needed

---

### P1-12: Data Provider Internal Supabase Bypasses (Architecture)

**Found By:** Agent 18 (Tier 3)
**Impact:** "Single entry point" abstraction is pass-through, not enforced

| File | Line | Call |
|------|------|------|
| `unifiedDataProvider.ts` | 180 | `supabase.auth.getSession()` |
| `unifiedDataProvider.ts` | 490 | `supabase.auth.getSession()` |
| `unifiedDataProvider.ts` | 1178 | `supabase.rpc()` |
| `unifiedDataProvider.ts` | 1219-1282 | `supabase.storage.*` |
| `unifiedDataProvider.ts` | 1327 | `supabase.functions.invoke()` |
| `unifiedDataProvider.ts` | 1366 | `supabase.rpc()` |

**Fix:** Document as architectural decision (provider IS the abstraction layer)
**Effort:** S (30 min) - Add JSDoc documentation
**Dependencies:** None

---

## P2 - Medium (Fix Next Sprint)

| ID | Issue | File(s) | Effort |
|----|-------|---------|--------|
| P2-1 | CloseOpportunityModal lacks dirty state warning | CloseOpportunityModal.tsx | S |
| P2-2 | Whitespace-only strings accepted in org/task names | validation/*.ts | S |
| P2-3 | No AbortController for request cancellation | hooks/*.ts | M |
| P2-4 | No explicit timeouts on Edge Functions | supabase/functions/ | S |
| P2-5 | activity.duration_minutes has no upper bound | validation/activities.ts | S |
| P2-6 | Bare z.string() in contact union types | validation/contacts.ts:272-346 | M |
| P2-7 | Missing noUncheckedIndexedAccess in tsconfig | tsconfig.json | M |
| P2-8 | Silent JSON parse errors in data provider | unifiedDataProvider.ts:1498,1534 | S |
| P2-9 | Function declarations instead of arrow functions | 11 files | M |
| P2-10 | Missing resource.tsx in organizations/activities | 2 modules | M |
| P2-11 | Missing forms/ directories | 4 modules | M |
| P2-12 | FIXME comment about TypeScript version | record-field.tsx:80 | S |
| P2-13 | Activities/Sales list missing create action | list views | S |
| P2-14 | No character count in text fields | form components | M |
| P2-15 | Unused date-fns/locale imports | various | S |

---

## P3 - Low (Polish / When Touching Files)

| ID | Issue | File(s) | Effort |
|----|-------|---------|--------|
| P3-1 | Multiple modals can stack (no stacking guard) | modal components | S |
| P3-2 | Checkbox filter rapid clicks cause N+1 fetches | filter components | S |
| P3-3 | Named export consistency (2 modules missing) | organizations, activities | S |
| P3-4 | Test file any types (536+ instances) | __tests__/ | XL |
| P3-5 | Storybook demo components only | src/stories/ | - |
| P3-6 | Remove unused npm dependencies | package.json | S |
| P3-7 | Delete orphan UI components | src/components/ui/ | S |
| P3-8 | Remove unused exports from ErrorBoundary | ErrorBoundary.tsx | S |
| P3-9 | Remove PlaybookCategoryInput alias | SegmentComboboxInput.tsx | S |
| P3-10 | Remove simple-show-layout.tsx | admin/ | S |
| P3-11 | Import path consistency (some missing @/ alias) | various | S |
| P3-12 | Re-export consistency in index files | various | S |

---

## Sprint Planning

### Sprint 1: Critical + High Priority (Week 1-2)

| Day | Tasks | Hours |
|-----|-------|-------|
| 1 | P0-2 (Zod .max), P0-6 (Context memo), P0-7 (Auth doc) | 2 |
| 2 | P0-4 (Trigger verify), P0-8 (FK constraint) | 2 |
| 3 | P0-3 (Cascade fix), P0-5 (Promise handling) | 3 |
| 4-5 | P0-1 (Nested components - batch 1) | 4 |
| 6 | P1-2 (Cache invalidation), P1-3 (React.memo), P1-5 (Slide-over) | 2 |
| 7 | P1-6 (Empty states), P1-7 (strictObject), P1-8 (Error vars) | 2 |
| 8-9 | P1-1 (any types - high priority files) | 4 |
| 10 | P1-4 (Layer violations), P1-12 (Document bypasses) | 3 |

**Sprint 1 Total:** ~22 hours

### Sprint 2: Medium Priority (Week 3-4)

- P0-1 completion (remaining nested components)
- P1-1 completion (remaining any types)
- P1-9, P1-10, P1-11 (Data integrity fixes)
- All P2 items
- Quick P3 wins (dead code removal)

**Sprint 2 Total:** ~25 hours

---

## Fix Order Dependencies

```
P0-3 (Cascade function)
  └── P1-9 (Org deletion cascade)

P0-8 (FK constraint)
  └── Verify no orphan records first

P1-11 (Optimistic locking)
  └── Requires schema migration first

P2-7 (noUncheckedIndexedAccess)
  └── Will surface many new type errors - do after P1-1
```

---

## Quick Wins (< 30 min each)

1. P0-6: Wrap 3 context values in useMemo
2. P0-2: Add .max() to 6 Zod fields
3. P1-2: Add cache invalidation to 3 Edit views
4. P1-3: Add React.memo to 8 badge components
5. P1-7: Change 2 schemas to strictObject
6. P3-6: `npm uninstall jsonwebtoken @types/faker`
7. P3-7: Delete 4 orphan UI component files

**Total Quick Wins:** 7 items, ~3 hours, high impact

---

## Verification Checklist

After fixes, verify with:

```bash
# TypeScript strictness
grep -rE ": any|as any|any\[\]" src/ --include="*.ts" --include="*.tsx" | wc -l

# Zod constraints
grep -rE "z\.string\(\)" src/atomic-crm/validation/ | grep -v "\.max"

# Nested components
grep -rn "const.*=.*=>.*{" src/ | grep -A5 "function\|const.*Component"

# Promise handling
grep -rn "Promise\.allSettled\|Promise\.all" src/ --include="*.tsx"

# React.memo usage
grep -rn "React\.memo" src/atomic-crm/ | wc -l
```

---

*Report synthesized from 20 audit reports*
*47 unique findings from 120+ raw issues*
*Conflicts resolved using Tier 3 authority*
