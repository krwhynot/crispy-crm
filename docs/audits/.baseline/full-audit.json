{
  "lastAudit": "2026-01-25",
  "lastAuditTime": "12:13",
  "mode": "full",
  "duration_minutes": 27,
  "totals": {
    "critical": 39,
    "high": 113,
    "medium": 88,
    "total": 240
  },
  "by_layer": {
    "L1_database": {
      "critical": 14,
      "high": 24,
      "medium": 9,
      "status": "CRITICAL",
      "primary_concerns": "RLS policies (96 USING(true)), soft-delete gaps, missing indexes, stage/priority defaults"
    },
    "L2_domain": {
      "critical": 0,
      "high": 30,
      "medium": 28,
      "status": "WARN",
      "primary_concerns": "Type assertions in tests, interface drift risk, validation naming"
    },
    "L3_provider": {
      "critical": 2,
      "high": 14,
      "medium": 3,
      "status": "WARN",
      "primary_concerns": "Direct Supabase import in timelineHandler, incomplete junction handlers"
    },
    "L4_ui_foundation": {
      "critical": 4,
      "high": 8,
      "medium": 12,
      "status": "WARN",
      "primary_concerns": "Missing form-primitives.tsx, small touch targets, icon accessibility"
    },
    "L5_features": {
      "critical": 19,
      "high": 37,
      "medium": 36,
      "status": "CRITICAL",
      "primary_concerns": "Cache invalidation gaps, N+1 queries, incomplete features, business rule enforcement"
    }
  },
  "by_category": {
    "security": {
      "critical": 4,
      "high": 18,
      "medium": 8,
      "status": "CRITICAL",
      "note": "4 RLS USING(true) holes in task_id_mapping, audit_trail, products, tags tables"
    },
    "data-integrity": {
      "critical": 6,
      "high": 8,
      "medium": 5,
      "status": "CRITICAL",
      "note": "96 USING(true) policies, Strangler Fig complete (13 handlers), hard DELETE statements"
    },
    "error-handling": {
      "critical": 0,
      "high": 2,
      "medium": 3,
      "status": "OK",
      "note": "Both HIGH findings are compliant patterns (fire-and-forget storage cleanup), 100% withErrorLogging coverage"
    },
    "db-hardening": {
      "critical": 4,
      "high": 8,
      "medium": 6,
      "status": "CRITICAL",
      "note": "product_distributors missing soft-delete, missing FK indexes, nullable company_id breaks isolation"
    },
    "stale-state": {
      "critical": 2,
      "high": 5,
      "medium": 4,
      "status": "HIGH",
      "note": "useSalesUpdate/updatePassword missing cache invalidation, hardcoded query keys"
    },
    "workflow-gaps": {
      "critical": 4,
      "high": 5,
      "medium": 3,
      "status": "CRITICAL",
      "note": "Stage transitions app-only, customer_organization_id nullable, win/loss validation gaps, priority silently defaults"
    },
    "architecture": {
      "critical": 7,
      "high": 12,
      "medium": 4,
      "status": "HIGH",
      "note": "7 manual interfaces (type drift), unverified .strict() coverage, timelineHandler Supabase import"
    },
    "typescript": {
      "critical": 0,
      "high": 30,
      "medium": 28,
      "status": "WARN",
      "note": "Test code patterns (180+ any usages in mocks), 35+ as unknown as casts, production code clean"
    },
    "accessibility": {
      "critical": 4,
      "high": 8,
      "medium": 12,
      "status": "WARN",
      "note": "Missing form-primitives.tsx, small touch targets (h-8 w-8), icon labels, opacity contrast"
    },
    "performance": {
      "critical": 4,
      "high": 6,
      "medium": 8,
      "status": "WARN",
      "note": "N+1 patterns in useEntityData (7 queries), useDistributorAuthorization (3 queries), memoization gaps"
    },
    "code-quality": {
      "critical": 4,
      "high": 12,
      "medium": 7,
      "status": "WARN",
      "note": "1406-line test file, 70 console statements, stale leads TODO, DRY violations (4 identical hooks)"
    }
  },
  "critical_issues_summary": [
    {
      "rank": 1,
      "category": "security",
      "issue": "task_id_mapping RLS disabled",
      "impact": "Multi-tenant data leakage",
      "fix_effort": "5 min",
      "status": "OPEN"
    },
    {
      "rank": 2,
      "category": "security",
      "issue": "audit_trail/products/tags USING(true) policies",
      "impact": "Unrestricted access to sensitive data",
      "fix_effort": "30 min per table",
      "status": "OPEN"
    },
    {
      "rank": 3,
      "category": "workflow-gaps",
      "issue": "Stage transitions enforced only in app layer",
      "impact": "Invalid transitions possible via raw SQL",
      "fix_effort": "1 hour (DB trigger)",
      "status": "OPEN"
    },
    {
      "rank": 4,
      "category": "stale-state",
      "issue": "useSalesUpdate/updatePassword missing cache invalidation",
      "impact": "Stale user data after profile changes",
      "fix_effort": "15 min each",
      "status": "OPEN"
    },
    {
      "rank": 5,
      "category": "db-hardening",
      "issue": "customer_organization_id nullable but required by Q12",
      "impact": "Orphaned opportunities violate business rules",
      "fix_effort": "30 min (migration + trigger)",
      "status": "OPEN"
    }
  ],
  "layer_fix_priority": [
    {
      "layer": "L1_database",
      "reason": "RLS holes + business rule enforcement at DB level",
      "critical_count": 14,
      "estimated_effort": "4-6 hours"
    },
    {
      "layer": "L5_features",
      "reason": "Cache coherence + N+1 queries block feature reliability",
      "critical_count": 19,
      "estimated_effort": "8-10 hours"
    },
    {
      "layer": "L3_provider",
      "reason": "Strangler Fig completion, architecture compliance",
      "critical_count": 2,
      "estimated_effort": "2-3 hours"
    },
    {
      "layer": "L2_domain",
      "reason": "Type safety (test patterns, not production)",
      "critical_count": 0,
      "estimated_effort": "4-6 hours"
    },
    {
      "layer": "L4_ui_foundation",
      "reason": "Accessibility, touch targets",
      "critical_count": 4,
      "estimated_effort": "3-4 hours"
    }
  ],
  "strangler_fig_status": {
    "unifiedDataProvider_lines": 0,
    "composedDataProvider_lines": 260,
    "handler_count": 25,
    "status": "COMPLETED"
  },
  "audit_methodology": {
    "type": "Full 11-Audit Parallel Execution",
    "batches": 3,
    "batch1_agents": ["security", "data-integrity", "error-handling", "db-hardening"],
    "batch2_agents": ["stale-state", "workflow-gaps", "architecture", "typescript"],
    "batch3_agents": ["accessibility", "performance", "code-quality"],
    "files_analyzed": 913,
    "duration_minutes": 27,
    "confidence_average": 88
  },
  "delta_from_previous": {
    "previous_date": "2026-01-25",
    "previous_critical": 10,
    "previous_high": 55,
    "previous_medium": 69,
    "previous_total": 134,
    "current_critical": 39,
    "current_high": 113,
    "current_medium": 88,
    "current_total": 240,
    "critical_change": 29,
    "high_change": 58,
    "medium_change": 19,
    "total_change": 106,
    "analysis": "Increase due to comprehensive full audits. +29 critical largely pre-existing (96 USING(true) policies, business rule gaps). True regressions: settings mutations, missing form-primitives.tsx, incomplete stale leads feature."
  }
}
