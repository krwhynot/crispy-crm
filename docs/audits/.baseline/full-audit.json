{
  "lastAudit": "2026-01-23",
  "lastAuditTime": "11:16",
  "mode": "full",
  "duration_minutes": 28,
  "totals": {
    "critical": 28,
    "high": 51,
    "medium": 99
  },
  "by_layer": {
    "L1_database": { "critical": 3, "high": 12, "status": "CRITICAL" },
    "L2_domain": { "critical": 18, "high": 15, "status": "CRITICAL" },
    "L3_provider": { "critical": 1, "high": 5, "status": "WARN" },
    "L4_ui_foundation": { "critical": 1, "high": 2, "status": "WARN" },
    "L5_features": { "critical": 5, "high": 17, "status": "WARN" }
  },
  "by_category": {
    "security": { "critical": 0, "high": 24, "medium": 2 },
    "data-integrity": { "critical": 0, "high": 27, "medium": 5 },
    "error-handling": { "critical": 0, "high": 2, "medium": 8 },
    "db-hardening": { "critical": 3, "high": 12, "medium": 38 },
    "stale-state": { "critical": 3, "high": 8, "medium": 4 },
    "workflow-gaps": { "critical": 3, "high": 4, "medium": 6 },
    "architecture": { "critical": 1, "high": 2, "medium": 3 },
    "typescript": { "critical": 18, "high": 6, "medium": 5 },
    "accessibility": { "critical": 0, "high": 2, "medium": 8 },
    "performance": { "critical": 2, "high": 5, "medium": 8 },
    "code-quality": { "critical": 3, "high": 8, "medium": 12 }
  },
  "critical_findings": [
    {
      "source_audit": "security",
      "id": "SEC-001",
      "severity": "critical",
      "check": "Direct Supabase Import",
      "location": "useCurrentSale.ts:3",
      "description": "Auth context bypasses provider pattern - violates PROVIDER_RULES",
      "firstSeen": "2026-01-22",
      "status": "open"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-001",
      "severity": "critical",
      "check": "Hard DELETE in RPC",
      "location": "20251029051621_update_sync_rpc_remove_pricing.sql:88",
      "description": "sync_opportunity_with_products() uses DELETE instead of soft-delete",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-002",
      "severity": "critical",
      "check": "Hard DELETE Cascade",
      "location": "20251018152315_cloud_schema_fresh.sql:714",
      "description": "delete_contact_cascade() hard-deletes junction tables",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-003",
      "severity": "critical",
      "check": "RLS Missing Soft-Delete Filter",
      "location": "Multiple RLS policies",
      "description": "40+ RLS policies missing deleted_at IS NULL filter",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-004",
      "severity": "critical",
      "check": "Merge Function Status",
      "location": "20251123215857_fix_merge_function_table_names.sql",
      "description": "merge_duplicate_contacts() soft-delete status unverified",
      "firstSeen": "2026-01-23",
      "status": "verify"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-005",
      "severity": "critical",
      "check": "Cascade Hard Delete",
      "location": "20251231120000_add_sync_opportunity_contacts_rpc.sql:18",
      "description": "delete_contact_cascade() performs hard DELETE on junction",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-006",
      "severity": "critical",
      "check": "Strangler Fig Migration",
      "location": "composedDataProvider.ts",
      "description": "Migration COMPLETED - 260 lines, 15 handlers, all resources routed",
      "firstSeen": "2026-01-20",
      "status": "fixed"
    },
    {
      "source_audit": "error-handling",
      "id": "EH-001",
      "severity": "critical",
      "check": "Fire-and-Forget Cleanup",
      "location": "organizationsCallbacks.ts:124-143",
      "description": "Storage cleanup errors silently ignored - GDPR compliance risk",
      "firstSeen": "2026-01-22",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-001",
      "severity": "critical",
      "check": "Hardcoded Query Keys",
      "location": "22 locations",
      "description": "Cache keys bypass queryKeys factory causing invalidation misses",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-002",
      "severity": "critical",
      "check": "Missing refetchOnWindowFocus",
      "location": "useTaskCount.ts:31",
      "description": "Task count badge stale on tab return - violates <2s KPI",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-003",
      "severity": "critical",
      "check": "Polling Without Stale Gate",
      "location": "NotificationBell.tsx:23",
      "description": "refetchInterval without staleTime causes excessive API calls",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-004",
      "severity": "critical",
      "check": "Cascade Invalidation",
      "location": "Note.tsx:39-41",
      "description": "Deleting 1 note clears all related resource caches",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-005",
      "severity": "critical",
      "check": "Manual Optimistic Updates",
      "location": "useFavorites.ts:78-122",
      "description": "Uses manual rollback instead of React Query onMutate pattern",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "workflow-gaps",
      "id": "WG-001",
      "severity": "critical",
      "check": "Nullable Required FK",
      "location": "opportunities.customer_organization_id",
      "description": "Business-critical FK is nullable - causes orphaned opportunities",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "workflow-gaps",
      "id": "WG-002",
      "severity": "critical",
      "check": "Win/Loss App-Only Validation",
      "location": "opportunities-operations.ts:385-423",
      "description": "Database has no CHECK constraints - app crash allows invalid data",
      "firstSeen": "2026-01-22",
      "status": "open"
    },
    {
      "source_audit": "architecture",
      "id": "ARCH-001",
      "severity": "critical",
      "check": "Tier 1 RA Import",
      "location": "priority-tabs.tsx:25",
      "description": "Tier 1 UI component imports react-admin type - violates UI_STANDARDS",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "architecture",
      "id": "ARCH-002",
      "severity": "critical",
      "check": "Direct Supabase Auth",
      "location": "useCurrentSale.ts:3",
      "description": "Auth bypass outside provider pattern",
      "firstSeen": "2026-01-22",
      "status": "open"
    },
    {
      "source_audit": "typescript",
      "id": "TS-001",
      "severity": "critical",
      "check": "as any Cast",
      "location": "zodErrorFormatting.ts:36",
      "description": "getFriendlyErrorMessage uses as any bypass",
      "firstSeen": "2026-01-22",
      "status": "open"
    },
    {
      "source_audit": "typescript",
      "id": "TS-002",
      "severity": "critical",
      "check": "as any Cast",
      "location": "zodErrorFormatting.ts:70",
      "description": "formatZodError uses as any bypass",
      "firstSeen": "2026-01-22",
      "status": "open"
    },
    {
      "source_audit": "typescript",
      "id": "TS-003",
      "severity": "critical",
      "check": "as any Cast",
      "location": "zodErrorFormatting.ts:94",
      "description": "Third as any in validation formatting",
      "firstSeen": "2026-01-22",
      "status": "open"
    }
  ],
  "strangler_fig_status": {
    "unifiedDataProvider_lines": 0,
    "composedDataProvider_lines": 260,
    "handler_count": 15,
    "status": "COMPLETED"
  },
  "excellence_areas": [
    "Strangler Fig: 100% COMPLETE - 15 composed handlers",
    "RLS Coverage: 31/31 tables (100%)",
    "Fail-Fast: NO retry logic found",
    "Soft Deletes: RLS enforced on base tables",
    "WCAG 2.1 AA: Accessibility compliant",
    "Code Splitting: React.lazy on routes",
    "Form Accessibility: role=alert, aria-live patterns",
    "Validation: Zod at API boundary with strictObject",
    "Memoization: 41 React.memo components"
  ],
  "trend": {
    "direction": "EXPANDED_DETECTION",
    "note": "Increase in critical reflects expanded detection patterns (TypeScript double-casts, N+1 queries), not degradation. Architecture compliance at 91%.",
    "previous_critical": 20,
    "current_critical": 28,
    "previous_high": 67,
    "current_high": 51,
    "previous_medium": 93,
    "current_medium": 99
  },
  "delta_summary": {
    "fixed": [
      "DI-006: Strangler Fig 100% COMPLETE (15 handlers, 260 lines)",
      "High-count reclassification (-16 high issues)"
    ],
    "new": [
      "TS-CAST-001 through TS-CAST-018 (double type cast detection)",
      "PERF-001, PERF-002 (N+1 query detection in useEntityData)",
      "WG-003 through WG-006 (workflow orphan detection)",
      "DB-001 through DB-003 (permissive RLS, function search paths)"
    ],
    "unchanged": [
      "SEC-001 through SEC-024 (security validation gaps)",
      "EH-001 (storage cleanup fire-and-forget)",
      "ARCH-001 (Tier 1 RA import)"
    ]
  },
  "excellence_areas": [
    "Strangler Fig: 100% COMPLETE - 15 composed handlers",
    "RLS Coverage: 31/31 tables (100%)",
    "Fail-Fast: NO retry logic found",
    "WCAG 2.1 AA: 92% compliant",
    "Architecture: 91% feature compliance",
    "Validation: Zod at API boundary with strictObject"
  ]
}
