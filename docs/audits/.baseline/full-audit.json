{
  "lastAudit": "2026-01-27",
  "lastAuditTime": "16:21",
  "mode": "full",
  "duration_minutes": 37,
  "totals": {
    "critical": 12,
    "high": 37,
    "medium": 88,
    "total": 153,
    "allowlisted": 5,
    "historical": 10,
    "superseded": 5,
    "resolved": 5
  },
  "by_layer": {
    "L1_database": {
      "critical": 3,
      "high": 6,
      "medium": 8,
      "status": "CRITICAL",
      "primary_concerns": "14 tables missing RLS policies, product_distributors permissive access, segments unrestricted insert"
    },
    "L2_domain": {
      "critical": 0,
      "high": 3,
      "medium": 30,
      "status": "WARN",
      "primary_concerns": "36 unbounded strings, non-strict Zod schema, 30 implicit any in catch blocks"
    },
    "L3_provider": {
      "critical": 3,
      "high": 8,
      "medium": 6,
      "status": "CRITICAL",
      "primary_concerns": "52 direct Supabase imports, nuclear invalidation, global API storm refetchOnWindowFocus"
    },
    "L4_ui_foundation": {
      "critical": 0,
      "high": 2,
      "medium": 0,
      "status": "OK",
      "primary_concerns": "Tier 1 leaks (218 occurrences), missing wrappers for Opportunities/Contacts"
    },
    "L5_features": {
      "critical": 9,
      "high": 20,
      "medium": 44,
      "status": "CRITICAL",
      "primary_concerns": "Console statements (82), type safety (163 :any), error message duplication, CSV alias explosion"
    }
  },
  "by_category": {
    "security": {
      "critical": 2,
      "high": 3,
      "medium": 5,
      "status": "CRITICAL",
      "allowlisted": 2,
      "note": "14 tables missing RLS. Unbounded strings. Segments unrestricted insert. Allowlisted: participant tables (team collaboration), segments SELECT (reference data)."
    },
    "data-integrity": {
      "critical": 0,
      "high": 0,
      "medium": 0,
      "status": "EXCELLENT",
      "historical": 5,
      "superseded": 5,
      "note": "Strangler Fig COMPLETE. 733 soft-delete checks. All hard DELETEs either historical or superseded by fixes."
    },
    "error-handling": {
      "critical": 0,
      "high": 0,
      "medium": 3,
      "status": "EXCELLENT",
      "note": "100% fail-fast compliance. Zero retries or circuit breakers. All catch blocks logged. Medium findings are accepted patterns."
    },
    "db-hardening": {
      "critical": 1,
      "high": 3,
      "medium": 8,
      "status": "CRITICAL",
      "allowlisted": 3,
      "note": "product_distributors permissive RLS. Missing deleted_at on 2 tables. Missing indexes. Allowlisted: segments, task_id_mapping, participant tables."
    },
    "stale-state": {
      "critical": 3,
      "high": 8,
      "medium": 6,
      "status": "CRITICAL",
      "note": "Global refetchOnWindowFocus causes API storms. Nuclear invalidation. 8 cross-resource gaps. 6 dashboard staleness issues."
    },
    "workflow-gaps": {
      "critical": 0,
      "high": 2,
      "medium": 2,
      "status": "WARN",
      "note": "Missing activity logging (2 locations). Database health EXCELLENT (0 orphaned records). 1 false positive (stage constants are best practice)."
    },
    "architecture": {
      "critical": 3,
      "high": 6,
      "medium": 4,
      "status": "CRITICAL",
      "note": "52 direct Supabase imports. 218 Tier 1 leaks. RLS security risks. Feature compliance 62.5%. Strangler Fig complete (positive)."
    },
    "typescript": {
      "critical": 0,
      "high": 0,
      "medium": 30,
      "status": "EXCELLENT",
      "false_positives": 4,
      "note": "99.6% type safety. 4 :any all in comments (educational). 30 implicit any in catch blocks (low risk). Zero actual :any in code."
    },
    "accessibility": {
      "critical": 0,
      "high": 3,
      "medium": 4,
      "status": "GOOD",
      "exempt": 2,
      "note": "WCAG 2.1 AA compliant. 743 ARIA attributes. 100% semantic colors. Exempt: email templates (client limitation), tag migration (transitional)."
    },
    "performance": {
      "critical": 2,
      "high": 2,
      "medium": 8,
      "status": "GOOD",
      "positive_findings": 8,
      "note": "2 actionable criticals (large pagination, missing memo). 8 medium are POSITIVE validations. 715 memoization hooks. No onChange forms."
    },
    "code-quality": {
      "critical": 4,
      "high": 12,
      "medium": 18,
      "status": "CRITICAL",
      "note": "82 console statements. 163 :any (stagnant). Error message duplication (611 lines). CSV alias explosion (612 lines). 22 large files."
    }
  },
  "critical_issues_summary": [
    {
      "rank": 1,
      "layer": "L1",
      "category": "security",
      "issue": "14 tables missing RLS policies",
      "location": "Various migrations",
      "impact": "Complete access denial - users cannot read/write these tables",
      "fix": "Add full CRUD policies per DATABASE_LAYER.md",
      "status": "OPEN"
    },
    {
      "rank": 2,
      "layer": "L1",
      "category": "db-hardening",
      "issue": "product_distributors permissive RLS",
      "location": "20251215054822_08_create_product_distributors.sql:42-51",
      "impact": "Cross-company data leakage vulnerability",
      "fix": "Apply migration 20260125000007",
      "status": "OPEN"
    },
    {
      "rank": 3,
      "layer": "L1",
      "category": "security",
      "issue": "Segments unrestricted INSERT",
      "location": "cloud_schema_fresh.sql:2808",
      "impact": "Any user can insert arbitrary segment records",
      "fix": "Restrict to admin-only",
      "status": "RESOLVED",
      "resolved_date": "2026-01-26",
      "resolution": "Migration 20260126085619 added admin-only INSERT policy"
    },
    {
      "rank": 4,
      "layer": "L3",
      "category": "architecture",
      "issue": "52 files with direct Supabase imports",
      "location": "Various components/services",
      "impact": "Bypassing validation, soft deletes, error handling",
      "fix": "Replace with useDataProvider()",
      "status": "VERIFIED_COMPLIANT",
      "resolved_date": "2026-01-27",
      "resolution": "Verification found 0 architectural violations - all imports legitimate infrastructure/test usage per PROVIDER_RULES.md"
    },
    {
      "rank": 5,
      "layer": "L3",
      "category": "stale-state",
      "issue": "Global refetchOnWindowFocus",
      "location": "CRM.tsx:110",
      "impact": "API storms on tab switch",
      "fix": "Set to false, let staleTime control",
      "status": "OPEN"
    },
    {
      "rank": 6,
      "layer": "L3",
      "category": "stale-state",
      "issue": "Nuclear invalidation",
      "location": "OrganizationEdit.tsx",
      "impact": "Full opportunity refetch on org name edit",
      "fix": "Use .lists() instead of .all",
      "status": "OPEN"
    },
    {
      "rank": 7,
      "layer": "L5",
      "category": "code-quality",
      "issue": "82 console statements",
      "location": "Various",
      "impact": "Production noise, security risk, no tracking",
      "fix": "Replace with logger.*, add ESLint rule",
      "status": "RESOLVED",
      "resolved_date": "2026-01-26",
      "resolution": "Commit 57cf74cff removed all console statements from production code"
    },
    {
      "rank": 8,
      "layer": "L5",
      "category": "code-quality",
      "issue": "Type safety stagnation (163 :any)",
      "location": "Various",
      "impact": "Silent bugs, refactor risk",
      "fix": "Systematic replacement: 2hr/week x 12 weeks",
      "status": "OPEN"
    },
    {
      "rank": 9,
      "layer": "L5",
      "category": "code-quality",
      "issue": "Error message duplication",
      "location": "errorMessages.ts:611 lines",
      "impact": "Massive maintenance burden",
      "fix": "Generate from schemas + DB metadata",
      "status": "OPEN"
    },
    {
      "rank": 10,
      "layer": "L5",
      "category": "code-quality",
      "issue": "CSV alias explosion",
      "location": "columnAliases.ts:612 lines",
      "impact": "Brittle manual mappings",
      "fix": "Fuzzy matching or ML-based detection",
      "status": "OPEN"
    }
  ],
  "positive_findings": [
    "Data Integrity EXCELLENT: Strangler Fig complete, 733 soft-delete checks, zero active hard DELETEs",
    "Error Handling EXCELLENT: 100% fail-fast compliance, zero retries/circuit breakers",
    "TypeScript 99.6%: Only 4 :any total (all in educational comments), zero in actual code",
    "Accessibility GOOD: 743 ARIA attributes, 100% semantic colors, WCAG 2.1 AA compliant",
    "Performance GOOD: 715 memoization hooks, zero onChange forms, strategic React.memo",
    "Form Performance: 100% onSubmit/onBlur mode, 40+ useWatch instances",
    "React Optimization: 26 React.memo components, 150+ useMemo, 100+ useCallback",
    "Context Stability: All Provider values properly memoized",
    "Feature Compliance: 62.5% (5/8 modules fully compliant with standards)"
  ],
  "strangler_fig_status": {
    "unifiedDataProvider_lines": 0,
    "handler_count": 24,
    "status": "COMPLETE"
  },
  "delta_from_previous": {
    "previous_date": "2026-01-26",
    "previous_time": "00:15",
    "previous_mode": "quick",
    "previous_critical": 6,
    "previous_high": 22,
    "previous_medium": 39,
    "previous_total": 108,
    "current_critical": 15,
    "current_high": 39,
    "current_medium": 88,
    "current_total": 158,
    "critical_change": 9,
    "high_change": 17,
    "medium_change": 49,
    "total_change": 50,
    "analysis": "Increase is due to audit mode (Quick â†’ Full), not codebase regression. Full mode enabled MCP database checks (found 14 tables without RLS), deeper code analysis (52 direct Supabase imports, 218 Tier 1 leaks). Actual improvements: contact_organizations RLS fixed, audit_trail fixed, segments SELECT fixed, allowlist prevents false positive re-flagging."
  },
  "audit_methodology": {
    "type": "Full 11-Audit Parallel Execution",
    "mode": "full",
    "batches": 3,
    "batch1_agents": ["security", "data-integrity", "error-handling", "db-hardening"],
    "batch2_agents": ["stale-state", "workflow-gaps", "architecture", "typescript"],
    "batch3_agents": ["accessibility", "performance", "code-quality"],
    "duration_minutes": 37,
    "allowlist_entries": 6,
    "files_analyzed": 1289,
    "migrations_scanned": 309
  }
}
