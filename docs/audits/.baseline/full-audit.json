{
  "lastAudit": "2026-01-24",
  "lastAuditTime": "21:25",
  "mode": "full",
  "duration_minutes": 21,
  "totals": {
    "critical": 24,
    "high": 65,
    "medium": 133
  },
  "by_layer": {
    "L1_database": { "critical": 9, "high": 8, "medium": 84, "status": "CRITICAL" },
    "L2_domain": { "critical": 0, "high": 1, "medium": 7, "status": "OK" },
    "L3_provider": { "critical": 2, "high": 14, "medium": 9, "status": "CRITICAL" },
    "L4_ui_foundation": { "critical": 0, "high": 0, "medium": 0, "status": "EXCELLENT" },
    "L5_features": { "critical": 13, "high": 42, "medium": 33, "status": "CRITICAL" }
  },
  "by_category": {
    "security": { "critical": 2, "high": 4, "medium": 3 },
    "data-integrity": { "critical": 3, "high": 4, "medium": 2 },
    "error-handling": { "critical": 1, "high": 10, "medium": 4 },
    "db-hardening": { "critical": 2, "high": 4, "medium": 82 },
    "stale-state": { "critical": 5, "high": 8, "medium": 4 },
    "workflow-gaps": { "critical": 1, "high": 4, "medium": 5 },
    "architecture": { "critical": 0, "high": 2, "medium": 3 },
    "typescript": { "critical": 0, "high": 1, "medium": 7 },
    "accessibility": { "critical": 0, "high": 0, "medium": 0 },
    "performance": { "critical": 3, "high": 4, "medium": 5 },
    "code-quality": { "critical": 7, "high": 24, "medium": 18 }
  },
  "critical_findings": [
    {
      "source_audit": "security",
      "id": "SEC-01",
      "severity": "critical",
      "layer": "L1",
      "check": "USING(true) on activities, tasks, tags tables",
      "location": "supabase/migrations/20251123190738_restore_activities_rls_policies.sql",
      "description": "Any authenticated user can access ALL activities, tasks, and tags records",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "security",
      "id": "SEC-02",
      "severity": "critical",
      "layer": "L1",
      "check": "Legacy product_distributors has permissive RLS",
      "location": "supabase/migrations/20251215054822_08_create_product_distributors.sql",
      "description": "Product distributors table has overly permissive RLS policies",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-01",
      "severity": "critical",
      "layer": "L1",
      "check": "hard_delete_contact bypasses soft delete",
      "location": "Multiple migrations",
      "description": "Hard delete function exists that bypasses soft-delete pattern",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-02",
      "severity": "critical",
      "layer": "L1",
      "check": "hard_delete_organization bypasses soft delete",
      "location": "Multiple migrations",
      "description": "Hard delete function exists that bypasses soft-delete pattern",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-03",
      "severity": "critical",
      "layer": "L1",
      "check": "RLS SELECT policies missing deleted_at IS NULL",
      "location": "activities, tasks, tags tables",
      "description": "RLS policies don't filter out soft-deleted records",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "db-hardening",
      "id": "DB-01",
      "severity": "critical",
      "layer": "L1",
      "check": "Permissive USING(true) on write policies",
      "location": "activities, tasks, tags tables",
      "description": "Write policies allow any authenticated user to modify records",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "db-hardening",
      "id": "DB-02",
      "severity": "critical",
      "layer": "L1",
      "check": "Missing FK indexes for EXISTS subqueries",
      "location": "Junction tables",
      "description": "Foreign key columns lack indexes causing slow EXISTS queries",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-01",
      "severity": "critical",
      "layer": "L1",
      "check": "contact_organizations cache invalidation gap",
      "location": "Junction table",
      "description": "Mutations don't invalidate related caches",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-02",
      "severity": "critical",
      "layer": "L1",
      "check": "opportunity_contacts cache invalidation gap",
      "location": "Junction table",
      "description": "Mutations don't invalidate related caches",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "error-handling",
      "id": "EH-01",
      "severity": "critical",
      "layer": "L3",
      "check": "Console logging instead of structured logger",
      "location": "src/atomic-crm/providers/supabase/wrappers/withErrorLogging.ts:102-127",
      "description": "Uses console.error instead of structured logger service",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "workflow-gaps",
      "id": "WF-01",
      "severity": "critical",
      "layer": "L3",
      "check": "Missing server-side win/loss validation RPC",
      "location": "Provider layer",
      "description": "Win/loss reason validation only exists client-side",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-03",
      "severity": "critical",
      "layer": "L5",
      "check": "Missing refetch after opportunity product link",
      "location": "src/atomic-crm/opportunities/OpportunityProductsTab.tsx",
      "description": "Product links not refreshed after mutation",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-04",
      "severity": "critical",
      "layer": "L5",
      "check": "Stale state after contact unlink",
      "location": "src/atomic-crm/contacts/UnlinkConfirmDialog.tsx",
      "description": "Contact list shows stale data after unlink",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-05",
      "severity": "critical",
      "layer": "L5",
      "check": "LinkOpportunityModal cache coherence gap",
      "location": "src/atomic-crm/opportunities/LinkOpportunityModal.tsx",
      "description": "Modal doesn't invalidate caches after linking",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "performance",
      "id": "PERF-01",
      "severity": "critical",
      "layer": "L5",
      "check": "N+1 queries (3 sequential useGetOne)",
      "location": "src/atomic-crm/activities/QuickLogActivityDialog.tsx:413-428",
      "description": "3 sequential useGetOne calls that could be combined",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "performance",
      "id": "PERF-02",
      "severity": "critical",
      "layer": "L5",
      "check": "Unbounded list (1000 records, no pagination)",
      "location": "src/atomic-crm/opportunities/OpportunityArchivedList.tsx:24-28",
      "description": "Fetches 1000 records without pagination",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "performance",
      "id": "PERF-03",
      "severity": "critical",
      "layer": "L5",
      "check": "Client-side filtering of 500 orgs",
      "location": "src/atomic-crm/opportunities/QuickAddForm.tsx:326-332",
      "description": "Fetches 500 organizations for client-side filtering",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-01",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (673)",
      "location": "src/atomic-crm/providers/supabase/filterRegistry.ts",
      "description": "Large file needs splitting",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-02",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (663)",
      "location": "src/atomic-crm/opportunities/QuickAddForm.tsx",
      "description": "Large file needs splitting",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-03",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (655)",
      "location": "src/atomic-crm/opportunities/kanban/QuickAddOpportunity.tsx",
      "description": "Large file needs splitting",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-04",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (648)",
      "location": "src/atomic-crm/opportunities/OpportunityList.tsx",
      "description": "Large file needs splitting",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-05",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (628)",
      "location": "src/atomic-crm/contacts/ContactCompactForm.tsx",
      "description": "Large file needs splitting",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-06",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (620)",
      "location": "src/atomic-crm/activities/QuickLogActivityDialog.tsx",
      "description": "Large file needs splitting",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-07",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (608)",
      "location": "src/atomic-crm/opportunities/OpportunityEdit.tsx",
      "description": "Large file needs splitting",
      "firstSeen": "2026-01-24",
      "status": "open"
    }
  ],
  "strangler_fig_status": {
    "unifiedDataProvider_lines": 0,
    "composedDataProvider_lines": 260,
    "handler_count": 19,
    "status": "COMPLETED"
  },
  "excellence_areas": [
    "Accessibility: A+ Grade - 100% WCAG 2.1 AA compliance",
    "TypeScript: A+ Grade - Excellent type safety, minimal casting",
    "Strangler Fig: 100% COMPLETE - 19 composed handlers, 0 monolith lines",
    "Architecture: 90% compliance - Clean 3-tier separation",
    "RLS Coverage: 22/22 tables (100%)",
    "Form Validation: onSubmit/onBlur mode enforced",
    "Design System: No color violations - semantic OKLCH tokens"
  ],
  "trend": {
    "direction": "IMPROVED",
    "note": "Critical issues reduced 45% (44→24), total issues reduced 40% (370→222). Accessibility issues resolved. Major improvements in L4 UI Foundation layer.",
    "previous_critical": 44,
    "current_critical": 24,
    "previous_high": 52,
    "current_high": 65,
    "previous_medium": 274,
    "current_medium": 133,
    "delta": {
      "critical_change": -20,
      "critical_percent": "-45%",
      "high_change": 13,
      "high_percent": "+25%",
      "medium_change": -141,
      "medium_percent": "-51%",
      "total_change": -148,
      "total_percent": "-40%"
    }
  }
}
