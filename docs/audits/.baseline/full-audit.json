{
  "lastAudit": "2026-01-24",
  "lastAuditTime": "18:55",
  "mode": "full",
  "duration_minutes": 25,
  "totals": {
    "critical": 44,
    "high": 52,
    "medium": 274
  },
  "by_layer": {
    "L1_database": { "critical": 5, "high": 6, "status": "CRITICAL" },
    "L2_domain": { "critical": 0, "high": 0, "status": "EXCELLENT" },
    "L3_provider": { "critical": 6, "high": 10, "status": "CRITICAL" },
    "L4_ui_foundation": { "critical": 15, "high": 5, "status": "CRITICAL" },
    "L5_features": { "critical": 18, "high": 31, "status": "CRITICAL" }
  },
  "by_category": {
    "security": { "critical": 3, "high": 4, "medium": 5 },
    "data-integrity": { "critical": 3, "high": 4, "medium": 2 },
    "error-handling": { "critical": 3, "high": 5, "medium": 8 },
    "db-hardening": { "critical": 2, "high": 3, "medium": 4 },
    "stale-state": { "critical": 3, "high": 8, "medium": 12 },
    "workflow-gaps": { "critical": 3, "high": 3, "medium": 2 },
    "architecture": { "critical": 3, "high": 2, "medium": 213 },
    "typescript": { "critical": 0, "high": 0, "medium": 4 },
    "accessibility": { "critical": 12, "high": 3, "medium": 2 },
    "performance": { "critical": 4, "high": 8, "medium": 7 },
    "code-quality": { "critical": 8, "high": 12, "medium": 15 }
  },
  "critical_findings": [
    {
      "source_audit": "security",
      "id": "SEC-001",
      "severity": "critical",
      "layer": "L1",
      "check": "USING(true) RLS on core tables",
      "location": "supabase/migrations/20251111121526_add_role_based_permissions.sql:163,184,205",
      "description": "contacts, organizations, products tables allow any authenticated user to access ALL records",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "db-hardening",
      "id": "DB-002",
      "severity": "critical",
      "layer": "L1",
      "check": "Missing deleted_at column",
      "location": "product_distributors table",
      "description": "Junction table lacks soft-delete column for proper data lifecycle",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "db-hardening",
      "id": "DB-003",
      "severity": "critical",
      "layer": "L1",
      "check": "Missing deleted_at column",
      "location": "opportunity_contacts table",
      "description": "Junction table lacks soft-delete column",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "error-handling",
      "id": "EH-001",
      "severity": "critical",
      "layer": "L3",
      "check": "Fail-fast violation - graceful fallback",
      "location": "src/atomic-crm/hooks/useRelatedRecordCounts.ts:183",
      "description": "Timeout resolves to fallback count=0 instead of failing fast",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "error-handling",
      "id": "EH-002",
      "severity": "critical",
      "layer": "L3",
      "check": "Fire-and-forget side effects",
      "location": "src/atomic-crm/providers/supabase/callbacks/organizationsCallbacks.ts:137",
      "description": "Storage cleanup bypasses Provider error handling boundary",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "architecture",
      "id": "ARCH-001",
      "severity": "critical",
      "layer": "L3",
      "check": "Direct Supabase usage bypassing provider",
      "location": "src/atomic-crm/providers/supabase/handlers/timelineHandler.ts:100",
      "description": "Uses supabase client directly instead of baseProvider.getList()",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "accessibility",
      "id": "A11Y-001",
      "severity": "critical",
      "layer": "L4",
      "check": "Missing aria-invalid on form inputs",
      "location": "src/atomic-crm/sales/SalesProfileTab.tsx:186-257",
      "description": "4 form inputs (first_name, last_name, email, phone) missing aria-invalid attribute",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "accessibility",
      "id": "A11Y-005",
      "severity": "critical",
      "layer": "L4",
      "check": "Missing aria-describedby on form inputs",
      "location": "src/atomic-crm/sales/SalesProfileTab.tsx:186-257",
      "description": "4 form inputs missing aria-describedby linking to error messages",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "accessibility",
      "id": "A11Y-009",
      "severity": "critical",
      "layer": "L4",
      "check": "Missing role=alert on error messages",
      "location": "src/atomic-crm/sales/SalesProfileTab.tsx:186-257",
      "description": "4 error message spans missing role=alert for screen readers",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "accessibility",
      "id": "A11Y-013",
      "severity": "critical",
      "layer": "L4",
      "check": "Touch targets below 44px",
      "location": "src/atomic-crm/organizations/OrganizationAside.tsx:58,69,83",
      "description": "min-h-[24px] below WCAG AAA 44px minimum for iPad",
      "firstSeen": "2026-01-23",
      "status": "open"
    },
    {
      "source_audit": "performance",
      "id": "PERF-001",
      "severity": "critical",
      "layer": "L4",
      "check": "Large bundle chunk exceeds limit",
      "location": "dist/js/chunk-BGXvQuDD.js:366.64 kB",
      "description": "Main bundle chunk exceeds 300 kB recommended limit",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-001",
      "severity": "critical",
      "layer": "L5",
      "check": "Missing cache invalidation on junction mutations",
      "location": "src/atomic-crm/contacts/UnlinkConfirmDialog.tsx:28-51",
      "description": "Junction table deletes don't invalidate related caches",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-002",
      "severity": "critical",
      "layer": "L5",
      "check": "Missing refetchOnWindowFocus",
      "location": "src/atomic-crm/contacts/OpportunitiesTab.tsx:51-82",
      "description": "Tab switch doesn't refresh opportunity links",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-003",
      "severity": "critical",
      "layer": "L5",
      "check": "Product authorization cache hole",
      "location": "src/atomic-crm/organizations/ProductExceptionsSection.tsx:24-60",
      "description": "Deleted authorizations still shown after delete",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "performance",
      "id": "PERF-004",
      "severity": "critical",
      "layer": "L5",
      "check": "N+1 Query Pattern",
      "location": "src/atomic-crm/opportunities/OpportunityListFilter.tsx:35-46",
      "description": "2 sequential useGetList calls that could be combined",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "performance",
      "id": "PERF-005",
      "severity": "critical",
      "layer": "L5",
      "check": "3 useGetList calls at mount",
      "location": "src/atomic-crm/opportunities/QuickAddForm.tsx:320-335",
      "description": "3 queries at mount that could be batched",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-001",
      "severity": "critical",
      "layer": "L5",
      "check": "53 files exceed 400 lines",
      "location": "Various including 5000+ line generated types",
      "description": "Large files indicate mixed responsibilities",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-002",
      "severity": "critical",
      "layer": "L5",
      "check": "QuickAddForm.tsx 663 lines",
      "location": "src/atomic-crm/opportunities/QuickAddForm.tsx",
      "description": "11 hooks, high complexity - needs splitting",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-005",
      "severity": "critical",
      "layer": "L5",
      "check": "DRY violation - handler patterns",
      "location": "src/atomic-crm/providers/supabase/handlers/",
      "description": "80+ lines duplicated across handler passthrough patterns",
      "firstSeen": "2026-01-24",
      "status": "open"
    },
    {
      "source_audit": "workflow-gaps",
      "id": "WG-001",
      "severity": "critical",
      "layer": "L5",
      "check": "Stale leads feature requires server-side RPC",
      "location": "Feature: stale leads",
      "description": "No get_stale_leads function exists for server-side filtering",
      "firstSeen": "2026-01-24",
      "status": "open"
    }
  ],
  "strangler_fig_status": {
    "unifiedDataProvider_lines": 0,
    "composedDataProvider_lines": 260,
    "handler_count": 19,
    "status": "COMPLETED"
  },
  "excellence_areas": [
    "TypeScript Production: A+ Grade - 0 any types, 0 double casts in production code",
    "Strangler Fig: 100% COMPLETE - 19 composed handlers, 0 monolith lines",
    "RLS Coverage: 22/22 tables (100%)",
    "Fail-Fast: NO retry logic found",
    "Form Validation: onSubmit/onBlur mode enforced",
    "Design System: No color violations - semantic OKLCH tokens",
    "XSS Protection: DOMPurify sanitization"
  ],
  "trend": {
    "direction": "DETECTION_IMPROVED",
    "note": "Issue increase (123â†’370) reflects improved audit thoroughness, not codebase regression. Accessibility now checks all form inputs for aria attributes (12 new critical). Architecture now counts ALL Tier 1 imports (213 medium). Security found additional USING(true) policies.",
    "previous_critical": 18,
    "current_critical": 44,
    "previous_high": 48,
    "current_high": 52,
    "previous_medium": 57,
    "current_medium": 274,
    "audit_improvements": [
      "Accessibility: Now checks aria-invalid, aria-describedby, role=alert on ALL form inputs",
      "Architecture: Now counts ALL Tier 1 component imports in features",
      "Security: More thorough scan of RLS policies on core tables"
    ]
  }
}
