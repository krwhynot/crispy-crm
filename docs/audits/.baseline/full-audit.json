{
  "lastAudit": "2026-01-25",
  "lastAuditTime": "12:45",
  "mode": "full",
  "duration_minutes": 23,
  "totals": {
    "critical": 15,
    "high": 55,
    "medium": 69
  },
  "by_layer": {
    "L1_database": { "critical": 6, "high": 16, "medium": 13, "status": "WARN" },
    "L2_domain": { "critical": 0, "high": 3, "medium": 2, "status": "OK" },
    "L3_provider": { "critical": 2, "high": 14, "medium": 3, "status": "WARN" },
    "L4_ui_foundation": { "critical": 0, "high": 2, "medium": 3, "status": "OK" },
    "L5_features": { "critical": 7, "high": 20, "medium": 48, "status": "CRITICAL" }
  },
  "by_category": {
    "security": { "critical": 0, "high": 5, "medium": 5 },
    "data-integrity": { "critical": 0, "high": 0, "medium": 2 },
    "error-handling": { "critical": 0, "high": 1, "medium": 2 },
    "db-hardening": { "critical": 0, "high": 8, "medium": 5 },
    "stale-state": { "critical": 7, "high": 12, "medium": 8 },
    "workflow-gaps": { "critical": 2, "high": 4, "medium": 3 },
    "architecture": { "critical": 0, "high": 1, "medium": 2 },
    "typescript": { "critical": 0, "high": 2, "medium": 3 },
    "accessibility": { "critical": 0, "high": 2, "medium": 4 },
    "performance": { "critical": 3, "high": 8, "medium": 17 },
    "code-quality": { "critical": 4, "high": 12, "medium": 18 }
  },
  "critical_findings": [
    {
      "source_audit": "security",
      "id": "SEC-01",
      "severity": "critical",
      "layer": "L1",
      "check": "USING(true) on activities table",
      "location": "supabase/migrations/20251123190738_restore_activities_rls_policies.sql",
      "description": "14 RLS policies allow ANY authenticated user to access all activities records",
      "fix": "Replace all USING(true) with company_id isolation: company_id = (auth.jwt() ->> 'company_id')::int AND deleted_at IS NULL",
      "firstSeen": "2026-01-25",
      "status": "closed",
      "resolution": "Fixed in migration 20260123144656_fix_permissive_rls_policies.sql - verified deployed with ownership-based policies + deleted_at IS NULL",
      "closedDate": "2026-01-25"
    },
    {
      "source_audit": "security",
      "id": "SEC-02",
      "severity": "critical",
      "layer": "L1",
      "check": "product_distributors permissive RLS",
      "location": "supabase/migrations/20251215054822_08_create_product_distributors.sql",
      "description": "Legacy permissive policies exist (fixed in later migration 20260125000007)",
      "fix": "Verify migration 20260125000007 is deployed to production",
      "firstSeen": "2026-01-25",
      "status": "closed",
      "resolution": "Fixed via MCP migration product_distributors_dual_auth_rls - all 4 CRUD operations now use dual-authorization pattern (user must own both product AND distributor)",
      "closedDate": "2026-01-25"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-03",
      "severity": "critical",
      "layer": "L1",
      "check": "RLS SELECT policies missing deleted_at IS NULL",
      "location": "activities, tasks, tags tables",
      "description": "RLS policies don't filter out soft-deleted records",
      "fix": "Add deleted_at IS NULL to all SELECT policies",
      "firstSeen": "2026-01-25",
      "status": "closed",
      "resolution": "Fixed in migrations 20260121000004 and 20260123144656 - all SELECT policies now include deleted_at IS NULL filter",
      "closedDate": "2026-01-25"
    },
    {
      "source_audit": "data-integrity",
      "id": "DI-04",
      "severity": "critical",
      "layer": "L1",
      "check": "segments USING(true) policy",
      "location": "supabase/migrations/20251018152315_cloud_schema_fresh.sql",
      "description": "Permissive policy on reference data table (acceptable but needs documentation)",
      "fix": "Replace with auth.uid() IS NOT NULL and document reference data status",
      "firstSeen": "2026-01-25",
      "status": "closed",
      "resolution": "Fixed in migration 20260109000004_fix_segments_rls_authenticated.sql - uses auth.uid() IS NOT NULL. Segments is read-only reference data (acceptable pattern per DATABASE_LAYER.md)",
      "closedDate": "2026-01-25"
    },
    {
      "source_audit": "db-hardening",
      "id": "DB-01",
      "severity": "critical",
      "layer": "L1",
      "check": "opportunity_participants missing soft-delete RLS filter",
      "location": "supabase/migrations/20251029024045_fix_rls_policies_company_isolation.sql",
      "description": "Deleted records remain queryable",
      "fix": "Add deleted_at IS NULL to all RLS policies",
      "firstSeen": "2026-01-25",
      "status": "closed",
      "resolution": "Fixed in migration 20251129170506_harden_participant_tables_rls_security.sql - SELECT policy now includes deleted_at IS NULL",
      "closedDate": "2026-01-25"
    },
    {
      "source_audit": "db-hardening",
      "id": "DB-02",
      "severity": "critical",
      "layer": "L1",
      "check": "interaction_participants missing soft-delete in RLS",
      "location": "RLS policies",
      "description": "Soft-deleted records not hidden at database layer",
      "fix": "Add soft-delete filtering to all 4 CRUD policies",
      "firstSeen": "2026-01-25",
      "status": "closed",
      "resolution": "Fixed in migration 20251129170506_harden_participant_tables_rls_security.sql - SELECT policy now includes deleted_at IS NULL",
      "closedDate": "2026-01-25"
    },
    {
      "source_audit": "db-hardening",
      "id": "DB-03",
      "severity": "critical",
      "layer": "L1",
      "check": "notification_participants table never created",
      "location": "Multiple migrations",
      "description": "Orphaned foreign key references in migrations",
      "fix": "Audit all migrations for dangling references",
      "firstSeen": "2026-01-25",
      "status": "closed",
      "resolution": "FALSE POSITIVE - notification_participants table does not exist in schema. No CREATE TABLE statement found. Audit flagged orphaned comment references.",
      "closedDate": "2026-01-25"
    },
    {
      "source_audit": "error-handling",
      "id": "EH-01",
      "severity": "critical",
      "layer": "L3",
      "check": "Console logging instead of structured logger",
      "location": "src/atomic-crm/providers/supabase/wrappers/withErrorLogging.ts:102-127",
      "description": "Uses console.error instead of structured logger service",
      "fix": "Replace with logger service for Sentry integration",
      "firstSeen": "2026-01-25",
      "status": "closed",
      "resolution": "FALSE POSITIVE - withErrorLogging.ts:24 already uses structured logger (import { logger } from '@/lib/logger') with Sentry integration. Logger.error() called at lines 104-108.",
      "closedDate": "2026-01-25"
    },
    {
      "source_audit": "workflow-gaps",
      "id": "WF-01",
      "severity": "critical",
      "layer": "L3",
      "check": "Missing server-side win/loss validation RPC",
      "location": "Provider layer",
      "description": "Win/loss reason validation only exists client-side",
      "fix": "Implement server-side RPC validation",
      "firstSeen": "2026-01-25",
      "status": "closed",
      "resolution": "3-layer defense already implemented: (1) Zod validation at src/atomic-crm/validation/opportunities/opportunities-operations.ts:417-456, (2) DB constraint at migrations/20260122235000_add_win_loss_check_constraints.sql:23-35, (3) Trigger validation at migrations/20260125041610_opportunity_closure_validation.sql:1-50",
      "closedDate": "2026-01-25"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-03",
      "severity": "critical",
      "layer": "L5",
      "check": "AddProductExceptionDialog missing cache invalidation",
      "location": "src/atomic-crm/opportunities/AddProductExceptionDialog.tsx",
      "description": "Product exceptions don't appear without refresh",
      "fix": "Add queryClient.invalidateQueries after mutation",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-04",
      "severity": "critical",
      "layer": "L5",
      "check": "AddPrincipalDialog missing cache invalidation",
      "location": "src/atomic-crm/opportunities/AddPrincipalDialog.tsx",
      "description": "New authorizations invisible without refresh",
      "fix": "Add cache invalidation after mutation",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-05",
      "severity": "critical",
      "layer": "L5",
      "check": "TagCreateModal no cache invalidation",
      "location": "src/atomic-crm/tags/TagCreateModal.tsx",
      "description": "New tags don't appear in selectors",
      "fix": "Add queryClient.invalidateQueries",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-06",
      "severity": "critical",
      "layer": "L5",
      "check": "OpportunityProductsTab stale product counts",
      "location": "src/atomic-crm/opportunities/OpportunityProductsTab.tsx",
      "description": "Product counts go stale after sync mutation",
      "fix": "Invalidate product caches after mutation",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-07",
      "severity": "critical",
      "layer": "L5",
      "check": "UnlinkConfirmDialog incomplete invalidation",
      "location": "src/atomic-crm/contacts/UnlinkConfirmDialog.tsx",
      "description": "Only invalidates junction table, missing parent caches",
      "fix": "Add parent opportunity/contact detail invalidation",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-08",
      "severity": "critical",
      "layer": "L5",
      "check": "LinkOpportunityModal cache coherence gap",
      "location": "src/atomic-crm/opportunities/LinkOpportunityModal.tsx",
      "description": "Modal doesn't invalidate caches after linking",
      "fix": "Add cache invalidation after successful link",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "stale-state",
      "id": "SS-09",
      "severity": "critical",
      "layer": "L5",
      "check": "ProductExceptionsSection hardcoded query keys",
      "location": "src/atomic-crm/products/ProductExceptionsSection.tsx",
      "description": "Uses hardcoded string instead of constants, risk of cache desync",
      "fix": "Use constants from query key factory",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "performance",
      "id": "PERF-01",
      "severity": "critical",
      "layer": "L5",
      "check": "Cascading fetch chain in useEntityData",
      "location": "src/atomic-crm/dashboard/useEntityData.ts:104-237",
      "description": "6 parallel queries fetching 300+ records, 2-3s dashboard load time",
      "fix": "Add staleTime: 5*60*1000, batch fallback queries, reduce perPage: 100→25",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "performance",
      "id": "PERF-02",
      "severity": "critical",
      "layer": "L5",
      "check": "N+1 query pattern in RelatedOpportunitiesSection",
      "location": "src/atomic-crm/opportunities/RelatedOpportunitiesSection.tsx:20-31",
      "description": "useGetOne + useGetList with no cache strategy",
      "fix": "Add staleTime, reduce perPage: 100→25",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "performance",
      "id": "PERF-03",
      "severity": "critical",
      "layer": "L5",
      "check": "Unbounded pagination across 43 files",
      "location": "Multiple list components",
      "description": "perPage: 100 without pagination UI, 1-2MB JSON per page",
      "fix": "Bulk find-replace perPage: 100→25",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-01",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (673)",
      "location": "src/atomic-crm/providers/supabase/filterRegistry.ts",
      "description": "Large file needs splitting by domain",
      "fix": "Split into separate files per resource",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-02",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (663)",
      "location": "src/atomic-crm/opportunities/QuickAddForm.tsx",
      "description": "Large file needs splitting - extract hooks",
      "fix": "Extract custom hooks and helper functions",
      "firstSeen": "2026-01-25",
      "status": "open"
    },
    {
      "source_audit": "code-quality",
      "id": "CQ-03",
      "severity": "critical",
      "layer": "L5",
      "check": "File over 600 lines (655)",
      "location": "src/atomic-crm/opportunities/kanban/QuickAddOpportunity.tsx",
      "description": "Large file needs splitting - extract components",
      "fix": "Split into smaller focused components",
      "firstSeen": "2026-01-25",
      "status": "open"
    }
  ],
  "strangler_fig_status": {
    "unifiedDataProvider_lines": 0,
    "composedDataProvider_lines": 260,
    "handler_count": 24,
    "status": "COMPLETED"
  },
  "excellence_areas": [
    "Accessibility: 92% WCAG 2.1 AA compliance - 100% semantic colors, all touch targets 44-48px",
    "TypeScript: Excellent type safety - strict mode, 30+ z.infer derived types",
    "Strangler Fig: 100% COMPLETE - 24 composed handlers, 0 monolith lines",
    "Architecture: 92% compliance - 0 direct Supabase imports in features",
    "RLS Coverage: 31/31 tables (100%) have RLS enabled",
    "Form Validation: onSubmit/onBlur mode enforced throughout",
    "Design System: Perfect compliance - semantic OKLCH tokens only"
  ],
  "trend": {
    "direction": "IMPROVING",
    "note": "L1 database security resolved: 7 critical issues closed (activities USING(true), product_distributors dual-auth, soft-delete filters, participant tables). Critical reduced 32% (22→15). All remaining critical are L5 cache/performance.",
    "previous_critical": 22,
    "current_critical": 15,
    "previous_high": 65,
    "current_high": 55,
    "previous_medium": 133,
    "current_medium": 69,
    "delta": {
      "critical_change": 0,
      "critical_percent": "±0%",
      "high_change": -10,
      "high_percent": "-15%",
      "medium_change": -64,
      "medium_percent": "-48%",
      "total_change": -74,
      "total_percent": "-34%"
    }
  }
}
