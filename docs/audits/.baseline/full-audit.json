{
  "lastAudit": "2026-01-26",
  "lastAuditTime": "08:02",
  "mode": "quick",
  "duration_minutes": 21,
  "totals": {
    "critical": 17,
    "high": 80,
    "medium": 83,
    "total": 251
  },
  "by_layer": {
    "L1_database": {
      "critical": 6,
      "high": 12,
      "medium": 7,
      "status": "CRITICAL",
      "primary_concerns": "USING(true) RLS policies (product_distributors, summary views, junction tables), hard DELETE in RPC, WITH CHECK(true) policies"
    },
    "L2_domain": {
      "critical": 4,
      "high": 0,
      "medium": 0,
      "status": "CRITICAL",
      "primary_concerns": "any types in Edge Functions (supabaseAdmin.ts, updatePassword.ts, capture-dashboard-snapshots), 62 type assertions"
    },
    "L3_provider": {
      "critical": 2,
      "high": 1,
      "medium": 3,
      "status": "WARN",
      "primary_concerns": "filter-select-ui.tsx Tier 1 violation, business logic in productsHandler, console.log in tasksHandler"
    },
    "L4_ui_foundation": {
      "critical": 0,
      "high": 0,
      "medium": 1,
      "status": "OK",
      "primary_concerns": "WCAG 2.1 AA+ compliant, 100% semantic colors, 48px touch targets, ~73% focus-visible coverage"
    },
    "L5_features": {
      "critical": 5,
      "high": 67,
      "medium": 72,
      "status": "WARN",
      "primary_concerns": "Missing activity logging for stage transitions, silent defaults, pagination gaps, 51 large files, race conditions in hooks"
    }
  },
  "by_category": {
    "security": {
      "critical": 3,
      "high": 5,
      "medium": 4,
      "status": "CRITICAL",
      "note": "USING(true) RLS on product_distributors, summary views, junction tables. Missing Zod .max() limits. Client storage concerns."
    },
    "data-integrity": {
      "critical": 2,
      "high": 4,
      "medium": 5,
      "status": "WARN",
      "note": "Hard DELETE in migrations (historical) and sync RPC. Strangler Fig COMPLETE (24 handlers). 719 soft-delete RLS filters."
    },
    "error-handling": {
      "critical": 0,
      "high": 2,
      "medium": 7,
      "status": "PASS",
      "note": "100% withErrorLogging coverage. Fail-fast compliant. Minor: storage preference fallback silent, side-effect handling review."
    },
    "db-hardening": {
      "critical": 1,
      "high": 3,
      "medium": 2,
      "status": "WARN",
      "note": "segments permissive policy. Missing partial indexes on junction FKs. Inconsistent timestamp trigger coverage."
    },
    "stale-state": {
      "critical": 0,
      "high": 2,
      "medium": 4,
      "status": "WARN",
      "note": "useFavorites missing cancelQueries (race condition). reopenTask fire-and-forget. 40+ hardcoded staleTime values."
    },
    "workflow-gaps": {
      "critical": 3,
      "high": 2,
      "medium": 3,
      "status": "CRITICAL",
      "note": "No activity logging for stage transitions. Silent status defaults. Stage transitions lack business prerequisites."
    },
    "architecture": {
      "critical": 2,
      "high": 1,
      "medium": 3,
      "status": "WARN",
      "note": "filter-select-ui.tsx in Tier 1, business logic in productsHandler, console.log in tasksHandler. Feature structure 5/5 compliant."
    },
    "typescript": {
      "critical": 4,
      "high": 62,
      "medium": 0,
      "status": "WARN",
      "note": "4 any in Edge Functions/scripts. 62 type assertions. 0 @ts-ignore. 132 z.infer usages. Test any (281) properly isolated."
    },
    "accessibility": {
      "critical": 0,
      "high": 0,
      "medium": 1,
      "status": "PASS",
      "note": "WCAG 2.1 AA+ compliant. 84 aria-invalid, 55 aria-describedby, 37 role=alert. 48px touch targets. ~73% focus-visible."
    },
    "performance": {
      "critical": 2,
      "high": 0,
      "medium": 7,
      "status": "WARN",
      "note": "perPage: 500-1000 in reports. 10+ hooks missing pagination. Good memoization (267 hooks, 12 React.memo)."
    },
    "code-quality": {
      "critical": 12,
      "high": 58,
      "medium": 47,
      "status": "WARN",
      "note": "12 as any in tests. 51 large files (500+ lines). 20 console.log. 20 deep nesting files. 174 avg lines/file."
    }
  },
  "critical_issues_summary": [
    {
      "rank": 1,
      "layer": "L1",
      "category": "security",
      "issue": "USING(true) RLS - Product Distributors",
      "location": "20251215054822_08_create_product_distributors.sql:41-51",
      "impact": "ANY authenticated user can CRUD all product-distributor mappings",
      "fix": "Apply dual-auth pattern from migration 20260125000007",
      "status": "OPEN"
    },
    {
      "rank": 2,
      "layer": "L1",
      "category": "security",
      "issue": "USING(true) RLS - Summary Views",
      "location": "20251111121526_add_role_based_permissions.sql:163-325",
      "impact": "Cross-tenant data exposure on contacts, opportunities, organizations",
      "fix": "Add auth.uid() IS NOT NULL AND deleted_at IS NULL",
      "status": "OPEN"
    },
    {
      "rank": 3,
      "layer": "L1",
      "category": "security",
      "issue": "USING(true) RLS - Junction Tables",
      "location": "20251129170506_harden_participant_tables.sql:410-425",
      "impact": "Users can link unauthorized records",
      "fix": "Implement dual foreign key authorization with EXISTS checks",
      "status": "OPEN"
    },
    {
      "rank": 4,
      "layer": "L1",
      "category": "data-integrity",
      "issue": "Hard DELETE in sync RPC",
      "location": "20251029051621_update_sync_rpc_remove_pricing.sql:88",
      "impact": "RPC bypasses soft-delete enforcement",
      "fix": "Update RPC to use UPDATE deleted_at",
      "status": "OPEN"
    },
    {
      "rank": 5,
      "layer": "L1",
      "category": "db-hardening",
      "issue": "segments permissive policy",
      "location": "20251018152315_cloud_schema_fresh.sql",
      "impact": "Any authenticated user can view all segments",
      "fix": "Add auth.uid() IS NOT NULL check",
      "status": "OPEN"
    },
    {
      "rank": 6,
      "layer": "L2",
      "category": "typescript",
      "issue": "any in supabaseAdmin proxy",
      "location": "supabase/functions/_shared/supabaseAdmin.ts:37",
      "impact": "Type safety bypassed for all Supabase admin operations",
      "fix": "Use proper generic type parameter",
      "status": "OPEN"
    },
    {
      "rank": 7,
      "layer": "L2",
      "category": "typescript",
      "issue": "any in updatePassword",
      "location": "supabase/functions/updatePassword/index.ts:13",
      "impact": "No type safety for user object",
      "fix": "Define proper User type from Supabase auth",
      "status": "OPEN"
    },
    {
      "rank": 8,
      "layer": "L3",
      "category": "architecture",
      "issue": "Tier 1 violation",
      "location": "src/components/ui/filter-select-ui.tsx",
      "impact": "React Admin code in dumb UI layer",
      "fix": "Move to src/components/ra-wrappers/",
      "status": "OPEN"
    },
    {
      "rank": 9,
      "layer": "L3",
      "category": "architecture",
      "issue": "Business logic in handler",
      "location": "src/atomic-crm/providers/supabase/handlers/productsHandler.ts",
      "impact": "Handlers should be plumbing only",
      "fix": "Extract RPC calls to ProductsService",
      "status": "OPEN"
    },
    {
      "rank": 10,
      "layer": "L5",
      "category": "workflow-gaps",
      "issue": "Missing activity logging for stage transitions",
      "location": "src/atomic-crm/providers/supabase/callbacks/opportunitiesCallbacks.ts",
      "impact": "Lost audit trail for pipeline progression",
      "fix": "Add afterUpdate callback to log stage changes",
      "status": "OPEN"
    },
    {
      "rank": 11,
      "layer": "L5",
      "category": "workflow-gaps",
      "issue": "Silent status defaults",
      "location": "src/atomic-crm/validation/organizations.ts:189",
      "impact": "Organizations default to 'active' without validation",
      "fix": "Remove .default('active'), require explicit selection",
      "status": "OPEN"
    },
    {
      "rank": 12,
      "layer": "L5",
      "category": "workflow-gaps",
      "issue": "Stage prerequisites not validated",
      "location": "src/atomic-crm/validation/opportunities/opportunities-operations.ts:32-40",
      "impact": "Opportunities advance without required data",
      "fix": "Add business rule refinements",
      "status": "OPEN"
    },
    {
      "rank": 13,
      "layer": "L5",
      "category": "performance",
      "issue": "Large pagination in reports",
      "location": "src/atomic-crm/reports/hooks/useReportData.ts",
      "impact": "perPage: 1000 causes slow loads",
      "fix": "Use server-side aggregation via RPC",
      "status": "OPEN"
    },
    {
      "rank": 14,
      "layer": "L5",
      "category": "performance",
      "issue": "Missing pagination limits",
      "location": "10+ hooks in dashboard/",
      "impact": "No explicit limits on list queries",
      "fix": "Add { page: 1, perPage: 50 }",
      "status": "OPEN"
    }
  ],
  "positive_findings": [
    "Strangler Fig migration COMPLETE (0 unifiedDataProvider lines, 24 handlers)",
    "Error handling 100% withErrorLogging coverage, fail-fast compliant",
    "Zero @ts-ignore directives in entire codebase",
    "132 z.infer usages - strong schema-type derivation",
    "WCAG 2.1 AA+ accessibility: aria-invalid, aria-describedby, role=alert",
    "100% semantic color usage (0 hex codes, 0 hardcoded Tailwind)",
    "48px touch targets exceed WCAG AAA",
    "719 soft-delete RLS filters at database layer",
    "0 direct .delete() calls in application code",
    "267 memoization hooks (99 useMemo, 156 useCallback, 12 React.memo)",
    "All forms use onSubmit/onBlur mode (no onChange performance issues)",
    "23 useWatch usages (proper isolated re-render pattern)"
  ],
  "strangler_fig_status": {
    "unifiedDataProvider_lines": 0,
    "handler_count": 24,
    "status": "COMPLETE"
  },
  "delta_from_previous": {
    "previous_date": "2026-01-25",
    "previous_time": "17:03",
    "previous_critical": 6,
    "previous_high": 17,
    "previous_medium": 24,
    "previous_total": 47,
    "current_critical": 17,
    "current_high": 80,
    "current_medium": 83,
    "current_total": 251,
    "critical_change": 11,
    "high_change": 63,
    "medium_change": 59,
    "total_change": 204,
    "analysis": "Increase due to methodology expansion: TypeScript audit now includes Edge Functions/scripts, code-quality audit added comprehensive checks, performance audit added pagination verification. Core security posture unchanged (same RLS issues). No actual regression."
  },
  "audit_methodology": {
    "type": "Quick 11-Audit Parallel Execution",
    "mode": "quick",
    "batches": 3,
    "batch1_agents": ["security", "data-integrity", "error-handling", "db-hardening"],
    "batch2_agents": ["stale-state", "workflow-gaps", "architecture", "typescript"],
    "batch3_agents": ["accessibility", "performance", "code-quality"],
    "duration_minutes": 21,
    "files_analyzed": 1287,
    "lines_analyzed": 224543,
    "migrations_analyzed": 306
  }
}
