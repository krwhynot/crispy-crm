# Atomic CRM - Database Entity Relationship Diagram

## Overview

The Atomic CRM database is built on PostgreSQL with Supabase integration, featuring a sophisticated architecture with JSONB evolution patterns, comprehensive Row Level Security (RLS), and sales-centric data organization.

## Architecture Summary

- **Database**: PostgreSQL 15 via Supabase
- **Security Model**: Single-tenant with authenticated user access
- **Primary Keys**: bigint GENERATED BY DEFAULT AS IDENTITY
- **Special Features**: JSONB fields, array relationships, automated triggers

## Core Tables

### Authentication Layer

#### `auth.users` (Supabase)
- Supabase authentication system
- Triggers automatic `sales` record creation
- Links to application through `sales.user_id`

### User Management

#### `sales` [RLS Enabled, Has Triggers]
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | bigint IDENTITY | PRIMARY KEY | Sales user identifier |
| `first_name` | text | NOT NULL | User first name |
| `last_name` | text | NOT NULL | User last name |
| `email` | text | NOT NULL | User email |
| `user_id` | uuid | NOT NULL, UNIQUE, FK | Links to auth.users(id) |
| `administrator` | boolean | NOT NULL | Admin privileges flag |
| `avatar` | jsonb | | Profile avatar data |
| `disabled` | boolean | DEFAULT FALSE | Account status |

**Relationships**:
- `user_id` → `auth.users(id)`
- One-to-many with all business entities via `sales_id`

### Business Entities

#### `companies` [RLS Enabled]
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | bigint IDENTITY | PRIMARY KEY | Company identifier |
| `created_at` | timestamptz | NOT NULL, DEFAULT now() | Creation timestamp |
| `name` | text | NOT NULL | Company name |
| `sector` | text | | Industry sector |
| `size` | smallint | | Company size |
| `linkedin_url` | text | | LinkedIn profile |
| `website` | text | | Company website |
| `phone_number` | text | | Primary phone |
| `address` | text | | Street address |
| `zipcode` | text | | Postal code |
| `city` | text | | City |
| `stateAbbr` | text | | State abbreviation |
| `sales_id` | bigint | FK | Assigned sales user |
| `context_links` | json | | Additional links |
| `country` | text | | Country |
| `description` | text | | Company description |
| `revenue` | text | | Revenue information |
| `tax_identifier` | text | | Tax ID |
| `logo` | jsonb | | Company logo data |

**Relationships**:
- `sales_id` → `sales(id)`
- One-to-many with `contacts`, `deals`

#### `contacts` [RLS Enabled, Has Summary View]
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | bigint IDENTITY | PRIMARY KEY | Contact identifier |
| `first_name` | text | | Contact first name |
| `last_name` | text | | Contact last name |
| `gender` | text | | Gender |
| `title` | text | | Job title |
| `email_jsonb` | jsonb | | **EVOLVED**: Email addresses array |
| `phone_jsonb` | jsonb | | **EVOLVED**: Phone numbers array |
| `background` | text | | Contact background |
| `avatar` | jsonb | | Profile avatar |
| `first_seen` | timestamptz | | First interaction |
| `last_seen` | timestamptz | | Last interaction |
| `has_newsletter` | boolean | | Newsletter subscription |
| `status` | text | | Contact status |
| `tags` | bigint[] | ARRAY | Tag references |
| `company_id` | bigint | FK | Parent company |
| `sales_id` | bigint | FK | Assigned sales user |
| `linkedin_url` | text | | LinkedIn profile |

**JSONB Structure**:
- `email_jsonb`: `[{"email": "user@example.com", "type": "Work"}]`
- `phone_jsonb`: `[{"number": "555-1234", "type": "Mobile"}]`

**Relationships**:
- `company_id` → `companies(id)` CASCADE
- `sales_id` → `sales(id)`
- `tags` array → `tags(id)` (logical reference)
- One-to-many with `tasks`, `contactNotes`

#### `deals` [RLS Enabled]
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | bigint IDENTITY | PRIMARY KEY | Deal identifier |
| `name` | text | NOT NULL | Deal name |
| `company_id` | bigint | FK | Associated company |
| `contact_ids` | bigint[] | ARRAY | Associated contacts |
| `category` | text | | Deal category |
| `stage` | text | NOT NULL | Pipeline stage |
| `description` | text | | Deal description |
| `amount` | bigint | | Deal value |
| `created_at` | timestamptz | NOT NULL, DEFAULT now() | Creation date |
| `updated_at` | timestamptz | NOT NULL, DEFAULT now() | Last update |
| `archived_at` | timestamptz | | Archive date |
| `expected_closing_date` | timestamptz | | Expected close |
| `sales_id` | bigint | FK | Assigned sales user |
| `index` | smallint | | Display order |

**Relationships**:
- `company_id` → `companies(id)` CASCADE
- `sales_id` → `sales(id)`
- `contact_ids` array → `contacts(id)` (logical many-to-many)
- One-to-many with `dealNotes`

#### `tags` [RLS Enabled]
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | bigint IDENTITY | PRIMARY KEY | Tag identifier |
| `name` | text | NOT NULL | Tag name |
| `color` | text | NOT NULL, CHECK constraint | **EVOLVED**: Semantic color |

**Color Evolution**: Migrated from hex codes to semantic identifiers:
- Valid colors: 'warm', 'green', 'teal', 'blue', 'purple', 'yellow', 'gray', 'pink'
- Backup table: `tags_color_backup` for rollback capability

#### `tasks` [RLS Enabled]
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | bigint IDENTITY | PRIMARY KEY | Task identifier |
| `contact_id` | bigint | NOT NULL, FK | Associated contact |
| `type` | text | | Task type |
| `text` | text | | Task description |
| `due_date` | timestamptz | NOT NULL | Due date |
| `done_date` | timestamptz | | Completion date |
| `sales_id` | bigint | FK | Assigned to sales user |

**Relationships**:
- `contact_id` → `contacts(id)` CASCADE
- `sales_id` → `sales(id)`

#### `contactNotes` [RLS Enabled]
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | bigint IDENTITY | PRIMARY KEY | Note identifier |
| `contact_id` | bigint | NOT NULL, FK | Associated contact |
| `text` | text | | Note content |
| `date` | timestamptz | DEFAULT now() | Note date |
| `sales_id` | bigint | FK | Note author |
| `status` | text | | Note status |
| `attachments` | jsonb[] | ARRAY | File attachments |

**Relationships**:
- `contact_id` → `contacts(id)` CASCADE
- `sales_id` → `sales(id)` CASCADE

#### `dealNotes` [RLS Enabled]
| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | bigint IDENTITY | PRIMARY KEY | Note identifier |
| `deal_id` | bigint | NOT NULL, FK | Associated deal |
| `type` | text | | Note type |
| `text` | text | | Note content |
| `date` | timestamptz | DEFAULT now() | Note date |
| `sales_id` | bigint | FK | Note author |
| `attachments` | jsonb[] | ARRAY | File attachments |

**Relationships**:
- `deal_id` → `deals(id)` CASCADE
- `sales_id` → `sales(id)`

## Performance Views

### `companies_summary`
Aggregates company data with relationship counts:
- All company fields
- `nb_deals`: Count of associated deals
- `nb_contacts`: Count of associated contacts

**Source**: `companies` + `deals` + `contacts`

### `contacts_summary`
Enhanced contact data with aggregations:
- All contact fields
- `company_name`: Joined company name
- `nb_tasks`: Count of associated tasks
- `email_fts`: Full-text search optimized email data
- `phone_fts`: Full-text search optimized phone data

**Source**: `contacts` + `tasks` + `companies`

### `init_state`
System initialization check:
- `is_initialized`: Count of sales users (indicates if system has users)

**Source**: `sales`

## Security Architecture

### Row Level Security (RLS)
All business tables have RLS enabled with these policy patterns:

- **SELECT**: "Enable read access for authenticated users" `USING (true)`
- **INSERT**: "Enable insert for authenticated users only" `WITH CHECK (true)`
- **UPDATE**: "Enable update for authenticated users only" `USING (true)`
- **DELETE**: "[Table] Delete Policy" `USING (true)`

**Current Model**: Single-tenant with permissive authenticated user access
- All authenticated users can access all data
- Security through application-layer sales assignment
- Suitable for trusted team environments

### Storage Security
- **Bucket**: `attachments` (public bucket)
- **Policies**: RLS-protected SELECT/INSERT/DELETE for authenticated users

## Database Functions & Triggers

### User Provisioning
- **`handle_new_user()`**: Creates sales record when auth.users record is inserted
- **`handle_update_user()`**: Syncs sales data when auth.users is updated
- **Triggers**: `on_auth_user_created`, `on_auth_user_updated`

**Logic**: First user becomes administrator automatically

## Schema Evolution History

### Email JSONB Migration (2025-01-09)
**File**: `20250109152531_email_jsonb.sql`
- Migrated from single `email` text field to `email_jsonb` array
- Format: `[{"email": "user@example.com", "type": "Other"}]`
- Added `email_fts` field for full-text search

### Phone JSONB Migration (2025-01-13)
**File**: `20250113132531_phone_jsonb.sql`
- Migrated from `phone_1_number`, `phone_1_type`, `phone_2_number`, `phone_2_type` to `phone_jsonb`
- Format: `[{"number": "555-1234", "type": "Work"}]`
- Added `phone_fts` field for full-text search

### Tag Color Migration (2024-12-21)
**File**: `20241221120000_migrate_tag_colors.sql`
- Migrated from hex color codes to semantic identifiers
- Added CHECK constraint for valid colors
- Created backup table for rollback capability
- Mapping examples: `#eddcd2` → `'warm'`, `#fff1e6` → `'yellow'`

## Relationship Summary

### Primary Relationships
```
sales (1) ──→ (M) companies
sales (1) ──→ (M) contacts
sales (1) ──→ (M) deals
sales (1) ──→ (M) tasks
sales (1) ──→ (M) contactNotes
sales (1) ──→ (M) dealNotes

companies (1) ──→ (M) contacts
companies (1) ──→ (M) deals

contacts (1) ──→ (M) tasks
contacts (1) ──→ (M) contactNotes

deals (1) ──→ (M) dealNotes
```

### Array Relationships
```
deals.contact_ids ~~~> contacts(id)    [Many-to-Many via array]
contacts.tags ~~~> tags(id)            [Many-to-Many via array]
```

### Special Relationships
```
auth.users (1) ──→ (1) sales           [Via triggers, unique constraint]
```

## Technical Configuration

### Supabase Configuration
**File**: `supabase/config.toml`
- **Project ID**: `atomic-crm-demo`
- **API Port**: 54321
- **Database Port**: 54322
- **Studio Port**: 54323
- **PostgreSQL Version**: 15
- **File Size Limit**: 50MiB

### Required Environment Variables
- `VITE_SUPABASE_URL`: Supabase project URL
- `VITE_SUPABASE_ANON_KEY`: Anonymous access key

## Migration Files Location
All migrations are stored in: `/supabase/migrations/`

Key migration files:
- `20240730075029_init_db.sql` - Initial schema
- `20240730075425_init_triggers.sql` - User provisioning triggers
- `20250109152531_email_jsonb.sql` - Email JSONB migration
- `20250113132531_phone_jsonb.sql` - Phone JSONB migration
- `20241221120000_migrate_tag_colors.sql` - Semantic color migration

---

*This ERD represents the current state of the Atomic CRM database as of the latest migrations. The architecture demonstrates thoughtful evolution from rigid relational structures to flexible JSONB patterns while maintaining data integrity and performance.*