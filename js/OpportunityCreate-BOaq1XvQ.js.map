{"version":3,"file":"OpportunityCreate-BOaq1XvQ.js","sources":["../../src/atomic-crm/tutorial/steps/opportunityCreateFormSteps.ts","../../src/atomic-crm/tutorial/OpportunityCreateFormTutorial.tsx","../../src/atomic-crm/utils/levenshtein.ts","../../src/atomic-crm/opportunities/hooks/useSimilarOpportunityCheck.ts","../../src/atomic-crm/opportunities/forms/OpportunityInputs.tsx","../../src/atomic-crm/opportunities/components/OpportunityCreateSaveButton.tsx","../../src/atomic-crm/opportunities/components/SimilarOpportunitiesDialog.tsx","../../src/atomic-crm/opportunities/OpportunityCreate.tsx"],"sourcesContent":["import type { TutorialStep } from \"../types\";\n\n/**\n * Tutorial steps for the Opportunity Create form ONLY.\n * These steps are standalone and do NOT navigate between pages.\n * Used by OpportunityCreateFormTutorial component.\n *\n * Coverage: Required fields + section headers for discoverability\n */\nexport const opportunityCreateFormSteps: TutorialStep[] = [\n  // Step 1: Welcome (no element - centered modal)\n  {\n    popover: {\n      title: \"Create an Opportunity\",\n      description:\n        \"This form captures a new deal in your sales pipeline. Let me walk you through each field.\",\n      align: \"center\",\n    },\n  },\n  // Step 2: Name\n  {\n    element: '[data-tutorial=\"opp-name\"]',\n    popover: {\n      title: \"Opportunity Name\",\n      description:\n        'Give this deal a clear name. Convention: \"[Customer] - [Principal] - [Context]\" e.g., \"ABC Restaurant - Sysco Authorization\"',\n      side: \"bottom\",\n    },\n  },\n  // Step 3: Customer Organization\n  {\n    element: '[data-tutorial=\"opp-customer\"]',\n    popover: {\n      title: \"Customer Organization\",\n      description:\n        'Select the customer (Operator or Distributor) pursuing this deal. Use the \"+\" button to create a new customer inline.',\n      side: \"right\",\n    },\n  },\n  // Step 4: Principal Organization\n  {\n    element: '[data-tutorial=\"opp-principal\"]',\n    popover: {\n      title: \"Principal Organization\",\n      description:\n        \"Which Principal (manufacturer) does this opportunity represent? Each opportunity is linked to exactly one Principal.\",\n      side: \"left\",\n    },\n  },\n  // Step 5: Stage\n  {\n    element: '[data-tutorial=\"opp-stage\"]',\n    popover: {\n      title: \"Pipeline Stage\",\n      description:\n        \"Track progress: New Lead → Initial Outreach → Sample/Visit → Feedback → Demo → Closed Won/Lost\",\n      side: \"bottom\",\n    },\n  },\n  // Step 6: Priority\n  {\n    element: '[data-tutorial=\"opp-priority\"]',\n    popover: {\n      title: \"Priority Level\",\n      description:\n        \"Set urgency: Low, Medium, High, or Critical. Helps prioritize your weekly focus.\",\n      side: \"bottom\",\n    },\n  },\n  // Step 7: Close Date\n  {\n    element: '[data-tutorial=\"opp-close-date\"]',\n    popover: {\n      title: \"Estimated Close Date\",\n      description: \"When do you expect this deal to close? This drives pipeline forecasting.\",\n      side: \"bottom\",\n    },\n  },\n  // Step 8: Account Manager\n  {\n    element: '[data-tutorial=\"opp-account-manager\"]',\n    popover: {\n      title: \"Account Manager\",\n      description: \"Assign the team member responsible for this opportunity (defaults to you).\",\n      side: \"right\",\n    },\n  },\n  // Step 9: Distributor\n  {\n    element: '[data-tutorial=\"opp-distributor\"]',\n    popover: {\n      title: \"Distributor Organization\",\n      description:\n        \"Optional: If this deal involves a specific distributor, select it here. Shows authorization warnings if not authorized.\",\n      side: \"left\",\n    },\n  },\n  // Step 10: Contacts\n  {\n    element: '[data-tutorial=\"opp-contacts\"]',\n    popover: {\n      title: \"Related Contacts\",\n      description:\n        \"Link key people involved in this deal. Contacts are filtered by the selected Customer Organization.\",\n      side: \"top\",\n    },\n  },\n  // Step 11: Products\n  {\n    element: '[data-tutorial=\"opp-products\"]',\n    popover: {\n      title: \"Products\",\n      description:\n        \"Add products from the Principal's catalog. At least one product is required. Add notes for each product.\",\n      side: \"top\",\n    },\n  },\n  // Step 12: Classification Section Header\n  {\n    element: '[data-tutorial=\"opp-section-classification\"]',\n    popover: {\n      title: \"Classification Section\",\n      description: \"Optional fields for tracking how opportunities are sourced and categorized.\",\n      side: \"top\",\n    },\n  },\n  // Step 13: Lead Source\n  {\n    element: '[data-tutorial=\"opp-lead-source\"]',\n    popover: {\n      title: \"Lead Source\",\n      description:\n        'Where did this lead come from? Examples: \"Referral\", \"Trade Show\", \"Cold Call\", \"Website Inquiry\".',\n      side: \"right\",\n    },\n  },\n  // Step 14: Campaign\n  {\n    element: '[data-tutorial=\"opp-campaign\"]',\n    popover: {\n      title: \"Campaign\",\n      description:\n        'Link this opportunity to a marketing campaign for tracking ROI. Example: \"Q4 2025 Trade Show\".',\n      side: \"left\",\n    },\n  },\n  // Step 15: Additional Details Section Header\n  {\n    element: '[data-tutorial=\"opp-section-details\"]',\n    popover: {\n      title: \"Additional Details\",\n      description: \"Optional fields for context, planning, and notes.\",\n      side: \"top\",\n    },\n  },\n  // Step 16: Description\n  {\n    element: '[data-tutorial=\"opp-description\"]',\n    popover: {\n      title: \"Description\",\n      description:\n        \"Summarize what this opportunity is about - the products, customer needs, or deal context.\",\n      side: \"bottom\",\n    },\n  },\n  // Step 17: Next Action\n  {\n    element: '[data-tutorial=\"opp-next-action\"]',\n    popover: {\n      title: \"Next Action\",\n      description:\n        \"What's the next step to move this deal forward? Keep it specific and actionable.\",\n      side: \"right\",\n    },\n  },\n  // Step 18: Next Action Date\n  {\n    element: '[data-tutorial=\"opp-next-action-date\"]',\n    popover: {\n      title: \"Next Action Date\",\n      description:\n        \"When should the next action be completed? This helps with task planning and follow-ups.\",\n      side: \"left\",\n    },\n  },\n  // Step 19: Save Button\n  {\n    element: '[data-tutorial=\"opp-save-btn\"]',\n    popover: {\n      title: \"Create Opportunity\",\n      description:\n        \"Click to create the opportunity. Similar name detection will warn if a duplicate might exist.\",\n      side: \"top\",\n    },\n  },\n  // Step 20: Completion\n  {\n    popover: {\n      title: \"Ready to Create!\",\n      description:\n        \"You now know all the fields. Fill out the required fields (*) and click Create Opportunity.\",\n      align: \"center\",\n    },\n  },\n];\n","import { useRef, useCallback, useState, useEffect } from \"react\";\nimport { useLocation } from \"react-router-dom\";\nimport { HelpCircle } from \"lucide-react\";\nimport { driver, type Driver, type Config } from \"driver.js\";\nimport \"driver.js/dist/driver.css\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { opportunityCreateFormSteps } from \"./steps/opportunityCreateFormSteps\";\nimport { waitForElement, filterValidSteps } from \"./waitForElement\";\n\n/**\n * Standalone floating tutorial button for the Opportunity Create form.\n *\n * Key differences from PageTutorialTrigger:\n * - Does NOT use TutorialProvider/useTutorial context\n * - No auto-start on first visit (click-only trigger)\n * - Page-specific: Only renders on /opportunities/create\n * - Uses create-form-only steps (no cross-page navigation)\n * - No progress persistence\n */\nexport function OpportunityCreateFormTutorial() {\n  const location = useLocation();\n  const driverRef = useRef<Driver | null>(null);\n  const [isActive, setIsActive] = useState(false);\n\n  // Only render on /opportunities/create\n  const isCreatePage = location.pathname === \"/opportunities/create\";\n\n  // Cleanup on unmount\n  useEffect(() => {\n    return () => {\n      if (driverRef.current) {\n        driverRef.current.destroy();\n        driverRef.current = null;\n      }\n    };\n  }, []);\n\n  const startTutorial = useCallback(async () => {\n    // Destroy any existing instance\n    if (driverRef.current) {\n      driverRef.current.destroy();\n      driverRef.current = null;\n    }\n\n    // Filter to only steps with existing elements\n    const validSteps = filterValidSteps(opportunityCreateFormSteps);\n\n    // For the first step with an element, wait for it to be ready\n    const firstElementStep = validSteps.find((s) => s.element);\n    if (firstElementStep?.element) {\n      try {\n        await waitForElement(firstElementStep.element, 3000);\n      } catch {\n        console.warn(\"Tutorial: First element not found, starting anyway\");\n      }\n    }\n\n    const config: Config = {\n      showProgress: true,\n      animate: true,\n      smoothScroll: true,\n      allowClose: true,\n      allowKeyboardControl: true,\n      overlayColor: \"rgba(0, 0, 0, 0.75)\",\n      popoverClass: \"tutorial-popover\",\n      showButtons: [\"next\", \"previous\", \"close\"],\n      nextBtnText: \"Next\",\n      prevBtnText: \"Back\",\n      doneBtnText: \"Got it!\",\n\n      steps: validSteps.map((step) => ({\n        element: step.element,\n        popover: {\n          title: step.popover.title,\n          description: step.popover.description,\n          side: step.popover.side,\n          align: step.popover.align,\n        },\n      })),\n\n      onDestroyed: () => {\n        setIsActive(false);\n        driverRef.current = null;\n      },\n    };\n\n    try {\n      driverRef.current = driver(config);\n      setIsActive(true);\n      driverRef.current.drive();\n    } catch (error) {\n      console.error(\"Failed to start create form tutorial:\", error);\n      setIsActive(false);\n      driverRef.current = null;\n    }\n  }, []);\n\n  // Don't render if not on create page or if tutorial is active\n  if (!isCreatePage || isActive) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed bottom-4 left-4 z-50\">\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Button\n            variant=\"default\"\n            size=\"icon\"\n            onClick={startTutorial}\n            className=\"h-11 w-11 rounded-full shadow-lg bg-primary text-primary-foreground hover:scale-105 transition-transform\"\n            aria-label=\"Start form tutorial\"\n          >\n            <HelpCircle className=\"h-5 w-5\" />\n          </Button>\n        </TooltipTrigger>\n        <TooltipContent side=\"right\">\n          <p>Learn about this form</p>\n        </TooltipContent>\n      </Tooltip>\n    </div>\n  );\n}\n","/**\n * Levenshtein Distance Utility\n *\n * Implements fuzzy string matching using the Levenshtein algorithm to detect\n * similar opportunity names. Used to warn users when creating opportunities\n * with names similar to existing ones.\n *\n * Per Engineering Constitution P1: Fail-fast - returns results immediately\n * without complex retry logic or circuit breakers.\n */\n\n/**\n * Calculate the Levenshtein distance between two strings.\n *\n * The Levenshtein distance is the minimum number of single-character edits\n * (insertions, deletions, or substitutions) required to transform one string\n * into another.\n *\n * @param a - First string to compare\n * @param b - Second string to compare\n * @returns The edit distance between the two strings (0 = identical)\n *\n * @example\n * ```typescript\n * levenshteinDistance(\"kitten\", \"sitting\") // 3\n * levenshteinDistance(\"hello\", \"hello\") // 0\n * levenshteinDistance(\"ABC Corp\", \"ABC Corp\") // 0\n * levenshteinDistance(\"ABC Corp\", \"ABC Crop\") // 1\n * ```\n */\nexport function levenshteinDistance(a: string, b: string): number {\n  // Normalize strings: lowercase and trim for case-insensitive comparison\n  const str1 = a.toLowerCase().trim();\n  const str2 = b.toLowerCase().trim();\n\n  // Early exit for identical strings\n  if (str1 === str2) return 0;\n\n  // Early exit for empty strings\n  if (str1.length === 0) return str2.length;\n  if (str2.length === 0) return str1.length;\n\n  // Create distance matrix using Wagner-Fischer algorithm\n  // Space optimization: only keep two rows at a time\n  const len1 = str1.length;\n  const len2 = str2.length;\n\n  // Initialize previous row (representing distances from empty string to str2)\n  let prevRow = Array.from({ length: len2 + 1 }, (_, i) => i);\n  let currRow = new Array(len2 + 1);\n\n  for (let i = 1; i <= len1; i++) {\n    // First element is distance from str1[0..i] to empty string\n    currRow[0] = i;\n\n    for (let j = 1; j <= len2; j++) {\n      const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;\n\n      currRow[j] = Math.min(\n        prevRow[j] + 1, // Deletion\n        currRow[j - 1] + 1, // Insertion\n        prevRow[j - 1] + cost // Substitution\n      );\n    }\n\n    // Swap rows for next iteration\n    [prevRow, currRow] = [currRow, prevRow];\n  }\n\n  // Result is in prevRow after the last swap\n  return prevRow[len2];\n}\n\n/**\n * Information about a similar opportunity match\n */\nexport interface SimilarOpportunity {\n  id: string | number;\n  name: string;\n  distance: number;\n  stage: string;\n  customer_organization_name?: string;\n  principal_organization_name?: string;\n}\n\n/**\n * Parameters for finding similar opportunities\n */\nexport interface FindSimilarParams {\n  /** The name to check for similarities */\n  name: string;\n  /** Maximum Levenshtein distance to consider as \"similar\" (default: 3) */\n  threshold?: number;\n  /** Optional: Exclude this opportunity ID from results (for edit mode) */\n  excludeId?: string | number;\n}\n\n/**\n * Result of similarity check\n */\nexport interface SimilarityCheckResult {\n  /** Whether any similar opportunities were found */\n  hasSimilar: boolean;\n  /** List of similar opportunities, sorted by distance (closest first) */\n  matches: SimilarOpportunity[];\n}\n\n/**\n * Find opportunities with names similar to the provided name.\n *\n * Uses Levenshtein distance algorithm to identify near-matches that might\n * indicate duplicate entries. Default threshold of 3 catches:\n * - Typos: \"ABC Corp\" vs \"ABC Crop\" (distance: 1)\n * - Plural variations: \"Widget\" vs \"Widgets\" (distance: 1)\n * - Minor differences: \"ABC Corp - Q1\" vs \"ABC Corp - Q2\" (distance: 1)\n * - Small additions: \"ABC Corp\" vs \"ABC Corp Inc\" (distance: 4, above threshold)\n *\n * @param opportunities - Array of existing opportunities to check against\n * @param params - Search parameters including name and threshold\n * @returns Object containing whether similar items exist and the matches\n *\n * @example\n * ```typescript\n * const result = findSimilarOpportunities(existingOpps, {\n *   name: \"ABC Corp - Widget Deal\",\n *   threshold: 3,\n * });\n *\n * if (result.hasSimilar) {\n *   // Show warning dialog with result.matches\n * }\n * ```\n */\nexport function findSimilarOpportunities(\n  opportunities: Array<{\n    id: string | number;\n    name: string;\n    stage: string;\n    customer_organization_name?: string;\n    principal_organization_name?: string;\n  }>,\n  params: FindSimilarParams\n): SimilarityCheckResult {\n  const { name, threshold = 3, excludeId } = params;\n\n  // Validate input\n  if (!name || name.trim().length === 0) {\n    return { hasSimilar: false, matches: [] };\n  }\n\n  const normalizedName = name.toLowerCase().trim();\n\n  // Filter and map opportunities\n  const matches: SimilarOpportunity[] = opportunities\n    .filter((opp) => {\n      // Exclude the current opportunity if editing\n      if (excludeId !== undefined && opp.id === excludeId) {\n        return false;\n      }\n      // Skip opportunities without names\n      if (!opp.name || opp.name.trim().length === 0) {\n        return false;\n      }\n      return true;\n    })\n    .map((opp) => ({\n      id: opp.id,\n      name: opp.name,\n      distance: levenshteinDistance(normalizedName, opp.name),\n      stage: opp.stage,\n      customer_organization_name: opp.customer_organization_name,\n      principal_organization_name: opp.principal_organization_name,\n    }))\n    .filter((match) => match.distance <= threshold && match.distance > 0) // Exclude exact matches (distance 0)\n    .sort((a, b) => a.distance - b.distance); // Sort by distance (closest first)\n\n  return {\n    hasSimilar: matches.length > 0,\n    matches,\n  };\n}\n\n/**\n * Check if a name is \"too similar\" to any existing opportunity.\n *\n * Convenience function that returns just a boolean, useful for validation.\n *\n * @param opportunities - Array of existing opportunities\n * @param name - Name to check\n * @param threshold - Maximum distance to consider similar (default: 3)\n * @returns true if similar opportunities exist\n */\nexport function hasSimilarOpportunity(\n  opportunities: Array<{ id: string | number; name: string; stage: string }>,\n  name: string,\n  threshold = 3\n): boolean {\n  return findSimilarOpportunities(opportunities, { name, threshold }).hasSimilar;\n}\n","/**\n * useSimilarOpportunityCheck Hook\n *\n * Manages the state and logic for checking if an opportunity name is similar\n * to existing opportunities using Levenshtein distance algorithm.\n *\n * Features:\n * - Debounced checking to avoid excessive API calls\n * - Caches opportunity list with React Query\n * - Returns dialog state and handlers for integration with forms\n *\n * Per Engineering Constitution:\n * - P1: Fail-fast - no retry logic or circuit breakers\n * - P2: Uses React Admin's useGetList as single entry point for data\n */\n\nimport { useState, useCallback, useMemo } from \"react\";\nimport { useGetList } from \"ra-core\";\nimport {\n  findSimilarOpportunities,\n  type SimilarOpportunity,\n  type SimilarityCheckResult,\n} from \"../../utils/levenshtein\";\n\n/** Default Levenshtein distance threshold for similarity detection */\nconst DEFAULT_THRESHOLD = 3;\n\n/**\n * Opportunity record shape expected from the API\n */\ninterface OpportunityRecord {\n  id: string | number;\n  name: string;\n  stage: string;\n  customer_organization_id?: string | number;\n  principal_organization_id?: string | number;\n  deleted_at?: string | null;\n}\n\n/**\n * Extended opportunity with organization names for display\n */\ninterface OpportunityWithOrgs extends OpportunityRecord {\n  customer_organization_name?: string;\n  principal_organization_name?: string;\n}\n\n/**\n * Hook return type\n */\nexport interface UseSimilarOpportunityCheckResult {\n  /** Check if a name has similar opportunities and show dialog if found */\n  checkForSimilar: (name: string) => SimilarityCheckResult;\n  /** Whether the dialog should be shown */\n  showDialog: boolean;\n  /** Close the dialog (user clicked \"Go Back\") */\n  closeDialog: () => void;\n  /** Confirm creation despite warning (user clicked \"Create Anyway\") */\n  confirmCreate: () => void;\n  /** The proposed name that was checked */\n  proposedName: string;\n  /** List of similar opportunities found */\n  similarOpportunities: SimilarOpportunity[];\n  /** Whether the initial opportunity list is loading */\n  isLoading: boolean;\n  /** Whether the user has confirmed to proceed despite warning */\n  hasConfirmed: boolean;\n  /** Reset the confirmation state (e.g., when form values change) */\n  resetConfirmation: () => void;\n}\n\n/**\n * Hook options\n */\nexport interface UseSimilarOpportunityCheckOptions {\n  /** Levenshtein distance threshold (default: 3) */\n  threshold?: number;\n  /** Opportunity ID to exclude from check (for edit mode) */\n  excludeId?: string | number;\n  /** Whether to skip the check entirely */\n  disabled?: boolean;\n}\n\n/**\n * Custom hook for checking opportunity name similarity\n *\n * @example\n * ```tsx\n * const {\n *   checkForSimilar,\n *   showDialog,\n *   closeDialog,\n *   confirmCreate,\n *   proposedName,\n *   similarOpportunities,\n *   hasConfirmed,\n * } = useSimilarOpportunityCheck();\n *\n * const handleSubmit = (values) => {\n *   const result = checkForSimilar(values.name);\n *   if (result.hasSimilar && !hasConfirmed) {\n *     return; // Dialog will be shown\n *   }\n *   // Proceed with creation\n * };\n * ```\n */\nexport function useSimilarOpportunityCheck(\n  options: UseSimilarOpportunityCheckOptions = {}\n): UseSimilarOpportunityCheckResult {\n  const { threshold = DEFAULT_THRESHOLD, excludeId, disabled = false } = options;\n\n  // State for dialog management\n  const [showDialog, setShowDialog] = useState(false);\n  const [proposedName, setProposedName] = useState(\"\");\n  const [similarOpportunities, setSimilarOpportunities] = useState<SimilarOpportunity[]>([]);\n  const [hasConfirmed, setHasConfirmed] = useState(false);\n\n  // Fetch all active opportunities for comparison\n  // Using a large perPage to get all opportunities for client-side comparison\n  // In production with many opportunities, consider a server-side endpoint\n  const { data: opportunities = [], isLoading } = useGetList<OpportunityWithOrgs>(\n    \"opportunities\",\n    {\n      pagination: { page: 1, perPage: 1000 },\n      sort: { field: \"name\", order: \"ASC\" },\n      filter: {\n        // Exclude soft-deleted and closed opportunities\n        \"deleted_at@is\": null,\n        // Only check against active opportunities\n        \"stage@not_in\": [\"closed_won\", \"closed_lost\"],\n      },\n    },\n    {\n      enabled: !disabled,\n      staleTime: 5 * 60 * 1000, // Cache for 5 minutes\n    }\n  );\n\n  // Memoize the opportunity list for comparison\n  const opportunityList = useMemo(() => {\n    return opportunities.map((opp) => ({\n      id: opp.id,\n      name: opp.name,\n      stage: opp.stage,\n      customer_organization_name: opp.customer_organization_name,\n      principal_organization_name: opp.principal_organization_name,\n    }));\n  }, [opportunities]);\n\n  /**\n   * Check if the given name is similar to existing opportunities\n   */\n  const checkForSimilar = useCallback(\n    (name: string): SimilarityCheckResult => {\n      // Skip if disabled, already confirmed, or name is empty\n      if (disabled || hasConfirmed || !name || name.trim().length === 0) {\n        return { hasSimilar: false, matches: [] };\n      }\n\n      const result = findSimilarOpportunities(opportunityList, {\n        name,\n        threshold,\n        excludeId,\n      });\n\n      if (result.hasSimilar) {\n        setProposedName(name);\n        setSimilarOpportunities(result.matches);\n        setShowDialog(true);\n      }\n\n      return result;\n    },\n    [disabled, hasConfirmed, opportunityList, threshold, excludeId]\n  );\n\n  /**\n   * Close the dialog without confirming (Go Back)\n   */\n  const closeDialog = useCallback(() => {\n    setShowDialog(false);\n  }, []);\n\n  /**\n   * Confirm creation despite warning (Create Anyway)\n   */\n  const confirmCreate = useCallback(() => {\n    setHasConfirmed(true);\n    setShowDialog(false);\n  }, []);\n\n  /**\n   * Reset the confirmation state (call when form values change significantly)\n   */\n  const resetConfirmation = useCallback(() => {\n    setHasConfirmed(false);\n    setSimilarOpportunities([]);\n    setProposedName(\"\");\n  }, []);\n\n  return {\n    checkForSimilar,\n    showDialog,\n    closeDialog,\n    confirmCreate,\n    proposedName,\n    similarOpportunities,\n    isLoading,\n    hasConfirmed,\n    resetConfirmation,\n  };\n}\n","import { useFormState } from \"react-hook-form\";\nimport { FormErrorSummary } from \"@/components/admin/FormErrorSummary\";\nimport { OpportunityCompactForm } from \"./OpportunityCompactForm\";\n\nconst OPPORTUNITY_FIELD_LABELS: Record<string, string> = {\n  name: \"Opportunity Name\",\n  customer_organization_id: \"Customer Organization\",\n  principal_organization_id: \"Principal Organization\",\n  stage: \"Stage\",\n  priority: \"Priority\",\n  estimated_close_date: \"Est. Close Date\",\n  account_manager_id: \"Account Manager\",\n  distributor_organization_id: \"Distributor Organization\",\n  contact_ids: \"Contacts\",\n  lead_source: \"Lead Source\",\n  campaign: \"Campaign\",\n  description: \"Description\",\n  next_action: \"Next Action\",\n  next_action_date: \"Next Action Date\",\n  decision_criteria: \"Decision Criteria\",\n  notes: \"Notes\",\n};\n\ninterface OpportunityInputsProps {\n  mode: \"create\" | \"edit\";\n}\n\nexport const OpportunityInputs = ({ mode }: OpportunityInputsProps) => {\n  const { errors } = useFormState();\n  const hasErrors = Object.keys(errors || {}).length > 0;\n\n  return (\n    <div className=\"flex flex-col gap-4\">\n      {hasErrors && (\n        <FormErrorSummary\n          errors={errors}\n          fieldLabels={OPPORTUNITY_FIELD_LABELS}\n          defaultExpanded={Object.keys(errors).length <= 3}\n        />\n      )}\n      <OpportunityCompactForm mode={mode} />\n    </div>\n  );\n};\n","/**\n * OpportunityCreateSaveButton\n *\n * Custom SaveButton for opportunity creation that integrates with the\n * Levenshtein fuzzy match warning system. Intercepts form submission\n * to check for similar opportunities before saving.\n *\n * Follows the existing SaveButton pattern from src/components/admin/form.tsx\n * but adds pre-submission validation for duplicate detection.\n */\n\nimport { useCallback, useEffect, useRef, type MouseEvent } from \"react\";\nimport { useFormContext, useFormState, useWatch } from \"react-hook-form\";\nimport { setSubmissionErrors, useSaveContext, useTranslate, useRecordFromLocation } from \"ra-core\";\nimport { Loader2, Save } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport type { SimilarityCheckResult } from \"../../utils/levenshtein\";\n\nexport interface OpportunityCreateSaveButtonProps {\n  /** Function to check for similar opportunities */\n  checkForSimilar: (name: string) => SimilarityCheckResult;\n  /** Whether user has confirmed to proceed despite warning */\n  hasConfirmed: boolean;\n  /** Reset confirmation state when form values change */\n  resetConfirmation: () => void;\n  /** Button label (default: \"Create Opportunity\") */\n  label?: string;\n  /** Additional CSS classes */\n  className?: string;\n}\n\n/**\n * SaveButton that checks for similar opportunities before submission.\n *\n * When clicked:\n * 1. Gets the current \"name\" field value from the form\n * 2. Runs Levenshtein similarity check against existing opportunities\n * 3. If similar found AND not confirmed: blocks submission, shows dialog\n * 4. If no similar OR already confirmed: proceeds with normal save\n */\nexport function OpportunityCreateSaveButton({\n  checkForSimilar,\n  hasConfirmed,\n  resetConfirmation,\n  label = \"Create Opportunity\",\n  className,\n}: OpportunityCreateSaveButtonProps) {\n  const translate = useTranslate();\n  const form = useFormContext();\n  const saveContext = useSaveContext();\n  const { dirtyFields, isValidating, isSubmitting } = useFormState();\n\n  // Track previous name value to reset confirmation when name changes\n  const previousNameRef = useRef<string | null>(null);\n\n  // Watch the name field for changes\n  const currentName = useWatch({ control: form.control, name: \"name\" });\n\n  // Reset confirmation when name changes significantly\n  useEffect(() => {\n    if (previousNameRef.current !== null && previousNameRef.current !== currentName) {\n      resetConfirmation();\n    }\n    previousNameRef.current = currentName;\n  }, [currentName, resetConfirmation]);\n\n  // Calculate disabled state (same logic as standard SaveButton)\n  const isDirty = Object.keys(dirtyFields).length > 0;\n  const recordFromLocation = useRecordFromLocation();\n  const disabled = (!isDirty && recordFromLocation == null) || isValidating || isSubmitting;\n\n  /**\n   * Handle form submission through React Admin's save context\n   */\n  const handleSubmit = useCallback(\n    async (values: any) => {\n      let errors;\n      if (saveContext?.save) {\n        errors = await saveContext.save(values, {});\n      }\n      if (errors != null) {\n        setSubmissionErrors(errors, form.setError);\n      }\n    },\n    [form.setError, saveContext]\n  );\n\n  /**\n   * Intercept click to check for similar opportunities first\n   */\n  const handleClick = useCallback(\n    async (event: MouseEvent<HTMLButtonElement>) => {\n      event.preventDefault();\n      event.stopPropagation();\n\n      // Get current form values\n      const values = form.getValues();\n      const name = values.name;\n\n      // Skip check if already confirmed or name is empty\n      if (!hasConfirmed && name && name.trim().length > 0) {\n        const result = checkForSimilar(name);\n\n        // If similar opportunities found, don't submit - dialog will show\n        if (result.hasSimilar) {\n          return;\n        }\n      }\n\n      // No similar opportunities or already confirmed - proceed with save\n      // Trigger form validation and submission\n      await form.handleSubmit(handleSubmit)(event);\n    },\n    [form, hasConfirmed, checkForSimilar, handleSubmit]\n  );\n\n  const displayedLabel = translate(label, { _: label });\n\n  return (\n    <Button\n      type=\"button\" // Use button type to prevent default form submission\n      variant=\"default\"\n      disabled={disabled}\n      onClick={handleClick}\n      data-tutorial=\"opp-save-btn\"\n      className={cn(\n        \"h-11 min-w-[160px]\", // 44px height for touch target\n        disabled ? \"opacity-50 cursor-not-allowed\" : \"cursor-pointer\",\n        className\n      )}\n    >\n      {isSubmitting ? (\n        <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n      ) : (\n        <Save className=\"mr-2 h-4 w-4\" />\n      )}\n      {displayedLabel}\n    </Button>\n  );\n}\n","/**\n * SimilarOpportunitiesDialog\n *\n * Displays a warning dialog when the user attempts to create an opportunity\n * with a name similar to existing opportunities. Uses Levenshtein distance\n * algorithm to detect near-matches (threshold: 3 edits).\n *\n * Follows design system:\n * - Semantic colors (text-muted-foreground, bg-warning, etc.)\n * - 44px minimum touch targets\n * - Desktop-first responsive design (lg: breakpoint)\n */\n\nimport { AlertTriangle } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport type { SimilarOpportunity } from \"../../utils/levenshtein\";\nimport { getOpportunityStageLabel, getOpportunityStageColor } from \"../constants/stageConstants\";\n\nexport interface SimilarOpportunitiesDialogProps {\n  /** Whether the dialog is open */\n  open: boolean;\n  /** Callback when user closes dialog (go back) */\n  onClose: () => void;\n  /** Callback when user confirms creation despite warning */\n  onConfirm: () => void;\n  /** The name the user is trying to create */\n  proposedName: string;\n  /** List of similar existing opportunities */\n  similarOpportunities: SimilarOpportunity[];\n  /** Whether the confirm action is loading */\n  isLoading?: boolean;\n}\n\n/**\n * Get a human-readable similarity description based on edit distance\n */\nfunction getSimilarityLabel(distance: number): string {\n  if (distance === 1) return \"Very Similar\";\n  if (distance === 2) return \"Similar\";\n  return \"Somewhat Similar\";\n}\n\n/**\n * Get badge variant based on similarity (lower distance = higher severity)\n */\nfunction getSimilarityVariant(distance: number): \"destructive\" | \"warning\" | \"secondary\" {\n  if (distance === 1) return \"destructive\";\n  if (distance === 2) return \"warning\";\n  return \"secondary\";\n}\n\nexport function SimilarOpportunitiesDialog({\n  open,\n  onClose,\n  onConfirm,\n  proposedName,\n  similarOpportunities,\n  isLoading = false,\n}: SimilarOpportunitiesDialogProps) {\n  return (\n    <Dialog open={open} onOpenChange={(isOpen) => !isOpen && onClose()}>\n      <DialogContent className=\"sm:max-w-2xl\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2 text-warning\">\n            <AlertTriangle className=\"h-5 w-5\" />\n            Similar Opportunities Found\n          </DialogTitle>\n          <DialogDescription className=\"text-muted-foreground\">\n            The opportunity name <strong className=\"text-foreground\">\"{proposedName}\"</strong> is\n            similar to {similarOpportunities.length} existing{\" \"}\n            {similarOpportunities.length === 1 ? \"opportunity\" : \"opportunities\"}. Please review\n            before proceeding to avoid duplicates.\n          </DialogDescription>\n        </DialogHeader>\n\n        {/* Similar opportunities table */}\n        <div className=\"max-h-64 overflow-y-auto rounded-md border border-border\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead className=\"w-[40%]\">Name</TableHead>\n                <TableHead className=\"w-[20%]\">Stage</TableHead>\n                <TableHead className=\"w-[20%]\">Principal</TableHead>\n                <TableHead className=\"w-[20%] text-right\">Similarity</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {similarOpportunities.map((opp) => (\n                <TableRow key={opp.id} className=\"hover:bg-muted/50\">\n                  <TableCell className=\"font-medium\">{opp.name}</TableCell>\n                  <TableCell>\n                    <span\n                      className=\"inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium\"\n                      style={{\n                        backgroundColor: getOpportunityStageColor(opp.stage),\n                        color: \"var(--text-on-color)\",\n                      }}\n                    >\n                      {getOpportunityStageLabel(opp.stage)}\n                    </span>\n                  </TableCell>\n                  <TableCell className=\"text-muted-foreground\">\n                    {opp.principal_organization_name || \"—\"}\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <Badge variant={getSimilarityVariant(opp.distance)}>\n                      {getSimilarityLabel(opp.distance)}\n                    </Badge>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </div>\n\n        {/* Help text */}\n        <p className=\"text-sm text-muted-foreground\">\n          <strong>Tip:</strong> If this is a different opportunity, consider making the name more\n          distinct (e.g., add a date, product name, or campaign identifier).\n        </p>\n\n        <DialogFooter className=\"flex-col gap-2 sm:flex-row sm:justify-end\">\n          <Button\n            type=\"button\"\n            variant=\"outline\"\n            onClick={onClose}\n            disabled={isLoading}\n            className=\"h-11 min-w-[120px]\"\n          >\n            Go Back\n          </Button>\n          <Button\n            type=\"button\"\n            variant=\"default\"\n            onClick={onConfirm}\n            disabled={isLoading}\n            className=\"h-11 min-w-[150px]\"\n          >\n            {isLoading ? \"Creating...\" : \"Create Anyway\"}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","import { CreateBase, Form, useGetIdentity } from \"ra-core\";\nimport { useFormState } from \"react-hook-form\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { CancelButton } from \"@/components/admin/cancel-button\";\nimport { FormErrorSummary } from \"@/components/admin/FormErrorSummary\";\nimport { FormToolbar } from \"../layout/FormToolbar\";\nimport { OpportunityInputs } from \"./forms/OpportunityInputs\";\nimport { opportunitySchema } from \"../validation/opportunities\";\nimport { OpportunityCreateSaveButton } from \"./components/OpportunityCreateSaveButton\";\nimport { SimilarOpportunitiesDialog } from \"./components/SimilarOpportunitiesDialog\";\nimport { useSimilarOpportunityCheck } from \"./hooks/useSimilarOpportunityCheck\";\nimport { OpportunityCreateFormTutorial } from \"../tutorial/OpportunityCreateFormTutorial\";\n\nconst OpportunityCreate = () => {\n  const { data: identity } = useGetIdentity();\n\n  // Fuzzy match warning system (Levenshtein threshold: 3)\n  const {\n    checkForSimilar,\n    showDialog,\n    closeDialog,\n    confirmCreate,\n    proposedName,\n    similarOpportunities,\n    hasConfirmed,\n    resetConfirmation,\n  } = useSimilarOpportunityCheck();\n\n  // Generate defaults from schema, then merge with identity-specific values\n  // Per Constitution #5: FORM STATE DERIVED FROM TRUTH\n  // Use .partial() to make all fields optional during default generation\n  // This extracts fields with .default() (stage, priority, estimated_close_date)\n  // Explicitly initialize array fields for React Hook Form to track them:\n  const formDefaults = {\n    ...opportunitySchema.partial().parse({}),\n    opportunity_owner_id: identity?.id,\n    account_manager_id: identity?.id,\n    contact_ids: [], // Explicitly initialize for ReferenceArrayInput\n    products_to_sync: [], // Explicitly initialize for ArrayInput\n  };\n\n  return (\n    <CreateBase redirect=\"show\">\n      <div className=\"bg-muted px-6 py-6\">\n        <div className=\"max-w-4xl mx-auto create-form-card\">\n          <Form defaultValues={formDefaults}>\n            <Card>\n              <CardContent>\n                <OpportunityFormContent\n                  checkForSimilar={checkForSimilar}\n                  hasConfirmed={hasConfirmed}\n                  resetConfirmation={resetConfirmation}\n                />\n              </CardContent>\n            </Card>\n          </Form>\n        </div>\n      </div>\n\n      {/* Similar Opportunities Warning Dialog */}\n      <SimilarOpportunitiesDialog\n        open={showDialog}\n        onClose={closeDialog}\n        onConfirm={confirmCreate}\n        proposedName={proposedName}\n        similarOpportunities={similarOpportunities}\n      />\n\n      {/* Standalone Form Tutorial - bottom-left floating button */}\n      <OpportunityCreateFormTutorial />\n    </CreateBase>\n  );\n};\n\nconst OpportunityFormContent = ({\n  checkForSimilar,\n  hasConfirmed,\n  resetConfirmation,\n}: {\n  checkForSimilar: (name: string) => Promise<void>;\n  hasConfirmed: boolean;\n  resetConfirmation: () => void;\n}) => {\n  const { errors } = useFormState();\n\n  return (\n    <>\n      <FormErrorSummary errors={errors} />\n      <OpportunityInputs mode=\"create\" />\n      <FormToolbar>\n        <div className=\"flex flex-row gap-2 justify-end\">\n          <CancelButton />\n          <div data-tutorial=\"opp-save-btn\">\n            <OpportunityCreateSaveButton\n              checkForSimilar={checkForSimilar}\n              hasConfirmed={hasConfirmed}\n              resetConfirmation={resetConfirmation}\n            />\n          </div>\n        </div>\n      </FormToolbar>\n    </>\n  );\n};\n\nexport { OpportunityCreate };\nexport default OpportunityCreate;\n"],"names":["opportunityCreateFormSteps","popover","title","description","align","element","side","OpportunityCreateFormTutorial","location","useLocation","driverRef","useRef","isActive","setIsActive","useState","isCreatePage","pathname","useEffect","current","destroy","startTutorial","useCallback","async","validSteps","filterValidSteps","firstElementStep","find","s","waitForElement","config","showProgress","animate","smoothScroll","allowClose","allowKeyboardControl","overlayColor","popoverClass","showButtons","nextBtnText","prevBtnText","doneBtnText","steps","map","step","onDestroyed","__name","driver","drive","error","jsx","className","children","Tooltip","TooltipTrigger","asChild","Button","variant","size","onClick","HelpCircle","TooltipContent","levenshteinDistance","a","b","str1","toLowerCase","trim","str2","length","len1","len2","prevRow","Array","from","_","i","currRow","j","cost","Math","min","findSimilarOpportunities","opportunities","params","name","threshold","excludeId","hasSimilar","matches","normalizedName","filter","opp","id","distance","stage","customer_organization_name","principal_organization_name","match","sort","DEFAULT_THRESHOLD","useSimilarOpportunityCheck","options","disabled","showDialog","setShowDialog","proposedName","setProposedName","similarOpportunities","setSimilarOpportunities","hasConfirmed","setHasConfirmed","data","isLoading","useGetList","pagination","page","perPage","field","order","enabled","staleTime","opportunityList","useMemo","checkForSimilar","result","closeDialog","confirmCreate","resetConfirmation","OPPORTUNITY_FIELD_LABELS","customer_organization_id","principal_organization_id","priority","estimated_close_date","account_manager_id","distributor_organization_id","contact_ids","lead_source","campaign","next_action","next_action_date","decision_criteria","notes","OpportunityInputs","mode","errors","useFormState","hasErrors","Object","keys","jsxs","FormErrorSummary","fieldLabels","defaultExpanded","OpportunityCompactForm","OpportunityCreateSaveButton","label","translate","useTranslate","form","useFormContext","saveContext","useSaveContext","dirtyFields","isValidating","isSubmitting","previousNameRef","currentName","useWatch","control","isDirty","recordFromLocation","useRecordFromLocation","handleSubmit","values","save","setSubmissionErrors","setError","handleClick","event","preventDefault","stopPropagation","getValues","displayedLabel","type","cn","Loader2","Save","getSimilarityLabel","getSimilarityVariant","SimilarOpportunitiesDialog","open","onClose","onConfirm","Dialog","onOpenChange","isOpen","DialogContent","DialogHeader","DialogTitle","AlertTriangle","DialogDescription","Table","TableHeader","TableRow","TableHead","TableBody","TableCell","style","backgroundColor","getOpportunityStageColor","color","getOpportunityStageLabel","Badge","DialogFooter","OpportunityCreate","identity","useGetIdentity","formDefaults","opportunitySchema","partial","parse","opportunity_owner_id","products_to_sync","CreateBase","redirect","Form","defaultValues","Card","CardContent","OpportunityFormContent","Fragment","FormToolbar","CancelButton"],"mappings":"o7CASO,MAAMA,EAA6C,CAExD,CACEC,QAAS,CACPC,MAAO,wBACPC,YACE,4FACFC,MAAO,WAIX,CACEC,QAAS,6BACTJ,QAAS,CACPC,MAAO,mBACPC,YACE,+HACFG,KAAM,WAIV,CACED,QAAS,iCACTJ,QAAS,CACPC,MAAO,wBACPC,YACE,wHACFG,KAAM,UAIV,CACED,QAAS,kCACTJ,QAAS,CACPC,MAAO,yBACPC,YACE,uHACFG,KAAM,SAIV,CACED,QAAS,8BACTJ,QAAS,CACPC,MAAO,iBACPC,YACE,iGACFG,KAAM,WAIV,CACED,QAAS,iCACTJ,QAAS,CACPC,MAAO,iBACPC,YACE,mFACFG,KAAM,WAIV,CACED,QAAS,mCACTJ,QAAS,CACPC,MAAO,uBACPC,YAAa,2EACbG,KAAM,WAIV,CACED,QAAS,wCACTJ,QAAS,CACPC,MAAO,kBACPC,YAAa,6EACbG,KAAM,UAIV,CACED,QAAS,oCACTJ,QAAS,CACPC,MAAO,2BACPC,YACE,0HACFG,KAAM,SAIV,CACED,QAAS,iCACTJ,QAAS,CACPC,MAAO,mBACPC,YACE,sGACFG,KAAM,QAIV,CACED,QAAS,iCACTJ,QAAS,CACPC,MAAO,WACPC,YACE,2GACFG,KAAM,QAIV,CACED,QAAS,+CACTJ,QAAS,CACPC,MAAO,yBACPC,YAAa,8EACbG,KAAM,QAIV,CACED,QAAS,oCACTJ,QAAS,CACPC,MAAO,cACPC,YACE,qGACFG,KAAM,UAIV,CACED,QAAS,iCACTJ,QAAS,CACPC,MAAO,WACPC,YACE,iGACFG,KAAM,SAIV,CACED,QAAS,wCACTJ,QAAS,CACPC,MAAO,qBACPC,YAAa,oDACbG,KAAM,QAIV,CACED,QAAS,oCACTJ,QAAS,CACPC,MAAO,cACPC,YACE,4FACFG,KAAM,WAIV,CACED,QAAS,oCACTJ,QAAS,CACPC,MAAO,cACPC,YACE,mFACFG,KAAM,UAIV,CACED,QAAS,yCACTJ,QAAS,CACPC,MAAO,mBACPC,YACE,0FACFG,KAAM,SAIV,CACED,QAAS,iCACTJ,QAAS,CACPC,MAAO,qBACPC,YACE,gGACFG,KAAM,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"}