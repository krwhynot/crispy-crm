var e=Object.defineProperty,s=(s,t)=>e(s,"name",{value:t,configurable:!0});import{l as t,aF as a,G as n,j as i,H as r,u as l,U as o,am as c,an as d}from"./chunk-ByJg_QQB.js";import{r as p,e as u}from"./chunk-1NZFT-6z.js";import{d as m,F as x}from"./chunk-JxeXaC9i.js";import{R as h}from"./chunk-MaXPr535.js";import{F as g,H as j,Z as y,$ as f,B as _,s as N,d as b,a0 as w,a1 as k,ao as C,bz as v,I as z,J as M,C as D,a as P,q as F,b as S,c as E}from"../assets/index-BoLku8RR.js";import{X as O,p as T,a as $,E as A}from"./chunk-Bc6KM1xM.js";import{R as B}from"./chunk-D6FmavVW.js";import{A as I}from"./chunk-DRZQUu5H.js";import{f as R}from"./chunk-CFj7NhUg.js";import{s as U}from"./chunk-BnJ5ohE_.js";import{d as V}from"./chunk-DwAffUXc.js";import"./chunk-knA4lag3.js";import"./chunk-Tyyhsnez.js";import"./chunk-XoqkUGE_.js";import"./chunk-CRKBdUTG.js";import"./chunk-nUtrHAIa.js";import"./chunk-CMQLDEz_.js";import"./chunk-C_u3nriX.js";const W=s(e=>{const{choices:l,resource:o,source:c,optionText:d,optionValue:u,translateChoice:m,defaultValue:x=[],label:h,helperText:D,validate:P,disabled:F,emptyText:S="Select items",...E}=e,T=t(),{allChoices:$,source:A}=a({choices:l,resource:o,source:c}),{field:B,fieldState:{error:I}}=n({defaultValue:x,resource:o,source:A,validate:P,...E}),R=p.useCallback((e,s)=>{const t=B.value||[],a=s?[...t,e]:t.filter(s=>s!==e);B.onChange(a)},[B]),U=p.useCallback(e=>{e.stopPropagation(),B.onChange([])},[B]),V=B.value?.length||0,W=V>0?`${S} (${V} selected)`:S;return i.jsxs(g,{children:[!1!==h&&i.jsx(j,{htmlFor:B.name,children:i.jsx(r,{label:h,source:A,resource:o})}),i.jsxs(y,{children:[i.jsx(f,{asChild:!0,children:i.jsxs(_,{variant:"outline",className:N("w-full justify-between",V>0&&!F&&"border-primary text-primary"),disabled:F,children:[i.jsx("span",{children:W}),V>0&&i.jsx(b,{variant:"secondary",className:"ml-2",children:V})]})}),i.jsxs(w,{className:"w-56",children:[V>0&&i.jsxs(i.Fragment,{children:[i.jsxs(k,{onClick:U,children:[i.jsx(O,{className:"mr-2 h-4 w-4"}),"Clear all"]}),i.jsx(C,{})]}),$?.map(e=>{const t=e[u??"id"],a=e[d??"name"],n=B.value?.includes(t)||!1;return i.jsx(v,{checked:n,onCheckedChange:s(e=>R(t,e),"onCheckedChange"),children:m?T(a,{_:a}):a},t)})]})]}),i.jsx(z,{helperText:D}),I&&i.jsx(M,{children:I.message})]})},"MultiSelectInput");function H({filters:e,onFiltersChange:t}){const a=m({defaultValues:e});p.useEffect(()=>{const e=a.watch(e=>{t(e)});return()=>e.unsubscribe()},[a,t]);const n=e.principal_organization_id||e.stage.length>0||e.opportunity_owner_id||e.startDate||e.endDate,r=s(()=>{a.reset({principal_organization_id:null,stage:[],opportunity_owner_id:null,startDate:null,endDate:null})},"clearFilters");return i.jsx(x,{...a,children:i.jsxs("form",{className:"flex flex-wrap items-center gap-2",children:[i.jsx(B,{source:"principal_organization_id",reference:"organizations",filter:{organization_type:"principal"},children:i.jsx(I,{label:!1,placeholder:"Filter by Principal",sx:{minWidth:200}})}),i.jsx(W,{source:"stage",emptyText:"All Stages",choices:R,sx:{minWidth:150}}),i.jsx(B,{source:"opportunity_owner_id",reference:"sales",children:i.jsx(I,{label:!1,placeholder:"Filter by Sales Rep",sx:{minWidth:200}})}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("input",{type:"date",...a.register("startDate"),className:"h-11 px-3 py-2 border border-border rounded text-sm",placeholder:"From Date","aria-label":"Filter from date"}),i.jsx("span",{className:"text-muted-foreground",children:"to"}),i.jsx("input",{type:"date",...a.register("endDate"),className:"h-11 px-3 py-2 border border-border rounded text-sm",placeholder:"To Date","aria-label":"Filter to date"})]}),n&&i.jsx(_,{variant:"ghost",size:"sm",onClick:r,type:"button",className:"h-11",children:"Clear Filters"})]})})}function G(){const e=u(),t=l(),[a,n]=p.useState({principal_organization_id:null,stage:[],opportunity_owner_id:null,startDate:null,endDate:null}),[r,m]=p.useState(new Set),x=p.useMemo(()=>{const e={"deleted_at@is":null,status:"active"};return a.principal_organization_id&&(e.principal_organization_id=a.principal_organization_id),a.stage.length>0&&(e.stage=a.stage),a.opportunity_owner_id&&(e.opportunity_owner_id=a.opportunity_owner_id),a.startDate&&(e["estimated_close_date@gte"]=a.startDate),a.endDate&&(e["estimated_close_date@lte"]=a.endDate),e},[a]),{data:g,isPending:j}=o("opportunities_summary",{pagination:{page:1,perPage:1e4},filter:x,sort:{field:"estimated_close_date",order:"ASC"}}),y=p.useMemo(()=>Array.from(new Set((g||[]).map(e=>e.opportunity_owner_id).filter(Boolean))),[g]),{data:f}=o("sales",{pagination:{page:1,perPage:1e3},filter:y.length>0?{id:y}:void 0}),_=p.useMemo(()=>new Map((f||[]).map(e=>[e.id,`${e.first_name} ${e.last_name}`])),[f]),N=p.useMemo(()=>{if(!g)return[];const e=new Map;g.forEach(s=>{const t=s.principal_organization_id?.toString()||null,a=s.principal_organization_name||"No Principal Assigned";e.has(t)||e.set(t,{principalId:t,principalName:a,opportunities:[],totalCount:0,stageBreakdown:{}});const n=e.get(t);n.opportunities.push(s),n.totalCount+=1;const i=s.stage||"Unknown";n.stageBreakdown[i]=(n.stageBreakdown[i]||0)+1});const s=Array.from(e.values()).sort((e,s)=>s.totalCount-e.totalCount);if(0===r.size&&s.length>0){const e=new Set(s.slice(0,3).map(e=>e.principalId||"null"));m(e)}return s},[g,r.size]),b=s(e=>{const s=e||"null",t=new Set(r);t.has(s)?t.delete(s):t.add(s),m(t)},"togglePrincipalExpansion"),w=s(()=>{const e=[];N.forEach(s=>{s.opportunities.forEach(t=>{const a=t.estimated_close_date?F(t.estimated_close_date):null;e.push({principal:U(s.principalName),opportunity:U(t.name),organization:U(t.customer_organization_name||""),stage:U(t.stage),close_date:a?V(a,"yyyy-MM-dd"):"",sales_rep:U(_.get(t.opportunity_owner_id)||"Unassigned"),priority:U(t.priority||"medium"),status:U(t.status),days_in_stage:t.days_in_stage||0})})}),0!==e.length?c(e,(e,s)=>{e?t("Export failed. Please try again.",{type:"error"}):(d(s,`opportunities-by-principal-${V(new Date,"yyyy-MM-dd")}`),t("Report exported successfully",{type:"success"}))}):t("No data to export",{type:"warning"})},"handleExport"),k=s(s=>{e(`/opportunities/${s}/show`)},"handleOpportunityClick");if(j)return i.jsx(h,{title:"Opportunities by Principal",children:i.jsx("p",{className:"text-muted-foreground",children:"Loading opportunities..."})});const C=g?.length||0,v=N.length;return i.jsx(h,{title:"Opportunities by Principal",onExport:w,actions:i.jsx(H,{filters:a,onFiltersChange:n}),children:i.jsxs("div",{className:"space-y-section",children:[i.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-content",children:[i.jsx(D,{children:i.jsxs(P,{className:"p-4",children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Opportunities"}),i.jsx("p",{className:"text-2xl font-bold",children:C})]})}),i.jsx(D,{children:i.jsxs(P,{className:"p-4",children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Principals"}),i.jsx("p",{className:"text-2xl font-bold",children:v})]})}),i.jsx(D,{children:i.jsxs(P,{className:"p-4",children:[i.jsx("p",{className:"text-sm text-muted-foreground",children:"Avg per Principal"}),i.jsx("p",{className:"text-2xl font-bold",children:v>0?Math.round(C/v):0})]})})]}),0===N.length?i.jsx("p",{className:"text-center text-muted-foreground py-8",children:"No opportunities found matching the selected filters"}):i.jsx("div",{className:"space-y-content",children:N.map(e=>i.jsx(q,{group:e,isExpanded:r.has(e.principalId||"null"),onToggle:s(()=>b(e.principalId),"onToggle"),onOpportunityClick:k,salesMap:_},e.principalId||"null"))})]})})}function q({group:e,isExpanded:t,onToggle:a,onOpportunityClick:n,salesMap:r}){const l=Object.entries(e.stageBreakdown).sort(([,e],[,s])=>s-e).slice(0,3).map(([e,s])=>`${e}: ${s}`).join(", ");return i.jsxs(D,{children:[i.jsx(S,{className:"cursor-pointer hover:bg-accent/50 transition-colors",onClick:a,children:i.jsxs(E,{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-2",children:[t?i.jsx(T,{className:"w-5 h-5"}):i.jsx($,{className:"w-5 h-5"}),i.jsx("span",{children:e.principalName})]}),i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsxs(b,{variant:"secondary",children:[e.totalCount," ",1===e.totalCount?"opportunity":"opportunities"]}),l&&i.jsxs("span",{className:"text-sm text-muted-foreground hidden md:inline",children:["(",l,")"]})]})]})}),t&&i.jsx(P,{children:i.jsx("div",{className:"overflow-x-auto",children:i.jsxs("table",{className:"w-full",children:[i.jsx("thead",{children:i.jsxs("tr",{className:"border-b text-sm text-muted-foreground",children:[i.jsx("th",{className:"text-left py-2 px-2 min-w-[200px]",children:"Opportunity"}),i.jsx("th",{className:"text-left py-2 px-2 min-w-[150px]",children:"Organization"}),i.jsx("th",{className:"text-left py-2 px-2 min-w-[120px]",children:"Stage"}),i.jsx("th",{className:"text-left py-2 px-2 min-w-[100px]",children:"Close Date"}),i.jsx("th",{className:"text-left py-2 px-2 min-w-[100px]",children:"Sales Rep"}),i.jsx("th",{className:"text-center py-2 px-2 min-w-[50px]",children:"Action"})]})}),i.jsx("tbody",{children:e.opportunities.map(e=>i.jsxs("tr",{className:"border-b hover:bg-accent/30 transition-colors",children:[i.jsx("td",{className:"py-2 px-2",children:i.jsxs("div",{className:"flex items-center gap-2",children:[i.jsx("span",{className:"font-medium",children:e.name}),"high"===e.priority&&i.jsx(b,{variant:"outline",className:"text-xs bg-warning-light",children:"High"}),"critical"===e.priority&&i.jsx(b,{variant:"outline",className:"text-xs bg-destructive-light",children:"Critical"}),e.days_in_stage&&e.days_in_stage>14&&i.jsxs(b,{variant:"outline",className:"text-xs",children:[e.days_in_stage," days"]})]})}),i.jsx("td",{className:"py-2 px-2",children:e.customer_organization_name||"-"}),i.jsx("td",{className:"py-2 px-2",children:i.jsx(b,{variant:"outline",children:e.stage})}),i.jsx("td",{className:"py-2 px-2",children:e.estimated_close_date&&F(e.estimated_close_date)?V(F(e.estimated_close_date),"MMM dd, yyyy"):"-"}),i.jsx("td",{className:"py-2 px-2",children:r.get(e.opportunity_owner_id)||"Unassigned"}),i.jsx("td",{className:"py-2 px-2 text-center",children:i.jsx(_,{variant:"ghost",size:"sm",onClick:s(s=>{s.stopPropagation(),n(e.id)},"onClick"),children:i.jsx(A,{className:"w-4 h-4"})})})]},e.id))})]})})})]})}s(H,"FilterToolbar"),s(G,"OpportunitiesByPrincipalReport"),s(q,"PrincipalGroupCard");export{G as default};
