var e=Object.defineProperty,s=(s,i)=>e(s,"name",{value:i,configurable:!0});import{w as i,U as t,j as a,ar as r,u as n,i as o,as as d}from"./chunk-ByJg_QQB.js";import{r as c}from"./chunk-1NZFT-6z.js";import{S as l,B as h,q as u,d as x,D as p,e as m,f as j,g,h as v,L as f,i as N,j as b,k as y,m as z,n as w,t as C,p as _}from"../assets/index-BoLku8RR.js";import{A as S,a as A,b as P,c as k,d as E,e as R,f as O,g as F}from"./chunk-D62ZQQIe.js";import{C as D,a as I,b as T}from"./chunk-DsNwAyt-.js";import{a5 as M,a4 as $,p as L,a as V,o as B,a7 as q,a8 as U,a9 as G,aa as H,C as J,X as K,T as Q}from"./chunk-Bc6KM1xM.js";import{d as W}from"./chunk-DwAffUXc.js";function X({record:e,distributorId:r,isActiveTab:n=!0}){const o=e?.id??r,[d,u]=c.useState(!1),[x,p]=c.useState(null),m=i(),{data:j,isPending:g,error:v}=t("distributor_principal_authorizations",{filter:{distributor_id:o,deleted_at:null},sort:{field:"created_at",order:"DESC"},pagination:{page:1,perPage:100}},{enabled:n&&!!o}),{data:f}=t("organizations",{filter:{organization_type:"principal",deleted_at:null},sort:{field:"name",order:"ASC"},pagination:{page:1,perPage:200}},{enabled:n&&d}),N=new Set(j?.map(e=>e.principal_id)||[]),b=f?.filter(e=>!N.has(Number(e.id)));if(!o)return a.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No distributor selected"});if(g)return a.jsx("div",{className:"space-y-4",children:[1,2,3].map(e=>a.jsxs("div",{className:"p-4 border border-border rounded-lg",children:[a.jsx(l,{className:"h-4 w-32 mb-2"}),a.jsx(l,{className:"h-3 w-full mb-1"}),a.jsx(l,{className:"h-3 w-3/4"})]},e))});if(v)return a.jsx("div",{className:"text-center py-8 text-destructive",children:"Failed to load authorizations"});const y=j||[];return a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("p",{className:"text-sm text-muted-foreground",children:0===y.length?"No authorized principals":`${y.length} authorized principal${1!==y.length?"s":""}`}),a.jsxs(h,{variant:"outline",size:"sm",onClick:s(()=>u(!0),"onClick"),className:"h-11",children:[a.jsx(M,{className:"h-4 w-4 mr-1"}),"Add Principal"]})]}),0===y.length?a.jsx(Y,{onAddClick:s(()=>u(!0),"onAddClick")}):a.jsx("div",{className:"space-y-3",children:y.map(e=>a.jsx(Z,{authorization:e,distributorId:Number(o),onRemove:s(()=>p(e),"onRemove")},e.id))}),a.jsx(se,{open:d,onOpenChange:u,distributorId:o,availablePrincipals:b||[],onSuccess:s(()=>{m(),u(!1)},"onSuccess")}),a.jsx(te,{authorization:x,onClose:s(()=>p(null),"onClose"),onSuccess:s(()=>{m(),p(null)},"onSuccess")})]})}function Y({onAddClick:e}){return a.jsxs("div",{className:"text-center py-12 border border-dashed border-border rounded-lg",children:[a.jsx($,{className:"h-12 w-12 mx-auto text-muted-foreground/50 mb-4"}),a.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Authorized Principals"}),a.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Add principals that are authorized to sell through this distributor."}),a.jsxs(h,{variant:"outline",onClick:e,className:"h-11",children:[a.jsx(M,{className:"h-4 w-4 mr-1"}),"Add First Principal"]})]})}function Z({authorization:e,distributorId:s,onRemove:i}){const[r,n]=c.useState(!1),{data:o}=t("organizations",{filter:{id:e.principal_id},pagination:{page:1,perPage:1}}),{data:d,isPending:l}=t("product_distributor_authorizations",{filter:{distributor_id:s,deleted_at:null},sort:{field:"created_at",order:"DESC"},pagination:{page:1,perPage:50}},{enabled:r}),{data:p}=t("products",{filter:{principal_id:e.principal_id,deleted_at:null},sort:{field:"name",order:"ASC"},pagination:{page:1,perPage:100}},{enabled:r}),m=o?.[0]?.name||`Principal #${e.principal_id}`,j=e.expiration_date?u(e.expiration_date):null,g=j&&j<new Date,v=e.is_authorized&&!g,f=new Set(p?.map(e=>Number(e.id))||[]),N=d?.filter(e=>f.has(e.product_id))||[],b=N.length;return a.jsx(D,{open:r,onOpenChange:n,children:a.jsxs("div",{className:"border border-border rounded-lg hover:bg-muted/50 transition-colors",children:[a.jsxs("div",{className:"flex gap-4 p-4",children:[a.jsx(I,{asChild:!0,children:a.jsx(h,{variant:"ghost",size:"sm",className:"h-11 w-11 p-0 flex-shrink-0 mt-0.5","aria-label":r?"Collapse product exceptions":"Expand product exceptions",children:r?a.jsx(L,{className:"h-4 w-4"}):a.jsx(V,{className:"h-4 w-4"})})}),a.jsx("div",{className:"flex-shrink-0 mt-1",children:a.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:a.jsx($,{className:"h-5 w-5 text-primary"})})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"flex items-start justify-between mb-1",children:[a.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[a.jsx("span",{className:"font-medium",children:m}),a.jsx(x,{variant:v?"default":"secondary",children:v?"Active":g?"Expired":"Inactive"}),b>0&&a.jsxs(x,{variant:"outline",className:"text-xs",children:[a.jsx(B,{className:"h-3 w-3 mr-1"}),b," exception",1!==b?"s":""]})]}),a.jsx(h,{variant:"ghost",size:"sm",className:"h-11 w-11 p-0 text-muted-foreground hover:text-destructive",onClick:i,title:"Remove authorization",children:a.jsx(q,{className:"h-4 w-4"})})]}),a.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-sm text-muted-foreground mt-2",children:[e.authorization_date&&a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(U,{className:"h-3.5 w-3.5"}),a.jsxs("span",{children:["Since"," ",W(u(e.authorization_date)??new Date,"MMM d, yyyy")]})]}),e.expiration_date&&j&&a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(U,{className:"h-3.5 w-3.5"}),a.jsxs("span",{className:g?"text-destructive":"",children:[g?"Expired":"Expires"," ",W(j,"MMM d, yyyy")]})]}),e.territory_restrictions&&e.territory_restrictions.length>0&&a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(G,{className:"h-3.5 w-3.5"}),a.jsx("span",{children:e.territory_restrictions.join(", ")})]})]}),e.notes&&a.jsxs("div",{className:"flex items-start gap-1 mt-2 text-sm",children:[a.jsx(H,{className:"h-3.5 w-3.5 mt-0.5 text-muted-foreground"}),a.jsx("span",{className:"text-foreground/80",children:e.notes})]})]})]}),a.jsx(T,{children:a.jsx(ee,{authorization:e,distributorId:s,products:p||[],productAuths:N,isLoading:l})})]})})}function ee({authorization:e,distributorId:t,products:r,productAuths:n,isLoading:o}){const[d,p]=c.useState(!1),[m,j]=c.useState(null),g=i(),v=new Map(n.map(e=>[e.product_id,e])),f=r.filter(e=>v.has(Number(e.id))),N=r.filter(e=>!v.has(Number(e.id)));return o?a.jsxs("div",{className:"border-t border-border p-4 bg-muted/30",children:[a.jsx(l,{className:"h-4 w-48 mb-2"}),a.jsx(l,{className:"h-3 w-full"})]}):a.jsxs("div",{className:"border-t border-border p-4 bg-muted/30",children:[a.jsxs("div",{className:"flex justify-between items-center mb-3",children:[a.jsxs("h4",{className:"text-sm font-medium flex items-center gap-2",children:[a.jsx(B,{className:"h-4 w-4"}),"Product Exceptions"]}),N.length>0&&a.jsxs(h,{variant:"ghost",size:"sm",onClick:s(()=>p(!0),"onClick"),className:"h-11 text-xs",children:[a.jsx(M,{className:"h-4 w-4 mr-1"}),"Add Exception"]})]}),0===r.length?a.jsx("p",{className:"text-sm text-muted-foreground",children:"No products found for this principal."}):0===f.length?a.jsxs("p",{className:"text-sm text-muted-foreground",children:["All ",r.length," product",1!==r.length?"s":""," inherit the principal-level authorization.",N.length>0&&" Add an exception to override for specific products."]}):a.jsx("div",{className:"space-y-2",children:f.map(e=>{const i=v.get(Number(e.id)),t=i.is_authorized,r=i.expiration_date?u(i.expiration_date):null,n=r&&r<new Date;return a.jsxs("div",{className:"flex items-center justify-between p-3 bg-background rounded border border-border",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-8 h-8 rounded flex items-center justify-center "+(t&&!n?"bg-success/10 text-success":"bg-destructive/10 text-destructive"),children:t&&!n?a.jsx(J,{className:"h-4 w-4"}):a.jsx(K,{className:"h-4 w-4"})}),a.jsxs("div",{children:[a.jsx("span",{className:"text-sm font-medium",children:e.name}),a.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",e.sku,")"]}),n&&a.jsx(x,{variant:"outline",className:"ml-2 text-xs text-destructive border-destructive",children:"Expired"})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(x,{variant:t?"default":"destructive",className:"text-xs",children:t?"Authorized":"Not Authorized"}),a.jsx(h,{variant:"ghost",size:"sm",className:"h-11 w-11 p-0 text-muted-foreground hover:text-destructive",onClick:s(()=>j(i),"onClick"),title:"Remove exception",children:a.jsx(q,{className:"h-4 w-4"})})]})]},e.id)})}),a.jsx(ie,{open:d,onOpenChange:p,distributorId:t,availableProducts:N,inheritedAuthorization:e.is_authorized,onSuccess:s(()=>{g(),p(!1)},"onSuccess")}),a.jsx(ae,{productAuth:m,products:r,onClose:s(()=>j(null),"onClose"),onSuccess:s(()=>{g(),j(null)},"onSuccess")})]})}function se({open:e,onOpenChange:i,distributorId:t,availablePrincipals:d,onSuccess:l}){const[u,x]=c.useState(""),[S,A]=c.useState(""),[P,{isPending:k}]=r(),E=n(),{data:R}=o(),O=s(async()=>{if(u)try{await P("distributor_principal_authorizations",{data:{distributor_id:Number(t),principal_id:Number(u),is_authorized:!0,authorization_date:(new Date).toISOString().split("T")[0],notes:S.trim()||null,created_by:R?.id}},{returnPromise:!0}),E("Principal authorization added",{type:"success"}),x(""),A(""),l()}catch(e){const s=e instanceof Error?e.message:"Failed to add authorization";E(s,{type:"error"})}else E("Please select a principal",{type:"warning"})},"handleSubmit"),F=s(()=>{x(""),A(""),i(!1)},"handleClose");return a.jsx(p,{open:e,onOpenChange:F,children:a.jsxs(m,{className:"sm:max-w-md",children:[a.jsxs(j,{children:[a.jsx(g,{children:"Add Authorized Principal"}),a.jsx(v,{children:"Select a principal to authorize for selling through this distributor."})]}),a.jsxs("div",{className:"space-y-4 py-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"principal",children:"Principal"}),a.jsxs(N,{value:u,onValueChange:x,children:[a.jsx(b,{id:"principal",className:"h-11",children:a.jsx(y,{placeholder:"Select a principal..."})}),a.jsx(z,{children:0===d.length?a.jsx(w,{value:"",disabled:!0,children:"No principals available"}):d.map(e=>a.jsx(w,{value:String(e.id),children:e.name},e.id))})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"notes",children:"Notes (optional)"}),a.jsx(C,{id:"notes",placeholder:"Add any notes about this authorization...",value:S,onChange:s(e=>A(e.target.value),"onChange"),rows:3})]})]}),a.jsxs(_,{children:[a.jsx(h,{variant:"outline",onClick:F,className:"h-11",children:"Cancel"}),a.jsx(h,{onClick:O,disabled:k||!u,className:"h-11",children:k?"Adding...":"Add Authorization"})]})]})})}function ie({open:e,onOpenChange:i,distributorId:t,availableProducts:d,inheritedAuthorization:l,onSuccess:u}){const[S,A]=c.useState(""),[P,k]=c.useState("false"),[E,R]=c.useState(""),[O,{isPending:F}]=r(),D=n(),{data:I}=o(),T=s(async()=>{if(S)try{await O("product_distributor_authorizations",{data:{product_id:Number(S),distributor_id:t,is_authorized:"true"===P,authorization_date:(new Date).toISOString().split("T")[0],notes:E.trim()||null,created_by:I?.id}},{returnPromise:!0}),D("Product exception added",{type:"success"}),A(""),k("false"),R(""),u()}catch(e){const s=e instanceof Error?e.message:"Failed to add product exception";D(s,{type:"error"})}else D("Please select a product",{type:"warning"})},"handleSubmit"),M=s(()=>{A(""),k("false"),R(""),i(!1)},"handleClose");return a.jsx(p,{open:e,onOpenChange:M,children:a.jsxs(m,{className:"sm:max-w-md",children:[a.jsxs(j,{children:[a.jsx(g,{children:"Add Product Exception"}),a.jsxs(v,{children:["Override the principal-level authorization for a specific product. Currently, products inherit:"," ",a.jsx(x,{variant:l?"default":"destructive",className:"ml-1 text-xs",children:l?"Authorized":"Not Authorized"})]})]}),a.jsxs("div",{className:"space-y-4 py-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"product",children:"Product"}),a.jsxs(N,{value:S,onValueChange:A,children:[a.jsx(b,{id:"product",className:"h-11",children:a.jsx(y,{placeholder:"Select a product..."})}),a.jsx(z,{children:0===d.length?a.jsx(w,{value:"",disabled:!0,children:"No products available"}):d.map(e=>a.jsxs(w,{value:String(e.id),children:[e.name," (",e.sku,")"]},e.id))})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"authorization-status",children:"Exception Status"}),a.jsxs(N,{value:P,onValueChange:k,children:[a.jsx(b,{id:"authorization-status",className:"h-11",children:a.jsx(y,{})}),a.jsxs(z,{children:[a.jsx(w,{value:"true",children:a.jsxs("span",{className:"flex items-center gap-2",children:[a.jsx(J,{className:"h-4 w-4 text-success"}),"Authorized (Override to Allow)"]})}),a.jsx(w,{value:"false",children:a.jsxs("span",{className:"flex items-center gap-2",children:[a.jsx(K,{className:"h-4 w-4 text-destructive"}),"Not Authorized (Override to Block)"]})})]})]}),a.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.jsx(Q,{className:"h-3 w-3 inline mr-1"}),"This overrides the principal-level setting for this specific product only."]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx(f,{htmlFor:"exception-notes",children:"Notes (optional)"}),a.jsx(C,{id:"exception-notes",placeholder:"Reason for this exception...",value:E,onChange:s(e=>R(e.target.value),"onChange"),rows:2})]})]}),a.jsxs(_,{children:[a.jsx(h,{variant:"outline",onClick:M,className:"h-11",children:"Cancel"}),a.jsx(h,{onClick:T,disabled:F||!S,className:"h-11",children:F?"Adding...":"Add Exception"})]})]})})}function te({authorization:e,onClose:i,onSuccess:r}){const[o,{isPending:c}]=d(),l=n(),{data:h}=t("organizations",{filter:e?{id:e.principal_id}:{},pagination:{page:1,perPage:1}},{enabled:!!e}),u=h?.[0]?.name||(e?`Principal #${e.principal_id}`:""),x=s(async()=>{if(e)try{await o("distributor_principal_authorizations",{id:e.id},{onSuccess:s(()=>{l(`Removed authorization for ${u}`,{type:"success"}),r()},"onSuccess"),onError:s(e=>{const s=e instanceof Error?e.message:"Failed to remove authorization";l(s,{type:"error"})},"onError")})}catch{l("Failed to remove authorization. Please try again.",{type:"error"})}},"handleConfirm");return a.jsx(S,{open:!!e,onOpenChange:i,children:a.jsxs(A,{children:[a.jsxs(P,{children:[a.jsx(k,{children:"Remove Principal Authorization?"}),a.jsxs(E,{children:["Remove authorization for ",a.jsx("strong",{children:u}),"? This distributor will no longer be able to carry products from this principal."]})]}),a.jsxs(R,{children:[a.jsx(O,{className:"h-11",children:"Cancel"}),a.jsx(F,{onClick:x,disabled:c,className:"h-11 bg-destructive text-destructive-foreground hover:bg-destructive/90",children:c?"Removing...":"Remove"})]})]})})}function ae({productAuth:e,products:i,onClose:t,onSuccess:r}){const[o,{isPending:c}]=d(),l=n(),h=i.find(s=>Number(s.id)===e?.product_id),u=h?.name||(e?`Product #${e.product_id}`:""),x=s(async()=>{if(e)try{await o("product_distributor_authorizations",{id:e.id},{onSuccess:s(()=>{l(`Removed exception for ${u}`,{type:"success"}),r()},"onSuccess"),onError:s(e=>{const s=e instanceof Error?e.message:"Failed to remove exception";l(s,{type:"error"})},"onError")})}catch{l("Failed to remove exception. Please try again.",{type:"error"})}},"handleConfirm");return a.jsx(S,{open:!!e,onOpenChange:t,children:a.jsxs(A,{children:[a.jsxs(P,{children:[a.jsx(k,{children:"Remove Product Exception?"}),a.jsxs(E,{children:["Remove the exception for ",a.jsx("strong",{children:u}),"? This product will revert to the principal-level authorization setting."]})]}),a.jsxs(R,{children:[a.jsx(O,{className:"h-11",children:"Cancel"}),a.jsx(F,{onClick:x,disabled:c,className:"h-11 bg-destructive text-destructive-foreground hover:bg-destructive/90",children:c?"Removing...":"Remove Exception"})]})]})})}s(X,"AuthorizationsTab"),s(Y,"EmptyState"),s(Z,"AuthorizationCard"),s(ee,"ProductExceptionsSection"),s(se,"AddPrincipalDialog"),s(ie,"AddProductExceptionDialog"),s(te,"RemoveAuthorizationDialog"),s(ae,"RemoveProductExceptionDialog");export{X as A};
