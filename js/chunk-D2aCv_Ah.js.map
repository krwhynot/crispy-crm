{"version":3,"file":"chunk-D2aCv_Ah.js","sources":["../../src/atomic-crm/notes/NoteInputs.tsx","../../src/atomic-crm/notes/NoteCreate.tsx","../../src/atomic-crm/notes/Note.tsx","../../src/atomic-crm/notes/NotesIterator.tsx"],"sourcesContent":["import { useState } from \"react\";\nimport { useFormContext } from \"react-hook-form\";\n\nimport { cn } from \"@/lib/utils.ts\";\nimport { TextInput } from \"@/components/admin/text-input\";\nimport { Button } from \"@/components/ui/button\";\nimport { getCurrentDate } from \"../validation/notes\";\n\nexport const NoteInputs = () => {\n  const [displayMore, setDisplayMore] = useState(false);\n  const { setValue } = useFormContext();\n\n  return (\n    <div className=\"space-y-2\">\n      <TextInput\n        source=\"text\"\n        label={false}\n        multiline\n        helperText={false}\n        placeholder=\"Add a note\"\n      />\n\n      {!displayMore && (\n        <div className=\"flex justify-end items-center gap-2\">\n          <Button\n            variant=\"link\"\n            size=\"sm\"\n            onClick={() => {\n              setDisplayMore(!displayMore);\n              setValue(\"date\", getCurrentDate());\n            }}\n            className=\"text-sm text-muted-foreground underline hover:no-underline p-0 h-auto cursor-pointer\"\n          >\n            Show options\n          </Button>\n          <span className=\"text-sm text-muted-foreground\">(change date/time)</span>\n        </div>\n      )}\n\n      <div\n        className={cn(\n          \"space-y-3 mt-3 overflow-hidden transition-transform ease-in-out duration-300 origin-top\",\n          !displayMore ? \"scale-y-0 max-h-0 h-0\" : \"scale-y-100\"\n        )}\n      >\n        <TextInput\n          source=\"date\"\n          label=\"Date & Time\"\n          helperText={false}\n          type=\"datetime-local\"\n          className=\"text-primary\"\n          // defaultValue removed per Constitution #5 - defaults come from Zod schema via form-level defaultValues\n        />\n      </div>\n    </div>\n  );\n};\n","import type { Identifier, RaRecord } from \"ra-core\";\nimport {\n  CreateBase,\n  Form,\n  useGetIdentity,\n  useListContext,\n  useNotify,\n  useRecordContext,\n  useResourceContext,\n  useUpdate,\n} from \"ra-core\";\nimport { useFormContext, useFormState } from \"react-hook-form\";\n\nimport { SaveButton } from \"@/components/admin/form\";\nimport { FormErrorSummary } from \"@/components/admin/FormErrorSummary\";\nimport { NoteInputs } from \"./NoteInputs\";\nimport { baseNoteSchema, getCurrentDate } from \"../validation/notes\";\n\nconst foreignKeyMapping = {\n  contacts: \"contact_id\",\n  opportunities: \"opportunity_id\",\n  organizations: \"organization_id\",\n};\n\nexport const NoteCreate = ({\n  reference,\n}: {\n  reference: \"contacts\" | \"opportunities\" | \"organizations\";\n}) => {\n  const resource = useResourceContext();\n  const record = useRecordContext();\n  const { data: identity } = useGetIdentity();\n\n  if (!record || !identity) return null;\n\n  const formDefaults = {\n    ...baseNoteSchema.partial().parse({}),\n  };\n\n  return (\n    <CreateBase resource={resource} redirect={false}>\n      <Form defaultValues={formDefaults}>\n        <div className=\"space-y-3\">\n          <NoteFormContent reference={reference} record={record} />\n        </div>\n      </Form>\n    </CreateBase>\n  );\n};\n\nconst NoteFormContent = ({\n  reference,\n  record,\n}: {\n  reference: \"contacts\" | \"opportunities\" | \"organizations\";\n  record: RaRecord<Identifier>;\n}) => {\n  const { errors } = useFormState();\n\n  return (\n    <>\n      <FormErrorSummary errors={errors} />\n      <NoteInputs />\n      <NoteCreateButton reference={reference} record={record} />\n    </>\n  );\n};\n\nconst NoteCreateButton = ({\n  reference,\n  record,\n}: {\n  reference: \"contacts\" | \"opportunities\" | \"organizations\";\n  record: RaRecord<Identifier>;\n}) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const { data: identity } = useGetIdentity();\n  const { reset } = useFormContext();\n  const { refetch } = useListContext();\n\n  if (!record || !identity) return null;\n\n  const handleSuccess = () => {\n    reset(baseNoteSchema.partial().parse({}), { keepValues: false });\n    refetch();\n\n    // Only update last_seen for contacts (opportunities don't have last_seen)\n    if (reference === \"contacts\") {\n      update(reference, {\n        id: (record && record.id) as unknown as Identifier,\n        data: { last_seen: new Date().toISOString() },\n        previousData: record,\n      });\n    }\n\n    notify(\"Note added\");\n  };\n\n  return (\n    <div className=\"flex justify-end\">\n      <SaveButton\n        type=\"button\"\n        label=\"Add this note\"\n        transform={(data) => ({\n          ...data,\n          [foreignKeyMapping[reference]]: record.id,\n          sales_id: identity.id,\n          date: data.date || getCurrentDate(),\n        })}\n        mutationOptions={{\n          onSuccess: handleSuccess,\n        }}\n      >\n        Add this note\n      </SaveButton>\n    </div>\n  );\n};\n","import { Button } from \"@/components/ui/button\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { CircleX, Edit, Save, Trash2 } from \"lucide-react\";\nimport { Form, useDelete, useNotify, useResourceContext, useUpdate, WithRecord } from \"ra-core\";\nimport { useState } from \"react\";\nimport type { FieldValues, SubmitHandler } from \"react-hook-form\";\n\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { OrganizationAvatar } from \"../organizations/OrganizationAvatar\";\nimport { Avatar } from \"../contacts/Avatar\";\nimport { RelativeDate } from \"@/components/ui\";\nimport { SaleName } from \"../sales/SaleName\";\nimport type { ContactNote, OpportunityNote, OrganizationNote } from \"../types\";\nimport { NoteInputs } from \"./NoteInputs\";\n\nexport const Note = ({\n  note,\n}: {\n  note: OpportunityNote | ContactNote | OrganizationNote;\n  isLast: boolean;\n}) => {\n  const [isHover, setHover] = useState(false);\n  const [isEditing, setEditing] = useState(false);\n  const resource = useResourceContext();\n  const notify = useNotify();\n\n  const [update, { isPending }] = useUpdate();\n\n  const [deleteNote] = useDelete(\n    resource,\n    { id: note.id, previousData: note },\n    {\n      mutationMode: \"undoable\",\n      onSuccess: () => {\n        notify(\"Note deleted\", { type: \"info\", undoable: true });\n      },\n    }\n  );\n\n  const handleDelete = () => {\n    deleteNote();\n  };\n\n  const handleEnterEditMode = () => {\n    setEditing(!isEditing);\n  };\n\n  const handleCancelEdit = () => {\n    setEditing(false);\n    setHover(false);\n  };\n\n  const handleNoteUpdate: SubmitHandler<FieldValues> = (values) => {\n    update(\n      resource,\n      { id: note.id, data: values, previousData: note },\n      {\n        onSuccess: () => {\n          setEditing(false);\n          setHover(false);\n        },\n      }\n    );\n  };\n\n  return (\n    <div onMouseEnter={() => setHover(true)} onMouseLeave={() => setHover(false)}>\n      <div className=\"flex items-center space-x-4 w-full\">\n        {resource === \"contactNotes\" ? (\n          <Avatar width={20} height={20} />\n        ) : resource === \"opportunityNotes\" ? (\n          <ReferenceField\n            source=\"opportunity_id\"\n            reference=\"opportunities\"\n            record={note}\n            link={false}\n          >\n            <ReferenceField source=\"customer_organization_id\" reference=\"organizations\" link=\"show\">\n              <OrganizationAvatar width={20} height={20} />\n            </ReferenceField>\n          </ReferenceField>\n        ) : resource === \"organizationNotes\" ? (\n          <ReferenceField\n            source=\"organization_id\"\n            reference=\"organizations\"\n            record={note}\n            link={false}\n          >\n            <OrganizationAvatar width={20} height={20} />\n          </ReferenceField>\n        ) : null}\n        <div className=\"inline-flex h-full items-center text-sm text-muted-foreground\">\n          <ReferenceField\n            record={note}\n            resource={resource}\n            source=\"sales_id\"\n            reference=\"sales\"\n            link={false}\n          >\n            <WithRecord render={(record) => <SaleName sale={record} />} />\n          </ReferenceField>{\" \"}\n          added a note\n        </div>\n        <span className={`${isHover ? \"visible\" : \"invisible\"}`}>\n          <TooltipProvider>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={handleEnterEditMode}\n                  className=\"cursor-pointer\"\n                  aria-label=\"Edit note\"\n                >\n                  <Edit className=\"size-4\" />\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Edit note</p>\n              </TooltipContent>\n            </Tooltip>\n          </TooltipProvider>\n          <TooltipProvider>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  onClick={handleDelete}\n                  className=\"cursor-pointer\"\n                  aria-label=\"Delete note\"\n                >\n                  <Trash2 className=\"size-4\" />\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Delete note</p>\n              </TooltipContent>\n            </Tooltip>\n          </TooltipProvider>\n        </span>\n        <div className=\"flex-1\"></div>\n        <span className=\"text-sm text-muted-foreground\">\n          <RelativeDate date={note.created_at} />\n        </span>\n      </div>\n      {isEditing ? (\n        <Form onSubmit={handleNoteUpdate} record={note}>\n          <NoteInputs />\n          <div className=\"flex justify-end mt-4 space-x-4\">\n            <Button\n              variant=\"ghost\"\n              onClick={handleCancelEdit}\n              type=\"button\"\n              className=\"cursor-pointer\"\n            >\n              <CircleX className=\"size-4\" />\n              Cancel\n            </Button>\n            <Button\n              type=\"submit\"\n              disabled={isPending}\n              className=\"flex items-center gap-2 cursor-pointer\"\n            >\n              <Save className=\"size-4\" />\n              Update note\n            </Button>\n          </div>\n        </Form>\n      ) : (\n        <div className=\"pt-2 [&_p:empty]:min-h-[0.75em]\">\n          {note.text?.split(\"\\n\").map((paragraph: string, index: number) => (\n            <p className=\"text-sm leading-6 m-0\" key={index}>\n              {paragraph}\n            </p>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n};\n","import { useListContext } from \"ra-core\";\nimport * as React from \"react\";\n\nimport { Separator } from \"@/components/ui/separator\";\nimport { Note } from \"./Note\";\nimport { NoteCreate } from \"./NoteCreate\";\n\nexport const NotesIterator = ({\n  reference,\n}: {\n  reference: \"contacts\" | \"opportunities\" | \"organizations\";\n}) => {\n  const { data, error, isPending } = useListContext();\n  if (isPending || error) return null;\n  return (\n    <div className=\"mt-4\">\n      <NoteCreate reference={reference} />\n      {data && (\n        <div className=\"mt-4 space-y-4\">\n          {data.map((note, index) => (\n            <React.Fragment key={index}>\n              <Note note={note} isLast={index === data.length - 1} key={index} />\n              {index < data.length - 1 && <Separator />}\n            </React.Fragment>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n};\n"],"names":["NoteInputs","__name","displayMore","setDisplayMore","useState","setValue","useFormContext","jsxs","className","children","jsx","TextInput","source","label","multiline","helperText","placeholder","Button","variant","size","onClick","getCurrentDate","cn","type","foreignKeyMapping","contacts","opportunities","organizations","NoteCreate","reference","resource","useResourceContext","record","useRecordContext","data","identity","useGetIdentity","formDefaults","baseNoteSchema","partial","parse","CreateBase","redirect","Form","defaultValues","NoteFormContent","errors","useFormState","Fragment","FormErrorSummary","NoteCreateButton","update","useUpdate","notify","useNotify","reset","refetch","useListContext","handleSuccess","keepValues","id","last_seen","Date","toISOString","previousData","SaveButton","transform","sales_id","date","mutationOptions","onSuccess","Note","note","isHover","setHover","isEditing","setEditing","isPending","deleteNote","useDelete","mutationMode","undoable","handleDelete","handleEnterEditMode","handleCancelEdit","handleNoteUpdate","values","onMouseEnter","onMouseLeave","Avatar","width","height","ReferenceField","link","OrganizationAvatar","WithRecord","render","SaleName","sale","TooltipProvider","Tooltip","TooltipTrigger","asChild","Edit","TooltipContent","Trash2","RelativeDate","created_at","onSubmit","CircleX","disabled","Save","text","split","map","paragraph","index","NotesIterator","error","React.Fragment","isLast","length","Separator"],"mappings":"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"}