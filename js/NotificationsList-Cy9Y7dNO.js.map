{"version":3,"file":"NotificationsList-Cy9Y7dNO.js","sources":["../../src/atomic-crm/notifications/NotificationsList.tsx"],"sourcesContent":["import { formatDistanceToNow } from \"date-fns\";\nimport { Bell, Check, Eye, ExternalLink } from \"lucide-react\";\nimport { useListContext, useUpdate, useNotify, useRefresh } from \"ra-core\";\n\nimport { BulkActionsToolbar } from \"@/components/admin/bulk-actions-toolbar\";\nimport { List } from \"@/components/admin/list\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { Card } from \"@/components/ui/card\";\nimport { FilterLiveForm } from \"ra-core\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Link } from \"react-router-dom\";\nimport { cn } from \"@/lib/utils\";\nimport { parseDateSafely } from \"@/lib/date-utils\";\n\ninterface Notification {\n  id: number;\n  type: string;\n  message: string;\n  entity_type: string | null;\n  entity_id: number | null;\n  read: boolean;\n  created_at: string;\n}\n\nconst NotificationsList = () => {\n  return (\n    <List\n      title=\"Notifications\"\n      actions={<NotificationsListActions />}\n      perPage={20}\n      sort={{ field: \"created_at\", order: \"DESC\" }}\n      empty={<NotificationsEmpty />}\n    >\n      <NotificationsListLayout />\n    </List>\n  );\n};\n\nconst NotificationsListLayout = () => {\n  const { isPending } = useListContext<Notification>();\n\n  if (isPending) return <div className=\"p-6 text-center\">Loading...</div>;\n\n  return (\n    <div className=\"flex flex-row gap-6\">\n      <NotificationsListFilter />\n      <div className=\"flex-1 flex flex-col gap-4\">\n        <Card className=\"bg-card border border-border shadow-sm rounded-xl p-2\">\n          <NotificationsListContent />\n        </Card>\n      </div>\n      <BulkActionsToolbar>\n        <NotificationsBulkActions />\n      </BulkActionsToolbar>\n    </div>\n  );\n};\n\nconst NotificationsListActions = () => (\n  <TopToolbar>{/* No actions needed for notifications list */}</TopToolbar>\n);\n\nconst NotificationsListFilter = () => {\n  return (\n    <div className=\"w-52 min-w-52 order-first\">\n      <Card className=\"bg-card border border-border shadow-sm rounded-xl p-4\">\n        <div className=\"flex flex-col gap-4\">\n          {/* Search */}\n          <FilterLiveForm>\n            <SearchInput source=\"q\" placeholder=\"Search notifications...\" />\n          </FilterLiveForm>\n\n          {/* Divider */}\n          <div className=\"border-b border-border\" />\n\n          {/* Read/Unread Filter */}\n          <FilterCategory label=\"Status\" icon={<Bell className=\"h-4 w-4\" />}>\n            <ToggleFilterButton\n              className=\"w-full justify-between\"\n              label=\"Unread only\"\n              value={{ read: false }}\n            />\n            <ToggleFilterButton\n              className=\"w-full justify-between\"\n              label=\"Read only\"\n              value={{ read: true }}\n            />\n          </FilterCategory>\n        </div>\n      </Card>\n    </div>\n  );\n};\n\nconst NotificationsListContent = () => {\n  const { data } = useListContext<Notification>();\n\n  if (!data || data.length === 0) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-12 text-muted-foreground\">\n        <Bell className=\"h-12 w-12 mb-4 opacity-50\" />\n        <p className=\"text-lg font-medium\">No notifications</p>\n        <p className=\"text-sm\">You're all caught up!</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"divide-y divide-border\">\n      {data.map((notification) => (\n        <NotificationRow key={notification.id} notification={notification} />\n      ))}\n    </div>\n  );\n};\n\nconst NotificationRow = ({ notification }: { notification: Notification }) => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n\n  const markAsRead = async () => {\n    await update(\n      \"notifications\",\n      { id: notification.id, data: { read: true } },\n      {\n        onSuccess: () => {\n          notify(\"Notification marked as read\", { type: \"success\" });\n          refresh();\n        },\n        onError: () => {\n          notify(\"Error marking notification as read\", { type: \"error\" });\n        },\n      }\n    );\n  };\n\n  const timeAgo = formatDistanceToNow(parseDateSafely(notification.created_at) ?? new Date(), {\n    addSuffix: true,\n  });\n\n  const entityLink = getEntityLink(notification.entity_type, notification.entity_id);\n\n  return (\n    <div\n      className={cn(\n        \"flex items-start gap-4 p-4 hover:bg-muted/30 transition-colors\",\n        !notification.read && \"bg-muted/20\"\n      )}\n    >\n      {/* Status Indicator */}\n      <div className=\"flex-shrink-0 mt-2\">\n        <div\n          className={cn(\n            \"w-3 h-3 rounded-full\",\n            !notification.read ? \"bg-primary\" : \"bg-muted-foreground/30\"\n          )}\n        />\n      </div>\n\n      {/* Content */}\n      <div className=\"flex-1 min-w-0\">\n        <div className=\"flex items-start justify-between gap-4\">\n          <p className=\"text-sm\">{notification.message}</p>\n          <Badge variant=\"outline\" className=\"flex-shrink-0\">\n            {getNotificationTypeLabel(notification.type)}\n          </Badge>\n        </div>\n\n        <div className=\"flex items-center gap-3 mt-2 text-xs text-muted-foreground\">\n          <span>{timeAgo}</span>\n          {entityLink && (\n            <>\n              <span>â€¢</span>\n              <Link\n                to={entityLink}\n                className=\"hover:text-foreground transition-colors inline-flex items-center gap-1\"\n              >\n                View {notification.entity_type}\n                <ExternalLink className=\"h-3 w-3\" />\n              </Link>\n            </>\n          )}\n        </div>\n      </div>\n\n      {/* Mark as Read Button */}\n      {!notification.read && (\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          className=\"flex-shrink-0 h-11 w-11\"\n          onClick={markAsRead}\n          aria-label=\"Mark as read\"\n        >\n          <Eye className=\"h-4 w-4\" />\n        </Button>\n      )}\n    </div>\n  );\n};\n\nconst NotificationsBulkActions = () => {\n  const [update] = useUpdate();\n  const notify = useNotify();\n  const refresh = useRefresh();\n  const { selectedIds } = useListContext();\n\n  const markAllAsRead = async () => {\n    try {\n      // Phase 3: Use Promise.allSettled() to handle partial failures gracefully\n      const results = await Promise.allSettled(\n        selectedIds.map((id) => update(\"notifications\", { id, data: { read: true } }))\n      );\n\n      // Count successes and failures\n      const successes = results.filter((r) => r.status === \"fulfilled\").length;\n      const failures = results.filter((r) => r.status === \"rejected\").length;\n\n      if (failures === 0) {\n        notify(`${successes} notification(s) marked as read`, { type: \"success\" });\n      } else if (successes > 0) {\n        notify(`${successes} notification(s) marked as read, ${failures} failed`, {\n          type: \"warning\",\n        });\n      } else {\n        notify(\"Failed to mark notifications as read\", { type: \"error\" });\n      }\n\n      refresh();\n    } catch {\n      notify(\"Error marking notifications as read\", { type: \"error\" });\n    }\n  };\n\n  return (\n    <Button variant=\"ghost\" size=\"sm\" onClick={markAllAsRead} className=\"h-11 text-xs\">\n      <Check className=\"h-4 w-4 mr-2\" />\n      Mark as read\n    </Button>\n  );\n};\n\nconst NotificationsEmpty = () => {\n  return (\n    <div className=\"flex flex-col items-center justify-center min-h-[50vh] text-muted-foreground\">\n      <Bell className=\"h-16 w-16 mb-4 opacity-50\" />\n      <h2 className=\"text-2xl font-semibold mb-2\">No notifications yet</h2>\n      <p className=\"text-sm\">Notifications will appear here when you have updates.</p>\n    </div>\n  );\n};\n\n// Helper functions\nconst getEntityLink = (entityType: string | null, entityId: number | null): string | null => {\n  if (!entityType || !entityId) return null;\n\n  const routes: Record<string, string> = {\n    task: `/tasks/${entityId}`,\n    opportunity: `/opportunities/${entityId}/show`,\n    contact: `/contacts/${entityId}/show`,\n    organization: `/organizations/${entityId}/show`,\n    product: `/products/${entityId}/show`,\n  };\n\n  return routes[entityType] || null;\n};\n\nconst getNotificationTypeLabel = (type: string): string => {\n  const labels: Record<string, string> = {\n    task_overdue: \"Overdue Task\",\n    task_assigned: \"Task Assigned\",\n    mention: \"Mention\",\n    opportunity_won: \"Opportunity Won\",\n    opportunity_lost: \"Opportunity Lost\",\n    system: \"System\",\n  };\n\n  return labels[type] || type;\n};\n\nexport default NotificationsList;\n"],"names":["NotificationsList","__name","jsx","List","title","actions","NotificationsListActions","perPage","sort","field","order","empty","NotificationsEmpty","children","NotificationsListLayout","isPending","useListContext","className","jsxs","NotificationsListFilter","Card","NotificationsListContent","BulkActionsToolbar","NotificationsBulkActions","TopToolbar","FilterLiveForm","SearchInput","source","placeholder","FilterCategory","label","icon","Bell","ToggleFilterButton","value","read","data","length","map","notification","NotificationRow","id","update","useUpdate","notify","useNotify","refresh","useRefresh","markAsRead","async","onSuccess","type","onError","timeAgo","formatDistanceToNow","parseDateSafely","created_at","Date","addSuffix","entityLink","getEntityLink","entity_type","entity_id","cn","message","Badge","variant","getNotificationTypeLabel","Fragment","Link","to","ExternalLink","Button","size","onClick","Eye","selectedIds","markAllAsRead","results","Promise","allSettled","successes","filter","r","status","failures","Check","entityType","entityId","task","opportunity","contact","organization","product","task_overdue","task_assigned","mention","opportunity_won","opportunity_lost","system"],"mappings":"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"}