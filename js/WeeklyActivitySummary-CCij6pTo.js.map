{"version":3,"file":"WeeklyActivitySummary-CCij6pTo.js","sources":["../../src/atomic-crm/reports/WeeklyActivitySummary.tsx"],"sourcesContent":["import { useState, useMemo } from \"react\";\nimport { useGetList, useGetIdentity, downloadCSV, useNotify } from \"ra-core\";\nimport { startOfWeek, endOfWeek, format } from \"date-fns\";\nimport jsonExport from \"jsonexport/dist\";\nimport { ReportLayout } from \"./ReportLayout\";\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { sanitizeCsvValue } from \"@/atomic-crm/utils/csvUploadValidator\";\nimport type { ActivityRecord, Organization, Sale } from \"../types\";\n\n/**\n * Weekly Activity Summary Report\n *\n * Shows activity counts by rep and principal for manager visibility.\n * Groups: Sales Rep → Principal → Activity Type Counts\n *\n * Flags low-activity principals (< 3 activities/week) with warning.\n *\n * CSV Export: rep_name, principal_name, calls, emails, meetings, notes, total\n */\nexport default function WeeklyActivitySummary() {\n  const { data: identity } = useGetIdentity();\n  const notify = useNotify();\n  const [dateRange, setDateRange] = useState(() => ({\n    start: format(startOfWeek(new Date(), { weekStartsOn: 1 }), \"yyyy-MM-dd\"),\n    end: format(endOfWeek(new Date(), { weekStartsOn: 1 }), \"yyyy-MM-dd\"),\n  }));\n\n  // Fetch activities for date range\n  const { data: activities, isPending: activitiesPending } = useGetList<ActivityRecord>(\n    \"activities\",\n    {\n      pagination: { page: 1, perPage: 10000 },\n      filter: {\n        \"activity_date@gte\": dateRange.start,\n        \"activity_date@lte\": dateRange.end,\n      },\n      sort: { field: \"activity_date\", order: \"DESC\" },\n    }\n  );\n\n  // Fetch sales reps\n  const createdByIds = useMemo(\n    () => Array.from(new Set((activities || []).map((a) => a.created_by).filter(Boolean))),\n    [activities]\n  );\n\n  const { data: sales } = useGetList<Sale>(\"sales\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: { id: createdByIds },\n  });\n\n  // Fetch organizations (principals)\n  const orgIds = useMemo(\n    () => Array.from(new Set((activities || []).map((a) => a.organization_id).filter(Boolean))),\n    [activities]\n  );\n\n  const { data: organizations } = useGetList<Organization>(\"organizations\", {\n    pagination: { page: 1, perPage: 1000 },\n    filter: { id: orgIds },\n  });\n\n  // Build lookup maps\n  const salesMap = useMemo(() => new Map((sales || []).map((s) => [s.id, s])), [sales]);\n\n  const orgMap = useMemo(\n    () => new Map((organizations || []).map((o) => [o.id, o])),\n    [organizations]\n  );\n\n  // Group activities by rep → principal → type\n  const reportData = useMemo(() => {\n    if (!activities) return [];\n\n    const groups = new Map<\n      number,\n      {\n        rep: Sale;\n        principals: Map<\n          number,\n          {\n            org: Organization;\n            calls: number;\n            emails: number;\n            meetings: number;\n            notes: number;\n            total: number;\n          }\n        >;\n      }\n    >();\n\n    activities.forEach((activity) => {\n      if (!activity.created_by) return;\n\n      const rep = salesMap.get(activity.created_by);\n      if (!rep) return;\n\n      if (!groups.has(activity.created_by)) {\n        groups.set(activity.created_by, { rep, principals: new Map() });\n      }\n\n      const repGroup = groups.get(activity.created_by)!;\n\n      const orgId = activity.organization_id || 0;\n      if (!repGroup.principals.has(orgId)) {\n        const org = orgId ? orgMap.get(orgId) : null;\n        repGroup.principals.set(orgId, {\n          org: org || ({ id: 0, name: \"No Principal\" } as Organization),\n          calls: 0,\n          emails: 0,\n          meetings: 0,\n          notes: 0,\n          total: 0,\n        });\n      }\n\n      const principalStats = repGroup.principals.get(orgId)!;\n\n      // Count by type\n      if (activity.type === \"call\") principalStats.calls++;\n      else if (activity.type === \"email\") principalStats.emails++;\n      else if (activity.type === \"meeting\") principalStats.meetings++;\n      else principalStats.notes++;\n\n      principalStats.total++;\n    });\n\n    return Array.from(groups.values());\n  }, [activities, salesMap, orgMap]);\n\n  const handleExport = () => {\n    const exportData: any[] = [];\n\n    reportData.forEach((repGroup) => {\n      repGroup.principals.forEach((stats) => {\n        exportData.push({\n          rep_name: sanitizeCsvValue(`${repGroup.rep.first_name} ${repGroup.rep.last_name}`),\n          principal_name: sanitizeCsvValue(stats.org.name),\n          calls: stats.calls,\n          emails: stats.emails,\n          meetings: stats.meetings,\n          notes: stats.notes,\n          total: stats.total,\n        });\n      });\n    });\n\n    jsonExport(exportData, (err, csv) => {\n      if (err) {\n        console.error(\"Export error:\", err);\n        notify(\"Export failed. Please try again.\", { type: \"error\" });\n        return;\n      }\n      downloadCSV(csv, `weekly-activity-${dateRange.start}-to-${dateRange.end}`);\n      notify(\"Report exported successfully\", { type: \"success\" });\n    });\n  };\n\n  if (activitiesPending || !identity) {\n    return (\n      <ReportLayout title=\"Weekly Activity Summary\">\n        <p className=\"text-muted-foreground\">Loading activities...</p>\n      </ReportLayout>\n    );\n  }\n\n  const totalActivities = activities?.length || 0;\n\n  return (\n    <ReportLayout\n      title=\"Weekly Activity Summary\"\n      onExport={handleExport}\n      actions={\n        <div className=\"flex items-center gap-2\">\n          <input\n            type=\"date\"\n            value={dateRange.start}\n            onChange={(e) => setDateRange({ ...dateRange, start: e.target.value })}\n            className=\"px-3 py-2 border rounded text-sm\"\n          />\n          <span className=\"text-muted-foreground\">to</span>\n          <input\n            type=\"date\"\n            value={dateRange.end}\n            onChange={(e) => setDateRange({ ...dateRange, end: e.target.value })}\n            className=\"px-3 py-2 border rounded text-sm\"\n          />\n        </div>\n      }\n    >\n      <div className=\"space-y-section\">\n        {/* Summary Stats */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-content\">\n          <Card>\n            <CardContent className=\"p-4\">\n              <p className=\"text-sm text-muted-foreground\">Total Activities</p>\n              <p className=\"text-2xl font-bold\">{totalActivities}</p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"p-4\">\n              <p className=\"text-sm text-muted-foreground\">Active Reps</p>\n              <p className=\"text-2xl font-bold\">{reportData.length}</p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"p-4\">\n              <p className=\"text-sm text-muted-foreground\">Avg per Rep</p>\n              <p className=\"text-2xl font-bold\">\n                {reportData.length > 0 ? Math.round(totalActivities / reportData.length) : 0}\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Rep Activity Breakdown */}\n        {reportData.length === 0 ? (\n          <p className=\"text-center text-muted-foreground py-8\">\n            No activities found for this date range\n          </p>\n        ) : (\n          <div className=\"space-y-6\">\n            {reportData.map((repGroup) => (\n              <RepActivityCard key={repGroup.rep.id} repGroup={repGroup} />\n            ))}\n          </div>\n        )}\n      </div>\n    </ReportLayout>\n  );\n}\n\ninterface RepActivityCardProps {\n  repGroup: {\n    rep: Sale;\n    principals: Map<\n      number,\n      {\n        org: Organization;\n        calls: number;\n        emails: number;\n        meetings: number;\n        notes: number;\n        total: number;\n      }\n    >;\n  };\n}\n\nfunction RepActivityCard({ repGroup }: RepActivityCardProps) {\n  const totalActivities = Array.from(repGroup.principals.values()).reduce(\n    (sum, p) => sum + p.total,\n    0\n  );\n\n  const principalStats = Array.from(repGroup.principals.values()).sort((a, b) => b.total - a.total);\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle className=\"flex items-center justify-between\">\n          <span>\n            {repGroup.rep.first_name} {repGroup.rep.last_name}\n          </span>\n          <Badge>{totalActivities} activities</Badge>\n        </CardTitle>\n      </CardHeader>\n      <CardContent>\n        <table className=\"w-full\">\n          <thead>\n            <tr className=\"border-b text-sm text-muted-foreground\">\n              <th className=\"text-left py-2\">Principal</th>\n              <th className=\"text-right py-2\">Calls</th>\n              <th className=\"text-right py-2\">Emails</th>\n              <th className=\"text-right py-2\">Meetings</th>\n              <th className=\"text-right py-2\">Notes</th>\n              <th className=\"text-right py-2\">Total</th>\n            </tr>\n          </thead>\n          <tbody>\n            {principalStats.map((stats, idx) => (\n              <tr\n                key={stats.org.id || idx}\n                className={`border-b ${stats.total < 3 ? \"bg-warning/10\" : \"\"}`}\n              >\n                <td className=\"py-2 flex items-center gap-2\">\n                  {stats.org.name}\n                  {stats.total < 3 && (\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      ⚠️ Low Activity\n                    </Badge>\n                  )}\n                </td>\n                <td className=\"text-right\">{stats.calls}</td>\n                <td className=\"text-right\">{stats.emails}</td>\n                <td className=\"text-right\">{stats.meetings}</td>\n                <td className=\"text-right\">{stats.notes}</td>\n                <td className=\"text-right font-semibold\">{stats.total}</td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </CardContent>\n    </Card>\n  );\n}\n"],"names":["WeeklyActivitySummary","data","identity","useGetIdentity","notify","useNotify","dateRange","setDateRange","useState","start","format","startOfWeek","Date","weekStartsOn","end","endOfWeek","activities","isPending","activitiesPending","useGetList","pagination","page","perPage","filter","sort","field","order","createdByIds","useMemo","Array","from","Set","map","a","created_by","Boolean","sales","id","orgIds","organization_id","organizations","salesMap","Map","s","orgMap","o","reportData","groups","forEach","activity","rep","get","has","set","principals","repGroup","orgId","org","name","calls","emails","meetings","notes","total","principalStats","type","values","handleExport","__name","exportData","stats","push","rep_name","sanitizeCsvValue","first_name","last_name","principal_name","jsonExport","err","csv","downloadCSV","jsx","ReportLayout","title","children","className","totalActivities","length","onExport","actions","jsxs","value","onChange","e","target","Card","CardContent","Math","round","RepActivityCard","reduce","sum","p","b","CardHeader","CardTitle","Badge","idx","variant"],"mappings":"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"}