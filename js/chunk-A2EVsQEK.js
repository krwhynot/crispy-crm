var e=Object.defineProperty,a=(a,t)=>e(a,"name",{value:t,configurable:!0});import{j as t,P as s,ak as r}from"./chunk-ByJg_QQB.js";import{r as n}from"./chunk-1NZFT-6z.js";import{V as i,W as l,B as o,X as c,s as m,b1 as g}from"../assets/index-BoLku8RR.js";import{P as u,aQ as d,X as f}from"./chunk-Bc6KM1xM.js";import{g as h,o as p,f as x,h as v,n as b,z as y,_ as N}from"./chunk-JxeXaC9i.js";import{f as j}from"./chunk-CFj7NhUg.js";const k="crm-filter-sidebar-collapsed";function S({filterComponent:e,children:a,resource:s}){const[r,m]=n.useState(()=>{if("undefined"==typeof window)return!1;const e=localStorage.getItem(k);return null!==e?"true"===e:window.innerWidth<1024});n.useEffect(()=>{localStorage.setItem(k,String(r))},[r]);const g=n.useCallback(()=>{m(e=>!e)},[]);return t.jsxs("div",{className:"flex h-full min-h-0 flex-1 flex-col lg:flex-row gap-6",children:[t.jsxs("div",{className:"flex items-center gap-2 lg:hidden mb-2 shrink-0",children:[t.jsxs(i,{children:[t.jsx(l,{asChild:!0,children:t.jsx(o,{variant:"outline",size:"icon",onClick:g,className:"h-11 w-11","aria-label":r?"Show filters":"Hide filters","aria-expanded":!r,"aria-controls":"filter-sidebar",children:r?t.jsx(u,{className:"size-5"}):t.jsx(d,{className:"size-5"})})}),t.jsx(c,{side:"right",children:r?"Show filters":"Hide filters"})]}),r&&t.jsx("span",{className:"text-sm text-muted-foreground",children:"Filters hidden"})]}),t.jsx("aside",{id:"filter-sidebar","aria-label":`Filter ${s}`,className:`\n          filter-sidebar w-full lg:w-auto lg:sticky lg:top-0 lg:h-fit lg:self-start\n          transition-all duration-200 ease-out overflow-y-auto shrink-0\n          ${r?"max-h-0 lg:max-h-none lg:w-0 lg:opacity-0 lg:invisible":"max-h-[60vh] lg:max-h-[calc(100vh-6rem)] lg:opacity-100"}\n        `,"aria-hidden":r,children:t.jsxs("div",{className:"card-container p-2",children:[t.jsxs("div",{className:"hidden lg:flex items-center justify-between mb-2",children:[t.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"Filters"}),t.jsxs(i,{children:[t.jsx(l,{asChild:!0,children:t.jsx(o,{variant:"ghost",size:"icon",onClick:g,className:"h-11 w-11","aria-label":"Hide filters",children:t.jsx(d,{className:"size-5"})})}),t.jsx(c,{side:"right",children:"Hide filters"})]})]}),e]})}),r&&t.jsx("div",{className:"hidden lg:block shrink-0",children:t.jsxs(i,{children:[t.jsx(l,{asChild:!0,children:t.jsx(o,{variant:"outline",size:"icon",onClick:g,className:"h-11 w-11 sticky top-0","aria-label":"Show filters","aria-expanded":!1,"aria-controls":"filter-sidebar",children:t.jsx(u,{className:"size-5"})})}),t.jsx(c,{side:"right",children:"Show filters"})]})}),t.jsx("main",{role:"main","aria-label":`${s} list`,className:"flex h-full min-h-0 min-w-0 flex-1 flex-col overflow-hidden",children:t.jsx("div",{className:"card-container flex h-full min-h-0 flex-1 flex-col overflow-hidden pb-2",children:a})})]})}a(S,"StandardListLayout");const w=a(({label:e,onRemove:s,className:r})=>{const n=a(e=>{e.stopPropagation(),s()},"handleRemove");return t.jsxs("div",{className:m("inline-flex items-center gap-1.5 pl-3 pr-1 text-sm rounded-full","bg-muted hover:bg-muted/90 transition-colors","min-h-[2.75rem]",r),children:[t.jsx("span",{className:"truncate max-w-[150px]",children:e}),t.jsx(o,{variant:"ghost",size:"icon",className:m("rounded-full hover:bg-accent/50","h-11 w-11","focus:outline-none focus:ring-2 focus:ring-ring"),onClick:n,"aria-label":`Remove ${e} filter`,children:t.jsx(f,{className:"size-4","aria-hidden":"true"})})]})},"FilterChip");function C(e,t,r,i){const l=s(),[o,c]=n.useState({}),[m,g]=n.useState(!1),u=n.useMemo(()=>t?.join(",")||"",[t]);n.useEffect(()=>{if(!t||0===t.length)return;a(async()=>{const a=t.filter(e=>!o[e]);if(0!==a.length){g(!0);try{const{data:t}=await l.getMany(e,{ids:a}),s=t.reduce((e,a)=>(e[String(a.id)]=r(a),e),{});c(e=>({...e,...s}))}catch(s){}finally{g(!1)}}},"fetchNames")()},[u,t,o,l,e,r]);const d=n.useCallback(e=>o[e]||`${i} #${e}`,[o,i]);return{namesMap:o,getName:d,loading:m}}a(C,"useResourceNamesBase");const z={sales:a(e=>`${e.first_name??""} ${e.last_name??""}`.trim()||"Unknown","sales"),organizations:a(e=>e.name,"organizations"),tags:a(e=>e.name,"tags")},F=a(e=>{const{namesMap:a,getName:t,loading:s}=C("organizations",e,z.organizations,"Organization");return{organizationMap:a,getOrganizationName:t,loading:s}},"useOrganizationNames"),M=a(e=>{const{namesMap:a,getName:t,loading:s}=C("sales",e,z.sales,"Sales");return{salesMap:a,getSalesName:t,loading:s}},"useSalesNames"),A=a(e=>{const{namesMap:a,getName:t,loading:s}=C("tags",e,z.tags,"Tag");return{tagMap:a,getTagName:t,loading:s}},"useTagNames"),E=a(e=>e.name,"segmentExtractor"),_=a(e=>{const a=n.useMemo(()=>e?.filter(e=>!g[e]),[e]),{namesMap:t,loading:s}=C("segments",a,E,"Playbook"),r=n.useCallback(e=>{const a=g[e];return a||(t[e]||`Playbook #${e}`)},[t]);return{segmentMap:n.useMemo(()=>({...g,...t}),[t]),getSegmentName:r,loading:s}},"useSegmentNames"),G=a(e=>e.name,"categoryExtractor"),$=a(e=>{const{namesMap:a,getName:t,loading:s}=C("distinct_product_categories",e,G,"Category");return{categoryMap:a,getCategoryName:t,loading:s}},"useCategoryNames"),R=["deleted_at","deleted_at@is"];function L(e,a){const{filterValues:t,setFilters:s,displayedFilters:i}=r();if(!t||!s)throw new Error("useFilterChipBar must be used within a React Admin List context. Ensure FilterChipBar is rendered inside a <List> component.");const l=n.useMemo(()=>{const a={organizations:[],sales:[],tags:[],segments:[],categories:[]};return e.forEach(e=>{const s=t[e.key];if(!s)return;const r=Array.isArray(s)?s:[s];"organizations"===e.reference||"organization_id"===e.key?a.organizations.push(...r.map(String)):"sales"===e.reference||"sales_id"===e.key?a.sales.push(...r.map(String)):"tags"===e.reference||"tags"===e.key?a.tags.push(...r.map(String)):"segments"===e.reference||"segment_id"===e.key?a.segments.push(...r.map(String)):"categories"!==e.reference&&"category"!==e.key||a.categories.push(...r.map(String))}),a},[t,e]),{getOrganizationName:o}=F(l.organizations),{getSalesName:c}=M(l.sales),{getTagName:m}=A(l.tags),{getSegmentName:g}=_(l.segments),{getCategoryName:u}=$(l.categories),d=n.useMemo(()=>{const a=new Map;return e.forEach(e=>{if(e.removalGroup){const t=a.get(e.removalGroup)||[];a.set(e.removalGroup,[...t,e.key])}}),a},[e]),f=n.useCallback(e=>{if(e.choices)return"function"==typeof e.choices?e.choices(a):e.choices},[a]),h=n.useMemo(()=>{const a=[],s=new Set;return Object.entries(t).forEach(([r,n])=>{if(R.includes(r)||null==n)return;const i=e.find(e=>e.key===r),l=i?.label??r;if(i?.removalGroup){if(s.has(i.removalGroup))return;s.add(i.removalGroup);const r=e.filter(e=>e.removalGroup===i.removalGroup),n=[];if(r.forEach(e=>{const a=t[e.key];if(null!=a){const t=e.formatLabel?e.formatLabel(a):String(a);n.push(t)}}),n.length>0){const e=n.join(" â€“ ");a.push({key:i.removalGroup,value:i.removalGroup,label:e,category:i.label.replace(/(After|Before|@gte|@lte)/gi,"").trim()||"Date"})}return}(Array.isArray(n)?n:[n]).forEach(e=>{let t;if("q"===r)return t=`Search: "${String(e)}"`,void a.push({key:r,value:e,label:t,category:"Search"});if(i?.formatLabel)t=i.formatLabel(e);else if(i?.choices){const a=f(i),s=a?.find(a=>a.id===e);t=s?.name??String(e)}else t="organizations"===i?.reference||"organization_id"===r?o(String(e)):"sales"===i?.reference||"sales_id"===r?c(String(e)):"tags"===i?.reference||"tags"===r?m(String(e)):"segments"===i?.reference||"segment_id"===r?g(String(e)):"categories"===i?.reference||"category"===r?u(String(e)):String(e);a.push({key:r,value:e,label:t,category:l})})}),a},[t,e,f,o,c,m,g,u]),p=n.useCallback((a,r)=>{const n=e.find(e=>e.key===a);let l;l=d.has(a)?d.get(a)||[a]:n?.removalGroup&&d.get(n.removalGroup)||[a];const o=t[a];if(Array.isArray(o)&&void 0!==r&&1===l.length){const e=o.filter(e=>e!==r);s({...t,[a]:e.length?e:void 0},i)}else{const e={...t};l.forEach(a=>{delete e[a]}),s(e,i)}},[t,s,i,e,d]),x=n.useCallback(()=>{const e=Object.fromEntries(Object.entries(t).filter(([e])=>R.includes(e)));s(e,i)},[t,s,i]),v=h.length;return{chips:h,removeFilter:p,clearAllFilters:x,hasActiveFilters:v>0,activeCount:v}}function O({filterConfig:e,context:s,className:r}){const i=n.useRef(null);if(!e||0===e.length)throw new Error("FilterChipBar requires a non-empty filterConfig. Check that the feature has defined its filter configuration.");const{chips:l,removeFilter:c,clearAllFilters:g,hasActiveFilters:u,activeCount:d}=L(e,s),f=n.useCallback(e=>{const a=i.current?.querySelectorAll('button[aria-label^="Remove"]');if(!a?.length)return;const t=Array.from(a).findIndex(e=>e===document.activeElement);switch(e.key){case"ArrowRight":e.preventDefault(),a[(t+1)%a.length].focus();break;case"ArrowLeft":e.preventDefault(),a[t<=0?a.length-1:t-1].focus();break;case"Home":e.preventDefault(),a[0].focus();break;case"End":e.preventDefault(),a[a.length-1].focus()}},[]);return u?t.jsxs("div",{ref:i,role:"toolbar","aria-label":"Active filters","aria-orientation":"horizontal",onKeyDown:f,className:m("flex items-center gap-2 px-4 py-2 bg-muted/50 border-b overflow-x-auto",r),children:[t.jsx("span",{id:"filter-chip-bar-label",className:"text-sm text-muted-foreground whitespace-nowrap",children:"Active filters:"}),t.jsx("div",{role:"list","aria-labelledby":"filter-chip-bar-label",className:"flex items-center gap-1.5 flex-wrap",children:l.map(e=>t.jsx("div",{role:"listitem",children:t.jsx(w,{label:e.label,onRemove:a(()=>c(e.key,e.value),"onRemove")})},`${e.key}-${e.value}`))}),d>=2&&t.jsx(o,{variant:"ghost",size:"sm",onClick:g,className:"ml-auto whitespace-nowrap text-muted-foreground hover:text-foreground","aria-label":`Clear all ${d} filters`,children:"Clear all"})]}):null}a(L,"useFilterChipBar"),a(O,"FilterChipBar");const B=p({id:v([x(),b()]),name:x().max(100)}),P=y(e=>"function"==typeof e,{message:"Expected a function returning FilterChoice[]"}),D=y(e=>"function"==typeof e,{message:"Expected a function returning string"}),I=p({key:x().min(1).max(100),label:x().min(1).max(50),type:N(["select","multiselect","reference","date-range","search","toggle","boolean"]),reference:x().optional(),choices:v([h(B),P]).optional(),formatLabel:D.optional(),removalGroup:x().optional()}),H=h(I);function T(e){return H.parse(e)}function q(e,a,t={}){const s=t.type||"session";try{return("session"===s?sessionStorage:localStorage).setItem(e,JSON.stringify(a)),!0}catch(r){try{return("session"===s?localStorage:sessionStorage).setItem(e,JSON.stringify(a)),!0}catch(n){return!1}}}a(T,"validateFilterConfig"),a(q,"setStorageItem");j.filter(e=>!["closed_won","closed_lost"].includes(e.id)).map(e=>e.id);const J=a(e=>{if(0!==e.length)try{q("filter.opportunity_stages",e,{type:"session"})}catch(a){}},"saveStagePreferences");export{O as F,S,J as s,T as v};
