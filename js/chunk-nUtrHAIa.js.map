{"version":3,"file":"chunk-nUtrHAIa.js","sources":["../../src/components/admin/autocomplete-input.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { useCallback } from \"react\";\nimport { Check, ChevronsUpDown } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n} from \"@/components/ui/command\";\nimport { FormControl, FormError, FormField, FormLabel } from \"@/components/admin/form\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport type { ChoicesProps, InputProps } from \"ra-core\";\nimport {\n  useChoices,\n  useChoicesContext,\n  useGetRecordRepresentation,\n  useInput,\n  useTranslate,\n  FieldTitle,\n  useEvent,\n} from \"ra-core\";\nimport { InputHelperText } from \"./input-helper-text\";\nimport type { SupportCreateSuggestionOptions } from \"@/hooks/useSupportCreateSuggestion\";\nimport { useSupportCreateSuggestion } from \"@/hooks/useSupportCreateSuggestion\";\n\nexport const AutocompleteInput = (\n  props: Omit<InputProps, \"source\"> &\n    Omit<SupportCreateSuggestionOptions, \"handleChange\" | \"filter\"> &\n    Partial<Pick<InputProps, \"source\">> &\n    ChoicesProps & {\n      className?: string;\n      disableValue?: string;\n      filterToQuery?: (searchText: string) => any;\n      translateChoice?: boolean;\n      placeholder?: string;\n      inputText?: React.ReactNode | ((option: any | undefined) => React.ReactNode);\n    }\n) => {\n  const {\n    filterToQuery = DefaultFilterToQuery,\n    inputText,\n    create,\n    createValue,\n    createLabel,\n    createHintValue,\n    createItemLabel,\n    onCreate,\n    optionText,\n  } = props;\n  const {\n    allChoices = [],\n    source,\n    resource,\n    isFromReference,\n    setFilters,\n  } = useChoicesContext(props);\n  const { id, field, isRequired } = useInput({ ...props, source });\n  const translate = useTranslate();\n  const { placeholder = translate(\"ra.action.search\", { _: \"Search...\" }) } = props;\n\n  const getRecordRepresentation = useGetRecordRepresentation(resource);\n  const { getChoiceText, getChoiceValue } = useChoices({\n    optionText: props.optionText ?? (isFromReference ? getRecordRepresentation : \"name\"),\n    optionValue: props.optionValue ?? \"id\",\n    disableValue: props.disableValue,\n    translateChoice: props.translateChoice ?? !isFromReference,\n  });\n\n  const [filterValue, setFilterValue] = React.useState(\"\");\n\n  const [open, setOpen] = React.useState(false);\n  const selectedChoice = allChoices.find((choice) => getChoiceValue(choice) === field.value);\n\n  const getInputText = useCallback(\n    (selectedChoice: any) => {\n      if (typeof inputText === \"function\") {\n        return inputText(selectedChoice);\n      }\n      if (inputText !== undefined) {\n        return inputText;\n      }\n      return getChoiceText(selectedChoice);\n    },\n    [inputText, getChoiceText]\n  );\n\n  const handleOpenChange = useEvent((isOpen: boolean) => {\n    setOpen(isOpen);\n    // Reset the filter when the popover is closed\n    if (!isOpen) {\n      setFilters(filterToQuery(\"\"));\n    }\n  });\n\n  const handleChange = useCallback(\n    (choice: any) => {\n      if (field.value === getChoiceValue(choice) && !isRequired) {\n        field.onChange(\"\");\n        setFilterValue(\"\");\n        if (isFromReference) {\n          setFilters(filterToQuery(\"\"));\n        }\n        setOpen(false);\n        return;\n      }\n      field.onChange(getChoiceValue(choice));\n      setOpen(false);\n    },\n    [\n      field,\n      getChoiceValue,\n      isRequired,\n      setFilterValue,\n      isFromReference,\n      setFilters,\n      filterToQuery,\n      setOpen,\n    ]\n  );\n\n  const {\n    getCreateItem,\n    handleChange: handleChangeWithCreateSupport,\n    createElement,\n    getOptionDisabled,\n  } = useSupportCreateSuggestion({\n    create,\n    createLabel,\n    createValue,\n    createHintValue,\n    createItemLabel,\n    onCreate,\n    handleChange,\n    optionText,\n    filter: filterValue,\n  });\n\n  const createItem =\n    (create || onCreate) && (filterValue !== \"\" || createLabel) ? getCreateItem(filterValue) : null;\n  let finalChoices = allChoices;\n  if (createItem) {\n    finalChoices = [...finalChoices, createItem];\n  }\n\n  return (\n    <>\n      <FormField className={props.className} id={id} name={source}>\n        {props.label !== false && (\n          <FormLabel>\n            <FieldTitle\n              label={props.label}\n              source={props.source ?? source}\n              resource={resource}\n              isRequired={isRequired}\n            />\n          </FormLabel>\n        )}\n        <FormControl>\n          <Popover open={open} onOpenChange={handleOpenChange}>\n            <PopoverTrigger asChild>\n              <Button\n                variant=\"outline\"\n                role=\"combobox\"\n                aria-expanded={open}\n                className=\"w-full justify-between h-auto py-1.75 font-normal\"\n              >\n                {selectedChoice ? (\n                  getInputText(selectedChoice)\n                ) : (\n                  <span className=\"text-muted-foreground\">{placeholder}</span>\n                )}\n                <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n              </Button>\n            </PopoverTrigger>\n            <PopoverContent className=\"w-full p-0\" side=\"bottom\" align=\"start\">\n              {/* We handle the filtering ourselves */}\n              <Command shouldFilter={!isFromReference}>\n                <CommandInput\n                  placeholder=\"Search...\"\n                  value={filterValue}\n                  onValueChange={(filter) => {\n                    setFilterValue(filter);\n                    // We don't want the ChoicesContext to filter the choices if the input\n                    // is not from a reference as it would also filter out the selected values\n                    if (isFromReference) {\n                      setFilters(filterToQuery(filter));\n                    }\n                  }}\n                />\n                <CommandEmpty>No matching item found.</CommandEmpty>\n                <CommandGroup className=\"max-h-[280px] overflow-y-auto\">\n                  {finalChoices.map((choice) => {\n                    const isCreateItem = !!createItem && choice?.id === createItem.id;\n                    const disabled = getOptionDisabled(choice);\n\n                    return (\n                      <CommandItem\n                        key={getChoiceValue(choice)}\n                        value={\n                          isCreateItem\n                            ? // if it's the create option, include the filter value so it is shown in the command input\n                              // characters before and after the filter value are required\n                              // to show the option when the filter value starts or ends with a space\n                              `?${filterValue}?`\n                            : getChoiceValue(choice)\n                        }\n                        onSelect={() => handleChangeWithCreateSupport(choice)}\n                        disabled={disabled}\n                      >\n                        <Check\n                          className={cn(\n                            \"mr-2 h-4 w-4\",\n                            field.value === getChoiceValue(choice) ? \"opacity-100\" : \"opacity-0\"\n                          )}\n                        />\n                        {getChoiceText(isCreateItem ? createItem : choice)}\n                      </CommandItem>\n                    );\n                  })}\n                </CommandGroup>\n              </Command>\n            </PopoverContent>\n          </Popover>\n        </FormControl>\n        <InputHelperText helperText={props.helperText} />\n        <FormError />\n      </FormField>\n      {createElement}\n    </>\n  );\n};\n\nconst DefaultFilterToQuery = (searchText: string) => ({ q: searchText });\n"],"names":["AutocompleteInput","props","filterToQuery","DefaultFilterToQuery","inputText","create","createValue","createLabel","createHintValue","createItemLabel","onCreate","optionText","allChoices","source","resource","isFromReference","setFilters","useChoicesContext","id","field","isRequired","useInput","translate","useTranslate","placeholder","_","getRecordRepresentation","useGetRecordRepresentation","getChoiceText","getChoiceValue","useChoices","optionValue","disableValue","translateChoice","filterValue","setFilterValue","React.useState","open","setOpen","selectedChoice","find","choice","value","getInputText","useCallback","handleOpenChange","useEvent","isOpen","handleChange","onChange","getCreateItem","handleChangeWithCreateSupport","createElement","getOptionDisabled","useSupportCreateSuggestion","filter","createItem","finalChoices","jsxs","Fragment","children","FormField","className","name","label","jsx","FormLabel","FieldTitle","FormControl","Popover","onOpenChange","PopoverTrigger","asChild","Button","variant","role","ChevronsUpDown","PopoverContent","side","align","Command","shouldFilter","CommandInput","onValueChange","CommandEmpty","CommandGroup","map","isCreateItem","disabled","CommandItem","onSelect","__name","Check","cn","InputHelperText","helperText","FormError","searchText","q"],"mappings":"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"}