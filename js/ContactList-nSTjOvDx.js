var e=Object.defineProperty,t=(t,a)=>e(t,"name",{value:a,configurable:!0});import{a0 as a,Z as s,az as n,aa as r,j as i,an as o,aT as l,bd as c,aB as m,bh as d,br as h,bs as u}from"./chunk-DWisBx5Y.js";import{H as p,J as f,K as g,M as x,N as j,Q as _,U as w,g as y,C as v,V as b,W as C,X as k,h as N,R as S,T as z,a as I,S as O,B as T,j as D,L as M,Y as P,c as $,E as L}from"../assets/index-BMLg8LT4.js";import{S as F}from"./chunk-B95zjXFR.js";import{r as E,L as J}from"./chunk-CPNr-gD1.js";import{u as A}from"./chunk-DZFSGdBf.js";import{r as B}from"./chunk-DBZxM7AY.js";import{F as R,a as H}from"./chunk-ll1YpLU1.js";import{c as V,a5 as W,j as U,Z as q,U as X}from"./chunk-BePsjq0D.js";import{S as Y}from"./chunk-D3G-UbTO.js";import{T as Z}from"./chunk-CsuUTTMk.js";import{f as K,q as Q,h as G,s as ee,r as te}from"./chunk-DOHniRee.js";import{F as ae,T as se}from"./chunk-BNc-PUi5.js";import{g as ne}from"./chunk-Ifmr_1lo.js";import"./chunk-DAbVPE3R.js";import"./chunk-CLB8yy76.js";import"./chunk-8CWr9u5d.js";import"./chunk--io5iQ_d.js";import"./chunk-Caaz7sLq.js";import"./chunk-BmR7hIvH.js";const re=t(e=>{const[,t]=a();E.useEffect(()=>{const a=`RaStoreCRM.${e}.listParams`,s=localStorage.getItem(a);if(s)try{const n=JSON.parse(s);if(!n?.filter)return;const r={};let i=!1;for(const t in n.filter)Object.prototype.hasOwnProperty.call(n.filter,t)&&(p(e,t)?r[t]=n.filter[t]:i=!0);i&&(n.filter=r,localStorage.setItem(a,JSON.stringify(n)),t.setItem(a,n))}catch(n){}},[e,t])},"useFilterCleanup");var ie=B();function oe({batchSize:e=10,processBatch:t}){const a=E.useRef(0),[s,n]=E.useState({state:"idle"}),r=E.useCallback(()=>{n({state:"idle"}),a.current+=1},[]),i=E.useCallback(s=>{n({state:"parsing"});const r=a.current;ie.parse(s,{header:!0,skipEmptyLines:!0,async complete(s){if(a.current!==r)return;n({state:"running",rowCount:s.data.length,errorCount:s.errors.length,importCount:0,remainingTime:null});let i=0;for(let l=0;l<s.data.length;l+=e){if(a.current!==r)return;const c=s.data.slice(l,l+e);try{const e=Date.now();await t(c),i+=Date.now()-e;const a=i/(l+c.length);n(e=>{if("running"===e.state){const t=e.importCount+c.length;return{...e,importCount:t,remainingTime:a*(s.data.length-t)}}return e})}catch(o){n(e=>"running"===e.state?{...e,errorCount:e.errorCount+c.length}:e)}}n(e=>"running"===e.state?{...e,state:"complete",remainingTime:null}:e)},error(e){n({state:"error",error:e})},dynamicTyping:!0})},[e,t]);return E.useMemo(()=>({importer:s,parseCsv:i,reset:r}),[s,i,r])}function le(){const e=(new Date).toISOString(),{identity:t}=s(),a=n(),r=E.useMemo(()=>new Map,[a]),i=E.useCallback(async e=>ce("organizations",r,e,e=>({name:e,created_at:(new Date).toISOString(),sales_id:t?.id}),a),[r,t?.id,a]),o=E.useMemo(()=>new Map,[a]),l=E.useCallback(async e=>ce("tags",o,e,e=>({name:e,color:"gray"}),a),[o,a]);return E.useCallback(async s=>{const[n,r]=await Promise.all([i(s.map(e=>e.organization_name?.trim()).filter(e=>e)),l(s.flatMap(e=>me(e.tags)))]);await Promise.all(s.map(async({first_name:s,last_name:i,gender:o,title:l,email_work:c,email_home:m,email_other:d,phone_work:h,phone_home:u,phone_other:p,first_seen:f,last_seen:g,organization_name:x,organization_role:j,tags:_,linkedin_url:w})=>{const y=[{email:c,type:"Work"},{email:m,type:"Home"},{email:d,type:"Other"}].filter(({email:e})=>e),v=[{number:h,type:"Work"},{number:u,type:"Home"},{number:p,type:"Other"}].filter(({number:e})=>e),b=x?.trim();if(!b)return Promise.resolve();const C=n.get(b);if(!C?.id)return Promise.resolve();const k=me(_).map(e=>r.get(e)).filter(e=>!!e),N=(await a.create("contacts",{data:{first_name:s,last_name:i,gender:o,title:l,email:y,phone:v,first_seen:f?new Date(f).toISOString():e,last_seen:g?new Date(g).toISOString():e,tags:k.map(e=>e.id),sales_id:t?.id,linkedin_url:w}})).data.id;N&&await a.create("contact_organizations",{data:{contact_id:N,organization_id:C.id,is_primary:!0,role:j||"decision_maker"}})}))},[a,i,l,t?.id,e])}t(oe,"usePapaParse"),t(le,"useContactImport");const ce=t(async function(e,t,a,s,n){const r=[...new Set(a.map(e=>e.trim()))],i=r.filter(e=>!t.has(e));if(i.length>0){const a=await n.getList(e,{filter:{"name@in":`(${i.map(e=>`"${e}"`).join(",")})`},pagination:{page:1,perPage:r.length},sort:{field:"id",order:"ASC"}});for(const e of a.data)t.set(e.name.trim(),e)}return await Promise.all(i.map(async a=>{if(t.has(a))return;const r=await n.create(e,{data:s(a)});t.set(a,r.data)})),r.reduce((e,a)=>(e.set(a,t.get(a)),e),new Map)},"fetchRecordsWithCache"),me=t(e=>e?.split(",")?.map(e=>e.trim())?.filter(e=>e)??[],"parseTags"),de=`data:text/csv;name=crm_contacts_sample.csv;charset=utf-8,${encodeURIComponent('first_name,last_name,gender,title,organization_name,organization_role,first_seen,last_seen,tags,linkedin_url,email_work,email_home,email_other,phone_work,phone_home,phone_other\nJohn,Doe,male,Sales Executive,Acme Corporation,decision_maker,2024-07-01T00:00:00+00:00,2024-07-01T11:54:49.95+00:00,"influencer, developer",https://www.linkedin.com/in/johndoe,john@doe.example,john.doe@gmail.com,jdoe@caramail.com,659-980-2015,740.645.3807,(446) 758-2122\nJane,Doe,female,UX Designer,Acme Corporation,influencer,2024-07-01T00:00:00+00:00,2024-07-01T11:54:49.95+00:00,"UI, design",https://www.linkedin.com/in/janedoe,jane@doe.example,,,659-980-2020,740.647.3802,\n')}`;function he({open:e,onClose:a}){const s=r(),n=le(),{importer:l,parseCsv:c,reset:m}=oe({batchSize:10,processBatch:n}),[d,h]=E.useState(null);E.useEffect(()=>{"complete"===l.state&&s()},[l.state,s]);const u=t(e=>{h(e)},"handleFileChange"),p=t(()=>{d&&c(d)},"startImport"),v=t(()=>{m(),a()},"handleClose"),b=t(e=>{e.preventDefault(),m()},"handleReset");return i.jsx(f,{open:e,onOpenChange:v,children:i.jsxs(g,{className:"max-w-2xl",children:[i.jsxs(o,{className:"flex flex-col gap-4",children:[i.jsx(x,{children:i.jsx(j,{children:"Import"})}),i.jsxs("div",{className:"flex flex-col space-y-2",children:["running"===l.state&&i.jsxs("div",{className:"flex flex-col gap-2",children:[i.jsx(_,{children:i.jsxs(w,{className:"flex flex-row gap-4",children:[i.jsx(V,{className:"h-5 w-5 animate-spin"}),"The import is running, please do not close this tab."]})}),i.jsxs("div",{className:"text-sm",children:["Imported"," ",i.jsxs("strong",{children:[l.importCount," / ",l.rowCount]})," ","contacts, with ",i.jsx("strong",{children:l.errorCount})," errors.",null!==l.remainingTime&&i.jsxs(i.Fragment,{children:[" ","Estimated remaining time:"," ",i.jsx("strong",{children:ue(l.remainingTime)}),"."," ",i.jsx("button",{onClick:b,className:"text-red-600 underline hover:text-red-800",children:"Stop import"})]})]})]}),"error"===l.state&&i.jsx(_,{variant:"destructive",children:i.jsx(w,{children:"Failed to import this file, please make sure your provided a valid CSV file."})}),"complete"===l.state&&i.jsx(_,{children:i.jsxs(w,{children:["Contacts import complete. Imported ",l.importCount," ","contacts, with ",l.errorCount," errors"]})}),"idle"===l.state&&i.jsxs(i.Fragment,{children:[i.jsx(_,{children:i.jsxs(w,{className:"flex flex-col gap-4",children:["Here is a sample CSV file you can use as a template",i.jsx(y,{asChild:!0,variant:"outline",size:"sm",children:i.jsx(J,{to:de,download:"crm_contacts_sample.csv",children:"Download CSV sample"})})," "]})}),i.jsx(R,{source:"csv",label:"CSV File",accept:{"text/csv":[".csv"]},onChange:u,children:i.jsx(H,{source:"src",title:"title",target:"_blank"})})]})]})]}),i.jsx("div",{className:"flex justify-start pt-6 gap-2",children:"idle"===l.state?i.jsx(y,{onClick:p,disabled:!d,children:"Import"}):i.jsx(y,{variant:"outline",onClick:v,disabled:"running"===l.state,children:"Close"})})]})})}function ue(e){const t=Math.floor(e/1e3%60);return`${Math.floor(e/6e4%60)}m ${t}s`}t(he,"ContactImportDialog"),t(ue,"millisecondsToTime");const pe=t(()=>{const[e,a]=E.useState(!1),s=t(()=>{a(!0)},"handleOpenModal"),n=t(()=>{a(!1)},"handleCloseModal");return i.jsxs(i.Fragment,{children:[i.jsxs(y,{variant:"outline",onClick:s,className:"flex items-center gap-2 cursor-pointer",children:[i.jsx(W,{})," Import"]}),i.jsx(he,{open:e,onClose:n})]})},"ContactImportButton"),fe=t(()=>{const e=A();return i.jsxs("div",{className:"flex flex-col justify-center items-center gap-3",style:{height:`calc(100dvh - ${e}px)`},children:[i.jsx("img",{src:"./img/empty.svg",alt:"No contacts found"}),i.jsxs("div",{className:"flex flex-col gap-0 items-center",children:[i.jsx("h6",{className:"text-lg font-bold",children:"No contacts found"}),i.jsx("p",{className:"text-sm text-muted-foreground text-center mb-4",children:"It seems your contact list is empty."})]}),i.jsxs("div",{className:"flex flex-row gap-2",children:[i.jsx(v,{label:"New Contact"}),i.jsx(pe,{})]})]})},"ContactEmpty"),ge=t(()=>{const{data:e,error:a,isPending:s,onToggleItem:n,selectedIds:r}=l(),o=b();if(s)return i.jsx(C,{className:"w-full h-9"});if(a)return null;const m=Date.now();return i.jsxs("div",{className:"space-y-2",children:[e.map(e=>i.jsx(c,{value:e,children:i.jsxs("div",{className:"group relative flex items-center justify-between gap-3 rounded-lg border border-transparent bg-card px-3 py-2 transition-all duration-150 hover:border-border hover:shadow-md motion-safe:hover:-translate-y-0.5 active:scale-[0.98] focus-within:ring-2 focus-within:ring-ring focus-within:ring-offset-2",children:[i.jsxs("div",{className:"flex items-center gap-3 min-w-0 flex-1",children:[i.jsx(k,{checked:r.includes(e.id),onCheckedChange:t(()=>n(e.id),"onCheckedChange"),"aria-label":`Select ${e.first_name} ${e.last_name??""}`,className:"relative z-10 shrink-0"}),i.jsx(N,{className:"shrink-0"}),i.jsxs("div",{className:"flex-1 min-w-0",children:[i.jsxs(J,{to:`/contacts/${e.id}/show`,className:"font-medium text-sm text-primary hover:underline focus:outline-none",children:[`${e.first_name} ${e.last_name??""}`,i.jsx("span",{className:"absolute inset-0","aria-hidden":"true"})]}),i.jsxs("div",{className:"text-xs text-muted-foreground truncate",children:[e.title,e.department&&` - ${e.department}`,e.title&&e.organizations?.find(e=>e.is_primary)&&" at ",e.organizations?.find(e=>e.is_primary)&&i.jsx(S,{record:{organization_id:e.organizations.find(e=>e.is_primary)?.organization_id},source:"organization_id",reference:"organizations",link:!1,children:i.jsx(z,{source:"name"})})," ",i.jsx(Z,{})]})]})]}),e.last_seen&&i.jsx("div",{className:"text-xs text-muted-foreground shrink-0 relative z-10",children:i.jsxs("div",{title:e.last_seen,children:[!o&&"last activity ",K(e.last_seen,m)," ",i.jsx(Y,{status:e.status})]})})]})},e.id)),0===e.length&&i.jsx("div",{className:"p-8 text-center bg-muted/30 border border-border rounded-xl shadow-sm",children:i.jsx("p",{className:"text-sm text-muted-foreground",children:"No contacts found"})})]})},"ContactListContent"),xe=t(()=>{const{identity:e}=s(),{data:t}=m("tags",{pagination:{page:1,perPage:10},sort:{field:"name",order:"ASC"}});return i.jsx("div",{className:"w-52 min-w-52 order-first",children:i.jsx(I,{className:"bg-card border border-border shadow-sm rounded-xl p-4",children:i.jsxs("div",{className:"flex flex-col gap-4",children:[i.jsx(d,{children:i.jsx(O,{source:"q",placeholder:"Search name, company..."})}),i.jsxs(ae,{label:"Last activity",icon:i.jsx(U,{}),children:[i.jsx(se,{className:"w-full justify-between",label:"Today",value:{"last_seen@gte":Q().toISOString(),"last_seen@lte":void 0}}),i.jsx(se,{className:"w-full justify-between",label:"This week",value:{"last_seen@gte":G(new Date).toISOString(),"last_seen@lte":void 0}}),i.jsx(se,{className:"w-full justify-between",label:"Before this week",value:{"last_seen@gte":void 0,"last_seen@lte":G(new Date).toISOString()}}),i.jsx(se,{className:"w-full justify-between",label:"Before this month",value:{"last_seen@gte":void 0,"last_seen@lte":ee(new Date).toISOString()}}),i.jsx(se,{className:"w-full justify-between",label:"Before last month",value:{"last_seen@gte":void 0,"last_seen@lte":te(ee(new Date)).toISOString()}})]}),i.jsx(ae,{label:"Tags",icon:i.jsx(q,{}),children:t&&t.map(e=>i.jsx(se,{multiselect:!0,className:"w-full justify-between",label:i.jsx(T,{variant:"secondary",className:D("text-xs font-normal cursor-pointer",ne(e?.color)),children:e?.name}),value:{tags:e.id}},e.id))}),i.jsx(ae,{icon:i.jsx(X,{className:"h-4 w-4"}),label:"Account Manager",children:i.jsx(se,{className:"w-full justify-between",label:"Me",value:{sales_id:e?.id}})})]})})})},"ContactListFilter"),je=t(()=>{const{identity:e}=s();return re("contacts"),e?i.jsx(M,{title:!1,actions:i.jsx(we,{}),perPage:25,sort:{field:"last_seen",order:"DESC"},exporter:ye,children:i.jsx(_e,{})}):null},"ContactList"),_e=t(()=>{const{data:e,isPending:t,filterValues:a}=l(),{identity:n}=s(),r=a&&Object.keys(a).length>0;return!n||t?null:e?.length||r?i.jsxs("div",{className:"flex flex-row gap-6",children:[i.jsx(xe,{}),i.jsx("div",{className:"flex-1 flex flex-col gap-4",children:i.jsx(I,{className:"bg-card border border-border shadow-sm rounded-xl p-2",children:i.jsx(ge,{})})}),i.jsx(P,{})]}):i.jsx(fe,{})},"ContactListLayout"),we=t(()=>i.jsxs($,{children:[i.jsx(F,{fields:["first_name","last_name","last_seen"]}),i.jsx(pe,{}),i.jsx(L,{exporter:ye}),i.jsx(v,{})]}),"ContactListActions"),ye=t(async(e,t)=>{const a=await t(e,"sales_id","sales"),s=await t(e,"tags","tags"),n=Array.from(new Set(e.flatMap(e=>e.organizations?.map(e=>e.organization_id)||[]))),r=n.length>0?await t(n.map(e=>({id:e,organization_id:e})),"organization_id","organizations"):{},i=e.map(e=>{const t=e.organizations?.find(e=>e.is_primary),n={...e,company:t?.organization_id?r[t.organization_id]?.name:void 0,sales:`${a[e.sales_id].first_name} ${a[e.sales_id].last_name}`,tags:e.tags.map(e=>s[e].name).join(", "),email_work:e.email?.find(e=>"Work"===e.type)?.email,email_home:e.email?.find(e=>"Home"===e.type)?.email,email_other:e.email?.find(e=>"Other"===e.type)?.email,email:JSON.stringify(e.email),email_fts:void 0,phone_work:e.phone?.find(e=>"Work"===e.type)?.number,phone_home:e.phone?.find(e=>"Home"===e.type)?.number,phone_other:e.phone?.find(e=>"Other"===e.type)?.number,phone:JSON.stringify(e.phone),phone_fts:void 0,department:e.department||"",is_primary_contact:t?"Yes":"No",organizations:e.organizations?JSON.stringify(e.organizations):"[]",total_organizations:e.organizations?e.organizations.length:0};return delete n.email_fts,delete n.phone_fts,n});return h(i,{},(e,t)=>{u(t,"contacts")})},"exporter");export{je as ContactList,je as default};
