{"version":3,"file":"ContactList-B6mcVxog.js","sources":["../../src/atomic-crm/contacts/csvConstants.ts","../../src/atomic-crm/contacts/columnAliases.ts","../../src/atomic-crm/contacts/csvProcessor.ts","../../src/atomic-crm/contacts/usePapaParse.tsx","../../src/atomic-crm/contacts/contactImport.logic.ts","../../src/atomic-crm/contacts/useContactImport.tsx","../../src/atomic-crm/contacts/ContactImportPreview.tsx","../../src/atomic-crm/contacts/ContactImportResult.tsx","../../src/atomic-crm/contacts/contactImport.helpers.ts","../../src/atomic-crm/contacts/useColumnMapping.ts","../../src/atomic-crm/contacts/useImportWizard.types.ts","../../src/atomic-crm/contacts/useImportWizard.ts","../../src/atomic-crm/utils/rateLimiter.ts","../../src/components/admin/file-input.tsx","../../src/components/admin/file-field.tsx","../../src/atomic-crm/contacts/ContactImportDialog.tsx","../../src/atomic-crm/contacts/contacts_export.csv?raw","../../src/atomic-crm/contacts/ContactImportButton.tsx","../../src/atomic-crm/contacts/ContactEmpty.tsx","../../src/atomic-crm/contacts/ContactListFilter.tsx","../../src/atomic-crm/contacts/ContactDetailsTab.tsx","../../src/atomic-crm/contacts/slideOverTabs/ContactNotesTab.tsx","../../src/atomic-crm/contacts/ActivitiesTab.tsx","../../src/atomic-crm/contacts/ContactHierarchyBreadcrumb.tsx","../../src/atomic-crm/contacts/ContactSlideOver.tsx","../../src/atomic-crm/contacts/ContactBadges.tsx","../../src/atomic-crm/contacts/formatters.ts","../../src/atomic-crm/utils/exportHelpers.ts","../../src/atomic-crm/contacts/contactExporter.ts","../../src/atomic-crm/contacts/contactFilterConfig.ts","../../src/atomic-crm/contacts/ContactList.tsx"],"sourcesContent":["/**\n * Shared constants for CSV processing\n *\n * This module contains constants used across multiple CSV-related modules.\n * By keeping these in a separate file, we avoid circular dependencies.\n */\n\n/**\n * Marker constant used to identify full name columns that need to be split\n * into first_name and last_name components.\n *\n * Used by:\n * - columnAliases.ts: Returns this marker for full name columns\n * - csvProcessor.ts: Detects this marker to trigger name splitting\n */\nexport const FULL_NAME_SPLIT_MARKER = \"_full_name_split_\";\n","/**\n * Column Alias Registry for CSV Import\n * Maps common CSV header variations to ContactImportSchema fields\n *\n * IMPORTANT: Maps to ContactImportSchema fields (email_work, phone_home, etc.)\n * NOT database JSONB fields (email, phone arrays)\n */\n\nimport { FULL_NAME_SPLIT_MARKER } from \"./csvConstants\";\n\n/**\n * Registry mapping ContactImportSchema field names to common CSV header variations\n * All variations are normalized (lowercase, trimmed) for comparison\n */\nexport const COLUMN_ALIASES: Record<string, string[]> = {\n  // Core identity fields\n  first_name: [\n    \"first_name\",\n    \"first name\",\n    \"first\",\n    \"firstname\",\n    \"fname\",\n    \"given name\",\n    \"given_name\",\n    \"givenname\",\n    \"forename\",\n    \"christian name\",\n    \"christian_name\",\n    \"prenom\",\n    \"vorname\",\n  ],\n\n  last_name: [\n    \"last_name\",\n    \"last name\",\n    \"last\",\n    \"lastname\",\n    \"lname\",\n    \"surname\",\n    \"family name\",\n    \"family_name\",\n    \"familyname\",\n    \"nom\",\n    \"nachname\",\n    \"apellido\",\n  ],\n\n  // Organization field (most critical - many variations in real-world CSVs)\n  organization_name: [\n    \"organization_name\",\n    \"organization name\",\n    \"organization\",\n    \"organisations\",\n    \"organizations\",\n    \"organizations (dropdown)\",\n    \"organisation\",\n    \"company\",\n    \"company name\",\n    \"company_name\",\n    \"companyname\",\n    \"business\",\n    \"business name\",\n    \"business_name\",\n    \"org\",\n    \"org name\",\n    \"org_name\",\n    \"employer\",\n    \"enterprise\",\n    \"firm\",\n    \"client\",\n    \"client name\",\n    \"client_name\",\n    \"customer\",\n    \"customer name\",\n    \"account\",\n    \"account name\",\n    \"vendor\",\n    \"vendor name\",\n  ],\n\n  // Organization role field\n  organization_role: [\n    \"organization_role\",\n    \"organization role\",\n    \"role\",\n    \"job role\",\n    \"job_role\",\n    \"position\",\n    \"position (dropdown)\",\n    \"title\",\n    \"job title\",\n    \"job_title\",\n    \"jobtitle\",\n    \"designation\",\n    \"function\",\n    \"responsibility\",\n  ],\n\n  // Email fields - separate work/home/other for ContactImportSchema\n  email_work: [\n    \"email_work\",\n    \"email work\",\n    \"work email\",\n    \"work_email\",\n    \"workemail\",\n    \"business email\",\n    \"business_email\",\n    \"businessemail\",\n    \"professional email\",\n    \"office email\",\n    \"office_email\",\n    \"company email\",\n    \"corporate email\",\n    \"email\", // Default email maps to work\n    \"e-mail\",\n    \"e mail\",\n    \"email address\",\n    \"email_address\",\n    \"emailaddress\",\n    \"mail\",\n    \"email_primary\",\n    \"primary email\",\n    \"primary_email\",\n  ],\n\n  email_home: [\n    \"email_home\",\n    \"email home\",\n    \"home email\",\n    \"home_email\",\n    \"homeemail\",\n    \"personal email\",\n    \"personal_email\",\n    \"personalemail\",\n    \"private email\",\n    \"private_email\",\n    \"email personal\",\n    \"email_personal\",\n    \"secondary email\",\n    \"secondary_email\",\n    \"email_secondary\",\n  ],\n\n  email_other: [\n    \"email_other\",\n    \"email other\",\n    \"other email\",\n    \"other_email\",\n    \"otheremail\",\n    \"alternate email\",\n    \"alternate_email\",\n    \"alternative email\",\n    \"additional email\",\n    \"additional_email\",\n    \"backup email\",\n    \"email_alternate\",\n    \"email alternate\",\n    \"email_additional\",\n    \"tertiary email\",\n    \"email_tertiary\",\n  ],\n\n  // Phone fields - separate work/home/other for ContactImportSchema\n  phone_work: [\n    \"phone_work\",\n    \"phone work\",\n    \"work phone\",\n    \"work_phone\",\n    \"workphone\",\n    \"business phone\",\n    \"business_phone\",\n    \"businessphone\",\n    \"office phone\",\n    \"office_phone\",\n    \"officephone\",\n    \"company phone\",\n    \"desk phone\",\n    \"phone\", // Default phone maps to work\n    \"phone number\",\n    \"phone_number\",\n    \"phonenumber\",\n    \"telephone\",\n    \"tel\",\n    \"mobile\",\n    \"mobile phone\",\n    \"mobile_phone\",\n    \"cell\",\n    \"cell phone\",\n    \"cellphone\",\n    \"contact number\",\n    \"contact_number\",\n    \"primary phone\",\n    \"phone_primary\",\n  ],\n\n  phone_home: [\n    \"phone_home\",\n    \"phone home\",\n    \"home phone\",\n    \"home_phone\",\n    \"homephone\",\n    \"personal phone\",\n    \"personal_phone\",\n    \"personalphone\",\n    \"private phone\",\n    \"private_phone\",\n    \"residential phone\",\n    \"house phone\",\n    \"phone personal\",\n    \"phone_personal\",\n    \"secondary phone\",\n    \"phone_secondary\",\n  ],\n\n  phone_other: [\n    \"phone_other\",\n    \"phone other\",\n    \"other phone\",\n    \"other_phone\",\n    \"otherphone\",\n    \"alternate phone\",\n    \"alternate_phone\",\n    \"alternative phone\",\n    \"additional phone\",\n    \"additional_phone\",\n    \"backup phone\",\n    \"fax\",\n    \"fax number\",\n    \"phone_alternate\",\n    \"phone alternate\",\n    \"phone_additional\",\n    \"tertiary phone\",\n    \"phone_tertiary\",\n  ],\n\n  // Professional info\n  title: [\n    \"title\",\n    \"job title\",\n    \"job_title\",\n    \"jobtitle\",\n    \"position title\",\n    \"position_title\",\n    \"professional title\",\n    \"role title\",\n    \"designation\",\n    \"job position\",\n    \"job_position\",\n    \"work title\",\n  ],\n\n  // Gender field\n  gender: [\"gender\", \"sex\", \"gender identity\", \"gender_identity\", \"m/f\", \"male/female\", \"pronouns\"],\n\n  // Avatar/photo field\n  avatar: [\n    \"avatar\",\n    \"photo\",\n    \"picture\",\n    \"profile picture\",\n    \"profile_picture\",\n    \"profile photo\",\n    \"profile_photo\",\n    \"headshot\",\n    \"image\",\n    \"image url\",\n    \"image_url\",\n    \"photo url\",\n    \"photo_url\",\n    \"avatar url\",\n    \"avatar_url\",\n  ],\n\n  // Date fields\n  first_seen: [\n    \"first_seen\",\n    \"first seen\",\n    \"date added\",\n    \"date_added\",\n    \"dateadded\",\n    \"created\",\n    \"created date\",\n    \"created_date\",\n    \"creation date\",\n    \"added on\",\n    \"added_on\",\n    \"first contact\",\n    \"first_contact\",\n    \"initial contact\",\n  ],\n\n  last_seen: [\n    \"last_seen\",\n    \"last seen\",\n    \"last contact\",\n    \"last_contact\",\n    \"last contacted\",\n    \"last_contacted\",\n    \"last activity\",\n    \"last_activity\",\n    \"last interaction\",\n    \"last_interaction\",\n    \"recent contact\",\n    \"updated\",\n    \"updated date\",\n    \"modified\",\n    \"modified date\",\n  ],\n\n  // Tags field\n  tags: [\n    \"tags\",\n    \"tag\",\n    \"categories\",\n    \"category\",\n    \"labels\",\n    \"label\",\n    \"groups\",\n    \"group\",\n    \"segments\",\n    \"segment\",\n    \"keywords\",\n    \"keyword\",\n    \"classifications\",\n  ],\n\n  // Social media\n  linkedin_url: [\n    \"linkedin_url\",\n    \"linkedin url\",\n    \"linkedin\",\n    \"linkedin profile\",\n    \"linkedin_profile\",\n    \"linkedin link\",\n    \"linkedin_link\",\n    \"social media\",\n    \"social_media\",\n    \"linkedin address\",\n    \"li url\",\n    \"li_url\",\n  ],\n\n  // Notes field\n  notes: [\n    \"notes\",\n    \"note\",\n    \"comments\",\n    \"comment\",\n    \"description\",\n    \"remarks\",\n    \"remark\",\n    \"memo\",\n    \"memos\",\n    \"additional info\",\n    \"additional_info\",\n    \"additional information\",\n    \"details\",\n    \"detail\",\n    \"observations\",\n    \"observation\",\n  ],\n};\n\n/**\n * Special patterns for detecting full name columns that need to be split\n * These columns contain both first and last name in a single field\n */\nexport const FULL_NAME_PATTERNS: string[] = [\n  \"full name\",\n  \"fullname\",\n  \"full_name\",\n  \"name\",\n  \"contact name\",\n  \"contact_name\",\n  \"contactname\",\n  \"person name\",\n  \"person_name\",\n  \"full name (first, last)\",\n  \"full name (first,last)\",\n  \"full name (first last)\",\n  \"complete name\",\n  \"complete_name\",\n  \"whole name\",\n  \"display name\",\n  \"display_name\",\n  \"customer name\",\n  \"client name\",\n  \"user name\",\n  \"username\",\n  \"contact\",\n  \"person\",\n];\n\n/**\n * Normalize a header string for comparison\n * - Converts to lowercase\n * - Trims whitespace\n * - Removes special characters (keeping spaces, underscores, hyphens)\n * - Collapses multiple spaces\n */\nexport function normalizeHeader(header: string): string {\n  if (!header || typeof header !== \"string\") {\n    return \"\";\n  }\n\n  return (\n    header\n      .toLowerCase()\n      .trim()\n      // Remove special characters except spaces, underscores, hyphens\n      .replace(/[^a-z0-9\\s_-]/g, \" \")\n      // Collapse multiple spaces to single space\n      .replace(/\\s+/g, \" \")\n      .trim()\n  );\n}\n\n// --- Performance Optimizations: Pre-computed lookup tables ---\n\n/**\n * Pre-computed reverse map from a normalized alias to its canonical field name.\n * This avoids re-calculating normalization and iterating the alias list on every lookup.\n * @private\n */\nconst NORMALIZED_ALIAS_MAP: Map<string, string> = new Map();\nfor (const [fieldName, aliases] of Object.entries(COLUMN_ALIASES)) {\n  for (const alias of aliases) {\n    const normalized = normalizeHeader(alias);\n    // The first alias for a given normalized form wins.\n    if (normalized && !NORMALIZED_ALIAS_MAP.has(normalized)) {\n      NORMALIZED_ALIAS_MAP.set(normalized, fieldName);\n    }\n  }\n}\n\n/**\n * Pre-computed set of normalized full name patterns for O(1) lookups.\n * @private\n */\nconst NORMALIZED_FULL_NAME_PATTERNS: Set<string> = new Set(\n  FULL_NAME_PATTERNS.map((p) => normalizeHeader(p)).filter(Boolean)\n);\n\n// --- End Optimizations ---\n\n/**\n * Find the canonical ContactImportSchema field name for a user-provided header\n * Returns null if no match is found\n */\nexport function findCanonicalField(userHeader: string): string | null {\n  if (!userHeader || typeof userHeader !== \"string\") {\n    return null;\n  }\n\n  const normalized = normalizeHeader(userHeader);\n  if (!normalized) {\n    return null;\n  }\n\n  return NORMALIZED_ALIAS_MAP.get(normalized) || null;\n}\n\n/**\n * Check if a header represents a full name column that needs to be split\n */\nexport function isFullNameColumn(header: string): boolean {\n  if (!header || typeof header !== \"string\") {\n    return false;\n  }\n\n  const normalized = normalizeHeader(header);\n  return NORMALIZED_FULL_NAME_PATTERNS.has(normalized);\n}\n\n/**\n * Get all unrecognized headers from a CSV that don't map to any ContactImportSchema field\n * Useful for showing warnings to users about unmapped columns\n */\nexport function getUnmappedHeaders(headers: string[]): string[] {\n  if (!Array.isArray(headers)) {\n    return [];\n  }\n\n  return headers.filter((header) => {\n    // Skip empty headers\n    if (!header || typeof header !== \"string\") {\n      return false;\n    }\n\n    // Check if it maps to a known field\n    const canonicalField = findCanonicalField(header);\n\n    // Check if it's a full name column (these are special-handled)\n    const isFullName = isFullNameColumn(header);\n\n    // If it doesn't map to any field and isn't a full name, it's unmapped\n    return !canonicalField && !isFullName;\n  });\n}\n\n/**\n * Transform CSV headers to their canonical ContactImportSchema field names\n * Returns an object mapping original headers to canonical field names\n * Headers that don't match are mapped to null\n */\nexport function mapHeadersToFields(headers: string[]): Record<string, string | null> {\n  if (!Array.isArray(headers)) {\n    return {};\n  }\n\n  const mappings: Record<string, string | null> = {};\n\n  for (const header of headers) {\n    if (!header || typeof header !== \"string\") {\n      continue;\n    }\n\n    // Check if it's a full name column\n    if (isFullNameColumn(header)) {\n      // Full name columns will be handled specially during import\n      // Map to both first_name and last_name with a special marker\n      mappings[header] = FULL_NAME_SPLIT_MARKER;\n    } else {\n      // Try to find canonical field\n      mappings[header] = findCanonicalField(header);\n    }\n  }\n\n  return mappings;\n}\n\n/**\n * Get a human-readable description of how a header will be mapped\n * Useful for preview displays\n */\nexport function getHeaderMappingDescription(header: string): string {\n  if (!header || typeof header !== \"string\") {\n    return \"(ignored - empty header)\";\n  }\n\n  if (isFullNameColumn(header)) {\n    return \"first_name + last_name (will be split)\";\n  }\n\n  const canonical = findCanonicalField(header);\n  if (canonical) {\n    return canonical;\n  }\n\n  return \"(ignored - no matching field)\";\n}\n\n/**\n * Validate that all required ContactImportSchema fields have mappings\n * Returns an array of missing required fields\n */\nexport function validateRequiredMappings(mappings: Record<string, string | null>): string[] {\n  const requiredFields = [\"first_name\", \"last_name\", \"organization_name\"];\n  const mappedFields = new Set(Object.values(mappings).filter(Boolean));\n\n  // Check if we have a full name column (which provides first_name + last_name)\n  const hasFullName = Object.values(mappings).includes(FULL_NAME_SPLIT_MARKER);\n\n  const missingFields: string[] = [];\n\n  for (const field of requiredFields) {\n    // If it's first_name or last_name and we have a full name column, it's covered\n    if ((field === \"first_name\" || field === \"last_name\") && hasFullName) {\n      continue;\n    }\n\n    // Otherwise check if the field is mapped\n    if (!mappedFields.has(field)) {\n      missingFields.push(field);\n    }\n  }\n\n  return missingFields;\n}\n\n/**\n * Get all available ContactImportSchema fields for dropdown selection\n * Returns an array of field names that can be mapped to CSV columns\n */\nexport function getAvailableFields(): string[] {\n  // Extract all unique field names from COLUMN_ALIASES\n  const fieldNames = Object.keys(COLUMN_ALIASES);\n\n  // Sort alphabetically for better UX\n  return fieldNames.sort();\n}\n\n/**\n * Get available fields with display names for dropdown options\n * Returns an array of {value, label} objects\n */\nexport function getAvailableFieldsWithLabels(): Array<{ value: string; label: string }> {\n  const fields = getAvailableFields();\n\n  return [\n    // Special option for full name splitting\n    {\n      value: FULL_NAME_SPLIT_MARKER,\n      label: \"Full Name (will be split into first + last)\",\n    },\n    // All other fields\n    ...fields.map((field) => ({\n      value: field,\n      label: field.replace(/_/g, \" \").replace(/\\b\\w/g, (l) => l.toUpperCase()),\n    })),\n  ];\n}\n","/**\n * CSV Data Processing - Single Source of Truth\n * Centralizes all CSV transformation logic for contact imports\n *\n * This module is the canonical implementation used by:\n * - Production code (ContactImportDialog.tsx, usePapaParse.tsx)\n * - Test code (all CSV import tests)\n *\n * Phase 1 Security Remediation:\n * - Sanitizes all CSV values to prevent formula injection attacks\n * - Removes control characters and potential HTML/script tags\n */\n\nimport type { ContactImportSchema } from \"./useContactImport\";\nimport { mapHeadersToFields } from \"./columnAliases\";\nimport { FULL_NAME_SPLIT_MARKER } from \"./csvConstants\";\nimport { sanitizeCsvValue } from \"../utils/csvUploadValidator\";\n\n/**\n * Split a full name string into first and last name components\n *\n * Rules:\n * - Empty string → both empty\n * - Single name (e.g., \"Smith\" or \"Mike\") → assigned to last_name only\n * - Multiple names (e.g., \"John Doe\") → first word is first_name, rest is last_name\n *\n * Rationale: When a single name is provided, we assign it to last_name by default.\n * This prioritizes the standard convention of using a last name as the primary\n * identifier in contact lists and is the most predictable behavior for formal names.\n */\nexport function splitFullName(fullName: string): { first_name: string; last_name: string } {\n  if (!fullName || typeof fullName !== \"string\") {\n    return { first_name: \"\", last_name: \"\" };\n  }\n\n  const nameParts = fullName.trim().split(/\\s+/);\n\n  if (nameParts.length === 0 || fullName.trim() === \"\") {\n    // Empty name\n    return { first_name: \"\", last_name: \"\" };\n  } else if (nameParts.length === 1) {\n    // Single name part - treat as last name\n    // Examples: \"Smith\", \"Mike\", \"Figueroa\"\n    return { first_name: \"\", last_name: nameParts[0] };\n  } else {\n    // Multiple parts - first is first_name, rest is last_name\n    // Examples: \"John Doe\" → first: \"John\", last: \"Doe\"\n    //           \"Mary Jane Smith\" → first: \"Mary\", last: \"Jane Smith\"\n    return {\n      first_name: nameParts[0],\n      last_name: nameParts.slice(1).join(\" \"),\n    };\n  }\n}\n\n/**\n * Transform CSV headers using column aliases\n * Returns an array of canonical field names corresponding to each header\n *\n * @param headers - Original CSV header row\n * @returns Array of transformed header names (same length as input)\n * @private - Internal helper function, not exported\n */\nfunction transformHeaders(headers: string[]): string[] {\n  const mappings = mapHeadersToFields(headers);\n\n  return headers.map((header) => {\n    if (!header) return header;\n    const mapped = mappings[header];\n    // Return the mapped value, or original header if no mapping found\n    return mapped || header;\n  });\n}\n\n/**\n * Transform raw CSV data into ContactImportSchema objects\n * This is the main entry point for CSV data processing\n *\n * @param headers - Original CSV headers\n * @param dataRows - Raw data rows (arrays of values)\n * @returns Array of Contact objects ready for validation and import\n */\nexport function processCsvData(headers: string[], dataRows: any[][]): ContactImportSchema[] {\n  const transformedHeaders = transformHeaders(headers);\n\n  return dataRows.map((row) => {\n    const contact: any = {};\n\n    headers.forEach((originalHeader, index) => {\n      const transformedHeader = transformedHeaders[index];\n      const rawValue = row[index];\n\n      // SECURITY: Sanitize all cell values (Phase 1 Security Remediation)\n      const value = sanitizeCsvValue(rawValue);\n\n      // Handle full name splitting\n      if (transformedHeader === FULL_NAME_SPLIT_MARKER) {\n        const { first_name, last_name } = splitFullName(value || \"\");\n        contact.first_name = sanitizeCsvValue(first_name);\n        contact.last_name = sanitizeCsvValue(last_name);\n      } else {\n        contact[transformedHeader] = value;\n      }\n    });\n\n    return contact as ContactImportSchema;\n  });\n}\n\n/**\n * Transform raw CSV data with custom mappings (for interactive column mapping)\n * This allows users to override auto-detected mappings\n *\n * @param headers - Original CSV headers\n * @param dataRows - Raw data rows (arrays of values)\n * @param customMappings - User-defined mappings (overrides auto-detection)\n * @returns Array of Contact objects ready for validation and import\n */\nexport function processCsvDataWithMappings(\n  headers: string[],\n  dataRows: any[][],\n  customMappings: Record<string, string | null>\n): ContactImportSchema[] {\n  return dataRows.map((row) => {\n    const contact: any = {};\n\n    headers.forEach((originalHeader, index) => {\n      const targetField = customMappings[originalHeader];\n      const rawValue = row[index];\n\n      // SECURITY: Sanitize all cell values (Phase 1 Security Remediation)\n      const value = sanitizeCsvValue(rawValue);\n\n      // Handle full name splitting\n      if (targetField === FULL_NAME_SPLIT_MARKER) {\n        const { first_name, last_name } = splitFullName(value || \"\");\n        contact.first_name = sanitizeCsvValue(first_name);\n        contact.last_name = sanitizeCsvValue(last_name);\n      } else if (targetField) {\n        contact[targetField] = value;\n      }\n      // If targetField is null/undefined, skip this column\n    });\n\n    return contact as ContactImportSchema;\n  });\n}\n\n/**\n * Parse raw Papa Parse results into ContactImportSchema objects\n * Handles the specific structure of our CSV files:\n * - Row 0: Instructions\n * - Row 1: Empty row\n * - Row 2: Headers\n * - Row 3+: Data\n *\n * @param rawData - Raw data from Papa Parse (array of arrays)\n * @returns Object containing processed contact data and original headers\n * @throws Error if CSV structure is invalid\n */\nexport function parseRawCsvData(rawData: any[][]): {\n  contacts: ContactImportSchema[];\n  headers: string[];\n} {\n  if (!Array.isArray(rawData) || rawData.length < 4) {\n    throw new Error(\"CSV file is too short (less than 4 rows)\");\n  }\n\n  // Row 3 (index 2) contains the actual headers\n  const headers = rawData[2] as string[];\n\n  // Rows 4+ (index 3+) contain the data\n  const dataRows = rawData.slice(3);\n\n  const contacts = processCsvData(headers, dataRows);\n  return { contacts, headers };\n}\n","import * as Papa from \"papaparse\";\nimport { useCallback, useMemo, useRef, useState } from \"react\";\nimport { parseRawCsvData } from \"./csvProcessor\";\n\ntype Import =\n  | {\n      state: \"idle\";\n    }\n  | {\n      state: \"parsing\";\n    }\n  | {\n      state: \"running\" | \"complete\";\n\n      rowCount: number;\n      importCount: number;\n      errorCount: number;\n\n      // The remaining time in milliseconds\n      remainingTime: number | null;\n    }\n  | {\n      state: \"error\";\n\n      error: Error;\n    };\n\ninterface usePapaParseProps<T> {\n  // The import batch size\n  batchSize?: number;\n\n  // processBatch returns the number of imported items (optional - required for actual import, not for preview)\n  processBatch?: (batch: T[]) => Promise<void>;\n\n  // Optional: Callback for preview mode - receives parsed preview data, headers, and raw data rows\n  onPreview?: (data: { rows: T[]; headers: string[]; rawDataRows?: any[][] }) => void;\n\n  // Optional: Parse only first N rows for preview mode\n  previewRowCount?: number;\n}\n\nexport function usePapaParse<T>({\n  batchSize = 10,\n  processBatch,\n  onPreview,\n  previewRowCount,\n}: usePapaParseProps<T>) {\n  const importIdRef = useRef<number>(0);\n\n  const [importer, setImporter] = useState<Import>({\n    state: \"idle\",\n  });\n\n  const reset = useCallback(() => {\n    setImporter({\n      state: \"idle\",\n    });\n    importIdRef.current += 1;\n  }, []);\n\n  const parseCsv = useCallback(\n    (file: File) => {\n      setImporter({\n        state: \"parsing\",\n      });\n\n      const importId = importIdRef.current;\n      Papa.parse<T>(file, {\n        header: false, // We'll manually handle headers after skipping rows\n        skipEmptyLines: true, // This auto-skips line 3 (empty row)\n        preview: previewRowCount ? previewRowCount + 2 : undefined, // Add 2 for skipped rows\n        async complete(results) {\n          if (importIdRef.current !== importId) {\n            return;\n          }\n\n          let transformedData: T[];\n          let headers: string[];\n          try {\n            // REFACTORED: Use the single source of truth to process raw CSV data.\n            // This replaces ~40 lines of duplicated logic.\n            const parseResult = parseRawCsvData(results.data as any[][]);\n            transformedData = parseResult.contacts as T[];\n            headers = parseResult.headers;\n          } catch (error: any) {\n            setImporter({\n              state: \"error\",\n              error: error instanceof Error ? error : new Error(String(error)),\n            });\n            return;\n          }\n\n          // If in preview mode, call onPreview callback and return early\n          if (onPreview && previewRowCount) {\n            // Pass raw data rows (skip first 3 rows: instructions, empty, headers)\n            const rawDataRows = (results.data as any[][]).slice(3);\n            onPreview({ rows: transformedData, headers, rawDataRows });\n            setImporter({\n              state: \"idle\",\n            });\n            return;\n          }\n\n          if (!processBatch) {\n            setImporter({\n              state: \"error\",\n              error: new Error(\"processBatch function not provided\"),\n            });\n            return;\n          }\n\n          setImporter({\n            state: \"running\",\n            rowCount: transformedData.length,\n            errorCount: results.errors.length,\n            importCount: 0,\n            remainingTime: null,\n          });\n\n          let totalTime = 0;\n          for (let i = 0; i < transformedData.length; i += batchSize) {\n            // Note: Removed importIdRef check that was breaking during React.StrictMode remounts\n            // The check was causing early returns without setting state to \"complete\"\n\n            const batch = transformedData.slice(i, i + batchSize);\n            try {\n              const start = Date.now();\n              await processBatch(batch);\n              const elapsed = Date.now() - start;\n              totalTime += elapsed;\n\n              const meanTime = totalTime / (i + batch.length);\n              setImporter((previous) => {\n                if (previous.state === \"running\") {\n                  const importCount = previous.importCount + batch.length;\n                  return {\n                    ...previous,\n                    importCount,\n                    remainingTime: meanTime * (transformedData.length - importCount),\n                  };\n                }\n                return previous;\n              });\n            } catch (error) {\n              console.error(\"Batch processing error:\", error);\n              setImporter((previous) =>\n                previous.state === \"running\"\n                  ? {\n                      ...previous,\n                      errorCount: previous.errorCount + batch.length,\n                    }\n                  : previous\n              );\n            }\n          }\n\n          setImporter((previous) =>\n            previous.state === \"running\"\n              ? {\n                  ...previous,\n                  state: \"complete\",\n                  remainingTime: null,\n                }\n              : previous\n          );\n        },\n        error(error) {\n          setImporter({\n            state: \"error\",\n            error,\n          });\n        },\n        dynamicTyping: false, // Keep all values as strings to avoid type conversion issues (e.g., phone numbers)\n      });\n    },\n    [batchSize, processBatch, onPreview, previewRowCount]\n  );\n\n  return useMemo(\n    () => ({\n      importer,\n      parseCsv,\n      reset,\n    }),\n    [importer, parseCsv, reset]\n  );\n}\n","/**\n * Pure business logic for CSV contact import\n * Shared between application code and test scripts\n */\n\nimport type { ContactImportSchema, DataQualityDecisions } from \"./contactImport.types\";\nimport { importContactSchema } from \"../validation/contacts\";\n\n/**\n * A consistent utility to check if a contact record is an organization-only entry.\n * An org-only entry has an organization name but lacks both first and last names.\n * @param contact The contact data to check.\n * @returns True if the contact is an organization-only entry.\n */\nexport function isOrganizationOnlyEntry(contact: Partial<ContactImportSchema>): boolean {\n  const hasOrgName = contact.organization_name && String(contact.organization_name).trim();\n  const hasFirstName = contact.first_name && String(contact.first_name).trim();\n  const hasLastName = contact.last_name && String(contact.last_name).trim();\n\n  return !!(hasOrgName && !hasFirstName && !hasLastName);\n}\n\n/**\n * Checks if a contact has a name but lacks any contact information (email or phone).\n * @param contact The contact data to check.\n * @returns True if the contact has a name but no contact info.\n */\nexport function isContactWithoutContactInfo(contact: Partial<ContactImportSchema>): boolean {\n  const hasFirstName = contact.first_name && String(contact.first_name).trim();\n  const hasLastName = contact.last_name && String(contact.last_name).trim();\n  const hasName = hasFirstName || hasLastName;\n\n  const hasEmail =\n    (contact.email_work && String(contact.email_work).trim()) ||\n    (contact.email_home && String(contact.email_home).trim()) ||\n    (contact.email_other && String(contact.email_other).trim());\n\n  const hasPhone =\n    (contact.phone_work && String(contact.phone_work).trim()) ||\n    (contact.phone_home && String(contact.phone_home).trim()) ||\n    (contact.phone_other && String(contact.phone_other).trim());\n\n  return !!(hasName && !hasEmail && !hasPhone);\n}\n\n/**\n * Applies data quality transformations to a set of contacts based on user decisions.\n * Currently handles auto-filling placeholder contacts for organization-only entries.\n *\n * @param contacts The array of contacts to transform.\n * @param decisions The user's data quality choices.\n * @returns An object containing the transformed contacts and metadata about the transformation.\n */\nexport function applyDataQualityTransformations(\n  contacts: ContactImportSchema[],\n  decisions: DataQualityDecisions = {\n    importOrganizationsWithoutContacts: false,\n    importContactsWithoutContactInfo: false,\n  }\n) {\n  const autoFilledContacts = new Set<number>();\n\n  const transformedContacts = contacts.map((contact, index) => {\n    const transformed = { ...contact };\n\n    // Auto-fill placeholder contact if the user approved this action.\n    if (isOrganizationOnlyEntry(transformed) && decisions.importOrganizationsWithoutContacts) {\n      transformed.first_name = \"General\";\n      transformed.last_name = \"Contact\";\n      autoFilledContacts.add(index);\n    }\n\n    return transformed;\n  });\n\n  return {\n    transformedContacts,\n    autoFilledCount: autoFilledContacts.size,\n    wasAutoFilled: (index: number) => autoFilledContacts.has(index),\n  };\n}\n\n/**\n * Validates a batch of contacts that have already been transformed.\n *\n * @param contacts The transformed contacts to validate.\n * @returns An object containing successfully validated data and detailed errors.\n */\nexport function validateTransformedContacts(contacts: ContactImportSchema[]) {\n  const validationResults = contacts.map((contact, index) => {\n    const result = importContactSchema.safeParse(contact);\n    return {\n      index,\n      contact,\n      success: result.success,\n      error: result.success ? null : result.error,\n    };\n  });\n\n  const successful = validationResults\n    .filter((r) => r.success)\n    .map((r) => ({ ...r.contact, originalIndex: r.index }));\n\n  const failed = validationResults\n    .filter((r) => !r.success)\n    .map((r) => ({\n      originalIndex: r.index,\n      data: r.contact,\n      errors: r.error!.issues.map((issue) => ({\n        field: issue.path.join(\".\"),\n        message: issue.message,\n      })),\n    }));\n\n  return { successful, failed };\n}\n","import type { DataProvider } from \"ra-core\";\nimport { useDataProvider, useGetIdentity } from \"ra-core\";\nimport { useCallback, useMemo } from \"react\";\nimport type { Organization, Tag } from \"../types\";\nimport { ZodError } from \"zod\";\nimport {\n  applyDataQualityTransformations,\n  validateTransformedContacts,\n  isContactWithoutContactInfo,\n} from \"./contactImport.logic\";\nimport { parseDateSafely } from \"@/lib/date-utils\";\n\n// Re-export types from centralized types file for backward compatibility\nexport type {\n  ContactImportSchema,\n  DataQualityDecisions,\n  FieldError,\n  ImportError,\n  ImportResult,\n  ImportOptions,\n} from \"./contactImport.types\";\n\nimport type {\n  ContactImportSchema,\n  ImportError,\n  ImportOptions,\n  ImportResult,\n  FieldError,\n} from \"./contactImport.types\";\n\nexport function useContactImport() {\n  const today = new Date().toISOString();\n  const { data: identity } = useGetIdentity();\n  const dataProvider = useDataProvider();\n\n  // organization cache to avoid creating the same organization multiple times and costly roundtrips\n  // Cache is dependent of dataProvider, so it's safe to use it as a dependency\n  const organizationsCache = useMemo(\n    () => new Map<string, Organization>(),\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [dataProvider]\n  );\n  const getOrganizations = useCallback(\n    async (names: string[], preview = false) =>\n      preview\n        ? validateOrganizationNames(names)\n        : fetchRecordsWithCache<Organization>(\n            \"organizations\",\n            organizationsCache,\n            names,\n            (name) => ({\n              name,\n              created_at: new Date().toISOString(),\n              sales_id: identity?.id,\n            }),\n            dataProvider\n          ),\n    [organizationsCache, identity?.id, dataProvider]\n  );\n\n  // Tags cache to avoid creating the same tag multiple times and costly roundtrips\n  // Cache is dependent of dataProvider, so it's safe to use it as a dependency\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const tagsCache = useMemo(() => new Map<string, Tag>(), [dataProvider]);\n  const getTags = useCallback(\n    async (names: string[], preview = false) =>\n      preview\n        ? validateTagNames(names)\n        : fetchRecordsWithCache<Tag>(\n            \"tags\",\n            tagsCache,\n            names,\n            (name) => ({\n              name,\n              color: \"gray\",\n            }),\n            dataProvider\n          ),\n    [tagsCache, dataProvider]\n  );\n\n  const processBatch = useCallback(\n    async (batch: ContactImportSchema[], options: ImportOptions = {}): Promise<ImportResult> => {\n      const { preview = false, onProgress, startingRow = 1, dataQualityDecisions } = options;\n      const startTime = new Date();\n      const errors: ImportError[] = [];\n      let successCount = 0;\n      let skippedCount = 0;\n      const totalProcessed = batch.length;\n\n      // Report progress if callback provided\n      if (onProgress) {\n        onProgress(0, totalProcessed);\n      }\n\n      // 1. Apply data quality transformations based on user decisions\n      const { transformedContacts } = applyDataQualityTransformations(batch, dataQualityDecisions);\n\n      // 2. Validate the entire transformed batch\n      const { successful, failed } = validateTransformedContacts(transformedContacts);\n\n      // Immediately add validation failures to the error list\n      failed.forEach((failure) => {\n        errors.push({\n          row: startingRow + failure.originalIndex,\n          data: failure.data,\n          errors: failure.errors,\n        });\n      });\n\n      // 2.5. Filter out contacts without contact info if user hasn't approved them\n      let contactsToProcess = successful;\n      if (!dataQualityDecisions?.importContactsWithoutContactInfo) {\n        const skippedContacts = new Set<number>();\n        contactsToProcess = successful.filter((contact) => {\n          if (isContactWithoutContactInfo(contact)) {\n            skippedContacts.add(contact.originalIndex);\n            return false;\n          }\n          return true;\n        });\n        skippedCount = skippedContacts.size;\n      }\n\n      // 3. Fetch related records (organizations, tags) for valid contacts only\n      const [organizations, tags] = await Promise.all([\n        getOrganizations(\n          contactsToProcess\n            .map((contact) => contact.organization_name?.trim())\n            .filter((name): name is string => !!name),\n          preview\n        ),\n        getTags(\n          contactsToProcess.flatMap((contact) => parseTags(contact.tags)),\n          preview\n        ),\n      ]);\n\n      // 4. Process all valid contacts with Promise.allSettled\n      const results = await Promise.allSettled(\n        contactsToProcess.map(async (contactData, index) => {\n          const rowNumber = startingRow + contactData.originalIndex;\n          const rowErrors: FieldError[] = [];\n\n          const {\n            first_name,\n            last_name,\n            gender,\n            title,\n            email_work,\n            email_home,\n            email_other,\n            phone_work,\n            phone_home,\n            phone_other,\n            first_seen,\n            last_seen,\n            organization_name,\n            tags: tagNames,\n            linkedin_url,\n            notes,\n          } = contactData;\n\n          // Organization logic check\n          const trimmedOrgName = String(organization_name || \"\").trim();\n          const organization = organizations.get(trimmedOrgName);\n          if (trimmedOrgName && !organization?.id && !preview) {\n            rowErrors.push({\n              field: \"organization_name\",\n              message: `Failed to find or create organization \"${trimmedOrgName}\"`,\n              value: trimmedOrgName,\n            });\n          }\n\n          if (rowErrors.length > 0) {\n            return {\n              rowNumber,\n              success: false,\n              errors: rowErrors,\n              data: contactData,\n            };\n          }\n\n          try {\n            const email = [\n              { value: email_work, type: \"work\" as const },\n              { value: email_home, type: \"home\" as const },\n              { value: email_other, type: \"other\" as const },\n            ].filter(({ value }) => value);\n\n            const phone = [\n              { value: phone_work, type: \"work\" as const },\n              { value: phone_home, type: \"home\" as const },\n              { value: phone_other, type: \"other\" as const },\n            ].filter(({ value }) => value);\n\n            const tagList = parseTags(tagNames)\n              .map((name) => tags.get(name))\n              .filter((tag): tag is Tag => !!tag);\n\n            const contactPayload = {\n              first_name,\n              last_name,\n              gender,\n              title,\n              email,\n              phone,\n              first_seen: first_seen\n                ? (parseDateSafely(first_seen)?.toISOString() ?? today)\n                : today,\n              last_seen: last_seen ? (parseDateSafely(last_seen)?.toISOString() ?? today) : today,\n              tags: preview ? [] : tagList.map((tag) => tag.id),\n              sales_id: identity?.id,\n              linkedin_url,\n              notes,\n              organization_id: organization?.id,\n              avatar: undefined,\n            };\n\n            if (preview) {\n              await dataProvider.create(\"contacts\", {\n                data: contactPayload,\n                meta: { dryRun: true },\n              });\n            } else {\n              await dataProvider.create(\"contacts\", {\n                data: contactPayload,\n              });\n            }\n\n            return { rowNumber, success: true };\n          } catch (error: any) {\n            // Catch errors from dataProvider (e.g., unique constraints)\n            const finalErrors: FieldError[] = [];\n            if (error instanceof ZodError) {\n              error.issues.forEach((issue) => {\n                finalErrors.push({\n                  field: issue.path.join(\".\"),\n                  message: issue.message,\n                });\n              });\n            } else if (error.body?.errors) {\n              for (const [field, message] of Object.entries(error.body.errors)) {\n                finalErrors.push({ field, message: String(message) });\n              }\n            } else {\n              finalErrors.push({\n                field: \"general\",\n                message: error.message || \"Unknown error during record creation\",\n              });\n            }\n            return { rowNumber, success: false, errors: finalErrors, data: contactData };\n          } finally {\n            if (onProgress) {\n              onProgress(index + 1 + failed.length, totalProcessed);\n            }\n          }\n        })\n      );\n\n      // 5. Tally results\n      results.forEach((result) => {\n        if (result.status === \"fulfilled\") {\n          const value = result.value as any;\n          if (value.success) {\n            successCount++;\n          } else {\n            errors.push({\n              row: value.rowNumber,\n              data: value.data,\n              errors: value.errors,\n            });\n          }\n        } else {\n          // This case is less likely now but kept for safety\n          errors.push({\n            row: 0, // Cannot determine row number here\n            data: {},\n            errors: [\n              {\n                field: \"processing\",\n                message: result.reason?.message || \"Unknown processing error\",\n              },\n            ],\n          });\n        }\n      });\n\n      const endTime = new Date();\n      const finalResult = {\n        totalProcessed,\n        successCount,\n        skippedCount,\n        failedCount: errors.length,\n        errors,\n        duration: endTime.getTime() - startTime.getTime(),\n        startTime,\n        endTime,\n      };\n\n      return finalResult;\n    },\n    [dataProvider, getOrganizations, getTags, identity?.id, today]\n  );\n\n  return processBatch;\n}\n\nconst fetchRecordsWithCache = async function <T>(\n  resource: string,\n  cache: Map<string, T>,\n  names: string[],\n  getCreateData: (name: string) => Partial<T>,\n  dataProvider: DataProvider\n) {\n  const trimmedNames = [...new Set(names.map((name) => name.trim()))];\n  const uncachedRecordNames = trimmedNames.filter((name) => !cache.has(name));\n\n  // check the backend for existing records\n  if (uncachedRecordNames.length > 0) {\n    const response = await dataProvider.getList(resource, {\n      filter: {\n        \"name@in\": `(${uncachedRecordNames.map((name) => `\"${name}\"`).join(\",\")})`,\n      },\n      pagination: { page: 1, perPage: trimmedNames.length },\n      sort: { field: \"id\", order: \"ASC\" },\n    });\n    for (const record of response.data) {\n      cache.set(record.name.trim(), record);\n    }\n  }\n\n  // Create missing records - errors will propagate\n  await Promise.all(\n    uncachedRecordNames.map(async (name) => {\n      if (cache.has(name)) return;\n      const response = await dataProvider.create(resource, {\n        data: getCreateData(name),\n      });\n      cache.set(name, response.data);\n    })\n  );\n\n  // now all records are in cache, return a map of all records\n  return trimmedNames.reduce((acc, name) => {\n    acc.set(name, cache.get(name) as T);\n    return acc;\n  }, new Map<string, T>());\n};\n\nconst parseTags = (tags: string) =>\n  tags\n    ?.split(\",\")\n    ?.map((tag: string) => tag.trim())\n    ?.filter((tag: string) => tag) ?? [];\n\n/**\n * Validate organization names for preview mode\n * Returns a Map similar to fetchRecordsWithCache but without database operations\n */\nconst validateOrganizationNames = async (names: string[]): Promise<Map<string, Organization>> => {\n  const trimmedNames = [...new Set(names.map((name) => name.trim()))];\n  const result = new Map<string, Organization>();\n\n  // In preview mode, we just create placeholder organizations\n  // to indicate they would be created during actual import\n  for (const name of trimmedNames) {\n    result.set(name, {\n      id: `preview-org-${name}`,\n      name,\n      created_at: new Date().toISOString(),\n    } as Organization);\n  }\n\n  return result;\n};\n\n/**\n * Validate tag names for preview mode\n * Returns a Map similar to fetchRecordsWithCache but without database operations\n */\nconst validateTagNames = async (names: string[]): Promise<Map<string, Tag>> => {\n  const trimmedNames = [...new Set(names.map((name) => name.trim()))];\n  const result = new Map<string, Tag>();\n\n  // In preview mode, we just create placeholder tags\n  // to indicate they would be created during actual import\n  for (const name of trimmedNames) {\n    result.set(name, {\n      id: `preview-tag-${name}`,\n      name,\n      color: \"gray\",\n    } as Tag);\n  }\n\n  return result;\n};\n","import { useState } from \"react\";\nimport {\n  CheckCircle,\n  AlertCircle,\n  Building2,\n  Tag,\n  User,\n  ChevronDown,\n  ChevronUp,\n  AlertTriangle,\n  HelpCircle,\n  ArrowRight,\n} from \"lucide-react\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Collapsible, CollapsibleContent, CollapsibleTrigger } from \"@/components/ui/collapsible\";\nimport { DialogFooter } from \"@/components/ui/dialog\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { contactSchema } from \"@/atomic-crm/validation/contacts\";\nimport { z } from \"zod\";\nimport { getAvailableFieldsWithLabels } from \"./columnAliases\";\nimport { FULL_NAME_SPLIT_MARKER } from \"./csvConstants\";\nimport type { DataQualityDecisions } from \"./contactImport.types\";\n\n// Re-export DataQualityDecisions for backward compatibility\nexport type { DataQualityDecisions } from \"./contactImport.types\";\n\n// Types for preview data\nexport interface ColumnMapping {\n  source: string;\n  target: string | null;\n  confidence: number;\n  sampleValue?: string;\n}\n\nexport interface ValidationError {\n  row: number;\n  field?: string;\n  message: string;\n}\n\nexport interface PreviewData {\n  mappings: ColumnMapping[];\n  sampleRows: unknown[];\n  validCount: number;\n  skipCount: number;\n  totalRows: number;\n  errors: ValidationError[];\n  warnings: ValidationError[];\n  newOrganizations: string[];\n  newTags: string[];\n  hasErrors: boolean;\n  lowConfidenceMappings: number;\n  // Data quality analysis\n  organizationsWithoutContacts: Array<{ organization_name: string; row: number }>;\n  contactsWithoutContactInfo: Array<{ name: string; organization_name: string; row: number }>;\n}\n\ninterface ContactImportPreviewProps {\n  preview: PreviewData;\n  onContinue: (decisions: DataQualityDecisions) => void;\n  onCancel: () => void;\n  onRemap?: () => void; // Phase 2 feature\n  onMappingChange?: (csvHeader: string, targetField: string | null) => void;\n  userOverrides?: Map<string, string | null>;\n}\n\nexport function ContactImportPreview({\n  preview,\n  onContinue,\n  onCancel,\n  onRemap,\n  onMappingChange,\n  userOverrides,\n}: ContactImportPreviewProps) {\n  const [expandedSections, setExpandedSections] = useState({\n    organizations: false,\n    tags: false,\n    errors: false,\n    warnings: false,\n    sampleData: false,\n    organizationsWithoutContacts: false,\n    contactsWithoutContactInfo: false,\n    skippedColumns: false,\n  });\n\n  // Data quality decisions state\n  const [dataQualityDecisions, setDataQualityDecisions] = useState<DataQualityDecisions>({\n    importOrganizationsWithoutContacts: false,\n    importContactsWithoutContactInfo: false,\n  });\n\n  const toggleSection = (section: keyof typeof expandedSections) => {\n    setExpandedSections((prev) => ({\n      ...prev,\n      [section]: !prev[section],\n    }));\n  };\n\n  // Get confidence icon for mapping\n  const _getConfidenceIcon = (confidence: number) => {\n    if (confidence >= 0.8) {\n      return <CheckCircle className=\"h-4 w-4 text-success\" />;\n    } else if (confidence >= 0.5) {\n      return <AlertCircle className=\"h-4 w-4 text-warning\" />;\n    } else {\n      return <HelpCircle className=\"h-4 w-4 text-muted-foreground\" />;\n    }\n  };\n\n  // Validate sample rows client-side\n  const validateSampleRows = () => {\n    const validationResults = preview.sampleRows.map((row, index) => {\n      try {\n        contactSchema.parse(row);\n        return { row: index + 1, valid: true };\n      } catch (error) {\n        if (error instanceof z.ZodError) {\n          return {\n            row: index + 1,\n            valid: false,\n            errors: error.issues.map((issue) => ({\n              field: issue.path.join(\".\"),\n              message: issue.message,\n            })),\n          };\n        }\n        return { row: index + 1, valid: false, errors: [] };\n      }\n    });\n\n    return validationResults;\n  };\n\n  const sampleValidation = validateSampleRows();\n  const validSamples = sampleValidation.filter((r) => r.valid).length;\n\n  // Split mappings into mapped and skipped for better UX\n  const mappedColumns = preview.mappings.filter((m) => m.target !== null);\n  const skippedColumns = preview.mappings.filter((m) => m.target === null);\n\n  // Get available fields for dropdown\n  const availableFieldOptions = getAvailableFieldsWithLabels();\n\n  // Detect duplicate field mappings\n  const targetFieldCounts = new Map<string, number>();\n  const duplicateTargets = new Set<string>();\n\n  preview.mappings.forEach((mapping) => {\n    if (mapping.target && mapping.target !== \"(ignored - no matching field)\") {\n      const count = targetFieldCounts.get(mapping.target) || 0;\n      targetFieldCounts.set(mapping.target, count + 1);\n\n      if (count + 1 > 1) {\n        duplicateTargets.add(mapping.target);\n      }\n    }\n  });\n\n  const hasDuplicates = duplicateTargets.size > 0;\n\n  return (\n    <div className=\"flex flex-col gap-4\">\n      {/* Summary Alert */}\n      <Alert variant={preview.hasErrors ? \"destructive\" : \"default\"} className=\"mb-2\">\n        <AlertTitle className=\"flex items-center gap-2\">\n          {preview.hasErrors ? (\n            <>\n              <AlertTriangle className=\"h-4 w-4\" />\n              Review Required\n            </>\n          ) : (\n            <>\n              <CheckCircle className=\"h-4 w-4\" />\n              Ready to Import\n            </>\n          )}\n        </AlertTitle>\n        <AlertDescription className=\"mt-2\">\n          <div className=\"flex flex-col gap-2\">\n            <div className=\"flex items-center gap-4\">\n              <span className=\"flex items-center gap-1\">\n                <User className=\"h-3 w-3\" />\n                <strong>{preview.validCount}</strong> contacts will be imported\n              </span>\n              {preview.skipCount > 0 && (\n                <span className=\"flex items-center gap-1 text-warning\">\n                  <AlertCircle className=\"h-3 w-3\" />\n                  <strong>{preview.skipCount}</strong> rows will be skipped\n                </span>\n              )}\n            </div>\n            {(preview.newOrganizations.length > 0 || preview.newTags.length > 0) && (\n              <div className=\"flex items-center gap-4 text-sm\">\n                {preview.newOrganizations.length > 0 && (\n                  <span className=\"flex items-center gap-1\">\n                    <Building2 className=\"h-3 w-3\" />\n                    {preview.newOrganizations.length} new organizations\n                  </span>\n                )}\n                {preview.newTags.length > 0 && (\n                  <span className=\"flex items-center gap-1\">\n                    <Tag className=\"h-3 w-3\" />\n                    {preview.newTags.length} new tags\n                  </span>\n                )}\n              </div>\n            )}\n          </div>\n        </AlertDescription>\n      </Alert>\n\n      {/* Duplicate Mappings Error */}\n      {hasDuplicates && (\n        <Alert variant=\"destructive\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertTitle>Duplicate Field Mappings Detected</AlertTitle>\n          <AlertDescription>\n            <div className=\"flex flex-col gap-2\">\n              <p>\n                Multiple CSV columns cannot be mapped to the same CRM field. Please fix the\n                following duplicates:\n              </p>\n              <ul className=\"list-disc list-inside\">\n                {Array.from(duplicateTargets).map((target) => (\n                  <li key={target}>\n                    <strong>{target}</strong> is mapped {targetFieldCounts.get(target)} times\n                  </li>\n                ))}\n              </ul>\n            </div>\n          </AlertDescription>\n        </Alert>\n      )}\n\n      {/* Column Mappings Card - Show only mapped columns */}\n      {mappedColumns.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Column Mappings</CardTitle>\n            <CardDescription>\n              {mappedColumns.length} CSV column{mappedColumns.length !== 1 ? \"s\" : \"\"} will be\n              imported\n              {skippedColumns.length > 0 &&\n                ` • ${skippedColumns.length} column${skippedColumns.length !== 1 ? \"s\" : \"\"} will be skipped`}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>CSV Column</TableHead>\n                  <TableHead className=\"text-center w-12\">\n                    <ArrowRight className=\"h-4 w-4 mx-auto\" />\n                  </TableHead>\n                  <TableHead>CRM Field</TableHead>\n                  <TableHead>Sample Value</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {mappedColumns.map((mapping, index) => {\n                  // Determine if this mapping is a user override\n                  const isUserOverride = userOverrides?.has(mapping.source);\n\n                  // Get the actual value to display (handle full name marker)\n                  // Use special marker for \"no mapping\" to avoid empty string (Radix UI doesn't allow empty values)\n                  const displayValue =\n                    mapping.target === \"first_name + last_name (will be split)\"\n                      ? FULL_NAME_SPLIT_MARKER\n                      : mapping.target || \"__no_mapping__\";\n\n                  return (\n                    <TableRow key={index} className={isUserOverride ? \"bg-primary-subtle\" : \"\"}>\n                      <TableCell className=\"font-mono text-sm text-muted-foreground\">\n                        {mapping.source}\n                        {isUserOverride && (\n                          <Badge variant=\"secondary\" className=\"ml-2 text-xs\">\n                            Custom\n                          </Badge>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-center\">\n                        <ArrowRight className=\"h-3 w-3 mx-auto text-muted-foreground\" />\n                      </TableCell>\n                      <TableCell>\n                        {onMappingChange ? (\n                          <Select\n                            value={displayValue}\n                            onValueChange={(value) => {\n                              // Convert special marker back to null for \"no mapping\"\n                              onMappingChange(\n                                mapping.source,\n                                value === \"__no_mapping__\" ? null : value\n                              );\n                            }}\n                          >\n                            <SelectTrigger className=\"w-full\">\n                              <SelectValue placeholder=\"(No mapping)\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value=\"__no_mapping__\">(No mapping)</SelectItem>\n                              {availableFieldOptions.map((option) => (\n                                <SelectItem key={option.value} value={option.value}>\n                                  {option.label}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        ) : (\n                          <Badge variant=\"outline\" className=\"font-mono text-xs\">\n                            {mapping.target}\n                          </Badge>\n                        )}\n                      </TableCell>\n                      <TableCell className=\"text-sm text-muted-foreground max-w-[200px] truncate\">\n                        {mapping.sampleValue || <span className=\"text-muted-foreground\">-</span>}\n                      </TableCell>\n                    </TableRow>\n                  );\n                })}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Skipped Columns - Collapsible */}\n      {skippedColumns.length > 0 && (\n        <Collapsible open={expandedSections.skippedColumns}>\n          <Card className=\"border-muted\">\n            <CollapsibleTrigger asChild>\n              <CardHeader\n                className=\"cursor-pointer\"\n                onClick={() => toggleSection(\"skippedColumns\")}\n              >\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <AlertCircle className=\"h-4 w-4 text-muted-foreground\" />\n                    <CardTitle className=\"text-muted-foreground\">Skipped Columns</CardTitle>\n                    <Badge variant=\"secondary\">{skippedColumns.length}</Badge>\n                  </div>\n                  {expandedSections.skippedColumns ? (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  )}\n                </div>\n                <CardDescription>\n                  These CSV columns don't match any CRM fields and will be ignored\n                </CardDescription>\n              </CardHeader>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <CardContent>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>CSV Column</TableHead>\n                      <TableHead>Sample Value</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {skippedColumns.map((mapping, index) => (\n                      <TableRow key={index}>\n                        <TableCell className=\"font-mono text-sm text-muted-foreground\">\n                          {mapping.source}\n                        </TableCell>\n                        <TableCell className=\"text-sm text-muted-foreground max-w-[300px] truncate\">\n                          {mapping.sampleValue || \"-\"}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </CardContent>\n            </CollapsibleContent>\n          </Card>\n        </Collapsible>\n      )}\n\n      {/* Sample Data Preview */}\n      <Collapsible open={expandedSections.sampleData}>\n        <Card>\n          <CollapsibleTrigger asChild>\n            <CardHeader className=\"cursor-pointer\" onClick={() => toggleSection(\"sampleData\")}>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle>Sample Data Preview</CardTitle>\n                  <CardDescription>\n                    First 5 rows after transformation ({validSamples}/5 valid)\n                  </CardDescription>\n                </div>\n                {expandedSections.sampleData ? (\n                  <ChevronUp className=\"h-4 w-4\" />\n                ) : (\n                  <ChevronDown className=\"h-4 w-4\" />\n                )}\n              </div>\n            </CardHeader>\n          </CollapsibleTrigger>\n          <CollapsibleContent>\n            <CardContent>\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead className=\"w-12\">Row</TableHead>\n                      <TableHead>Name</TableHead>\n                      <TableHead>Email</TableHead>\n                      <TableHead>Organization</TableHead>\n                      <TableHead>Status</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {preview.sampleRows.slice(0, 5).map((row, index) => {\n                      const validation = sampleValidation[index];\n                      return (\n                        <TableRow key={index}>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              {index + 1}\n                              {validation?.valid ? (\n                                <CheckCircle className=\"h-3 w-3 text-success\" />\n                              ) : (\n                                <AlertCircle className=\"h-3 w-3 text-destructive\" />\n                              )}\n                            </div>\n                          </TableCell>\n                          <TableCell>{row.name || `${row.first_name} ${row.last_name}`}</TableCell>\n                          <TableCell className=\"font-mono text-sm\">\n                            {row.email?.[0]?.email || \"-\"}\n                          </TableCell>\n                          <TableCell>{row.organization_name || \"-\"}</TableCell>\n                          <TableCell>\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {validation?.valid ? \"Valid\" : \"Has Issues\"}\n                            </Badge>\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })}\n                  </TableBody>\n                </Table>\n              </div>\n            </CardContent>\n          </CollapsibleContent>\n        </Card>\n      </Collapsible>\n\n      {/* New Organizations */}\n      {preview.newOrganizations.length > 0 && (\n        <Collapsible open={expandedSections.organizations}>\n          <Card>\n            <CollapsibleTrigger asChild>\n              <CardHeader className=\"cursor-pointer\" onClick={() => toggleSection(\"organizations\")}>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <Building2 className=\"h-4 w-4\" />\n                    <CardTitle>New Organizations</CardTitle>\n                    <Badge variant=\"secondary\">{preview.newOrganizations.length}</Badge>\n                  </div>\n                  {expandedSections.organizations ? (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  )}\n                </div>\n                <CardDescription>These organizations will be created automatically</CardDescription>\n              </CardHeader>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <CardContent>\n                <div className=\"flex flex-wrap gap-2\">\n                  {preview.newOrganizations.map((org, index) => (\n                    <Badge key={index} variant=\"outline\">\n                      {org}\n                    </Badge>\n                  ))}\n                </div>\n              </CardContent>\n            </CollapsibleContent>\n          </Card>\n        </Collapsible>\n      )}\n\n      {/* New Tags */}\n      {preview.newTags.length > 0 && (\n        <Collapsible open={expandedSections.tags}>\n          <Card>\n            <CollapsibleTrigger asChild>\n              <CardHeader className=\"cursor-pointer\" onClick={() => toggleSection(\"tags\")}>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <Tag className=\"h-4 w-4\" />\n                    <CardTitle>New Tags</CardTitle>\n                    <Badge variant=\"secondary\">{preview.newTags.length}</Badge>\n                  </div>\n                  {expandedSections.tags ? (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  )}\n                </div>\n                <CardDescription>These tags will be created automatically</CardDescription>\n              </CardHeader>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <CardContent>\n                <div className=\"flex flex-wrap gap-2\">\n                  {preview.newTags.map((tag, index) => (\n                    <Badge key={index} variant=\"secondary\">\n                      {tag}\n                    </Badge>\n                  ))}\n                </div>\n              </CardContent>\n            </CollapsibleContent>\n          </Card>\n        </Collapsible>\n      )}\n\n      {/* Validation Errors */}\n      {preview.errors.length > 0 && (\n        <Collapsible open={expandedSections.errors}>\n          <Card className=\"border-destructive/50\">\n            <CollapsibleTrigger asChild>\n              <CardHeader className=\"cursor-pointer\" onClick={() => toggleSection(\"errors\")}>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <AlertCircle className=\"h-4 w-4 text-destructive\" />\n                    <CardTitle className=\"text-destructive\">Validation Errors</CardTitle>\n                    <Badge variant=\"destructive\">{preview.errors.length}</Badge>\n                  </div>\n                  {expandedSections.errors ? (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  )}\n                </div>\n                <CardDescription>\n                  These rows cannot be imported due to validation errors\n                </CardDescription>\n              </CardHeader>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <CardContent>\n                <div className=\"space-y-2 max-h-60 overflow-y-auto\">\n                  {preview.errors.slice(0, 10).map((error, index) => (\n                    <div\n                      key={index}\n                      className=\"flex items-start gap-2 text-sm p-2 bg-destructive/10 rounded\"\n                    >\n                      <AlertCircle className=\"h-4 w-4 text-destructive mt-0.5 flex-shrink-0\" />\n                      <div>\n                        <span className=\"font-medium\">Row {error.row}</span>\n                        {error.field && (\n                          <span className=\"text-muted-foreground\"> ({error.field})</span>\n                        )}\n                        : {error.message}\n                      </div>\n                    </div>\n                  ))}\n                  {preview.errors.length > 10 && (\n                    <div className=\"text-sm text-muted-foreground text-center pt-2\">\n                      ... and {preview.errors.length - 10} more errors\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </CollapsibleContent>\n          </Card>\n        </Collapsible>\n      )}\n\n      {/* Validation Warnings */}\n      {preview.warnings.length > 0 && (\n        <Collapsible open={expandedSections.warnings}>\n          <Card className=\"border-warning/50\">\n            <CollapsibleTrigger asChild>\n              <CardHeader className=\"cursor-pointer\" onClick={() => toggleSection(\"warnings\")}>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <AlertTriangle className=\"h-4 w-4 text-warning\" />\n                    <CardTitle className=\"text-warning\">Warnings</CardTitle>\n                    <Badge variant=\"outline\" className=\"border-warning text-warning\">\n                      {preview.warnings.length}\n                    </Badge>\n                  </div>\n                  {expandedSections.warnings ? (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  )}\n                </div>\n                <CardDescription>\n                  These issues won't prevent import but should be reviewed\n                </CardDescription>\n              </CardHeader>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <CardContent>\n                <div className=\"space-y-2 max-h-60 overflow-y-auto\">\n                  {preview.warnings.slice(0, 10).map((warning, index) => (\n                    <div\n                      key={index}\n                      className=\"flex items-start gap-2 text-sm p-2 bg-warning/10 rounded\"\n                    >\n                      <AlertTriangle className=\"h-4 w-4 text-warning mt-0.5 flex-shrink-0\" />\n                      <div>\n                        <span className=\"font-medium\">Row {warning.row}</span>\n                        {warning.field && (\n                          <span className=\"text-muted-foreground\"> ({warning.field})</span>\n                        )}\n                        : {warning.message}\n                      </div>\n                    </div>\n                  ))}\n                  {preview.warnings.length > 10 && (\n                    <div className=\"text-sm text-muted-foreground text-center pt-2\">\n                      ... and {preview.warnings.length - 10} more warnings\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </CollapsibleContent>\n          </Card>\n        </Collapsible>\n      )}\n\n      {/* Data Quality Decision: Organizations Without Contacts */}\n      {preview.organizationsWithoutContacts && preview.organizationsWithoutContacts.length > 0 && (\n        <Collapsible open={expandedSections.organizationsWithoutContacts}>\n          <Card className=\"border-primary/50\">\n            <CollapsibleTrigger asChild>\n              <CardHeader\n                className=\"cursor-pointer\"\n                onClick={() => toggleSection(\"organizationsWithoutContacts\")}\n              >\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <Building2 className=\"h-4 w-4 text-primary\" />\n                    <CardTitle className=\"text-primary\">\n                      Organizations Without Contact Person\n                    </CardTitle>\n                    <Badge variant=\"outline\" className=\"border-primary text-primary\">\n                      {preview.organizationsWithoutContacts.length}\n                    </Badge>\n                  </div>\n                  {expandedSections.organizationsWithoutContacts ? (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  )}\n                </div>\n                <CardDescription>\n                  CSV rows with organization names but no contact person\n                </CardDescription>\n              </CardHeader>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <CardContent className=\"space-y-4\">\n                <Alert>\n                  <HelpCircle className=\"h-4 w-4\" />\n                  <AlertTitle>What happens if I import these?</AlertTitle>\n                  <AlertDescription>\n                    A placeholder contact named \"General Contact\" will be created for each\n                    organization. This allows you to maintain organizational records even without\n                    specific contact details.\n                  </AlertDescription>\n                </Alert>\n\n                <div className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id=\"import-orgs-without-contacts\"\n                    checked={dataQualityDecisions.importOrganizationsWithoutContacts}\n                    onCheckedChange={(checked) =>\n                      setDataQualityDecisions((prev) => ({\n                        ...prev,\n                        importOrganizationsWithoutContacts: checked === true,\n                      }))\n                    }\n                  />\n                  <Label\n                    htmlFor=\"import-orgs-without-contacts\"\n                    className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n                  >\n                    Create placeholder contacts for these{\" \"}\n                    {preview.organizationsWithoutContacts.length} organizations\n                  </Label>\n                </div>\n\n                <div className=\"max-h-40 overflow-y-auto space-y-1\">\n                  {preview.organizationsWithoutContacts.slice(0, 20).map((org, index) => (\n                    <div\n                      key={index}\n                      className=\"flex items-start gap-2 text-sm p-2 bg-primary/10 rounded\"\n                    >\n                      <Building2 className=\"h-4 w-4 text-primary mt-0.5 flex-shrink-0\" />\n                      <div>\n                        <span className=\"font-medium\">{org.organization_name}</span>\n                        <span className=\"text-muted-foreground\"> (Row {org.row})</span>\n                      </div>\n                    </div>\n                  ))}\n                  {preview.organizationsWithoutContacts.length > 20 && (\n                    <div className=\"text-sm text-muted-foreground text-center pt-2\">\n                      ... and {preview.organizationsWithoutContacts.length - 20} more\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </CollapsibleContent>\n          </Card>\n        </Collapsible>\n      )}\n\n      {/* Data Quality Decision: Contacts Without Contact Info */}\n      {preview.contactsWithoutContactInfo && preview.contactsWithoutContactInfo.length > 0 && (\n        <Collapsible open={expandedSections.contactsWithoutContactInfo}>\n          <Card className=\"border-warning/50\">\n            <CollapsibleTrigger asChild>\n              <CardHeader\n                className=\"cursor-pointer\"\n                onClick={() => toggleSection(\"contactsWithoutContactInfo\")}\n              >\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <User className=\"h-4 w-4 text-warning\" />\n                    <CardTitle className=\"text-warning\">Contacts Without Email or Phone</CardTitle>\n                    <Badge variant=\"outline\" className=\"border-warning text-warning\">\n                      {preview.contactsWithoutContactInfo.length}\n                    </Badge>\n                  </div>\n                  {expandedSections.contactsWithoutContactInfo ? (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  )}\n                </div>\n                <CardDescription>Contacts missing both email and phone information</CardDescription>\n              </CardHeader>\n            </CollapsibleTrigger>\n            <CollapsibleContent>\n              <CardContent className=\"space-y-4\">\n                <Alert>\n                  <AlertTriangle className=\"h-4 w-4\" />\n                  <AlertTitle>Limited Usefulness</AlertTitle>\n                  <AlertDescription>\n                    These contacts have no email or phone number, which significantly limits their\n                    value in a CRM. You can still import them, but you won't be able to contact them\n                    through standard channels.\n                  </AlertDescription>\n                </Alert>\n\n                <div className=\"flex items-center space-x-2\">\n                  <Checkbox\n                    id=\"import-contacts-without-info\"\n                    checked={dataQualityDecisions.importContactsWithoutContactInfo}\n                    onCheckedChange={(checked) =>\n                      setDataQualityDecisions((prev) => ({\n                        ...prev,\n                        importContactsWithoutContactInfo: checked === true,\n                      }))\n                    }\n                  />\n                  <Label\n                    htmlFor=\"import-contacts-without-info\"\n                    className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n                  >\n                    Import these {preview.contactsWithoutContactInfo.length} contacts anyway\n                  </Label>\n                </div>\n\n                <div className=\"max-h-40 overflow-y-auto space-y-1\">\n                  {preview.contactsWithoutContactInfo.slice(0, 20).map((contact, index) => (\n                    <div\n                      key={index}\n                      className=\"flex items-start gap-2 text-sm p-2 bg-warning/10 rounded\"\n                    >\n                      <User className=\"h-4 w-4 text-warning mt-0.5 flex-shrink-0\" />\n                      <div>\n                        <span className=\"font-medium\">{contact.name}</span>\n                        {contact.organization_name && (\n                          <span className=\"text-muted-foreground\">\n                            {\" \"}\n                            at {contact.organization_name}\n                          </span>\n                        )}\n                        <span className=\"text-muted-foreground\"> (Row {contact.row})</span>\n                      </div>\n                    </div>\n                  ))}\n                  {preview.contactsWithoutContactInfo.length > 20 && (\n                    <div className=\"text-sm text-muted-foreground text-center pt-2\">\n                      ... and {preview.contactsWithoutContactInfo.length - 20} more\n                    </div>\n                  )}\n                </div>\n              </CardContent>\n            </CollapsibleContent>\n          </Card>\n        </Collapsible>\n      )}\n\n      {/* Actions */}\n      <DialogFooter className=\"gap-2\">\n        <Button variant=\"outline\" onClick={onCancel}>\n          Cancel\n        </Button>\n        {preview.lowConfidenceMappings > 0 && onRemap && (\n          <Button variant=\"outline\" onClick={onRemap}>\n            Review Mappings ({preview.lowConfidenceMappings} uncertain)\n          </Button>\n        )}\n        <Button\n          variant=\"default\"\n          onClick={() => onContinue(dataQualityDecisions)}\n          disabled={preview.validCount === 0 || hasDuplicates}\n        >\n          Continue Import ({preview.validCount} contacts)\n        </Button>\n      </DialogFooter>\n    </div>\n  );\n}\n\nexport default ContactImportPreview;\n","import { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport {\n  AlertCircle,\n  AlertTriangle,\n  CheckCircle2,\n  Clock,\n  Download,\n  FileText,\n  RefreshCw,\n  X,\n} from \"lucide-react\";\nimport * as React from \"react\";\n\nexport interface FieldError {\n  field: string;\n  message: string;\n  value?: any;\n}\n\nexport interface ImportError {\n  row: number;\n  data: Record<string, unknown>;\n  errors: FieldError[];\n}\n\nexport interface ImportResultData {\n  totalProcessed: number;\n  successCount: number;\n  skippedCount: number;\n  failedCount: number;\n  errors: ImportError[];\n  duration: number; // in milliseconds\n  startTime?: Date;\n  endTime?: Date;\n}\n\ninterface ContactImportResultProps {\n  open: boolean;\n  onClose: () => void;\n  onRetry?: () => void;\n  result: ImportResultData;\n  allowRetry?: boolean;\n}\n\nexport function ContactImportResult({\n  open,\n  onClose,\n  onRetry,\n  result,\n  allowRetry = false,\n}: ContactImportResultProps) {\n  const successRate =\n    result.totalProcessed > 0 ? Math.round((result.successCount / result.totalProcessed) * 100) : 0;\n\n  const hasErrors = result.failedCount > 0 || result.skippedCount > 0;\n  const isComplete = result.successCount === result.totalProcessed;\n\n  // Format duration in human-readable format\n  const formatDuration = (ms: number) => {\n    const seconds = Math.floor((ms / 1000) % 60);\n    const minutes = Math.floor((ms / (60 * 1000)) % 60);\n    const hours = Math.floor(ms / (60 * 60 * 1000));\n\n    if (hours > 0) {\n      return `${hours}h ${minutes}m ${seconds}s`;\n    }\n    if (minutes > 0) {\n      return `${minutes}m ${seconds}s`;\n    }\n    return `${seconds}s`;\n  };\n\n  const handleDownloadErrors = () => {\n    // Create CSV content with comprehensive error details\n    const csvContent = [\n      [\n        \"Row\",\n        \"Error Reasons\",\n        \"First Name\",\n        \"Last Name\",\n        \"Organization\",\n        \"Title\",\n        \"Email (Work)\",\n        \"Email (Home)\",\n        \"Email (Other)\",\n        \"Phone (Work)\",\n        \"Phone (Home)\",\n        \"Phone (Other)\",\n        \"LinkedIn URL\",\n        \"Notes\",\n      ],\n      ...result.errors.map((error) => [\n        error.row.toString(),\n        error.errors.map((e) => `${e.field}: ${e.message}`).join(\"; \"), // Join all error messages\n        error.data.first_name || \"\",\n        error.data.last_name || \"\",\n        error.data.organization_name || \"\",\n        error.data.title || \"\",\n        error.data.email_work || \"\",\n        error.data.email_home || \"\",\n        error.data.email_other || \"\",\n        error.data.phone_work || \"\",\n        error.data.phone_home || \"\",\n        error.data.phone_other || \"\",\n        error.data.linkedin_url || \"\",\n        error.data.notes || \"\",\n      ]),\n    ]\n      .map((row) => row.map((cell) => `\"${String(cell).replace(/\"/g, '\"\"')}\"`).join(\",\"))\n      .join(\"\\n\");\n\n    // Create and trigger download\n    const blob = new Blob([csvContent], { type: \"text/csv;charset=utf-8;\" });\n    const link = document.createElement(\"a\");\n    const url = URL.createObjectURL(blob);\n    link.setAttribute(\"href\", url);\n    link.setAttribute(\"download\", `import_errors_${new Date().toISOString().split(\"T\")[0]}.csv`);\n    link.style.visibility = \"hidden\";\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-hidden flex flex-col\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            {isComplete ? (\n              <>\n                <CheckCircle2 className=\"h-5 w-5 text-success\" />\n                Import Completed Successfully\n              </>\n            ) : hasErrors ? (\n              <>\n                <AlertTriangle className=\"h-5 w-5 text-warning\" />\n                Import Completed with Issues\n              </>\n            ) : (\n              <>\n                <CheckCircle2 className=\"h-5 w-5 text-success\" />\n                Import Completed\n              </>\n            )}\n          </DialogTitle>\n          <DialogDescription>\n            Processed {result.totalProcessed.toLocaleString()} contacts in{\" \"}\n            {formatDuration(result.duration)}\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"flex-1 overflow-y-auto space-y-4 py-4\">\n          {/* Summary Statistics */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"border rounded-lg p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Successful</p>\n                  <p className=\"text-2xl font-semibold text-success\">\n                    {result.successCount.toLocaleString()}\n                  </p>\n                </div>\n                <CheckCircle2 className=\"h-11 w-11 text-success opacity-20\" />\n              </div>\n            </div>\n\n            <div className=\"border rounded-lg p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Skipped</p>\n                  <p className=\"text-2xl font-semibold text-warning\">\n                    {result.skippedCount.toLocaleString()}\n                  </p>\n                </div>\n                <AlertTriangle className=\"h-11 w-11 text-warning opacity-20\" />\n              </div>\n            </div>\n\n            <div className=\"border rounded-lg p-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Failed</p>\n                  <p className=\"text-2xl font-semibold text-error\">\n                    {result.failedCount.toLocaleString()}\n                  </p>\n                </div>\n                <X className=\"h-11 w-11 text-error opacity-20\" />\n              </div>\n            </div>\n          </div>\n\n          {/* Success Rate Progress */}\n          <div className=\"space-y-2\">\n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-sm font-medium\">Success Rate</span>\n              <span className=\"text-sm text-muted-foreground\">{successRate}%</span>\n            </div>\n            <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n              <div\n                className={`h-full transition-all ${\n                  successRate >= 90 ? \"bg-success\" : successRate >= 70 ? \"bg-warning\" : \"bg-error\"\n                }`}\n                style={{ width: `${successRate}%` }}\n              />\n            </div>\n          </div>\n\n          {/* Performance Metrics */}\n          <div className=\"border rounded-lg p-4 space-y-2\">\n            <h3 className=\"font-medium flex items-center gap-2\">\n              <Clock className=\"h-4 w-4\" />\n              Performance Metrics\n            </h3>\n            <div className=\"grid grid-cols-2 gap-4 text-sm\">\n              <div>\n                <span className=\"text-muted-foreground\">Total Duration:</span>{\" \"}\n                <span className=\"font-medium\">{formatDuration(result.duration)}</span>\n              </div>\n              <div>\n                <span className=\"text-muted-foreground\">Processing Speed:</span>{\" \"}\n                <span className=\"font-medium\">\n                  {result.duration > 0\n                    ? `${Math.round((result.totalProcessed / result.duration) * 1000)} contacts/sec`\n                    : \"N/A\"}\n                </span>\n              </div>\n              {result.startTime && (\n                <div>\n                  <span className=\"text-muted-foreground\">Started at:</span>{\" \"}\n                  <span className=\"font-medium\">{result.startTime.toLocaleTimeString()}</span>\n                </div>\n              )}\n              {result.endTime && (\n                <div>\n                  <span className=\"text-muted-foreground\">Completed at:</span>{\" \"}\n                  <span className=\"font-medium\">{result.endTime.toLocaleTimeString()}</span>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Error Details */}\n          {hasErrors && result.errors.length > 0 && (\n            <div className=\"border rounded-lg p-4 space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <h3 className=\"font-medium flex items-center gap-2\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  Rejected Records ({result.errors.length})\n                </h3>\n                <div className=\"flex gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={handleDownloadErrors}\n                    className=\"gap-2\"\n                  >\n                    <Download className=\"h-3 w-3\" />\n                    Export\n                  </Button>\n                </div>\n              </div>\n\n              <div className=\"space-y-2 max-h-96 overflow-y-auto p-1\">\n                {result.errors.map((error) => (\n                  <div\n                    key={error.row}\n                    className=\"flex flex-col gap-2 p-3 bg-muted/40 rounded border border-error-subtle\"\n                  >\n                    <div className=\"flex items-center gap-2\">\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        Row {error.row}\n                      </Badge>\n                      <span className=\"font-medium text-sm\">\n                        {error.data.first_name || \"(no first name)\"}{\" \"}\n                        {error.data.last_name || \"(no last name)\"}\n                      </span>\n                    </div>\n                    <ul className=\"text-xs text-error space-y-1 ml-4 list-disc list-inside\">\n                      {error.errors.map((fieldError, index) => (\n                        <li key={index}>\n                          <span className=\"font-semibold capitalize\">\n                            {fieldError.field.replace(/_/g, \" \")}:\n                          </span>{\" \"}\n                          {fieldError.message}\n                          {fieldError.value && (\n                            <span className=\"text-muted-foreground italic ml-1\">\n                              (was: \"{String(fieldError.value)}\")\n                            </span>\n                          )}\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Warnings for skipped rows */}\n          {result.skippedCount > 0 && (\n            <Alert>\n              <AlertTriangle className=\"h-4 w-4\" />\n              <AlertTitle>Skipped Rows</AlertTitle>\n              <AlertDescription>\n                {result.skippedCount} {result.skippedCount === 1 ? \"row was\" : \"rows were\"} skipped\n                during import. These typically include rows with missing required fields like\n                organization name. Review the error details above for specific reasons.\n              </AlertDescription>\n            </Alert>\n          )}\n        </div>\n\n        <DialogFooter>\n          <div className=\"flex gap-2 w-full justify-between\">\n            <div className=\"flex gap-2\">\n              {hasErrors && result.errors.length > 0 && (\n                <Button variant=\"outline\" onClick={handleDownloadErrors} className=\"gap-2\">\n                  <FileText className=\"h-4 w-4\" />\n                  Download Error Report\n                </Button>\n              )}\n            </div>\n            <div className=\"flex gap-2\">\n              {allowRetry && hasErrors && (\n                <Button\n                  variant=\"outline\"\n                  onClick={() => {\n                    onRetry?.();\n                    onClose();\n                  }}\n                  className=\"gap-2\"\n                >\n                  <RefreshCw className=\"h-4 w-4\" />\n                  Retry Failed\n                </Button>\n              )}\n              <Button onClick={onClose} variant={isComplete ? \"default\" : \"outline\"}>\n                {isComplete ? \"Done\" : \"Close\"}\n              </Button>\n            </div>\n          </div>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","/**\n * Helper functions for CSV contact import data extraction and analysis.\n *\n * These functions operate on parsed CSV data to extract metadata,\n * identify data quality issues, and prepare preview information.\n *\n * Function categories:\n * - **Extractors** (pure): Extract unique values from parsed data\n * - **Finders** (use predicates): Identify rows matching quality criteria\n *\n * @see contactImport.logic.ts for predicate functions\n * @see contactImport.types.ts for type definitions\n */\n\nimport type { ContactImportSchema } from \"./contactImport.types\";\nimport { isOrganizationOnlyEntry, isContactWithoutContactInfo } from \"./contactImport.logic\";\n\n// ============================================================\n// CONSTANTS\n// ============================================================\n\n/**\n * Offset to convert 0-indexed array position to user-facing row number.\n * Accounts for:\n * - 3 header rows in CSV template (title, description, field names)\n * - 1-indexed display for user-friendly row references\n */\nexport const CSV_DATA_START_OFFSET = 4;\n\n// ============================================================\n// EXTRACTION FUNCTIONS (Pure)\n// ============================================================\n\n/**\n * Extracts unique organization names from parsed CSV data.\n *\n * Pure function - no external dependencies, deterministic output.\n *\n * @param rows - Array of parsed contact data\n * @returns Array of unique organization names (trimmed, non-empty)\n *\n * @example\n * ```ts\n * const orgs = extractNewOrganizations([\n *   { organization_name: \"Acme Inc\", first_name: \"John\" },\n *   { organization_name: \"Acme Inc\", first_name: \"Jane\" },\n *   { organization_name: \"Tech Corp\", first_name: \"Bob\" },\n * ]);\n * // Returns: [\"Acme Inc\", \"Tech Corp\"]\n * ```\n */\nexport function extractNewOrganizations(rows: ContactImportSchema[]): string[] {\n  const organizations = new Set<string>();\n\n  for (const row of rows) {\n    if (row.organization_name) {\n      const trimmed = row.organization_name.trim();\n      if (trimmed) {\n        organizations.add(trimmed);\n      }\n    }\n  }\n\n  return Array.from(organizations);\n}\n\n/**\n * Extracts unique tags from parsed CSV data.\n *\n * Pure function - no external dependencies, deterministic output.\n * Tags in CSV are stored as comma-separated values in a single field.\n *\n * @param rows - Array of parsed contact data\n * @returns Array of unique tags (trimmed, non-empty)\n *\n * @example\n * ```ts\n * const tags = extractNewTags([\n *   { tags: \"VIP, Customer\", first_name: \"John\" },\n *   { tags: \"VIP, Partner\", first_name: \"Jane\" },\n * ]);\n * // Returns: [\"VIP\", \"Customer\", \"Partner\"]\n * ```\n */\nexport function extractNewTags(rows: ContactImportSchema[]): string[] {\n  const tags = new Set<string>();\n\n  for (const row of rows) {\n    if (row.tags) {\n      const tagList = row.tags.split(\",\");\n      for (const tag of tagList) {\n        const trimmed = tag.trim();\n        if (trimmed) {\n          tags.add(trimmed);\n        }\n      }\n    }\n  }\n\n  return Array.from(tags);\n}\n\n// ============================================================\n// FINDER FUNCTIONS (Use predicates)\n// ============================================================\n\n/**\n * Result type for organization-only entries found in CSV data.\n */\nexport interface OrganizationOnlyEntry {\n  /** Organization name from the row */\n  organization_name: string;\n  /** User-facing row number (1-indexed, accounting for header rows) */\n  row: number;\n}\n\n/**\n * Result type for contacts without contact information.\n */\nexport interface ContactWithoutInfoEntry {\n  /** Contact's full name (or \"Unknown\" if empty) */\n  name: string;\n  /** Organization name (may be empty) */\n  organization_name: string;\n  /** User-facing row number (1-indexed, accounting for header rows) */\n  row: number;\n}\n\n/**\n * Finds rows containing organization-only entries (org name but no contact name).\n *\n * Uses `isOrganizationOnlyEntry` predicate from contactImport.logic.ts.\n * These entries may indicate:\n * - Intentional organization records without a contact person\n * - Data entry errors where contact name was omitted\n *\n * @param rows - Array of parsed contact data\n * @returns Array of matching entries with organization name and row number\n *\n * @example\n * ```ts\n * const orgOnly = findOrganizationsWithoutContacts([\n *   { organization_name: \"Acme Inc\", first_name: \"\", last_name: \"\" },\n *   { organization_name: \"Tech Corp\", first_name: \"John\", last_name: \"Doe\" },\n * ]);\n * // Returns: [{ organization_name: \"Acme Inc\", row: 4 }]\n * ```\n */\nexport function findOrganizationsWithoutContacts(\n  rows: ContactImportSchema[]\n): OrganizationOnlyEntry[] {\n  const results: OrganizationOnlyEntry[] = [];\n\n  for (let index = 0; index < rows.length; index++) {\n    const row = rows[index];\n    if (isOrganizationOnlyEntry(row)) {\n      results.push({\n        organization_name: String(row.organization_name).trim(),\n        row: index + CSV_DATA_START_OFFSET,\n      });\n    }\n  }\n\n  return results;\n}\n\n/**\n * Finds contacts that have names but lack any contact information (email or phone).\n *\n * Uses `isContactWithoutContactInfo` predicate from contactImport.logic.ts.\n * These entries may indicate:\n * - Contacts imported from sources without contact details\n * - Data entry errors where email/phone was omitted\n *\n * @param rows - Array of parsed contact data\n * @returns Array of matching entries with name, organization, and row number\n *\n * @example\n * ```ts\n * const noInfo = findContactsWithoutContactInfo([\n *   { first_name: \"John\", last_name: \"Doe\", organization_name: \"Acme\" },\n *   { first_name: \"Jane\", last_name: \"Smith\", organization_name: \"Tech\", email_work: \"jane@tech.com\" },\n * ]);\n * // Returns: [{ name: \"John Doe\", organization_name: \"Acme\", row: 4 }]\n * ```\n */\nexport function findContactsWithoutContactInfo(\n  rows: ContactImportSchema[]\n): ContactWithoutInfoEntry[] {\n  const results: ContactWithoutInfoEntry[] = [];\n\n  for (let index = 0; index < rows.length; index++) {\n    const row = rows[index];\n    if (isContactWithoutContactInfo(row)) {\n      // Build display name from available parts\n      const nameParts: string[] = [];\n      if (row.first_name && String(row.first_name).trim()) {\n        nameParts.push(String(row.first_name).trim());\n      }\n      if (row.last_name && String(row.last_name).trim()) {\n        nameParts.push(String(row.last_name).trim());\n      }\n      const name = nameParts.length > 0 ? nameParts.join(\" \") : \"Unknown\";\n\n      results.push({\n        name,\n        organization_name: row.organization_name ? String(row.organization_name).trim() : \"\",\n        row: index + CSV_DATA_START_OFFSET,\n      });\n    }\n  }\n\n  return results;\n}\n","/**\n * useColumnMapping - Reusable hook for CSV column-to-field mapping\n *\n * Extracted from ContactImportDialog.tsx to:\n * 1. Reduce component complexity (god component anti-pattern)\n * 2. Enable reuse for other import dialogs (organizations, opportunities)\n * 3. Isolate pure derived state for easier testing\n *\n * @see /docs/architecture/csv-import-architecture.md\n */\n\nimport { useState, useMemo, useCallback, useEffect, useRef } from \"react\";\nimport { mapHeadersToFields } from \"./columnAliases\";\nimport { processCsvDataWithMappings } from \"./csvProcessor\";\nimport type { ContactImportSchema } from \"./contactImport.types\";\n\n/**\n * Return type for useColumnMapping hook\n */\nexport interface UseColumnMappingReturn {\n  /** Final mappings (auto-detected merged with user overrides) */\n  mappings: Record<string, string | null>;\n\n  /** User's manual overrides (exposed for UI \"Custom\" badge display) */\n  overrides: ReadonlyMap<string, string | null>;\n\n  /** Contacts with current mappings applied - SOURCE OF TRUTH for import */\n  contacts: ContactImportSchema[];\n\n  /** Raw headers from CSV (for preview UI) */\n  headers: string[];\n\n  /** Set or clear a single column override */\n  setOverride: (csvHeader: string, targetField: string | null) => void;\n\n  /** Initialize with parsed CSV data (called from onPreview callback) */\n  setRawData: (headers: string[], rows: any[][]) => void;\n\n  /** Reset all state (called when dialog closes or new file selected) */\n  reset: () => void;\n\n  /** True if data has been loaded */\n  hasData: boolean;\n}\n\n/**\n * Hook for managing CSV column-to-CRM-field mappings with user overrides.\n *\n * Implements a two-layer mapping strategy:\n * 1. Auto-detection via `mapHeadersToFields()` from columnAliases.ts\n * 2. User overrides stored in a Map (takes precedence over auto-detection)\n *\n * State is derived declaratively:\n * - rawHeaders + userOverrides → mergedMappings\n * - rawDataRows + mergedMappings → processedContacts\n *\n * @example\n * ```tsx\n * const { mappings, contacts, setOverride, setRawData, reset } = useColumnMapping();\n *\n * // When CSV is parsed\n * const onPreview = (data) => {\n *   setRawData(data.headers, data.rawDataRows);\n * };\n *\n * // When user changes a mapping in the UI\n * <Select onValueChange={(value) => setOverride(header, value)} />\n *\n * // When importing\n * await processBatch(contacts);\n * ```\n */\nexport function useColumnMapping(): UseColumnMappingReturn {\n  // Core state\n  const [rawHeaders, setRawHeaders] = useState<string[]>([]);\n  const [rawDataRows, setRawDataRows] = useState<any[][]>([]);\n  const [userOverrides, setUserOverrides] = useState<Map<string, string | null>>(new Map());\n\n  // Track previous headers to detect new file selection\n  const prevHeadersRef = useRef<string[]>([]);\n\n  // Reset overrides when headers change (new file selected)\n  // This prevents stale overrides from a previous file affecting the new one\n  useEffect(() => {\n    const headersChanged =\n      rawHeaders.length > 0 &&\n      (prevHeadersRef.current.length !== rawHeaders.length ||\n        !rawHeaders.every((h, i) => h === prevHeadersRef.current[i]));\n\n    if (headersChanged) {\n      setUserOverrides(new Map());\n      prevHeadersRef.current = rawHeaders;\n    }\n  }, [rawHeaders]);\n\n  /**\n   * Derive final mappings by merging auto-detection with user overrides.\n   * Priority: User override > Auto-detection\n   */\n  const mappings = useMemo<Record<string, string | null>>(() => {\n    if (rawHeaders.length === 0) return {};\n\n    const autoMappings = mapHeadersToFields(rawHeaders);\n    const finalMappings: Record<string, string | null> = {};\n\n    rawHeaders.forEach((header) => {\n      // User override takes precedence over auto-detection\n      finalMappings[header] = userOverrides.get(header) ?? autoMappings[header];\n    });\n\n    return finalMappings;\n  }, [rawHeaders, userOverrides]);\n\n  /**\n   * Derive processed contacts by applying current mappings to raw data.\n   * THIS IS THE SOURCE OF TRUTH FOR THE IMPORT - not re-parsing the file!\n   */\n  const contacts = useMemo<ContactImportSchema[]>(() => {\n    if (!rawHeaders.length || !rawDataRows.length) {\n      return [];\n    }\n    return processCsvDataWithMappings(rawHeaders, rawDataRows, mappings);\n  }, [rawHeaders, rawDataRows, mappings]);\n\n  /**\n   * Set or clear a single column override.\n   * - Pass a field name to override auto-detection\n   * - Pass null or empty string to revert to auto-detection\n   */\n  const setOverride = useCallback((csvHeader: string, targetField: string | null) => {\n    setUserOverrides((prev) => {\n      const next = new Map(prev);\n      if (targetField === null || targetField === \"\") {\n        // Clear override → revert to auto-detection\n        next.delete(csvHeader);\n      } else {\n        next.set(csvHeader, targetField);\n      }\n      return next;\n    });\n  }, []);\n\n  /**\n   * Initialize with parsed CSV data.\n   * Called from the onPreview callback when usePapaParse completes parsing.\n   */\n  const setRawData = useCallback((headers: string[], rows: any[][]) => {\n    setRawHeaders(headers);\n    setRawDataRows(rows);\n  }, []);\n\n  /**\n   * Reset all state to initial values.\n   * Called when dialog closes or user cancels import.\n   */\n  const reset = useCallback(() => {\n    setUserOverrides(new Map());\n    setRawHeaders([]);\n    setRawDataRows([]);\n    prevHeadersRef.current = [];\n  }, []);\n\n  return {\n    mappings,\n    overrides: userOverrides,\n    contacts,\n    headers: rawHeaders,\n    setOverride,\n    setRawData,\n    reset,\n    hasData: rawHeaders.length > 0,\n  };\n}\n","/**\n * Discriminated union types for the Import Wizard state machine.\n *\n * This pattern makes illegal states UNREPRESENTABLE at the type level:\n * - Each state variant carries only its relevant data\n * - TypeScript enforces exhaustive handling in switch statements\n * - State transitions are explicit and type-safe\n *\n * @see https://www.typescriptlang.org/docs/handbook/2/narrowing.html#discriminated-unions\n */\n\nimport type { ImportResult, ImportError, DataQualityDecisions } from \"./contactImport.types\";\nimport type { PreviewData } from \"./ContactImportPreview\";\nimport type { CsvValidationError } from \"../utils/csvUploadValidator\";\n\n// ============================================================\n// STATE DISCRIMINANTS\n// ============================================================\n\n/**\n * All possible wizard steps as a literal union.\n * Used as the discriminant property in WizardState.\n */\nexport type WizardStep =\n  | \"idle\"\n  | \"file_selected\"\n  | \"parsing\"\n  | \"preview\"\n  | \"importing\"\n  | \"complete\"\n  | \"error\";\n\n// ============================================================\n// PROGRESS & ACCUMULATED RESULT TYPES\n// ============================================================\n\n/**\n * Progress tracking for batch import operations.\n */\nexport interface ImportProgress {\n  /** Number of contacts processed so far */\n  count: number;\n  /** Total contacts to process */\n  total: number;\n}\n\n/**\n * Accumulated results across all import batches.\n * Mutable during import, frozen when complete.\n */\nexport interface AccumulatedResult {\n  totalProcessed: number;\n  successCount: number;\n  skippedCount: number;\n  failedCount: number;\n  errors: ImportError[];\n  startTime: Date | null;\n}\n\n/**\n * Initial accumulated result state.\n */\nexport const INITIAL_ACCUMULATED_RESULT: AccumulatedResult = {\n  totalProcessed: 0,\n  successCount: 0,\n  skippedCount: 0,\n  failedCount: 0,\n  errors: [],\n  startTime: null,\n};\n\n// ============================================================\n// WIZARD STATE DISCRIMINATED UNION\n// ============================================================\n\n/**\n * IDLE: Initial state, no file selected.\n *\n * Transitions to: FILE_SELECTED (when file is selected)\n */\nexport interface WizardStateIdle {\n  step: \"idle\";\n}\n\n/**\n * FILE_SELECTED: File has been selected and validated.\n *\n * Transitions to:\n * - PARSING (when Import button clicked)\n * - IDLE (when file is cleared)\n */\nexport interface WizardStateFileSelected {\n  step: \"file_selected\";\n  file: File;\n  validationErrors: CsvValidationError[];\n  validationWarnings: string[];\n}\n\n/**\n * PARSING: CSV file is being parsed by PapaParse.\n *\n * Transitions to:\n * - PREVIEW (when parsing completes successfully)\n * - ERROR (when parsing fails)\n */\nexport interface WizardStateParsing {\n  step: \"parsing\";\n  file: File;\n}\n\n/**\n * PREVIEW: Parsed data is being previewed before import.\n *\n * Transitions to:\n * - IMPORTING (when user confirms)\n * - IDLE (when user cancels)\n */\nexport interface WizardStatePreview {\n  step: \"preview\";\n  file: File;\n  previewData: PreviewData;\n  dataQualityDecisions: DataQualityDecisions;\n}\n\n/**\n * IMPORTING: Contacts are being imported in batches.\n *\n * Transitions to:\n * - COMPLETE (when all batches finish)\n * - ERROR (when fatal error occurs)\n */\nexport interface WizardStateImporting {\n  step: \"importing\";\n  file: File;\n  progress: ImportProgress;\n  accumulated: AccumulatedResult;\n  /** Current row offset for batch tracking */\n  rowOffset: number;\n}\n\n/**\n * COMPLETE: Import finished (success or partial failure).\n *\n * Transitions to:\n * - IDLE (when dialog is closed)\n */\nexport interface WizardStateComplete {\n  step: \"complete\";\n  result: ImportResult;\n}\n\n/**\n * ERROR: Fatal error occurred during parsing or import.\n *\n * Transitions to:\n * - IDLE (when dialog is closed)\n */\nexport interface WizardStateError {\n  step: \"error\";\n  error: Error;\n  /** The step where the error occurred */\n  previousStep: Exclude<WizardStep, \"error\">;\n}\n\n/**\n * Discriminated union of all wizard states.\n *\n * Usage with exhaustive checking:\n * ```typescript\n * switch (state.step) {\n *   case \"idle\": // state is WizardStateIdle\n *   case \"file_selected\": // state is WizardStateFileSelected\n *   case \"parsing\": // state is WizardStateParsing\n *   case \"preview\": // state is WizardStatePreview\n *   case \"importing\": // state is WizardStateImporting\n *   case \"complete\": // state is WizardStateComplete\n *   case \"error\": // state is WizardStateError\n *   default: assertNever(state); // TypeScript ensures exhaustiveness\n * }\n * ```\n */\nexport type WizardState =\n  | WizardStateIdle\n  | WizardStateFileSelected\n  | WizardStateParsing\n  | WizardStatePreview\n  | WizardStateImporting\n  | WizardStateComplete\n  | WizardStateError;\n\n// ============================================================\n// ACTION TYPES\n// ============================================================\n\n/**\n * All possible wizard action types as a literal union.\n */\nexport type WizardActionType =\n  | \"SELECT_FILE\"\n  | \"CLEAR_FILE\"\n  | \"START_PARSING\"\n  | \"PARSING_COMPLETE\"\n  | \"PARSING_FAILED\"\n  | \"UPDATE_PREVIEW\"\n  | \"UPDATE_DATA_QUALITY_DECISIONS\"\n  | \"START_IMPORT\"\n  | \"UPDATE_PROGRESS\"\n  | \"ACCUMULATE_RESULT\"\n  | \"IMPORT_COMPLETE\"\n  | \"IMPORT_FAILED\"\n  | \"CANCEL\"\n  | \"RESET\";\n\n/**\n * Action: Select a file for import.\n * Transition: IDLE → FILE_SELECTED\n */\nexport interface ActionSelectFile {\n  type: \"SELECT_FILE\";\n  payload: {\n    file: File;\n    validationErrors: CsvValidationError[];\n    validationWarnings: string[];\n  };\n}\n\n/**\n * Action: Clear the selected file.\n * Transition: FILE_SELECTED → IDLE\n */\nexport interface ActionClearFile {\n  type: \"CLEAR_FILE\";\n}\n\n/**\n * Action: Start parsing the CSV file.\n * Transition: FILE_SELECTED → PARSING\n */\nexport interface ActionStartParsing {\n  type: \"START_PARSING\";\n}\n\n/**\n * Action: Parsing completed successfully.\n * Transition: PARSING → PREVIEW\n */\nexport interface ActionParsingComplete {\n  type: \"PARSING_COMPLETE\";\n  payload: {\n    previewData: PreviewData;\n  };\n}\n\n/**\n * Action: Parsing failed with error.\n * Transition: PARSING → ERROR\n */\nexport interface ActionParsingFailed {\n  type: \"PARSING_FAILED\";\n  payload: {\n    error: Error;\n  };\n}\n\n/**\n * Action: Update preview data (e.g., when column mappings change).\n * Transition: PREVIEW → PREVIEW (same step, updated data)\n */\nexport interface ActionUpdatePreview {\n  type: \"UPDATE_PREVIEW\";\n  payload: {\n    previewData: PreviewData;\n  };\n}\n\n/**\n * Action: Update data quality decisions.\n * Transition: PREVIEW → PREVIEW (same step, updated decisions)\n */\nexport interface ActionUpdateDataQualityDecisions {\n  type: \"UPDATE_DATA_QUALITY_DECISIONS\";\n  payload: {\n    decisions: DataQualityDecisions;\n  };\n}\n\n/**\n * Action: Start the import process.\n * Transition: PREVIEW → IMPORTING\n */\nexport interface ActionStartImport {\n  type: \"START_IMPORT\";\n  payload: {\n    totalContacts: number;\n  };\n}\n\n/**\n * Action: Update import progress.\n * Transition: IMPORTING → IMPORTING (same step, updated progress)\n */\nexport interface ActionUpdateProgress {\n  type: \"UPDATE_PROGRESS\";\n  payload: {\n    count: number;\n  };\n}\n\n/**\n * Action: Accumulate batch results.\n * Transition: IMPORTING → IMPORTING (same step, accumulated results)\n */\nexport interface ActionAccumulateResult {\n  type: \"ACCUMULATE_RESULT\";\n  payload: {\n    batchProcessed: number;\n    batchSuccess: number;\n    batchSkipped: number;\n    batchFailed: number;\n    batchErrors: ImportError[];\n    batchSize: number;\n  };\n}\n\n/**\n * Action: Import completed.\n * Transition: IMPORTING → COMPLETE\n */\nexport interface ActionImportComplete {\n  type: \"IMPORT_COMPLETE\";\n}\n\n/**\n * Action: Import failed with fatal error.\n * Transition: IMPORTING → ERROR\n */\nexport interface ActionImportFailed {\n  type: \"IMPORT_FAILED\";\n  payload: {\n    error: Error;\n  };\n}\n\n/**\n * Action: Cancel current operation.\n * Transition: PREVIEW|IMPORTING → IDLE\n */\nexport interface ActionCancel {\n  type: \"CANCEL\";\n}\n\n/**\n * Action: Reset to initial state.\n * Transition: * → IDLE\n */\nexport interface ActionReset {\n  type: \"RESET\";\n}\n\n/**\n * Discriminated union of all wizard actions.\n */\nexport type WizardAction =\n  | ActionSelectFile\n  | ActionClearFile\n  | ActionStartParsing\n  | ActionParsingComplete\n  | ActionParsingFailed\n  | ActionUpdatePreview\n  | ActionUpdateDataQualityDecisions\n  | ActionStartImport\n  | ActionUpdateProgress\n  | ActionAccumulateResult\n  | ActionImportComplete\n  | ActionImportFailed\n  | ActionCancel\n  | ActionReset;\n\n// ============================================================\n// TYPE GUARDS & UTILITIES\n// ============================================================\n\n/**\n * Exhaustive check helper for switch statements.\n * TypeScript will error if any case is not handled.\n *\n * @example\n * switch (state.step) {\n *   case \"idle\": return <IdleView />;\n *   case \"file_selected\": return <FileView />;\n *   // ...\n *   default: return assertNever(state);\n * }\n */\nexport function assertNever(value: never): never {\n  throw new Error(`Unhandled discriminated union member: ${JSON.stringify(value)}`);\n}\n\n/**\n * Type guard: Check if state allows file selection.\n */\nexport function canSelectFile(state: WizardState): state is WizardStateIdle {\n  return state.step === \"idle\";\n}\n\n/**\n * Type guard: Check if state allows starting import.\n */\nexport function canStartImport(\n  state: WizardState\n): state is WizardStateFileSelected | WizardStatePreview {\n  return state.step === \"file_selected\" || state.step === \"preview\";\n}\n\n/**\n * Type guard: Check if state is cancellable.\n */\nexport function canCancel(state: WizardState): state is WizardStatePreview | WizardStateImporting {\n  return state.step === \"preview\" || state.step === \"importing\";\n}\n\n/**\n * Type guard: Check if state has a file.\n */\nexport function hasFile(\n  state: WizardState\n): state is\n  | WizardStateFileSelected\n  | WizardStateParsing\n  | WizardStatePreview\n  | WizardStateImporting {\n  return (\n    state.step === \"file_selected\" ||\n    state.step === \"parsing\" ||\n    state.step === \"preview\" ||\n    state.step === \"importing\"\n  );\n}\n\n/**\n * Type guard: Check if state is in a terminal state (complete or error).\n */\nexport function isTerminal(state: WizardState): state is WizardStateComplete | WizardStateError {\n  return state.step === \"complete\" || state.step === \"error\";\n}\n\n/**\n * Type guard: Check if state is actively processing.\n */\nexport function isProcessing(\n  state: WizardState\n): state is WizardStateParsing | WizardStateImporting {\n  return state.step === \"parsing\" || state.step === \"importing\";\n}\n\n// ============================================================\n// INITIAL STATE\n// ============================================================\n\n/**\n * Initial wizard state.\n */\nexport const INITIAL_WIZARD_STATE: WizardStateIdle = {\n  step: \"idle\",\n};\n\n// ============================================================\n// STATE DERIVATION HELPERS\n// ============================================================\n\n/**\n * Derive boolean flags from wizard state.\n * These replace the multiple useState booleans in the original implementation.\n */\nexport function deriveWizardFlags(state: WizardState) {\n  return {\n    /** True if preview dialog should be shown */\n    showPreview: state.step === \"preview\",\n    /** True if result dialog should be shown */\n    showResult: state.step === \"complete\",\n    /** True if import is in progress */\n    isImporting: state.step === \"importing\",\n    /** True if parsing is in progress */\n    isParsing: state.step === \"parsing\",\n    /** True if in error state */\n    hasError: state.step === \"error\",\n    /** True if a file is selected */\n    hasFile: hasFile(state),\n    /** True if in a terminal state */\n    isTerminal: isTerminal(state),\n    /** True if actively processing */\n    isProcessing: isProcessing(state),\n  };\n}\n","/**\n * useImportWizard - State machine hook for CSV import wizard\n *\n * Implements a discriminated union state machine pattern:\n * - Pure reducer function with no side effects\n * - Exhaustive switch statements for type safety\n * - Invalid transitions return unchanged state\n * - All state transitions are explicit and predictable\n *\n * State flow:\n * IDLE → FILE_SELECTED → PARSING → PREVIEW → IMPORTING → COMPLETE\n *                            ↓          ↓           ↓\n *                          ERROR      IDLE       ERROR\n *\n * @see useImportWizard.types.ts for type definitions\n */\n\nimport { useReducer, useCallback, useMemo, useRef, useEffect } from \"react\";\nimport type {\n  WizardState,\n  WizardAction,\n  WizardStateIdle,\n  WizardStateFileSelected,\n  WizardStateParsing,\n  WizardStatePreview,\n  WizardStateImporting,\n  WizardStateComplete,\n  WizardStateError,\n  ImportProgress,\n} from \"./useImportWizard.types\";\nimport {\n  INITIAL_ACCUMULATED_RESULT,\n  deriveWizardFlags,\n  assertNever,\n} from \"./useImportWizard.types\";\nimport type { ImportResult } from \"./contactImport.types\";\nimport type { PreviewData } from \"./ContactImportPreview\";\nimport type { CsvValidationError } from \"../utils/csvUploadValidator\";\n\n// ============================================================\n// INITIAL STATE FACTORY\n// ============================================================\n\n/**\n * Creates the initial wizard state.\n * Returns a new object each time to ensure immutability.\n */\nexport function createInitialState(): WizardStateIdle {\n  return { step: \"idle\" };\n}\n\n// ============================================================\n// REDUCER IMPLEMENTATION\n// ============================================================\n\n/**\n * Pure reducer function for the import wizard state machine.\n *\n * Design principles:\n * 1. No side effects - only returns new state\n * 2. Invalid transitions return unchanged state (same reference)\n * 3. Exhaustive handling of all action types per state\n * 4. Immutable updates - never mutates input state\n *\n * @param state - Current wizard state\n * @param action - Action to process\n * @returns New state (or same reference if action is invalid for current state)\n */\nexport function importWizardReducer(state: WizardState, action: WizardAction): WizardState {\n  // Handle RESET action from any state\n  if (action.type === \"RESET\") {\n    return createInitialState();\n  }\n\n  // Dispatch to state-specific handlers\n  switch (state.step) {\n    case \"idle\":\n      return reduceIdleState(state, action);\n\n    case \"file_selected\":\n      return reduceFileSelectedState(state, action);\n\n    case \"parsing\":\n      return reduceParsingState(state, action);\n\n    case \"preview\":\n      return reducePreviewState(state, action);\n\n    case \"importing\":\n      return reduceImportingState(state, action);\n\n    case \"complete\":\n      return reduceCompleteState(state, action);\n\n    case \"error\":\n      return reduceErrorState(state, action);\n\n    default:\n      // TypeScript exhaustive check\n      return assertNever(state);\n  }\n}\n\n// ============================================================\n// STATE-SPECIFIC REDUCERS\n// ============================================================\n\n/**\n * Handles actions when in IDLE state.\n * Valid transitions: SELECT_FILE → file_selected\n */\nfunction reduceIdleState(state: WizardStateIdle, action: WizardAction): WizardState {\n  switch (action.type) {\n    case \"SELECT_FILE\":\n      return {\n        step: \"file_selected\",\n        file: action.payload.file,\n        validationErrors: action.payload.validationErrors,\n        validationWarnings: action.payload.validationWarnings,\n      };\n\n    default:\n      // Invalid action for this state - return unchanged\n      return state;\n  }\n}\n\n/**\n * Handles actions when in FILE_SELECTED state.\n * Valid transitions:\n * - START_PARSING → parsing\n * - CLEAR_FILE → idle\n * - SELECT_FILE → file_selected (replace file)\n */\nfunction reduceFileSelectedState(\n  state: WizardStateFileSelected,\n  action: WizardAction\n): WizardState {\n  switch (action.type) {\n    case \"START_PARSING\":\n      return {\n        step: \"parsing\",\n        file: state.file,\n      };\n\n    case \"CLEAR_FILE\":\n      return createInitialState();\n\n    case \"SELECT_FILE\":\n      // Allow replacing file\n      return {\n        step: \"file_selected\",\n        file: action.payload.file,\n        validationErrors: action.payload.validationErrors,\n        validationWarnings: action.payload.validationWarnings,\n      };\n\n    default:\n      return state;\n  }\n}\n\n/**\n * Handles actions when in PARSING state.\n * Valid transitions:\n * - PARSING_COMPLETE → preview\n * - PARSING_FAILED → error\n * - CANCEL → idle\n */\nfunction reduceParsingState(state: WizardStateParsing, action: WizardAction): WizardState {\n  switch (action.type) {\n    case \"PARSING_COMPLETE\":\n      return {\n        step: \"preview\",\n        file: state.file,\n        previewData: action.payload.previewData,\n        dataQualityDecisions: {\n          importOrganizationsWithoutContacts: false,\n          importContactsWithoutContactInfo: false,\n        },\n      };\n\n    case \"PARSING_FAILED\":\n      return {\n        step: \"error\",\n        error: action.payload.error,\n        previousStep: \"parsing\",\n      };\n\n    case \"CANCEL\":\n      return createInitialState();\n\n    default:\n      return state;\n  }\n}\n\n/**\n * Handles actions when in PREVIEW state.\n * Valid transitions:\n * - START_IMPORT → importing\n * - UPDATE_PREVIEW → preview (updated)\n * - UPDATE_DATA_QUALITY_DECISIONS → preview (updated)\n * - CANCEL → idle\n */\nfunction reducePreviewState(state: WizardStatePreview, action: WizardAction): WizardState {\n  switch (action.type) {\n    case \"START_IMPORT\":\n      return {\n        step: \"importing\",\n        file: state.file,\n        progress: {\n          count: 0,\n          total: action.payload.totalContacts,\n        },\n        accumulated: {\n          ...INITIAL_ACCUMULATED_RESULT,\n          startTime: new Date(),\n        },\n        rowOffset: 0,\n      };\n\n    case \"UPDATE_PREVIEW\":\n      return {\n        ...state,\n        previewData: action.payload.previewData,\n      };\n\n    case \"UPDATE_DATA_QUALITY_DECISIONS\":\n      return {\n        ...state,\n        dataQualityDecisions: action.payload.decisions,\n      };\n\n    case \"CANCEL\":\n      return createInitialState();\n\n    default:\n      return state;\n  }\n}\n\n/**\n * Handles actions when in IMPORTING state.\n * Valid transitions:\n * - UPDATE_PROGRESS → importing (updated)\n * - ACCUMULATE_RESULT → importing (updated)\n * - IMPORT_COMPLETE → complete\n * - IMPORT_FAILED → error\n * - CANCEL → idle\n */\nfunction reduceImportingState(state: WizardStateImporting, action: WizardAction): WizardState {\n  switch (action.type) {\n    case \"UPDATE_PROGRESS\":\n      return {\n        ...state,\n        progress: {\n          ...state.progress,\n          count: action.payload.count,\n        },\n      };\n\n    case \"ACCUMULATE_RESULT\": {\n      const { batchProcessed, batchSuccess, batchSkipped, batchFailed, batchErrors, batchSize } =\n        action.payload;\n\n      return {\n        ...state,\n        accumulated: {\n          ...state.accumulated,\n          totalProcessed: state.accumulated.totalProcessed + batchProcessed,\n          successCount: state.accumulated.successCount + batchSuccess,\n          skippedCount: state.accumulated.skippedCount + batchSkipped,\n          failedCount: state.accumulated.failedCount + batchFailed,\n          errors: [...state.accumulated.errors, ...batchErrors],\n        },\n        rowOffset: state.rowOffset + batchSize,\n      };\n    }\n\n    case \"IMPORT_COMPLETE\": {\n      const endTime = new Date();\n      const startTime = state.accumulated.startTime || endTime;\n      const duration = endTime.getTime() - startTime.getTime();\n\n      const result: ImportResult = {\n        totalProcessed: state.accumulated.totalProcessed,\n        successCount: state.accumulated.successCount,\n        skippedCount: state.accumulated.skippedCount,\n        failedCount: state.accumulated.failedCount,\n        errors: state.accumulated.errors,\n        duration,\n        startTime,\n        endTime,\n      };\n\n      return {\n        step: \"complete\",\n        result,\n      };\n    }\n\n    case \"IMPORT_FAILED\":\n      return {\n        step: \"error\",\n        error: action.payload.error,\n        previousStep: \"importing\",\n      };\n\n    case \"CANCEL\":\n      return createInitialState();\n\n    default:\n      return state;\n  }\n}\n\n/**\n * Handles actions when in COMPLETE state.\n * Valid transitions: (only RESET, handled globally)\n */\nfunction reduceCompleteState(state: WizardStateComplete, _action: WizardAction): WizardState {\n  // No valid transitions from complete except RESET (handled globally)\n  return state;\n}\n\n/**\n * Handles actions when in ERROR state.\n * Valid transitions: (only RESET, handled globally)\n */\nfunction reduceErrorState(state: WizardStateError, _action: WizardAction): WizardState {\n  // No valid transitions from error except RESET (handled globally)\n  return state;\n}\n\n// ============================================================\n// ACTION CREATORS\n// ============================================================\n\n/**\n * Creates type-safe action creators for wizard transitions.\n * These are memoized functions that create properly typed actions.\n */\nexport function createWizardActions(dispatch: React.Dispatch<WizardAction>) {\n  return {\n    /**\n     * Select a file for import.\n     */\n    selectFile: (\n      file: File,\n      validationErrors: CsvValidationError[] = [],\n      validationWarnings: string[] = []\n    ) => {\n      dispatch({\n        type: \"SELECT_FILE\",\n        payload: { file, validationErrors, validationWarnings },\n      });\n    },\n\n    /**\n     * Clear the selected file.\n     */\n    clearFile: () => {\n      dispatch({ type: \"CLEAR_FILE\" });\n    },\n\n    /**\n     * Start parsing the selected file.\n     */\n    startParsing: () => {\n      dispatch({ type: \"START_PARSING\" });\n    },\n\n    /**\n     * Mark parsing as complete with preview data.\n     */\n    parsingComplete: (previewData: PreviewData) => {\n      dispatch({ type: \"PARSING_COMPLETE\", payload: { previewData } });\n    },\n\n    /**\n     * Mark parsing as failed with error.\n     */\n    parsingFailed: (error: Error) => {\n      dispatch({ type: \"PARSING_FAILED\", payload: { error } });\n    },\n\n    /**\n     * Update preview data (e.g., when column mappings change).\n     */\n    updatePreview: (previewData: PreviewData) => {\n      dispatch({ type: \"UPDATE_PREVIEW\", payload: { previewData } });\n    },\n\n    /**\n     * Update data quality decisions.\n     */\n    updateDataQualityDecisions: (decisions: {\n      importOrganizationsWithoutContacts: boolean;\n      importContactsWithoutContactInfo: boolean;\n    }) => {\n      dispatch({ type: \"UPDATE_DATA_QUALITY_DECISIONS\", payload: { decisions } });\n    },\n\n    /**\n     * Start the import process.\n     */\n    startImport: (totalContacts: number) => {\n      dispatch({ type: \"START_IMPORT\", payload: { totalContacts } });\n    },\n\n    /**\n     * Update import progress.\n     */\n    updateProgress: (count: number) => {\n      dispatch({ type: \"UPDATE_PROGRESS\", payload: { count } });\n    },\n\n    /**\n     * Accumulate batch results.\n     */\n    accumulateResult: (payload: {\n      batchProcessed: number;\n      batchSuccess: number;\n      batchSkipped: number;\n      batchFailed: number;\n      batchErrors: Array<{\n        row: number;\n        data: unknown;\n        errors: Array<{ field: string; message: string }>;\n      }>;\n      batchSize: number;\n    }) => {\n      dispatch({ type: \"ACCUMULATE_RESULT\", payload });\n    },\n\n    /**\n     * Mark import as complete.\n     */\n    importComplete: () => {\n      dispatch({ type: \"IMPORT_COMPLETE\" });\n    },\n\n    /**\n     * Mark import as failed with error.\n     */\n    importFailed: (error: Error) => {\n      dispatch({ type: \"IMPORT_FAILED\", payload: { error } });\n    },\n\n    /**\n     * Cancel current operation.\n     */\n    cancel: () => {\n      dispatch({ type: \"CANCEL\" });\n    },\n\n    /**\n     * Reset wizard to initial state.\n     */\n    reset: () => {\n      dispatch({ type: \"RESET\" });\n    },\n  };\n}\n\n// ============================================================\n// HOOK IMPLEMENTATION\n// ============================================================\n\n/**\n * Hook for managing CSV import wizard state with AbortController support.\n *\n * Provides:\n * - `state`: Current wizard state (discriminated union)\n * - `actions`: Type-safe action creators with stable references\n * - `flags`: Derived boolean flags for UI conditions\n * - `abortSignal`: AbortSignal for cancelling async operations\n * - `isAborted`: Check if current operation was aborted\n *\n * @example\n * ```tsx\n * const { state, actions, flags, abortSignal, isAborted } = useImportWizard();\n *\n * // Access state based on step\n * if (state.step === \"preview\") {\n *   console.log(state.previewData.validCount);\n * }\n *\n * // Use derived flags\n * if (flags.showPreview) {\n *   return <PreviewDialog data={state.previewData} />;\n * }\n *\n * // Dispatch actions\n * actions.selectFile(file);\n * actions.startImport(contacts.length);\n *\n * // Check abort signal in async loops\n * for (const batch of batches) {\n *   if (isAborted()) break;\n *   await processBatch(batch, { signal: abortSignal });\n * }\n * ```\n */\nexport function useImportWizard() {\n  const [state, dispatch] = useReducer(importWizardReducer, undefined, createInitialState);\n\n  // AbortController for cancelling async operations\n  const abortControllerRef = useRef<AbortController | null>(null);\n\n  /**\n   * Creates a new AbortController for the current operation.\n   * Aborts any previous controller first.\n   */\n  const createAbortController = useCallback(() => {\n    // Abort any existing operation\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n    }\n    // Create fresh controller\n    abortControllerRef.current = new AbortController();\n    return abortControllerRef.current;\n  }, []);\n\n  /**\n   * Aborts the current operation and resets the controller.\n   */\n  const abortCurrentOperation = useCallback(() => {\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n      abortControllerRef.current = null;\n    }\n  }, []);\n\n  /**\n   * Check if the current operation was aborted.\n   * Returns stable function reference.\n   */\n  const isAborted = useCallback(() => {\n    return abortControllerRef.current?.signal.aborted ?? false;\n  }, []);\n\n  /**\n   * Get the current abort signal for passing to async operations.\n   * Returns null if no operation is active.\n   */\n  const getAbortSignal = useCallback(() => {\n    return abortControllerRef.current?.signal ?? null;\n  }, []);\n\n  // Cleanup on unmount\n  useEffect(() => {\n    return () => {\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort();\n        abortControllerRef.current = null;\n      }\n    };\n  }, []);\n\n  // Memoize actions with stable references using useCallback wrappers\n  const actions = useMemo(() => {\n    const baseActions = createWizardActions(dispatch);\n\n    return {\n      ...baseActions,\n\n      /**\n       * Start parsing - creates new AbortController.\n       * Override to manage abort lifecycle.\n       */\n      startParsing: () => {\n        createAbortController();\n        baseActions.startParsing();\n      },\n\n      /**\n       * Start import - creates new AbortController.\n       * Override to manage abort lifecycle.\n       */\n      startImport: (totalContacts: number) => {\n        createAbortController();\n        baseActions.startImport(totalContacts);\n      },\n\n      /**\n       * Cancel - aborts current operation and dispatches CANCEL.\n       * Override to abort async operations.\n       */\n      cancel: () => {\n        abortCurrentOperation();\n        baseActions.cancel();\n      },\n\n      /**\n       * Reset - aborts current operation and dispatches RESET.\n       * Override to abort async operations.\n       */\n      reset: () => {\n        abortCurrentOperation();\n        baseActions.reset();\n      },\n    };\n  }, [createAbortController, abortCurrentOperation]);\n\n  // Derive boolean flags from state\n  const flags = useMemo(() => deriveWizardFlags(state), [state]);\n\n  return {\n    state,\n    actions,\n    flags,\n    dispatch, // Expose raw dispatch for advanced use cases\n    // Abort controller utilities\n    abortSignal: getAbortSignal(),\n    isAborted,\n    getAbortSignal,\n  };\n}\n\n// ============================================================\n// TYPE EXPORTS\n// ============================================================\n\nexport type { WizardState, WizardAction, ImportProgress };\nexport type WizardActions = ReturnType<typeof createWizardActions>;\n","/**\n * Client-side rate limiting for import operations\n * Prevents bulk upload abuse and excessive database load\n *\n * Phase 1 Security Remediation - MEDIUM/HIGH\n *\n * Protects against:\n * - Accidental bulk data corruption (user imports wrong file 20 times)\n * - Compromised accounts (attacker abuses CSV imports)\n * - Database overload (too many concurrent large imports)\n *\n * @module rateLimiter\n */\n\ninterface RateLimitConfig {\n  maxRequests: number;\n  windowMs: number;\n  storageKey: string;\n}\n\ninterface RateLimitState {\n  requests: number[];\n  firstRequest: number;\n}\n\n/**\n * Client-side rate limiter using sessionStorage\n *\n * Limits number of operations within a time window.\n * Uses sessionStorage (cleared on tab close) for tracking.\n *\n * @example\n * const limiter = new ClientRateLimiter({\n *   maxRequests: 10,\n *   windowMs: 24 * 60 * 60 * 1000, // 24 hours\n *   storageKey: 'rate_limit_csv_import'\n * });\n *\n * if (!limiter.canProceed()) {\n *   alert(`Too many imports. Try again in ${limiter.getResetTimeFormatted()}`);\n *   return;\n * }\n */\nexport class ClientRateLimiter {\n  private config: RateLimitConfig;\n\n  constructor(config: RateLimitConfig) {\n    this.config = config;\n  }\n\n  /**\n   * Check if operation is allowed under rate limit\n   *\n   * @returns true if operation allowed, false if rate limit exceeded\n   */\n  canProceed(): boolean {\n    const state = this.getState();\n    const now = Date.now();\n\n    // Remove requests outside the window\n    const validRequests = state.requests.filter((time) => now - time < this.config.windowMs);\n\n    if (validRequests.length < this.config.maxRequests) {\n      // Allow operation, record timestamp\n      validRequests.push(now);\n      this.setState({\n        requests: validRequests,\n        firstRequest: validRequests[0],\n      });\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Get remaining requests in current window\n   *\n   * @returns Number of operations remaining before rate limit\n   */\n  getRemaining(): number {\n    const state = this.getState();\n    const now = Date.now();\n    const validRequests = state.requests.filter((time) => now - time < this.config.windowMs);\n    return Math.max(0, this.config.maxRequests - validRequests.length);\n  }\n\n  /**\n   * Get milliseconds until rate limit resets\n   *\n   * @returns Milliseconds until oldest request expires\n   */\n  getResetTime(): number {\n    const state = this.getState();\n    if (state.requests.length === 0) return 0;\n\n    const now = Date.now();\n    const oldestRequest = state.requests[0];\n    return Math.max(0, this.config.windowMs - (now - oldestRequest));\n  }\n\n  /**\n   * Get formatted reset time for display\n   *\n   * @returns Human-readable time until reset (e.g., \"5 minutes\", \"2 hours\")\n   */\n  getResetTimeFormatted(): string {\n    const ms = this.getResetTime();\n    if (ms === 0) return \"now\";\n\n    const minutes = Math.ceil(ms / 60000);\n    if (minutes < 60) return `${minutes} minute${minutes > 1 ? \"s\" : \"\"}`;\n\n    const hours = Math.ceil(minutes / 60);\n    return `${hours} hour${hours > 1 ? \"s\" : \"\"}`;\n  }\n\n  /**\n   * Clear rate limit state (for testing or admin override)\n   */\n  reset(): void {\n    sessionStorage.removeItem(this.config.storageKey);\n  }\n\n  /**\n   * Get current rate limit state from sessionStorage\n   */\n  private getState(): RateLimitState {\n    try {\n      const stored = sessionStorage.getItem(this.config.storageKey);\n      if (stored) {\n        return JSON.parse(stored);\n      }\n    } catch (e) {\n      console.warn(\"[Rate Limiter] Failed to load state:\", e);\n    }\n\n    return { requests: [], firstRequest: Date.now() };\n  }\n\n  /**\n   * Save rate limit state to sessionStorage\n   */\n  private setState(state: RateLimitState): void {\n    try {\n      sessionStorage.setItem(this.config.storageKey, JSON.stringify(state));\n    } catch (e) {\n      console.error(\"[Rate Limiter] Failed to save state:\", e);\n    }\n  }\n}\n\n// ============================================================================\n// Singleton Instances for Different Import Types\n// ============================================================================\n\n/**\n * Rate limiter for contact CSV imports\n * Limit: 10 imports per 24 hours\n */\nexport const contactImportLimiter = new ClientRateLimiter({\n  maxRequests: 10, // 10 imports per day\n  windowMs: 24 * 60 * 60 * 1000,\n  storageKey: \"rate_limit_contact_import\",\n});\n\n/**\n * Rate limiter for organization CSV imports\n * Limit: 10 imports per 24 hours\n */\nexport const organizationImportLimiter = new ClientRateLimiter({\n  maxRequests: 10,\n  windowMs: 24 * 60 * 60 * 1000,\n  storageKey: \"rate_limit_organization_import\",\n});\n","import * as React from \"react\";\nimport type { HTMLAttributes } from \"react\";\nimport {\n  Children,\n  isValidElement,\n  type ComponentType,\n  type ReactElement,\n  type ReactNode,\n  useEffect,\n} from \"react\";\nimport type { InputProps } from \"ra-core\";\nimport { FieldTitle, RecordContextProvider, shallowEqual, useInput, useTranslate } from \"ra-core\";\nimport type { FileRejection, DropEvent, DropzoneInputProps } from \"react-dropzone\";\nimport { useDropzone, type DropzoneOptions } from \"react-dropzone\";\nimport { XCircle } from \"lucide-react\";\n\nimport { cn } from \"@/lib/utils\";\nimport { FormError, FormField, FormLabel } from \"@/components/admin/form\";\nimport { InputHelperText } from \"@/components/admin/input-helper-text\";\nimport { Button } from \"@/components/ui/button\";\nimport { sanitizeInputRestProps } from \"@/lib/sanitizeInputRestProps\";\n\n/** Default max file size: 5MB - prevents DoS attacks */\nconst DEFAULT_MAX_FILE_SIZE = 5 * 1024 * 1024;\n\nexport const FileInput = (props: FileInputProps) => {\n  const {\n    alwaysOn,\n    defaultValue,\n    format,\n    label,\n    helperText,\n    name: nameProp,\n    onBlur: onBlurProp,\n    onChange: onChangeProp,\n    parse,\n    resource,\n    source,\n    validate,\n    readOnly,\n    disabled,\n\n    accept,\n    maxSize,\n    minSize,\n    multiple = false,\n    options = {},\n\n    children,\n    className,\n    inputProps: inputPropsOptions,\n\n    onRemove: onRemoveProp,\n    validateFileRemoval,\n\n    placeholder,\n    labelMultiple = \"ra.input.file.upload_several\",\n    labelSingle = \"ra.input.file.upload_single\",\n    removeIcon,\n    ...rest\n  } = props;\n  const { onDrop: onDropProp } = options;\n  const translate = useTranslate();\n\n  // turn a browser dropped file structure into expected structure\n  const transformFile = (file: unknown) => {\n    if (!(file instanceof File)) {\n      return file;\n    }\n\n    const preview = URL.createObjectURL(file);\n    const transformedFile: TransformedFile = {\n      rawFile: file,\n      src: preview,\n      title: file.name,\n    };\n\n    return transformedFile;\n  };\n\n  const transformFiles = (files: unknown[]) => {\n    if (!files) {\n      return multiple ? [] : null;\n    }\n\n    if (Array.isArray(files)) {\n      return files.map(transformFile);\n    }\n\n    return transformFile(files);\n  };\n\n  const {\n    id,\n    field: { onChange, onBlur, value, name },\n    isRequired,\n  } = useInput({\n    alwaysOn,\n    defaultValue,\n    format: format || transformFiles,\n    label,\n    helperText,\n    name: nameProp,\n    onBlur: onBlurProp,\n    onChange: onChangeProp,\n    parse: parse || transformFiles,\n    resource,\n    source,\n    validate,\n    readOnly,\n    disabled,\n  });\n  const files = value ? (Array.isArray(value) ? value : [value]) : [];\n\n  const onDrop = (newFiles: any[], rejectedFiles: FileRejection[], event: DropEvent) => {\n    const updatedFiles = multiple ? [...files, ...newFiles] : [...newFiles];\n\n    if (multiple) {\n      onChange(updatedFiles);\n      onBlur();\n    } else {\n      onChange(updatedFiles[0]);\n      onBlur();\n    }\n\n    if (onDropProp) {\n      onDropProp(newFiles, rejectedFiles, event);\n    }\n  };\n\n  const onRemove = (file: any) => async () => {\n    if (validateFileRemoval) {\n      try {\n        await validateFileRemoval(file);\n      } catch {\n        return;\n      }\n    }\n\n    if (multiple) {\n      const filteredFiles = files.filter((stateFile) => !shallowEqual(stateFile, file));\n      onChange(filteredFiles);\n      onBlur();\n    } else {\n      onChange(null);\n      onBlur();\n    }\n\n    if (onRemoveProp) {\n      onRemoveProp(file);\n    }\n  };\n\n  const childrenElement =\n    children && isValidElement(Children.only(children))\n      ? (Children.only(children) as ReactElement)\n      : undefined;\n\n  const { getRootProps, getInputProps, fileRejections } = useDropzone({\n    accept,\n    maxSize: maxSize ?? DEFAULT_MAX_FILE_SIZE,\n    minSize,\n    multiple,\n    disabled: disabled || readOnly,\n    // Filename validation for security\n    validator: (file) => {\n      if (file.name.length > 255) {\n        return { code: \"name-too-long\", message: \"Filename exceeds 255 characters\" };\n      }\n      if (/[<>:\"/\\\\|?*]/.test(file.name)) {\n        return { code: \"invalid-chars\", message: \"Filename contains invalid characters\" };\n      }\n      return null;\n    },\n    ...options,\n    onDrop,\n  });\n\n  return (\n    <FormField\n      id={id}\n      name={name}\n      className={cn(\"w-full\", className)}\n      {...sanitizeInputRestProps(rest)}\n    >\n      <FormLabel\n        htmlFor={id}\n        className={disabled || readOnly ? \"cursor-default\" : \"cursor-pointer\"}\n      >\n        <FieldTitle label={label} source={source} resource={resource} isRequired={isRequired} />\n      </FormLabel>\n\n      <div\n        {...getRootProps({\n          className: cn(\n            \"border-2 border-dashed border-muted rounded-lg p-6 text-center transition-colors\",\n            \"hover:border-sidebar-ring focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n            disabled || readOnly\n              ? \"bg-muted cursor-not-allowed\"\n              : \"bg-muted text-muted-foreground cursor-pointer\"\n          ),\n          role: \"button\",\n          \"aria-label\": multiple ? translate(labelMultiple) : translate(labelSingle),\n          tabIndex: disabled || readOnly ? -1 : 0,\n        })}\n      >\n        <input\n          id={id}\n          name={name}\n          {...getInputProps({\n            ...inputPropsOptions,\n          })}\n        />\n\n        {placeholder ? (\n          placeholder\n        ) : multiple ? (\n          <p className=\"text-sm\">{translate(labelMultiple)}</p>\n        ) : (\n          <p className=\"text-sm\">{translate(labelSingle)}</p>\n        )}\n      </div>\n\n      {fileRejections.length > 0 && (\n        <ul\n          role=\"alert\"\n          aria-live=\"polite\"\n          className=\"text-sm text-destructive mt-2 list-disc pl-5\"\n        >\n          {fileRejections.map(({ file, errors }) => (\n            <li key={file.name}>\n              {file.name}: {errors.map((e) => e.message).join(\", \")}\n            </li>\n          ))}\n        </ul>\n      )}\n\n      <InputHelperText helperText={helperText} />\n      <FormError />\n\n      {children && (\n        <div className=\"previews flex flex-col gap-1\">\n          {files.map((file: any, index: number) => (\n            <FileInputPreview\n              key={index}\n              file={file}\n              onRemove={onRemove(file)}\n              removeIcon={removeIcon}\n            >\n              <RecordContextProvider value={file}>{childrenElement}</RecordContextProvider>\n            </FileInputPreview>\n          ))}\n        </div>\n      )}\n    </FormField>\n  );\n};\n\nexport type FileInputProps = Omit<InputProps, \"type\"> & {\n  accept?: DropzoneOptions[\"accept\"];\n  className?: string;\n  children?: ReactNode;\n  labelMultiple?: string;\n  labelSingle?: string;\n  maxSize?: DropzoneOptions[\"maxSize\"];\n  minSize?: DropzoneOptions[\"minSize\"];\n  multiple?: DropzoneOptions[\"multiple\"];\n  options?: DropzoneOptions;\n\n  onRemove?: (file: any) => void;\n  placeholder?: ReactNode;\n  removeIcon?: ComponentType<{ className?: string }>;\n  inputProps?: DropzoneInputProps & React.ComponentProps<\"input\">;\n\n  validateFileRemoval?(file: any): boolean | Promise<boolean>;\n};\n\nexport interface TransformedFile {\n  rawFile: File;\n  src: string;\n  title: string;\n}\n\nexport const FileInputPreview = (props: FileInputPreviewProps) => {\n  const {\n    className,\n    children,\n\n    file,\n    onRemove,\n    removeIcon: RemoveIcon = XCircle,\n\n    ...rest\n  } = props;\n\n  const translate = useTranslate();\n\n  useEffect(() => {\n    return () => {\n      const preview = file.rawFile ? file.rawFile.preview : file.preview;\n\n      if (preview) {\n        window.URL.revokeObjectURL(preview);\n      }\n    };\n  }, [file]);\n\n  return (\n    <div className={cn(\"flex flex-row gap-1\", className)} {...rest}>\n      <Button\n        variant=\"ghost\"\n        size=\"icon\"\n        className=\"h-11 w-11 rounded-full shadow-sm cursor-pointer\"\n        onClick={onRemove}\n        aria-label={translate(\"ra.action.delete\")}\n        title={translate(\"ra.action.delete\")}\n      >\n        <RemoveIcon className=\"h-4 w-4\" />\n      </Button>\n      {children}\n    </div>\n  );\n};\n\nexport interface FileInputPreviewProps extends HTMLAttributes<HTMLDivElement> {\n  file: any;\n  onRemove: () => void;\n  removeIcon?: React.ComponentType<{ className?: string }>;\n}\n","import type { HTMLAttributes } from \"react\";\n// es-toolkit: Deep property access with dynamic paths (lodash-compatible)\nimport { get } from \"es-toolkit/compat\";\nimport { type ExtractRecordPaths, type HintedString, useFieldValue, useTranslate } from \"ra-core\";\nimport { cn } from \"@/lib/utils\";\nimport type { FieldProps } from \"@/lib/field.type\";\n\n/**\n * Render a link to a file based on a path contained in a record field\n *\n * @example\n * import { FileField } from '@/components/admin/file-field';\n *\n * <FileField source=\"url\" title=\"title\" />\n *\n * // renders the record { id: 123, url: 'doc.pdf', title: 'Presentation' } as\n * <div>\n *     <a href=\"doc.pdf\" title=\"Presentation\">Presentation</a>\n * </div>\n */\nexport const FileField = <RecordType extends Record<string, any> = Record<string, any>>(\n  props: FileFieldProps<RecordType>\n) => {\n  const {\n    className,\n    empty,\n    title,\n    src,\n    target,\n    download,\n    defaultValue,\n    source,\n    record,\n    // Filter out React Admin-specific props that shouldn't be passed to DOM elements\n    label: _label,\n    sortable: _sortable,\n    sortBy: _sortBy,\n    textAlign: _textAlign,\n    rowClassName: _rowClassName,\n    cellClassName: _cellClassName,\n    headerClassName: _headerClassName,\n    resource: _resource,\n    ...rest\n  } = props;\n  const sourceValue = useFieldValue({ defaultValue, source, record });\n  const titleValue =\n    useFieldValue({\n      ...props,\n      // @ts-expect-error We ignore here because title might be a custom label or undefined instead of a field name\n      source: title,\n    })?.toString() ?? title;\n  const translate = useTranslate();\n\n  if (sourceValue == null || (Array.isArray(sourceValue) && sourceValue.length === 0)) {\n    if (!empty) {\n      return null;\n    }\n\n    return (\n      <div className={cn(\"inline-block\", className)} {...rest}>\n        {typeof empty === \"string\" ? translate(empty, { _: empty }) : empty}\n      </div>\n    );\n  }\n\n  if (Array.isArray(sourceValue)) {\n    return (\n      <ul className={cn(\"inline-block\", className)} {...rest}>\n        {sourceValue.map((file, index) => {\n          const fileTitleValue = title ? get(file, title, title) : title;\n          const srcValue = src ? get(file, src, title) : title;\n\n          return (\n            <li key={index}>\n              <a\n                href={srcValue}\n                title={fileTitleValue}\n                target={target}\n                download={download}\n                // useful to prevent click bubbling in a DataTable with rowClick\n                onClick={(e) => e.stopPropagation()}\n              >\n                {fileTitleValue}\n              </a>\n            </li>\n          );\n        })}\n      </ul>\n    );\n  }\n\n  return (\n    <div className={cn(\"inline-block\", className)} {...rest}>\n      <a\n        href={sourceValue?.toString()}\n        title={titleValue}\n        target={target}\n        download={download}\n        // useful to prevent click bubbling in a DataTable with rowClick\n        onClick={(e) => e.stopPropagation()}\n      >\n        {titleValue}\n      </a>\n    </div>\n  );\n};\n\nexport interface FileFieldProps<RecordType extends Record<string, any> = Record<string, any>>\n  extends FieldProps<RecordType>,\n    HTMLAttributes<HTMLElement> {\n  /**\n   * The source of the link to the file, for an array of files.\n   */\n  src?: string;\n  title?: HintedString<ExtractRecordPaths<RecordType>>;\n  target?: HTMLAnchorElement[\"target\"];\n  download?: HTMLAnchorElement[\"download\"];\n}\n","import { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Loader2 } from \"lucide-react\";\nimport { Form, useRefresh } from \"ra-core\";\nimport { Link } from \"react-router-dom\";\nimport { usePapaParse } from \"./usePapaParse\";\nimport type { ContactImportSchema } from \"./useContactImport\";\nimport { useContactImport } from \"./useContactImport\";\nimport type { PreviewData, DataQualityDecisions } from \"./ContactImportPreview\";\nimport { ContactImportPreview } from \"./ContactImportPreview\";\nimport { ContactImportResult } from \"./ContactImportResult\";\nimport {\n  extractNewOrganizations,\n  extractNewTags,\n  findOrganizationsWithoutContacts,\n  findContactsWithoutContactInfo,\n} from \"./contactImport.helpers\";\nimport { findCanonicalField, isFullNameColumn } from \"./columnAliases\";\nimport { useColumnMapping } from \"./useColumnMapping\";\nimport { useImportWizard } from \"./useImportWizard\";\nimport { assertNever } from \"./useImportWizard.types\";\nimport { FULL_NAME_SPLIT_MARKER } from \"./csvConstants\";\nimport { validateCsvFile, getSecurePapaParseConfig } from \"../utils/csvUploadValidator\";\nimport { contactImportLimiter } from \"../utils/rateLimiter\";\n\nimport { FileInput } from \"@/components/admin/file-input\";\nimport { FileField } from \"@/components/admin/file-field\";\nimport * as React from \"react\";\nimport { useCallback, useMemo } from \"react\";\nimport * as sampleCsv from \"./contacts_export.csv?raw\";\n\n// Feature flag for enhanced import preview\nconst ENABLE_IMPORT_PREVIEW = true;\n\nconst SAMPLE_URL = `data:text/csv;name=crm_contacts_sample.csv;charset=utf-8,${encodeURIComponent(\n  sampleCsv.default\n)}`;\n\ninterface ContactImportModalProps {\n  open: boolean;\n  onClose(): void;\n}\n\nexport function ContactImportDialog({ open, onClose }: ContactImportModalProps) {\n  const refresh = useRefresh();\n  const processBatchHook = useContactImport();\n\n  // ============================================================\n  // STATE MACHINE - Replaces 10 useState calls + 2 refs\n  // AbortController support for cancelling async operations\n  // ============================================================\n  const { state: wizardState, actions: wizardActions, isAborted } = useImportWizard();\n\n  // ============================================================\n  // COLUMN MAPPING - Extracted hook for reusability\n  // ============================================================\n  const {\n    mappings: mergedMappings,\n    overrides: userOverrides,\n    contacts: reprocessedContacts,\n    headers: rawHeaders,\n    setOverride: handleMappingChange,\n    setRawData,\n    reset: resetColumnMapping,\n    hasData: hasColumnData,\n  } = useColumnMapping();\n\n  // ============================================================\n  // PREVIEW CALLBACK - Triggered when PapaParse completes\n  // ============================================================\n  const onPreview = useCallback(\n    (data: { rows: ContactImportSchema[]; headers: string[]; rawDataRows?: any[][] }) => {\n      if (!ENABLE_IMPORT_PREVIEW) return;\n\n      const { rows, headers, rawDataRows: dataRows } = data;\n\n      // Delegate raw data storage to column mapping hook\n      if (dataRows) {\n        setRawData(headers, dataRows);\n      }\n\n      // Run data quality analysis\n      const organizationsWithoutContacts = findOrganizationsWithoutContacts(rows);\n      const contactsWithoutContactInfo = findContactsWithoutContactInfo(rows);\n\n      // Generate initial preview data with auto-detected mappings\n      const mappings = headers.map((header, index) => {\n        const canonicalField = findCanonicalField(header);\n        const isFullName = isFullNameColumn(header);\n        const target =\n          canonicalField || (isFullName ? \"first_name + last_name (will be split)\" : null);\n\n        // Calculate confidence: 1.0 for exact matches, 0.9 for full name patterns, 0 for no match\n        let confidence = 0;\n        if (canonicalField) confidence = 1.0;\n        else if (isFullName) confidence = 0.9;\n\n        // Get sample value from first row if available\n        const sampleValue = dataRows?.[0]?.[index]\n          ? String(dataRows[0][index]).substring(0, 50)\n          : undefined;\n\n        return {\n          source: header || \"(empty)\",\n          target,\n          confidence,\n          sampleValue,\n        };\n      });\n\n      const preview: PreviewData = {\n        mappings,\n        sampleRows: rows.slice(0, 5),\n        validCount: rows.length,\n        skipCount: 0,\n        totalRows: rows.length,\n        errors: [],\n        warnings: [],\n        newOrganizations: extractNewOrganizations(rows),\n        newTags: extractNewTags(rows),\n        hasErrors: false,\n        lowConfidenceMappings: mappings.filter((m) => m.confidence > 0 && m.confidence < 0.8)\n          .length,\n        organizationsWithoutContacts,\n        contactsWithoutContactInfo,\n      };\n\n      // Transition wizard to preview state\n      wizardActions.parsingComplete(preview);\n    },\n    [setRawData, wizardActions]\n  );\n\n  // ============================================================\n  // DERIVED PREVIEW DATA - Updates when column mappings change\n  // ============================================================\n  const derivedPreviewData = useMemo<PreviewData | null>(() => {\n    // Only compute when in preview state with column data\n    if (wizardState.step !== \"preview\" || !hasColumnData) {\n      return wizardState.step === \"preview\" ? wizardState.previewData : null;\n    }\n\n    // Re-run data quality analysis on the latest reprocessed data\n    const organizationsWithoutContacts = findOrganizationsWithoutContacts(reprocessedContacts);\n    const contactsWithoutContactInfo = findContactsWithoutContactInfo(reprocessedContacts);\n\n    // Generate updated mappings for UI display\n    const updatedMappings = rawHeaders.map((header) => {\n      const target = mergedMappings[header];\n\n      // Calculate confidence: 1.0 for user override or auto-match, 0.9 for full name\n      let confidence = 0;\n      if (userOverrides.has(header)) {\n        confidence = 1.0; // User override always high confidence\n      } else if (target === FULL_NAME_SPLIT_MARKER) {\n        confidence = 0.9;\n      } else if (target) {\n        confidence = 1.0; // Auto-detected match\n      }\n\n      // Get sample value from first reprocessed row\n      const firstContact = reprocessedContacts[0];\n      let sampleValue: string | undefined;\n      if (firstContact) {\n        // For full name splits, show the combined first + last\n        if (\n          target === FULL_NAME_SPLIT_MARKER ||\n          target === \"first_name + last_name (will be split)\"\n        ) {\n          const first = firstContact[\"first_name\"] || \"\";\n          const last = firstContact[\"last_name\"] || \"\";\n          sampleValue = [first, last].filter(Boolean).join(\" \").substring(0, 50);\n        } else if (target && firstContact[target]) {\n          sampleValue = String(firstContact[target]).substring(0, 50);\n        }\n      }\n\n      return {\n        source: header || \"(empty)\",\n        target:\n          target === FULL_NAME_SPLIT_MARKER ? \"first_name + last_name (will be split)\" : target,\n        confidence,\n        sampleValue,\n      };\n    });\n\n    // Detect conflicting mappings (full name split + explicit first/last name)\n    const warnings: PreviewData[\"warnings\"] = [];\n    const targetValues = Object.values(mergedMappings);\n    const hasFullNameSplit = targetValues.includes(FULL_NAME_SPLIT_MARKER);\n    const hasExplicitFirstName = targetValues.includes(\"first_name\");\n    const hasExplicitLastName = targetValues.includes(\"last_name\");\n\n    if (hasFullNameSplit && hasExplicitFirstName) {\n      warnings.push({\n        row: 0,\n        message:\n          \"A column is mapped to 'Full Name (split)' and another to 'First Name'. The explicit 'First Name' column will take precedence.\",\n      });\n    }\n    if (hasFullNameSplit && hasExplicitLastName) {\n      warnings.push({\n        row: 0,\n        message:\n          \"A column is mapped to 'Full Name (split)' and another to 'Last Name'. The explicit 'Last Name' column will take precedence.\",\n      });\n    }\n\n    return {\n      mappings: updatedMappings,\n      sampleRows: reprocessedContacts.slice(0, 5),\n      validCount: reprocessedContacts.length,\n      skipCount: 0,\n      totalRows: reprocessedContacts.length,\n      errors: [],\n      warnings,\n      newOrganizations: extractNewOrganizations(reprocessedContacts),\n      newTags: extractNewTags(reprocessedContacts),\n      hasErrors: false,\n      lowConfidenceMappings: updatedMappings.filter((m) => m.confidence > 0 && m.confidence < 0.8)\n        .length,\n      organizationsWithoutContacts,\n      contactsWithoutContactInfo,\n    };\n  }, [reprocessedContacts, mergedMappings, rawHeaders, hasColumnData, userOverrides, wizardState]);\n\n  // ============================================================\n  // PAPAPARSE HOOK - For CSV parsing\n  // ============================================================\n  const {\n    importer: previewImporter,\n    parseCsv,\n    reset: resetPreviewImporter,\n  } = usePapaParse<ContactImportSchema>({\n    onPreview: onPreview,\n    previewRowCount: 100,\n    papaConfig: getSecurePapaParseConfig(),\n  });\n\n  // ============================================================\n  // IMPORT HANDLERS\n  // ============================================================\n\n  /**\n   * Process a single batch of contacts during import.\n   * Updates wizard state with accumulated results.\n   */\n  const processBatch = useCallback(\n    async (batch: ContactImportSchema[], dataQualityDecisions: DataQualityDecisions) => {\n      if (wizardState.step !== \"importing\") return;\n\n      try {\n        const result = await processBatchHook(batch, {\n          preview: false,\n          startingRow: wizardState.rowOffset + 1,\n          dataQualityDecisions,\n          onProgress: () => {\n            // Progress is updated at batch level, not per-contact\n          },\n        });\n\n        // Accumulate results in wizard state\n        wizardActions.accumulateResult({\n          batchProcessed: result.totalProcessed,\n          batchSuccess: result.successCount,\n          batchSkipped: result.skippedCount,\n          batchFailed: result.failedCount,\n          batchErrors: result.errors,\n          batchSize: batch.length,\n        });\n      } catch (error: any) {\n        const errorMessage = error.message || \"A critical error occurred during batch processing.\";\n        const batchStartRow = wizardState.rowOffset + 1;\n\n        // Add an error entry for each contact in the failed batch\n        const batchErrors = batch.map((contactData, index) => ({\n          row: batchStartRow + index,\n          data: contactData,\n          errors: [{ field: \"batch_processing\", message: errorMessage }],\n        }));\n\n        wizardActions.accumulateResult({\n          batchProcessed: batch.length,\n          batchSuccess: 0,\n          batchSkipped: 0,\n          batchFailed: batch.length,\n          batchErrors,\n          batchSize: batch.length,\n        });\n      }\n    },\n    [processBatchHook, wizardState, wizardActions]\n  );\n\n  /**\n   * Handle preview confirmation - start the actual import.\n   */\n  const handlePreviewContinue = useCallback(\n    async (decisions: DataQualityDecisions) => {\n      // SECURITY: Check rate limit before starting import\n      if (!contactImportLimiter.canProceed()) {\n        const resetTime = contactImportLimiter.getResetTimeFormatted();\n        const remaining = contactImportLimiter.getRemaining();\n        alert(\n          `Import rate limit exceeded.\\n\\n` +\n            `You have ${remaining} imports remaining.\\n` +\n            `Rate limit resets in ${resetTime}.\\n\\n` +\n            `This limit prevents accidental bulk data corruption and protects database performance.`\n        );\n        return;\n      }\n\n      // Update data quality decisions in wizard state\n      wizardActions.updateDataQualityDecisions(decisions);\n\n      // Transition to importing state\n      wizardActions.startImport(reprocessedContacts.length);\n\n      // Process contacts in batches with abort support\n      const batchSize = 10;\n      for (let i = 0; i < reprocessedContacts.length; i += batchSize) {\n        // Check if operation was cancelled\n        if (isAborted()) {\n          // Don't mark as complete - user cancelled\n          return;\n        }\n\n        const batch = reprocessedContacts.slice(i, i + batchSize);\n        await processBatch(batch, decisions);\n        wizardActions.updateProgress(i + batch.length);\n      }\n\n      // Check abort one final time before marking complete\n      if (isAborted()) {\n        return;\n      }\n\n      // Mark import as complete\n      wizardActions.importComplete();\n      refresh();\n    },\n    [reprocessedContacts, processBatch, refresh, wizardActions, isAborted]\n  );\n\n  /**\n   * Handle file selection with validation.\n   */\n  const handleFileChange = useCallback(\n    async (file: File | null) => {\n      if (!file) {\n        wizardActions.reset();\n        return;\n      }\n\n      // SECURITY: Validate file before processing\n      const validation = await validateCsvFile(file);\n\n      if (!validation.valid && validation.errors) {\n        wizardActions.selectFile(file, validation.errors, []);\n        return;\n      }\n\n      // File is valid - store with any warnings\n      wizardActions.selectFile(file, [], validation.warnings || []);\n    },\n    [wizardActions]\n  );\n\n  /**\n   * Start the import/preview process.\n   */\n  const startImport = useCallback(() => {\n    if (wizardState.step !== \"file_selected\") return;\n\n    // Transition to parsing state\n    wizardActions.startParsing();\n\n    // Start parsing with PapaParse\n    parseCsv(wizardState.file);\n  }, [wizardState, wizardActions, parseCsv]);\n\n  /**\n   * Handle preview cancellation.\n   */\n  const handlePreviewCancel = useCallback(() => {\n    wizardActions.cancel();\n    resetPreviewImporter();\n    resetColumnMapping();\n  }, [wizardActions, resetPreviewImporter, resetColumnMapping]);\n\n  /**\n   * Handle dialog close - reset all state.\n   */\n  const handleClose = useCallback(() => {\n    resetPreviewImporter();\n    resetColumnMapping();\n    wizardActions.reset();\n    onClose();\n  }, [resetPreviewImporter, resetColumnMapping, wizardActions, onClose]);\n\n  /**\n   * Handle cancel/reset during import.\n   */\n  const handleReset = useCallback(\n    (e: React.MouseEvent<HTMLButtonElement>) => {\n      e.preventDefault();\n      handleClose();\n    },\n    [handleClose]\n  );\n\n  // ============================================================\n  // STEP-BASED RENDER FUNCTIONS\n  // ============================================================\n\n  /**\n   * Renders the file selection UI (idle and file_selected states).\n   * Shows download sample, file input, and validation messages.\n   */\n  const renderFileSelectionStep = () => {\n    const validationErrors =\n      wizardState.step === \"file_selected\" ? wizardState.validationErrors : [];\n    const validationWarnings =\n      wizardState.step === \"file_selected\" ? wizardState.validationWarnings : [];\n    const selectedFile = wizardState.step === \"file_selected\" ? wizardState.file : null;\n    const isParsing = wizardState.step === \"parsing\" || previewImporter.state === \"parsing\";\n\n    return (\n      <>\n        <Alert>\n          <AlertDescription className=\"flex flex-col gap-4\">\n            Here is a sample CSV file you can use as a template\n            <Button asChild variant=\"outline\" size=\"sm\">\n              <Link to={SAMPLE_URL} download={\"crm_contacts_sample.csv\"}>\n                Download CSV sample\n              </Link>\n            </Button>\n          </AlertDescription>\n        </Alert>\n\n        <FileInput\n          source=\"csv\"\n          label=\"CSV File\"\n          accept={{ \"text/csv\": [\".csv\"] }}\n          onChange={handleFileChange}\n        >\n          <FileField source=\"src\" title=\"title\" target=\"_blank\" />\n        </FileInput>\n\n        {/* SECURITY: Display validation errors */}\n        {validationErrors.length > 0 && (\n          <Alert variant=\"destructive\">\n            <AlertDescription>\n              <div className=\"font-semibold mb-2\">File validation failed:</div>\n              <ul className=\"list-disc pl-5 space-y-1\">\n                {validationErrors.map((error, idx) => (\n                  <li key={idx}>{error.message}</li>\n                ))}\n              </ul>\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {/* Display non-blocking warnings */}\n        {validationWarnings.length > 0 && (\n          <Alert>\n            <AlertDescription>\n              <div className=\"font-semibold mb-2\">Warnings:</div>\n              <ul className=\"list-disc pl-5 space-y-1\">\n                {validationWarnings.map((warning, idx) => (\n                  <li key={idx}>{warning}</li>\n                ))}\n              </ul>\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {/* Action Button */}\n        <div className=\"flex justify-start pt-6 gap-2\">\n          <Button\n            onClick={startImport}\n            disabled={!selectedFile || isParsing || validationErrors.length > 0}\n          >\n            {isParsing ? <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> : null}\n            Import\n          </Button>\n        </div>\n      </>\n    );\n  };\n\n  /**\n   * Renders the parsing state with loading indicator.\n   */\n  const renderParsingStep = () => (\n    <div className=\"flex flex-col items-center justify-center py-8 space-y-4\">\n      <Loader2 className=\"h-11 w-11 animate-spin text-primary\" />\n      <p className=\"text-muted-foreground\">Parsing CSV file...</p>\n      <Button variant=\"ghost\" onClick={handleClose}>\n        Cancel\n      </Button>\n    </div>\n  );\n\n  /**\n   * Renders the importing state with progress tracking.\n   * Shows real-time progress bar, statistics, and cancel button.\n   */\n  const renderImportingStep = () => {\n    if (wizardState.step !== \"importing\") return null;\n\n    const { progress, accumulated } = wizardState;\n    const progressPercent = progress.total > 0 ? (progress.count / progress.total) * 100 : 0;\n\n    return (\n      <Card className=\"border-primary/20\">\n        <CardContent className=\"pt-6 space-y-4\">\n          {/* Progress Header */}\n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex items-center gap-2\">\n              <Loader2 className=\"h-5 w-5 animate-spin text-primary\" />\n              <span className=\"font-medium\">Processing CSV Import</span>\n            </div>\n            <div className=\"ml-auto\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleReset}\n                className=\"h-11 px-4 text-destructive hover:text-destructive hover:bg-destructive/10\"\n              >\n                Cancel Import\n              </Button>\n            </div>\n          </div>\n\n          {/* Progress Bar */}\n          <div className=\"space-y-2\">\n            <Progress value={progressPercent} className=\"h-3\" />\n            <div className=\"flex justify-between text-sm text-muted-foreground\">\n              <span>\n                Processing {progress.count} of {progress.total} contacts\n              </span>\n              <span>{Math.round(progressPercent)}% Complete</span>\n            </div>\n          </div>\n\n          {/* Statistics */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-4 pt-2\">\n            <div className=\"space-y-1\">\n              <p className=\"text-sm font-medium\">Processed</p>\n              <p className=\"text-2xl font-bold text-primary\">{progress.count}</p>\n              <p className=\"text-xs text-muted-foreground\">of {progress.total} contacts</p>\n            </div>\n\n            <div className=\"space-y-1\">\n              <p className=\"text-sm font-medium\">Errors</p>\n              <p className=\"text-2xl font-bold text-destructive\">{accumulated.errors.length}</p>\n              <p className=\"text-xs text-muted-foreground\">failed imports</p>\n            </div>\n\n            <div className=\"space-y-1\">\n              <p className=\"text-sm font-medium\">Success</p>\n              <p className=\"text-2xl font-bold text-success\">{accumulated.successCount}</p>\n              <p className=\"text-xs text-muted-foreground\">imported</p>\n            </div>\n          </div>\n\n          {/* Warning Message */}\n          <Alert className=\"border-warning/50 bg-warning/10\">\n            <AlertDescription className=\"text-sm\">\n              Please keep this tab open until the import completes\n            </AlertDescription>\n          </Alert>\n        </CardContent>\n      </Card>\n    );\n  };\n\n  /**\n   * Renders the error state with error message and retry option.\n   */\n  const renderErrorStep = () => (\n    <>\n      <Alert variant=\"destructive\">\n        <AlertDescription>\n          Failed to import this file, please make sure your provided a valid CSV file.\n        </AlertDescription>\n      </Alert>\n      <div className=\"flex justify-start pt-6 gap-2\">\n        <Button variant=\"outline\" onClick={handleClose}>\n          Close\n        </Button>\n      </div>\n    </>\n  );\n\n  /**\n   * Renders the main dialog content based on current wizard step.\n   * Uses explicit switch pattern with exhaustive type checking.\n   * TypeScript will error at compile time if any step is unhandled.\n   */\n  const renderMainDialogContent = (): React.ReactNode => {\n    switch (wizardState.step) {\n      case \"idle\":\n      case \"file_selected\":\n        return renderFileSelectionStep();\n\n      case \"parsing\":\n        return renderParsingStep();\n\n      case \"importing\":\n        return renderImportingStep();\n\n      case \"error\":\n        return renderErrorStep();\n\n      case \"preview\":\n      case \"complete\":\n        // These states use separate dialogs, show nothing in main dialog\n        return null;\n\n      default:\n        // TypeScript exhaustive check - compiler will error if any case is missing\n        return assertNever(wizardState);\n    }\n  };\n\n  // ============================================================\n  // MAIN RENDER\n  // ============================================================\n\n  // Determine which dialog should be visible\n  const showMainDialog = open && wizardState.step !== \"preview\" && wizardState.step !== \"complete\";\n  const showPreviewDialog = open && wizardState.step === \"preview\" && derivedPreviewData;\n  const showResultDialog = open && wizardState.step === \"complete\";\n\n  return (\n    <>\n      {/* Main Import Dialog - File Selection, Parsing, Importing, Error */}\n      <Dialog open={showMainDialog} onOpenChange={handleClose}>\n        <DialogContent className=\"max-w-2xl\">\n          <Form className=\"flex flex-col gap-4\">\n            <DialogHeader>\n              <DialogTitle>Import Contacts</DialogTitle>\n              <DialogDescription>\n                Upload a CSV file to import contacts into your CRM.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"flex flex-col space-y-2\">{renderMainDialogContent()}</div>\n          </Form>\n        </DialogContent>\n      </Dialog>\n\n      {/* Preview Dialog - Column mapping and data review */}\n      {ENABLE_IMPORT_PREVIEW && showPreviewDialog && derivedPreviewData && (\n        <Dialog open={true} onOpenChange={handlePreviewCancel}>\n          <DialogContent className=\"sm:max-w-7xl h-[90vh] flex flex-col p-0\">\n            <DialogHeader className=\"px-6 pt-6 pb-4 border-b\">\n              <DialogTitle>Import Preview</DialogTitle>\n              <DialogDescription>\n                Review and map columns before importing your contacts.\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"flex-1 overflow-y-auto px-6\">\n              <ContactImportPreview\n                preview={derivedPreviewData}\n                onContinue={handlePreviewContinue}\n                onCancel={handlePreviewCancel}\n                onMappingChange={handleMappingChange}\n                userOverrides={userOverrides}\n              />\n            </div>\n          </DialogContent>\n        </Dialog>\n      )}\n\n      {/* Result Dialog - Import completion summary */}\n      {showResultDialog && wizardState.step === \"complete\" && (\n        <ContactImportResult\n          open={true}\n          onClose={handleClose}\n          result={wizardState.result}\n          allowRetry={false}\n        />\n      )}\n    </>\n  );\n}\n","export default \"first_name,last_name,gender,title,organization_name,organization_role,first_seen,last_seen,tags,linkedin_url,email_work,email_home,email_other,phone_work,phone_home,phone_other\\nJohn,Doe,male,Sales Executive,Acme Corporation,decision_maker,2024-07-01T00:00:00+00:00,2024-07-01T11:54:49.95+00:00,\\\"influencer, developer\\\",https://www.linkedin.com/in/johndoe,john@doe.example,john.doe@gmail.com,jdoe@caramail.com,659-980-2015,740.645.3807,(446) 758-2122\\nJane,Doe,female,UX Designer,Acme Corporation,influencer,2024-07-01T00:00:00+00:00,2024-07-01T11:54:49.95+00:00,\\\"UI, design\\\",https://www.linkedin.com/in/janedoe,jane@doe.example,,,659-980-2020,740.647.3802,\\n\"","import { Button } from \"@/components/ui/button\";\nimport { Upload } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { ContactImportDialog } from \"./ContactImportDialog\";\n\nexport const ContactImportButton = () => {\n  const [modalOpen, setModalOpen] = useState(false);\n\n  const handleOpenModal = () => {\n    setModalOpen(true);\n  };\n\n  const handleCloseModal = () => {\n    setModalOpen(false);\n  };\n\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        onClick={handleOpenModal}\n        className=\"flex items-center gap-2 cursor-pointer\"\n      >\n        <Upload /> Import\n      </Button>\n      <ContactImportDialog open={modalOpen} onClose={handleCloseModal} />\n    </>\n  );\n};\n","import { CreateButton } from \"@/components/admin/create-button\";\nimport useAppBarHeight from \"../hooks/useAppBarHeight\";\nimport { ContactImportButton } from \"./ContactImportButton\";\n\nexport const ContactEmpty = () => {\n  const appbarHeight = useAppBarHeight();\n  return (\n    <div\n      className=\"flex flex-col justify-center items-center gap-3\"\n      style={{\n        height: `calc(100dvh - ${appbarHeight}px)`,\n      }}\n    >\n      <img src=\"./img/empty.svg\" alt=\"No contacts found\" />\n      <div className=\"flex flex-col gap-0 items-center\">\n        <h2 className=\"text-lg font-bold\">No contacts found</h2>\n        <p className=\"text-sm text-muted-foreground text-center mb-4\">\n          It seems your contact list is empty.\n        </p>\n      </div>\n      <div className=\"flex flex-row gap-2\">\n        <CreateButton label=\"New Contact\" />\n        <ContactImportButton />\n      </div>\n    </div>\n  );\n};\n","import { Badge } from \"@/components/ui/badge\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { endOfYesterday, startOfMonth, startOfWeek, subMonths } from \"date-fns\";\nimport { Building2, Clock, Tag, Users } from \"lucide-react\";\nimport { FilterLiveForm, useGetIdentity, useGetList, useListContext } from \"ra-core\";\nimport { cn } from \"@/lib/utils\";\n\nimport { ToggleFilterButton } from \"@/components/admin/toggle-filter-button\";\nimport { SearchInput } from \"@/components/admin/search-input\";\nimport { FilterCategory } from \"../filters/FilterCategory\";\nimport { getTagColorClass } from \"../tags/tag-colors\";\n\n/**\n * ContactListFilter - Sidebar filter UI for Contacts list\n *\n * NOTE: Active filter chips are now displayed via FilterChipBar above the datagrid.\n */\nexport const ContactListFilter = () => {\n  const { data: identity } = useGetIdentity();\n  const { filterValues, setFilters } = useListContext();\n\n  const { data: tagsData } = useGetList(\"tags\", {\n    pagination: { page: 1, perPage: 10 },\n    sort: { field: \"name\", order: \"ASC\" },\n  });\n\n  // Fetch organizations for the organization filter dropdown\n  // Prioritize customer/prospect types as most relevant for contact filtering\n  const { data: organizationsData } = useGetList(\"organizations\", {\n    pagination: { page: 1, perPage: 100 },\n    sort: { field: \"name\", order: \"ASC\" },\n    filter: { deleted_at: null },\n  });\n\n  // Handle organization filter change via Select dropdown\n  const handleOrganizationChange = (value: string) => {\n    if (value === \"all\") {\n      // Remove organization_id filter when \"All Organizations\" is selected\n      const { organization_id: _, ...rest } = filterValues || {};\n      setFilters(rest);\n    } else {\n      setFilters({\n        ...filterValues,\n        organization_id: Number(value),\n      });\n    }\n  };\n\n  // Get current organization filter value for controlled Select\n  const currentOrgFilter = filterValues?.organization_id\n    ? String(filterValues.organization_id)\n    : \"all\";\n\n  return (\n    <div className=\"flex flex-col gap-4\" data-tutorial=\"contact-filters\">\n      {/* Search - Always visible */}\n      <FilterLiveForm>\n        <SearchInput source=\"q\" placeholder=\"Search contacts...\" />\n      </FilterLiveForm>\n\n      {/* Collapsible Filter Sections */}\n      <div className=\"flex flex-col gap-2\">\n        <FilterCategory label=\"Last activity\" icon={<Clock className=\"h-4 w-4\" />}>\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label=\"Today\"\n            value={{\n              \"last_seen@gte\": endOfYesterday().toISOString(),\n              \"last_seen@lte\": undefined,\n            }}\n          />\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label=\"This week\"\n            value={{\n              \"last_seen@gte\": startOfWeek(new Date()).toISOString(),\n              \"last_seen@lte\": undefined,\n            }}\n          />\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label=\"Before this week\"\n            value={{\n              \"last_seen@gte\": undefined,\n              \"last_seen@lte\": startOfWeek(new Date()).toISOString(),\n            }}\n          />\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label=\"Before this month\"\n            value={{\n              \"last_seen@gte\": undefined,\n              \"last_seen@lte\": startOfMonth(new Date()).toISOString(),\n            }}\n          />\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label=\"Before last month\"\n            value={{\n              \"last_seen@gte\": undefined,\n              \"last_seen@lte\": subMonths(startOfMonth(new Date()), 1).toISOString(),\n            }}\n          />\n        </FilterCategory>\n\n        <FilterCategory label=\"Tags\" icon={<Tag className=\"h-4 w-4\" />}>\n          {tagsData &&\n            tagsData.map((record) => (\n              <ToggleFilterButton\n                multiselect\n                className=\"w-full justify-between\"\n                key={record.id}\n                label={\n                  <Badge\n                    variant=\"secondary\"\n                    className={cn(\n                      \"text-xs font-normal cursor-pointer\",\n                      getTagColorClass(record?.color)\n                    )}\n                  >\n                    {record?.name}\n                  </Badge>\n                }\n                value={{ tags: record.id }}\n              />\n            ))}\n        </FilterCategory>\n\n        <FilterCategory label=\"Organization\" icon={<Building2 className=\"h-4 w-4\" />}>\n          <Select value={currentOrgFilter} onValueChange={handleOrganizationChange}>\n            <SelectTrigger\n              className=\"w-full min-h-11 bg-background border-border text-foreground\"\n              aria-label=\"Filter by organization\"\n            >\n              <SelectValue placeholder=\"All Organizations\" />\n            </SelectTrigger>\n            <SelectContent className=\"max-h-60\">\n              <SelectItem value=\"all\" className=\"min-h-11\">\n                <span className=\"text-muted-foreground\">All Organizations</span>\n              </SelectItem>\n              {organizationsData?.map((org) => (\n                <SelectItem key={org.id} value={String(org.id)} className=\"min-h-11\">\n                  <span className=\"truncate\" title={org.name}>\n                    {org.name}\n                  </span>\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </FilterCategory>\n\n        <FilterCategory icon={<Users className=\"h-4 w-4\" />} label=\"Account Manager\">\n          <ToggleFilterButton\n            className=\"w-full justify-between\"\n            label={\"Me\"}\n            value={{ sales_id: identity?.id }}\n          />\n        </FilterCategory>\n      </div>\n    </div>\n  );\n};\n","import { Mail, Phone, Linkedin, Building2 } from \"lucide-react\";\nimport { useUpdate, useNotify, RecordContextProvider } from \"ra-core\";\nimport { Form } from \"react-admin\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { ArrayField } from \"@/components/admin/array-field\";\nimport { EmailField } from \"@/components/admin/email-field\";\nimport { SingleFieldList } from \"@/components/admin/single-field-list\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { AsideSection } from \"@/components/ui\";\nimport { SaleName } from \"../sales/SaleName\";\nimport { ContactInputs } from \"./ContactInputs\";\nimport { Avatar } from \"./Avatar\";\nimport type { Contact } from \"../types\";\n\ninterface ContactDetailsTabProps {\n  record: Contact;\n  mode: \"view\" | \"edit\";\n  onModeToggle?: () => void;\n}\n\n/**\n * Details tab for ContactSlideOver.\n *\n * **View Mode**: Displays all contact fields from ContactShow + ContactAside:\n * - Identity: Avatar, Name, Gender, Title\n * - Position: Organization (link), Department, Title\n * - Contact Info: Email array, Phone array, LinkedIn\n * - Account: Sales rep, First seen, Last seen\n * - Tags: Tag badges (read-only)\n * - Notes: Free text notes field\n *\n * **Edit Mode**: Renders existing ContactInputs component inline with save/cancel.\n */\nexport function ContactDetailsTab({ record, mode, onModeToggle }: ContactDetailsTabProps) {\n  const [update] = useUpdate();\n  const notify = useNotify();\n\n  // Handle save in edit mode\n  const handleSave = async (data: Partial<Contact>) => {\n    try {\n      await update(\"contacts\", {\n        id: record.id,\n        data,\n        previousData: record,\n      });\n      notify(\"Contact updated successfully\", { type: \"success\" });\n      onModeToggle?.(); // Return to view mode after successful save\n    } catch (error) {\n      notify(\"Error updating contact\", { type: \"error\" });\n      console.error(\"Save error:\", error);\n    }\n  };\n\n  if (mode === \"edit\") {\n    return (\n      <RecordContextProvider value={record}>\n        <Form id=\"slide-over-edit-form\" onSubmit={handleSave} record={record}>\n          <div className=\"space-y-6\">\n            <ContactInputs />\n          </div>\n        </Form>\n      </RecordContextProvider>\n    );\n  }\n\n  // View mode - display all contact fields\n  return (\n    <RecordContextProvider value={record}>\n      <div className=\"space-y-6\">\n        {/* Identity Section */}\n        <AsideSection title=\"Identity\">\n          <div className=\"flex items-center gap-4\">\n            <Avatar />\n            <div className=\"flex-1\">\n              <h3 className=\"text-lg font-semibold\">\n                {record.first_name} {record.last_name}\n              </h3>\n              {record.gender && <p className=\"text-sm text-muted-foreground\">{record.gender}</p>}\n              {record.title && <p className=\"text-sm text-muted-foreground\">{record.title}</p>}\n            </div>\n          </div>\n        </AsideSection>\n\n        {/* Position Section */}\n        <AsideSection title=\"Position\">\n          <Card>\n            <CardContent className=\"p-4 space-y-2\">\n              {record.organization_id && (\n                <div className=\"flex items-center gap-2\">\n                  <Building2 className=\"size-4 text-muted-foreground\" />\n                  <ReferenceField source=\"organization_id\" reference=\"organizations\" link=\"show\">\n                    <TextField source=\"name\" className=\"font-medium\" />\n                  </ReferenceField>\n                </div>\n              )}\n              {record.department && (\n                <div className=\"text-sm\">\n                  <span className=\"text-muted-foreground\">Department: </span>\n                  <span className=\"font-medium\">{record.department}</span>\n                </div>\n              )}\n              {record.title && (\n                <div className=\"text-sm\">\n                  <span className=\"text-muted-foreground\">Title: </span>\n                  <span className=\"font-medium\">{record.title}</span>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </AsideSection>\n\n        {/* Contact Info Section */}\n        <AsideSection title=\"Contact Info\">\n          <div className=\"space-y-3\">\n            {/* Email */}\n            {record.email && record.email.length > 0 && (\n              <ArrayField source=\"email\">\n                <SingleFieldList className=\"flex-col gap-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Mail className=\"size-4 text-muted-foreground\" />\n                    <EmailField source=\"email\" />\n                    <TextField source=\"type\" className=\"text-xs text-muted-foreground\" />\n                  </div>\n                </SingleFieldList>\n              </ArrayField>\n            )}\n\n            {/* Phone */}\n            {record.phone && record.phone.length > 0 && (\n              <ArrayField source=\"phone\">\n                <SingleFieldList className=\"flex-col gap-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <Phone className=\"size-4 text-muted-foreground\" />\n                    <TextField source=\"number\" />\n                    <TextField source=\"type\" className=\"text-xs text-muted-foreground\" />\n                  </div>\n                </SingleFieldList>\n              </ArrayField>\n            )}\n\n            {/* LinkedIn */}\n            {record.linkedin_url && (\n              <div className=\"flex items-center gap-2\">\n                <Linkedin className=\"size-4 text-muted-foreground\" />\n                <a\n                  href={record.linkedin_url}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"text-sm text-primary hover:underline\"\n                >\n                  LinkedIn Profile\n                </a>\n              </div>\n            )}\n          </div>\n        </AsideSection>\n\n        {/* Account Section */}\n        <AsideSection title=\"Account\">\n          <div className=\"space-y-2\">\n            <div className=\"text-sm\">\n              <span className=\"text-muted-foreground\">Added on </span>\n              <DateField\n                source=\"first_seen\"\n                options={{ year: \"numeric\", month: \"long\", day: \"numeric\" }}\n              />\n            </div>\n\n            <div className=\"text-sm\">\n              <span className=\"text-muted-foreground\">Last activity on </span>\n              <DateField\n                source=\"last_seen\"\n                options={{ year: \"numeric\", month: \"long\", day: \"numeric\" }}\n              />\n            </div>\n\n            <div className=\"text-sm\">\n              <span className=\"text-muted-foreground\">Followed by </span>\n              <ReferenceField source=\"sales_id\" reference=\"sales\">\n                <SaleName />\n              </ReferenceField>\n            </div>\n          </div>\n        </AsideSection>\n\n        {/* Tags Section */}\n        {record.tags && record.tags.length > 0 && (\n          <AsideSection title=\"Tags\">\n            <div className=\"flex flex-wrap gap-2\">\n              {record.tags.map((tagId) => (\n                <ReferenceField\n                  key={tagId}\n                  record={{ tag_id: tagId }}\n                  source=\"tag_id\"\n                  reference=\"tags\"\n                  link={false}\n                >\n                  <Badge variant=\"outline\">\n                    <TextField source=\"name\" />\n                  </Badge>\n                </ReferenceField>\n              ))}\n            </div>\n          </AsideSection>\n        )}\n\n        {/* Notes Section */}\n        {record.notes && (\n          <AsideSection title=\"Notes\">\n            <Card>\n              <CardContent className=\"p-4\">\n                <p className=\"text-sm whitespace-pre-wrap\">{record.notes}</p>\n              </CardContent>\n            </Card>\n          </AsideSection>\n        )}\n      </div>\n    </RecordContextProvider>\n  );\n}\n","import { RecordContextProvider } from \"ra-core\";\nimport { ReferenceManyField } from \"@/components/admin/reference-many-field\";\nimport { NotesIterator } from \"../../notes\";\nimport type { Contact } from \"../types\";\n\ninterface ContactNotesTabProps {\n  record: Contact;\n  mode: \"view\" | \"edit\";\n}\n\n/**\n * Notes tab for ContactSlideOver.\n *\n * Wrapper around existing NotesIterator component from ContactShow.\n * Displays contact notes with create/edit/delete functionality.\n *\n * Both view and edit modes allow note creation and editing.\n */\nexport function ContactNotesTab({ record, mode }: ContactNotesTabProps) {\n  return (\n    <RecordContextProvider value={record}>\n      <div className=\"space-y-4\">\n        {/* Notes list with create form - NotesIterator includes NoteCreate internally */}\n        <ReferenceManyField\n          target=\"contact_id\"\n          reference=\"contactNotes\"\n          sort={{ field: \"created_at\", order: \"DESC\" }}\n        >\n          <NotesIterator reference=\"contacts\" />\n        </ReferenceManyField>\n\n        {/* Helper text for empty state */}\n        <div className=\"text-sm text-muted-foreground text-center py-4\">\n          {mode === \"view\"\n            ? \"Notes are visible to all team members\"\n            : \"Add notes to track important information about this contact\"}\n        </div>\n      </div>\n    </RecordContextProvider>\n  );\n}\n","import { useState } from \"react\";\nimport { Plus } from \"lucide-react\";\nimport { useGetList } from \"ra-core\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { QuickLogActivityDialog, ActivityTimelineEntry } from \"../activities\";\nimport type { ActivityRecord } from \"../types\";\nimport { ACTIVITY_PAGE_SIZE } from \"../activities/constants\";\n\ninterface ActivitiesTabProps {\n  contactId: string | number;\n}\n\nexport const ActivitiesTab = ({ contactId }: ActivitiesTabProps) => {\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n\n  const { data, isPending, error, refetch } = useGetList<ActivityRecord>(\"activities\", {\n    filter: { contact_id: contactId },\n    sort: { field: \"created_at\", order: \"DESC\" },\n    pagination: { page: 1, perPage: ACTIVITY_PAGE_SIZE },\n  });\n\n  // Convert contactId to number for the dialog (handles both string and number)\n  const numericContactId = typeof contactId === \"string\" ? parseInt(contactId, 10) : contactId;\n\n  if (isPending) {\n    return (\n      <div className=\"space-y-4\">\n        {[1, 2, 3].map((i) => (\n          <div key={i} className=\"p-4 border border-border rounded-lg\">\n            <Skeleton className=\"h-4 w-32 mb-2\" />\n            <Skeleton className=\"h-3 w-full mb-1\" />\n            <Skeleton className=\"h-3 w-3/4\" />\n          </div>\n        ))}\n      </div>\n    );\n  }\n\n  if (error) {\n    return <div className=\"text-center py-8 text-destructive\">Failed to load activities</div>;\n  }\n\n  const activities = data || [];\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Log Activity button - opens QuickLogActivityDialog pre-filled with contact */}\n      <div className=\"flex justify-end\">\n        <Button variant=\"outline\" className=\"h-11 gap-2\" onClick={() => setIsDialogOpen(true)}>\n          <Plus className=\"h-4 w-4\" />\n          Log Activity\n        </Button>\n      </div>\n\n      {activities.length === 0 ? (\n        <div className=\"text-center py-8 text-muted-foreground\">No activities recorded yet</div>\n      ) : (\n        <div className=\"space-y-3\">\n          {activities.map((activity) => (\n            <ActivityTimelineEntry key={activity.id} activity={activity} />\n          ))}\n        </div>\n      )}\n\n      {/* Activity logging dialog - pre-fills contact */}\n      <QuickLogActivityDialog\n        open={isDialogOpen}\n        onOpenChange={setIsDialogOpen}\n        entityContext={{ contactId: numericContactId }}\n        config={{\n          enableDraftPersistence: false, // No drafts for slide-over context\n          showSaveAndNew: false, // Single activity at a time\n        }}\n        onSuccess={() => {\n          refetch(); // Refresh the activity list\n        }}\n      />\n    </div>\n  );\n};\n\nexport default ActivitiesTab;\n","import { useGetOne } from \"react-admin\";\nimport { Building2, ChevronRight, User } from \"lucide-react\";\nimport { Link } from \"react-router-dom\";\nimport type { Contact, Organization } from \"../types\";\n\ninterface ContactHierarchyBreadcrumbProps {\n  record: Contact;\n}\n\n/**\n * Breadcrumb showing Contact's organization hierarchy\n * Displays: Organization Name > Contact Name\n *\n * The organization link opens the organization slide-over.\n * Used in ContactSlideOver header for context and quick navigation.\n */\nexport function ContactHierarchyBreadcrumb({ record }: ContactHierarchyBreadcrumbProps) {\n  // Fetch the organization for this contact\n  const { data: organization, isLoading } = useGetOne<Organization>(\n    \"organizations\",\n    { id: record.organization_id },\n    { enabled: !!record.organization_id }\n  );\n\n  // Don't show breadcrumb if no organization or still loading\n  if (!record.organization_id || isLoading || !organization) {\n    return null;\n  }\n\n  const contactName = [record.first_name, record.last_name].filter(Boolean).join(\" \");\n\n  return (\n    <nav aria-label=\"Contact hierarchy\" className=\"flex items-center gap-0.5 text-sm -ml-2\">\n      {/* Organization link with 44px touch target (WCAG AA) */}\n      <Link\n        to={`/organizations?view=${organization.id}`}\n        className=\"inline-flex items-center gap-1.5 min-h-11 px-2 text-muted-foreground hover:text-primary hover:bg-muted/50 rounded-md transition-colors truncate max-w-[200px]\"\n        title={organization.name}\n      >\n        <Building2 className=\"h-4 w-4 shrink-0\" />\n        {organization.name}\n      </Link>\n\n      <ChevronRight className=\"h-4 w-4 text-muted-foreground shrink-0\" />\n\n      <span className=\"flex items-center gap-1.5 min-h-11 px-2 text-foreground font-medium truncate\">\n        <User className=\"h-4 w-4 shrink-0\" />\n        {contactName || `Contact #${record.id}`}\n      </span>\n    </nav>\n  );\n}\n","import { UserIcon, ActivityIcon, FileTextIcon } from \"lucide-react\";\nimport { ResourceSlideOver, type TabConfig } from \"@/components/layouts/ResourceSlideOver\";\nimport { ContactDetailSkeleton } from \"@/components/ui/list-skeleton\";\nimport { ContactDetailsTab } from \"./ContactDetailsTab\";\nimport { ContactNotesTab } from \"./slideOverTabs/ContactNotesTab\";\nimport { ActivitiesTab } from \"./ActivitiesTab\";\nimport { ContactHierarchyBreadcrumb } from \"./ContactHierarchyBreadcrumb\";\nimport type { Contact } from \"../types\";\n\ninterface ContactSlideOverProps {\n  recordId: number | null;\n  isOpen: boolean;\n  mode: \"view\" | \"edit\";\n  onClose: () => void;\n  onModeToggle: () => void;\n}\n\n/**\n * Slide-over panel for viewing and editing contact records.\n *\n * Provides a tabbed interface with:\n * - Details: Contact information (view/edit)\n * - Activities: Activity timeline\n * - Notes: Contact notes (create/edit)\n *\n * Uses ResourceSlideOver wrapper for consistent UI.\n */\nexport function ContactSlideOver({\n  recordId,\n  isOpen,\n  mode,\n  onClose,\n  onModeToggle,\n}: ContactSlideOverProps) {\n  // Tab configuration with count badges\n  const contactTabs: TabConfig[] = [\n    {\n      key: \"details\",\n      label: \"Details\",\n      component: ContactDetailsTab,\n      icon: UserIcon,\n    },\n    {\n      key: \"activities\",\n      label: \"Activities\",\n      component: ({ record }) => <ActivitiesTab contactId={record.id} />,\n      icon: ActivityIcon,\n      countFromRecord: (record: Contact) => record.nb_activities,\n    },\n    {\n      key: \"notes\",\n      label: \"Notes\",\n      component: ContactNotesTab,\n      icon: FileTextIcon,\n      countFromRecord: (record: Contact) => record.nb_notes,\n    },\n  ];\n\n  // Record representation function\n  const getContactName = (record: Contact) => {\n    return `${record.first_name} ${record.last_name}`;\n  };\n\n  return (\n    <ResourceSlideOver\n      resource=\"contacts\"\n      recordId={recordId}\n      isOpen={isOpen}\n      onClose={onClose}\n      mode={mode}\n      onModeToggle={onModeToggle}\n      tabs={contactTabs}\n      recordRepresentation={getContactName}\n      breadcrumbComponent={ContactHierarchyBreadcrumb}\n      loadingSkeleton={ContactDetailSkeleton}\n    />\n  );\n}\n","/**\n * Contact Badge Components\n *\n * Extracted for reusability across:\n * - ContactList (table cells)\n * - ContactSlideOver (detail view)\n * - ContactListFilter (filter chips)\n *\n * Uses semantic tag colors from the MFB Garden to Table theme.\n * Pattern follows OrganizationBadges.tsx for consistency.\n *\n * @see OrganizationBadges.tsx - Reference implementation\n * @see src/index.css - OKLCH tag color definitions (lines 406-431)\n */\n\nimport { Badge } from \"@/components/ui/badge\";\n\n// =============================================================================\n// TYPE DEFINITIONS\n// =============================================================================\n\n/** Valid contact status levels matching database/configuration values */\nexport type ContactStatus = \"cold\" | \"warm\" | \"hot\" | \"in-contract\";\n\n/**\n * Contact role within an organization's buying process\n *\n * Matches database enum: public.contact_role\n * Based on BANT/MEDDIC sales methodology:\n * - decision_maker: Has authority to approve purchases\n * - influencer: Technical evaluator or department head\n * - buyer: Handles procurement/purchasing process\n * - end_user: Day-to-day user of the product/service\n * - gatekeeper: Controls access to decision makers\n * - champion: Internal advocate who drives the deal\n * - technical: Technical evaluator/implementer\n * - executive: C-level with budget authority\n */\nexport type ContactRole =\n  | \"decision_maker\"\n  | \"influencer\"\n  | \"buyer\"\n  | \"end_user\"\n  | \"gatekeeper\"\n  | \"champion\"\n  | \"technical\"\n  | \"executive\";\n\n/**\n * Contact influence level on purchasing decisions\n *\n * Maps from database smallint (1-5) to semantic levels:\n * - 5: Critical (can approve/veto unilaterally)\n * - 4: High (significant decision power)\n * - 3: Medium (meaningful input, needs consensus)\n * - 2: Low (provides feedback, limited power)\n * - 1: Minimal (informed but not involved in decisions)\n */\nexport type InfluenceLevel = \"critical\" | \"high\" | \"medium\" | \"low\" | \"minimal\";\n\n// =============================================================================\n// PROP INTERFACES\n// =============================================================================\n\ninterface ContactStatusBadgeProps {\n  /** Contact status from record.status */\n  status: ContactStatus | string;\n}\n\ninterface RoleBadgeProps {\n  /** Contact's role in the buying process (from contacts.role field) */\n  role: ContactRole | string;\n}\n\ninterface InfluenceBadgeProps {\n  /** Contact's influence level (string) or purchase_influence score (number 1-5) */\n  influence: InfluenceLevel | string | number;\n}\n\n// =============================================================================\n// BADGE COMPONENTS\n// =============================================================================\n\n/**\n * Displays contact engagement status with semantic colors\n *\n * Color mapping (MFB Garden to Table theme):\n * - cold: tag-blue (Cool/dormant - needs nurturing)\n * - warm: tag-amber (Engaged - showing interest)\n * - hot: tag-pink (Urgent/active - ready to buy)\n * - in-contract: tag-sage (Success - deal closed)\n *\n * WCAG AA Contrast: All tag colors use oklch(20% 0.02 85) foreground\n * against light backgrounds (85%+ lightness) = ~10:1 contrast ratio\n */\nexport function ContactStatusBadge({ status }: ContactStatusBadgeProps) {\n  // Handle null/undefined status gracefully - return placeholder\n  if (!status) {\n    return <Badge className=\"text-xs px-2 py-1 tag-gray\">--</Badge>;\n  }\n\n  const config: Record<string, { label: string; className: string }> = {\n    cold: { label: \"Cold\", className: \"tag-blue\" },\n    warm: { label: \"Warm\", className: \"tag-amber\" },\n    hot: { label: \"Hot\", className: \"tag-pink\" },\n    \"in-contract\": { label: \"Contract\", className: \"tag-sage\" },\n  };\n\n  const { label, className } = config[status] || {\n    label: status.charAt(0).toUpperCase() + status.slice(1),\n    className: \"tag-gray\",\n  };\n\n  return <Badge className={`text-xs px-2 py-1 ${className}`}>{label}</Badge>;\n}\n\n/**\n * Displays contact's role in the buying process\n *\n * Color mapping (emphasizes hierarchy and function):\n * - executive: tag-purple (Eggplant - authority/importance)\n * - decision_maker: tag-purple (Same as executive - authority)\n * - champion: tag-teal (Active/connected - internal ally)\n * - influencer: tag-warm (Clay Orange - engaged/involved)\n * - technical: tag-blue (Technical evaluator)\n * - buyer: tag-sage (Procurement - transactional)\n * - gatekeeper: tag-amber (Caution - controls access)\n * - end_user: tag-gray (Mushroom - neutral/standard)\n *\n * Matches database enum: public.contact_role\n */\nexport function RoleBadge({ role }: RoleBadgeProps) {\n  const config: Record<string, { label: string; className: string }> = {\n    executive: { label: \"Executive\", className: \"tag-purple\" },\n    decision_maker: { label: \"Decision Maker\", className: \"tag-purple\" },\n    champion: { label: \"Champion\", className: \"tag-teal\" },\n    influencer: { label: \"Influencer\", className: \"tag-warm\" },\n    technical: { label: \"Technical\", className: \"tag-blue\" },\n    buyer: { label: \"Buyer\", className: \"tag-sage\" },\n    gatekeeper: { label: \"Gatekeeper\", className: \"tag-amber\" },\n    end_user: { label: \"End User\", className: \"tag-gray\" },\n  };\n\n  const { label, className } = config[role] || {\n    // Handle unknown roles gracefully with title case\n    label: role\n      .split(\"_\")\n      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\n      .join(\" \"),\n    className: \"tag-gray\",\n  };\n\n  return <Badge className={`text-xs px-2 py-1 ${className}`}>{label}</Badge>;\n}\n\n/**\n * Displays contact's influence level with semantic status colors\n *\n * Accepts either:\n * - String level: \"critical\" | \"high\" | \"medium\" | \"low\" | \"minimal\"\n * - Numeric score: 1-5 (maps to levels automatically)\n *\n * Uses Badge variants (not tag classes) for visual distinction:\n * - critical/5: destructive (red - highest importance)\n * - high/4: default (primary green - significant)\n * - medium/3: secondary (muted - moderate)\n * - low/2: outline (minimal emphasis)\n * - minimal/1: outline (lowest emphasis)\n *\n * This follows PriorityBadge pattern from OrganizationBadges.tsx\n */\nexport function InfluenceBadge({ influence }: InfluenceBadgeProps) {\n  type BadgeVariant = \"default\" | \"secondary\" | \"destructive\" | \"outline\";\n\n  // Convert numeric score (1-5) to semantic level\n  const normalizedInfluence = typeof influence === \"number\" ? numericToLevel(influence) : influence;\n\n  const config: Record<string, { label: string; variant: BadgeVariant }> = {\n    critical: { label: \"Critical\", variant: \"destructive\" },\n    high: { label: \"High\", variant: \"default\" },\n    medium: { label: \"Medium\", variant: \"secondary\" },\n    low: { label: \"Low\", variant: \"outline\" },\n    minimal: { label: \"Minimal\", variant: \"outline\" },\n  };\n\n  const { label, variant } = config[normalizedInfluence] || {\n    label:\n      typeof influence === \"number\"\n        ? `Level ${influence}`\n        : influence.charAt(0).toUpperCase() + influence.slice(1),\n    variant: \"outline\" as BadgeVariant,\n  };\n\n  return (\n    <Badge variant={variant} className=\"text-xs px-2 py-1\">\n      {label}\n    </Badge>\n  );\n}\n\n/**\n * Converts numeric purchase_influence (1-5) to semantic level\n */\nfunction numericToLevel(score: number): InfluenceLevel {\n  if (score >= 5) return \"critical\";\n  if (score >= 4) return \"high\";\n  if (score >= 3) return \"medium\";\n  if (score >= 2) return \"low\";\n  return \"minimal\";\n}\n\n// =============================================================================\n// COMPOSITE BADGE (Optional - for dense displays)\n// =============================================================================\n\ninterface ContactBadgeGroupProps {\n  status?: ContactStatus | string;\n  role?: ContactRole | string;\n  influence?: InfluenceLevel | string | number;\n  /** Render direction */\n  direction?: \"horizontal\" | \"vertical\";\n}\n\n/**\n * Renders multiple contact badges in a group\n *\n * Useful for slide-over detail views where multiple badges\n * should be displayed together with consistent spacing.\n *\n * @example\n * <ContactBadgeGroup\n *   status=\"warm\"\n *   role=\"champion\"\n *   influence={4}\n * />\n */\nexport function ContactBadgeGroup({\n  status,\n  role,\n  influence,\n  direction = \"horizontal\",\n}: ContactBadgeGroupProps) {\n  const gapClass = direction === \"horizontal\" ? \"flex-row gap-2\" : \"flex-col gap-1\";\n\n  return (\n    <div className={`flex flex-wrap ${gapClass}`}>\n      {status && <ContactStatusBadge status={status} />}\n      {role && <RoleBadge role={role} />}\n      {influence !== undefined && <InfluenceBadge influence={influence} />}\n    </div>\n  );\n}\n","/**\n * Contact display formatters\n *\n * Local formatters for ContactList. These wrap the shared utilities\n * and can be used directly in FunctionField render props.\n */\n\nimport {\n  formatFullName as sharedFormatFullName,\n  formatRoleAndDept as sharedFormatRoleAndDept,\n} from \"../utils/formatters\";\n\n// Re-export for local use\nexport const formatFullName = sharedFormatFullName;\nexport const formatRoleAndDept = sharedFormatRoleAndDept;\n","/**\n * exportHelpers.ts - CSV export utility functions\n */\nimport type { EmailAndType, PhoneNumberAndType } from \"../types\";\n\n// Lowercase to match Zod schema (personalInfoTypeSchema)\nexport type EmailType = \"work\" | \"home\" | \"other\";\nexport type PhoneType = \"work\" | \"home\" | \"other\";\n\nexport function extractEmailByType(\n  emails: EmailAndType[] | undefined,\n  type: EmailType\n): string | undefined {\n  return emails?.find((e) => e.type === type)?.value;\n}\n\nexport function extractPhoneByType(\n  phones: PhoneNumberAndType[] | undefined,\n  type: PhoneType\n): string | undefined {\n  return phones?.find((p) => p.type === type)?.value;\n}\n\nexport function flattenEmailsForExport(emails: EmailAndType[] | undefined): {\n  email_work?: string;\n  email_home?: string;\n  email_other?: string;\n} {\n  return {\n    email_work: extractEmailByType(emails, \"work\"),\n    email_home: extractEmailByType(emails, \"home\"),\n    email_other: extractEmailByType(emails, \"other\"),\n  };\n}\n\nexport function flattenPhonesForExport(phones: PhoneNumberAndType[] | undefined): {\n  phone_work?: string;\n  phone_home?: string;\n  phone_other?: string;\n} {\n  return {\n    phone_work: extractPhoneByType(phones, \"work\"),\n    phone_home: extractPhoneByType(phones, \"home\"),\n    phone_other: extractPhoneByType(phones, \"other\"),\n  };\n}\n","/**\n * CSV Exporter for Contact records\n */\nimport jsonExport from \"jsonexport/dist\";\nimport type { Exporter } from \"ra-core\";\nimport { downloadCSV } from \"ra-core\";\nimport type { Contact, Sale, Tag, Organization } from \"../types\";\nimport { flattenEmailsForExport, flattenPhonesForExport } from \"../utils/exportHelpers\";\nimport { formatSalesName, formatTagsForExport } from \"../utils/formatters\";\n\n/**\n * Sanitize value for CSV export to prevent formula injection\n * @see docs/decisions/file-handling-best-practices.md\n */\nconst sanitizeForCSV = (value: unknown): string => {\n  if (value === null || value === undefined) return \"\";\n  const str = String(value);\n  const formulaTriggers = [\"=\", \"-\", \"+\", \"@\", \"\\t\", \"\\r\"];\n  if (formulaTriggers.some((char) => str.startsWith(char))) {\n    return `\\t${str}`; // Tab prefix neutralizes formulas\n  }\n  return str;\n};\n\nexport interface ContactExportRow {\n  first_name: string | undefined;\n  last_name: string | undefined;\n  gender: string | undefined;\n  title: string | undefined;\n  organization_name: string | undefined;\n  email_work: string | undefined;\n  email_home: string | undefined;\n  email_other: string | undefined;\n  phone_work: string | undefined;\n  phone_home: string | undefined;\n  phone_other: string | undefined;\n  avatar: string | undefined;\n  first_seen: string | undefined;\n  last_seen: string | undefined;\n  tags: string;\n  linkedin_url: string | null | undefined;\n  sales: string;\n  department: string;\n  id: number | string;\n  sales_id: number | string | null | undefined;\n  organization_id: number | string | null | undefined;\n}\n\nexport const contactExporter: Exporter<Contact> = async (records, fetchRelatedRecords) => {\n  const sales = await fetchRelatedRecords<Sale>(records, \"sales_id\", \"sales\");\n  const tags = await fetchRelatedRecords<Tag>(records, \"tags\", \"tags\");\n  const organizations = await fetchRelatedRecords<Organization>(\n    records,\n    \"organization_id\",\n    \"organizations\"\n  );\n\n  const contacts: ContactExportRow[] = records.map((contact) => ({\n    first_name: contact.first_name,\n    last_name: contact.last_name,\n    gender: contact.gender,\n    title: contact.title,\n    organization_name: contact.organization_id\n      ? organizations[contact.organization_id]?.name\n      : undefined,\n    ...flattenEmailsForExport(contact.email),\n    ...flattenPhonesForExport(contact.phone),\n    avatar: contact.avatar,\n    first_seen: contact.first_seen,\n    last_seen: contact.last_seen,\n    tags: formatTagsForExport(contact.tags, tags),\n    linkedin_url: contact.linkedin_url,\n    sales: formatSalesName(contact.sales_id ? sales[contact.sales_id] : null),\n    department: contact.department || \"\",\n    id: contact.id,\n    sales_id: contact.sales_id,\n    organization_id: contact.organization_id,\n  }));\n\n  const safeContacts = contacts.map((row) =>\n    Object.fromEntries(Object.entries(row).map(([key, value]) => [key, sanitizeForCSV(value)]))\n  );\n\n  return jsonExport(\n    safeContacts,\n    {\n      rowDelimiter: \",\",\n      endOfLine: \"\\r\\n\", // Windows/Excel compatibility\n    },\n    (err: Error | null, csv: string) => {\n      if (err) {\n        throw new Error(`CSV export failed: ${err.message}`);\n      }\n      downloadCSV(csv, \"contacts\");\n    }\n  );\n};\n","/**\n * Contact Filter Configuration\n *\n * Defines how contact filters are displayed in the FilterChipBar.\n *\n * @module contacts/contactFilterConfig\n */\n\nimport { validateFilterConfig } from \"../filters/filterConfigSchema\";\nimport { format, isToday, isThisWeek, isThisMonth } from \"date-fns\";\n\n/**\n * Format date values for chip display\n * Shows human-readable labels for recent dates\n */\nfunction formatDateLabel(value: unknown): string {\n  if (!value || typeof value !== \"string\") return String(value);\n\n  const date = new Date(value);\n  if (isNaN(date.getTime())) return String(value);\n\n  if (isToday(date)) return \"Today\";\n  if (isThisWeek(date)) return \"This week\";\n  if (isThisMonth(date)) return \"This month\";\n  return format(date, \"MMM d, yyyy\");\n}\n\n/**\n * Filter configuration for Contacts list\n *\n * Matches filters available in ContactListFilter.tsx:\n * - tags: Contact tags (multiselect reference)\n * - organization_id: Associated organization\n * - last_seen@gte/lte: Activity date range\n * - sales_id: Owner/sales rep reference\n */\nexport const CONTACT_FILTER_CONFIG = validateFilterConfig([\n  {\n    key: \"tags\",\n    label: \"Tag\",\n    type: \"multiselect\",\n    reference: \"tags\",\n  },\n  {\n    key: \"organization_id\",\n    label: \"Organization\",\n    type: \"reference\",\n    reference: \"organizations\",\n  },\n  {\n    key: \"last_seen@gte\",\n    label: \"Activity after\",\n    type: \"date-range\",\n    formatLabel: formatDateLabel,\n    // Group with @lte so removing either clears both\n    removalGroup: \"last_seen_range\",\n  },\n  {\n    key: \"last_seen@lte\",\n    label: \"Activity before\",\n    type: \"date-range\",\n    formatLabel: formatDateLabel,\n    removalGroup: \"last_seen_range\",\n  },\n  {\n    key: \"sales_id\",\n    label: \"Owner\",\n    type: \"reference\",\n    reference: \"sales\",\n  },\n]);\n","import { useGetIdentity, useListContext } from \"ra-core\";\n\nimport { BulkActionsToolbar } from \"@/components/admin/bulk-actions-toolbar\";\nimport { CreateButton } from \"@/components/admin/create-button\";\nimport { ExportButton } from \"@/components/admin/export-button\";\nimport { List } from \"@/components/admin/list\";\nimport { SortButton } from \"@/components/admin/sort-button\";\nimport { FloatingCreateButton } from \"@/components/admin/FloatingCreateButton\";\nimport { StandardListLayout } from \"@/components/layouts/StandardListLayout\";\nimport { PremiumDatagrid } from \"@/components/admin/PremiumDatagrid\";\nimport { TextField } from \"@/components/admin/text-field\";\nimport { ReferenceField } from \"@/components/admin/reference-field\";\nimport { DateField } from \"@/components/admin/date-field\";\nimport { FunctionField } from \"react-admin\";\nimport { useSlideOverState } from \"@/hooks/useSlideOverState\";\nimport { useListKeyboardNavigation } from \"@/hooks/useListKeyboardNavigation\";\nimport { ContactListSkeleton } from \"@/components/ui/list-skeleton\";\nimport type { Contact } from \"../types\";\nimport { useFilterCleanup } from \"../hooks/useFilterCleanup\";\nimport { FilterChipBar } from \"../filters\";\nimport { ContactEmpty } from \"./ContactEmpty\";\nimport { ContactListFilter } from \"./ContactListFilter\";\nimport { ContactSlideOver } from \"./ContactSlideOver\";\nimport { TopToolbar } from \"../layout/TopToolbar\";\nimport { Avatar } from \"./Avatar\";\nimport { ContactStatusBadge } from \"./ContactBadges\";\nimport { formatFullName, formatRoleAndDept } from \"./formatters\";\nimport { contactExporter } from \"./contactExporter\";\nimport { CONTACT_FILTER_CONFIG } from \"./contactFilterConfig\";\nimport { PageTutorialTrigger } from \"../tutorial\";\n\nexport const ContactList = () => {\n  const { data: identity, isPending: isIdentityPending } = useGetIdentity();\n  const { slideOverId, isOpen, mode, openSlideOver, closeSlideOver, toggleMode } =\n    useSlideOverState();\n\n  // Clean up stale cached filters from localStorage\n  // Generic hook validates all filters against filterRegistry.ts\n  useFilterCleanup(\"contacts\");\n\n  if (isIdentityPending) {\n    return <ContactListSkeleton />;\n  }\n  if (!identity) {\n    return null;\n  }\n\n  return (\n    <>\n      <div data-tutorial=\"contacts-list\">\n        <List\n          title={false}\n          actions={<ContactListActions />}\n          perPage={25}\n          sort={{ field: \"last_seen\", order: \"DESC\" }}\n          exporter={contactExporter}\n        >\n          <ContactListLayout openSlideOver={openSlideOver} isSlideOverOpen={isOpen} />\n          <FloatingCreateButton />\n        </List>\n      </div>\n      <ContactSlideOver\n        recordId={slideOverId}\n        isOpen={isOpen}\n        mode={mode}\n        onClose={closeSlideOver}\n        onModeToggle={toggleMode}\n      />\n      <PageTutorialTrigger chapter=\"contacts\" position=\"bottom-left\" />\n    </>\n  );\n};\n\nconst ContactListLayout = ({\n  openSlideOver,\n  isSlideOverOpen,\n}: {\n  openSlideOver: (id: number, mode: \"view\" | \"edit\") => void;\n  isSlideOverOpen: boolean;\n}) => {\n  const { data, isPending, filterValues } = useListContext();\n\n  // Keyboard navigation for list rows\n  // Disabled when slide-over is open to prevent conflicts\n  const { focusedIndex } = useListKeyboardNavigation({\n    onSelect: (id) => openSlideOver(Number(id), \"view\"),\n    enabled: !isSlideOverOpen,\n  });\n\n  const hasFilters = filterValues && Object.keys(filterValues).length > 0;\n\n  // Show skeleton during initial load (identity check happens in parent)\n  if (isPending) {\n    return (\n      <StandardListLayout resource=\"contacts\" filterComponent={<ContactListFilter />}>\n        <ContactListSkeleton />\n      </StandardListLayout>\n    );\n  }\n\n  if (!data?.length && !hasFilters) {\n    return <ContactEmpty />;\n  }\n\n  return (\n    <>\n      <StandardListLayout resource=\"contacts\" filterComponent={<ContactListFilter />}>\n        <FilterChipBar filterConfig={CONTACT_FILTER_CONFIG} />\n        <PremiumDatagrid\n          onRowClick={(id) => openSlideOver(Number(id), \"view\")}\n          focusedIndex={focusedIndex}\n        >\n          {/* Column 1: Avatar - Visual identifier (non-sortable) - hidden on mobile */}\n          <FunctionField\n            label=\"\"\n            sortable={false}\n            render={(record: Contact) => <Avatar record={record} width={40} height={40} />}\n            cellClassName=\"hidden lg:table-cell\"\n            headerClassName=\"hidden lg:table-cell\"\n          />\n\n          {/* Column 2: Name - Primary identifier (sortable by first_name) - always visible */}\n          <FunctionField\n            label=\"Name\"\n            sortBy=\"first_name\"\n            render={(record: Contact) => formatFullName(record.first_name, record.last_name)}\n          />\n\n          {/* Column 3: Role - Merged Title + Department (sortable by title) - hidden on tablet */}\n          <FunctionField\n            label=\"Role\"\n            sortBy=\"title\"\n            render={(record: Contact) => formatRoleAndDept(record.title, record.department)}\n            cellClassName=\"hidden lg:table-cell\"\n            headerClassName=\"hidden lg:table-cell\"\n          />\n\n          {/* Column 4: Organization - Relationship reference (sortable) - always visible */}\n          <ReferenceField\n            source=\"organization_id\"\n            reference=\"organizations\"\n            label=\"Organization\"\n            link={false}\n            sortable\n          >\n            <TextField source=\"name\" />\n          </ReferenceField>\n\n          {/* Column 5: Status - Badge-based indicator (non-sortable) - always visible */}\n          <FunctionField\n            label=\"Status\"\n            sortable={false}\n            render={(record: Contact) => <ContactStatusBadge status={record.status} />}\n          />\n\n          {/* Column 6: Notes - Activity count metric (non-sortable) - hidden on tablet */}\n          <FunctionField\n            label=\"Notes\"\n            sortable={false}\n            render={(record: Contact) => record.nb_notes ?? 0}\n            textAlign=\"center\"\n            cellClassName=\"hidden lg:table-cell\"\n            headerClassName=\"hidden lg:table-cell\"\n          />\n\n          {/* Column 7: Last Activity - Recency metric (sortable) - hidden on mobile */}\n          <DateField\n            source=\"last_seen\"\n            label=\"Last Activity\"\n            sortable\n            showTime={false}\n            cellClassName=\"hidden lg:table-cell\"\n            headerClassName=\"hidden lg:table-cell\"\n          />\n        </PremiumDatagrid>\n      </StandardListLayout>\n      <BulkActionsToolbar />\n    </>\n  );\n};\n\nconst ContactListActions = () => (\n  <TopToolbar>\n    <span data-tutorial=\"contact-sort-btn\">\n      <SortButton fields={[\"first_name\", \"last_name\", \"last_seen\"]} />\n    </span>\n    {/* MVP: Import feature hidden - re-enable post-launch\n    <span data-tutorial=\"contact-import-btn\">\n      <ContactImportButton />\n    </span>\n    */}\n    {/* MVP: Template export hidden - re-enable post-launch\n    <span data-tutorial=\"contact-template-btn\">\n      <ContactExportTemplateButton />\n    </span>\n    */}\n    <span data-tutorial=\"contact-export-btn\">\n      <ExportButton exporter={contactExporter} />\n    </span>\n    <span data-tutorial=\"create-contact-btn\">\n      <CreateButton />\n    </span>\n  </TopToolbar>\n);\n\nexport default ContactList;\n"],"names":["FULL_NAME_SPLIT_MARKER","COLUMN_ALIASES","first_name","last_name","organization_name","organization_role","email_work","email_home","email_other","phone_work","phone_home","phone_other","title","gender","avatar","first_seen","last_seen","tags","linkedin_url","notes","normalizeHeader","header","toLowerCase","trim","replace","__name","NORMALIZED_ALIAS_MAP","Map","fieldName","aliases","Object","entries","alias","normalized","has","set","NORMALIZED_FULL_NAME_PATTERNS","Set","map","p","filter","Boolean","findCanonicalField","userHeader","get","isFullNameColumn","mapHeadersToFields","headers","Array","isArray","mappings","getAvailableFields","keys","sort","getAvailableFieldsWithLabels","fields","value","label","field","l","toUpperCase","splitFullName","fullName","nameParts","split","length","slice","join","transformHeaders","processCsvData","dataRows","transformedHeaders","row","contact","forEach","originalHeader","index","transformedHeader","rawValue","sanitizeCsvValue","processCsvDataWithMappings","customMappings","targetField","parseRawCsvData","rawData","Error","contacts","usePapaParse","batchSize","processBatch","onPreview","previewRowCount","importIdRef","useRef","importer","setImporter","useState","state","reset","useCallback","current","parseCsv","file","importId","Papa.parse","skipEmptyLines","preview","complete","results","transformedData","parseResult","data","error","String","rawDataRows","rows","rowCount","errorCount","errors","importCount","remainingTime","totalTime","i","batch","start","Date","now","meanTime","previous","dynamicTyping","useMemo","isOrganizationOnlyEntry","hasOrgName","hasFirstName","hasLastName","isContactWithoutContactInfo","hasName","hasEmail","hasPhone","applyDataQualityTransformations","decisions","importOrganizationsWithoutContacts","importContactsWithoutContactInfo","autoFilledContacts","transformedContacts","transformed","add","autoFilledCount","size","wasAutoFilled","validateTransformedContacts","validationResults","result","importContactSchema","safeParse","success","successful","r","originalIndex","failed","issues","issue","path","message","useContactImport","today","toISOString","identity","useGetIdentity","dataProvider","useDataProvider","organizationsCache","getOrganizations","async","names","validateOrganizationNames","fetchRecordsWithCache","name","created_at","sales_id","id","tagsCache","getTags","validateTagNames","color","options","onProgress","startingRow","dataQualityDecisions","startTime","successCount","skippedCount","totalProcessed","failure","push","contactsToProcess","skippedContacts","organizations","Promise","all","flatMap","parseTags","allSettled","contactData","rowNumber","rowErrors","tagNames","trimmedOrgName","organization","email","type","phone","tagList","tag","contactPayload","parseDateSafely","organization_id","create","meta","dryRun","finalErrors","ZodError","body","status","reason","endTime","failedCount","duration","getTime","resource","cache","getCreateData","trimmedNames","uncachedRecordNames","response","getList","pagination","page","perPage","order","record","reduce","acc","ContactImportPreview","onContinue","onCancel","onRemap","onMappingChange","userOverrides","expandedSections","setExpandedSections","warnings","sampleData","organizationsWithoutContacts","contactsWithoutContactInfo","skippedColumns","setDataQualityDecisions","toggleSection","section","prev","sampleValidation","sampleRows","contactSchema","parse","valid","z.ZodError","validateSampleRows","validSamples","mappedColumns","m","target","availableFieldOptions","targetFieldCounts","duplicateTargets","mapping","count","hasDuplicates","jsxs","className","children","Alert","variant","hasErrors","jsx","AlertTitle","Fragment","AlertTriangle","CheckCircle","AlertDescription","User","validCount","skipCount","AlertCircle","newOrganizations","newTags","Building2","Tag","from","Card","CardHeader","CardTitle","CardDescription","CardContent","Table","TableHeader","TableRow","TableHead","ArrowRight","TableBody","isUserOverride","source","displayValue","TableCell","Badge","Select","onValueChange","SelectTrigger","SelectValue","placeholder","SelectContent","SelectItem","option","sampleValue","Collapsible","open","CollapsibleTrigger","asChild","onClick","ChevronUp","ChevronDown","CollapsibleContent","validation","org","warning","HelpCircle","Checkbox","checked","onCheckedChange","Label","htmlFor","DialogFooter","Button","lowConfidenceMappings","disabled","ContactImportResult","onClose","onRetry","allowRetry","successRate","Math","round","isComplete","formatDuration","ms","seconds","floor","minutes","hours","handleDownloadErrors","csvContent","toString","e","cell","blob","Blob","link","document","createElement","url","URL","createObjectURL","setAttribute","style","visibility","appendChild","click","removeChild","Dialog","onOpenChange","DialogContent","DialogHeader","DialogTitle","CheckCircle2","DialogDescription","toLocaleString","X","width","Clock","toLocaleTimeString","Download","fieldError","FileText","RefreshCw","extractNewOrganizations","trimmed","extractNewTags","findOrganizationsWithoutContacts","findContactsWithoutContactInfo","useColumnMapping","rawHeaders","setRawHeaders","setRawDataRows","setUserOverrides","prevHeadersRef","useEffect","every","h","autoMappings","finalMappings","setOverride","csvHeader","next","delete","setRawData","overrides","hasData","INITIAL_ACCUMULATED_RESULT","assertNever","JSON","stringify","hasFile","step","isTerminal","isProcessing","deriveWizardFlags","showPreview","showResult","isImporting","isParsing","hasError","createInitialState","importWizardReducer","action","reduceIdleState","reduceFileSelectedState","reduceParsingState","reducePreviewState","reduceImportingState","reduceCompleteState","reduceErrorState","payload","validationErrors","validationWarnings","previewData","previousStep","progress","total","totalContacts","accumulated","rowOffset","batchProcessed","batchSuccess","batchSkipped","batchFailed","batchErrors","_action","createWizardActions","dispatch","selectFile","clearFile","startParsing","parsingComplete","parsingFailed","updatePreview","updateDataQualityDecisions","startImport","updateProgress","accumulateResult","importComplete","importFailed","cancel","useImportWizard","useReducer","abortControllerRef","createAbortController","abort","AbortController","abortCurrentOperation","isAborted","signal","aborted","getAbortSignal","actions","baseActions","flags","abortSignal","_ClientRateLimiter","constructor","config","__publicField","this","canProceed","getState","validRequests","requests","time","windowMs","maxRequests","setState","firstRequest","getRemaining","max","getResetTime","oldestRequest","getResetTimeFormatted","ceil","sessionStorage","removeItem","storageKey","stored","getItem","setItem","ClientRateLimiter","contactImportLimiter","FileInput","props","alwaysOn","defaultValue","format","helperText","nameProp","onBlur","onBlurProp","onChange","onChangeProp","validate","readOnly","accept","maxSize","minSize","multiple","inputProps","inputPropsOptions","onRemove","onRemoveProp","validateFileRemoval","labelMultiple","labelSingle","removeIcon","rest","onDrop","onDropProp","translate","useTranslate","transformFile","File","rawFile","src","transformFiles","files","isRequired","useInput","newFiles","rejectedFiles","event","updatedFiles","filteredFiles","stateFile","shallowEqual","childrenElement","isValidElement","Children","only","getRootProps","getInputProps","fileRejections","useDropzone","validator","code","test","FormField","cn","sanitizeInputRestProps","FormLabel","FieldTitle","role","tabIndex","InputHelperText","FormError","FileInputPreview","RecordContextProvider","RemoveIcon","XCircle","window","revokeObjectURL","FileField","empty","download","_label","sortable","_sortable","sortBy","_sortBy","textAlign","_textAlign","rowClassName","_rowClassName","cellClassName","_cellClassName","headerClassName","_headerClassName","_resource","sourceValue","useFieldValue","titleValue","_","fileTitleValue","srcValue","href","stopPropagation","SAMPLE_URL","encodeURIComponent","ContactImportDialog","refresh","useRefresh","processBatchHook","wizardState","wizardActions","mergedMappings","reprocessedContacts","handleMappingChange","resetColumnMapping","hasColumnData","canonicalField","isFullName","confidence","substring","totalRows","derivedPreviewData","updatedMappings","firstContact","targetValues","values","hasFullNameSplit","includes","hasExplicitFirstName","hasExplicitLastName","previewImporter","resetPreviewImporter","papaConfig","getSecurePapaParseConfig","errorMessage","batchStartRow","handlePreviewContinue","resetTime","remaining","alert","handleFileChange","validateCsvFile","handlePreviewCancel","handleClose","handleReset","preventDefault","renderFileSelectionStep","selectedFile","Link","to","idx","Loader2","renderParsingStep","renderImportingStep","progressPercent","Progress","renderErrorStep","renderMainDialogContent","showMainDialog","showPreviewDialog","showResultDialog","Form","ContactImportButton","modalOpen","setModalOpen","handleOpenModal","handleCloseModal","Upload","ContactEmpty","appbarHeight","useAppBarHeight","height","alt","CreateButton","ContactListFilter","filterValues","setFilters","useListContext","tagsData","useGetList","organizationsData","deleted_at","handleOrganizationChange","Number","currentOrgFilter","FilterLiveForm","SearchInput","FilterCategory","icon","ToggleFilterButton","endOfYesterday","startOfWeek","startOfMonth","subMonths","multiselect","getTagColorClass","Users","ContactDetailsTab","mode","onModeToggle","update","useUpdate","notify","useNotify","handleSave","previousData","onSubmit","ContactInputs","AsideSection","Avatar","ReferenceField","reference","TextField","department","ArrayField","SingleFieldList","Mail","EmailField","Phone","Linkedin","rel","DateField","year","month","day","SaleName","tagId","tag_id","ContactNotesTab","ReferenceManyField","NotesIterator","ActivitiesTab","contactId","isDialogOpen","setIsDialogOpen","isPending","refetch","contact_id","ACTIVITY_PAGE_SIZE","numericContactId","parseInt","Skeleton","activities","Plus","activity","ActivityTimelineEntry","QuickLogActivityDialog","entityContext","enableDraftPersistence","showSaveAndNew","onSuccess","ContactHierarchyBreadcrumb","isLoading","useGetOne","enabled","contactName","ChevronRight","ContactSlideOver","recordId","isOpen","contactTabs","key","component","UserIcon","ActivityIcon","countFromRecord","nb_activities","FileTextIcon","nb_notes","getContactName","ResourceSlideOver","tabs","recordRepresentation","breadcrumbComponent","loadingSkeleton","ContactDetailSkeleton","ContactStatusBadge","cold","warm","hot","charAt","formatFullName","sharedFormatFullName","formatRoleAndDept","sharedFormatRoleAndDept","extractEmailByType","emails","find","extractPhoneByType","phones","flattenEmailsForExport","flattenPhonesForExport","sanitizeForCSV","str","some","char","startsWith","contactExporter","records","fetchRelatedRecords","sales","safeContacts","formatTagsForExport","formatSalesName","fromEntries","jsonExport","rowDelimiter","endOfLine","err","csv","downloadCSV","formatDateLabel","date","isNaN","isToday","isThisWeek","isThisMonth","CONTACT_FILTER_CONFIG","validateFilterConfig","formatLabel","removalGroup","ContactList","isIdentityPending","slideOverId","openSlideOver","closeSlideOver","toggleMode","useSlideOverState","useFilterCleanup","ContactListSkeleton","List","ContactListActions","exporter","ContactListLayout","isSlideOverOpen","FloatingCreateButton","PageTutorialTrigger","chapter","position","focusedIndex","useListKeyboardNavigation","onSelect","hasFilters","StandardListLayout","filterComponent","FilterChipBar","filterConfig","PremiumDatagrid","onRowClick","FunctionField","render","showTime","BulkActionsToolbar","TopToolbar","SortButton","ExportButton"],"mappings":"o5FAeO,MAAMA,GAAyB,oBCDzBC,GAA2C,CAEtDC,WAAY,CACV,aACA,aACA,QACA,YACA,QACA,aACA,aACA,YACA,WACA,iBACA,iBACA,SACA,WAGFC,UAAW,CACT,YACA,YACA,OACA,WACA,QACA,UACA,cACA,cACA,aACA,MACA,WACA,YAIFC,kBAAmB,CACjB,oBACA,oBACA,eACA,gBACA,gBACA,2BACA,eACA,UACA,eACA,eACA,cACA,WACA,gBACA,gBACA,MACA,WACA,WACA,WACA,aACA,OACA,SACA,cACA,cACA,WACA,gBACA,UACA,eACA,SACA,eAIFC,kBAAmB,CACjB,oBACA,oBACA,OACA,WACA,WACA,WACA,sBACA,QACA,YACA,YACA,WACA,cACA,WACA,kBAIFC,WAAY,CACV,aACA,aACA,aACA,aACA,YACA,iBACA,iBACA,gBACA,qBACA,eACA,eACA,gBACA,kBACA,QACA,SACA,SACA,gBACA,gBACA,eACA,OACA,gBACA,gBACA,iBAGFC,WAAY,CACV,aACA,aACA,aACA,aACA,YACA,iBACA,iBACA,gBACA,gBACA,gBACA,iBACA,iBACA,kBACA,kBACA,mBAGFC,YAAa,CACX,cACA,cACA,cACA,cACA,aACA,kBACA,kBACA,oBACA,mBACA,mBACA,eACA,kBACA,kBACA,mBACA,iBACA,kBAIFC,WAAY,CACV,aACA,aACA,aACA,aACA,YACA,iBACA,iBACA,gBACA,eACA,eACA,cACA,gBACA,aACA,QACA,eACA,eACA,cACA,YACA,MACA,SACA,eACA,eACA,OACA,aACA,YACA,iBACA,iBACA,gBACA,iBAGFC,WAAY,CACV,aACA,aACA,aACA,aACA,YACA,iBACA,iBACA,gBACA,gBACA,gBACA,oBACA,cACA,iBACA,iBACA,kBACA,mBAGFC,YAAa,CACX,cACA,cACA,cACA,cACA,aACA,kBACA,kBACA,oBACA,mBACA,mBACA,eACA,MACA,aACA,kBACA,kBACA,mBACA,iBACA,kBAIFC,MAAO,CACL,QACA,YACA,YACA,WACA,iBACA,iBACA,qBACA,aACA,cACA,eACA,eACA,cAIFC,OAAQ,CAAC,SAAU,MAAO,kBAAmB,kBAAmB,MAAO,cAAe,YAGtFC,OAAQ,CACN,SACA,QACA,UACA,kBACA,kBACA,gBACA,gBACA,WACA,QACA,YACA,YACA,YACA,YACA,aACA,cAIFC,WAAY,CACV,aACA,aACA,aACA,aACA,YACA,UACA,eACA,eACA,gBACA,WACA,WACA,gBACA,gBACA,mBAGFC,UAAW,CACT,YACA,YACA,eACA,eACA,iBACA,iBACA,gBACA,gBACA,mBACA,mBACA,iBACA,UACA,eACA,WACA,iBAIFC,KAAM,CACJ,OACA,MACA,aACA,WACA,SACA,QACA,SACA,QACA,WACA,UACA,WACA,UACA,mBAIFC,aAAc,CACZ,eACA,eACA,WACA,mBACA,mBACA,gBACA,gBACA,eACA,eACA,mBACA,SACA,UAIFC,MAAO,CACL,QACA,OACA,WACA,UACA,cACA,UACA,SACA,OACA,QACA,kBACA,kBACA,yBACA,UACA,SACA,eACA,gBAyCG,SAASC,GAAgBC,GAC9B,OAAKA,GAA4B,iBAAXA,EAKpBA,EACGC,cACAC,OAEAC,QAAQ,iBAAkB,KAE1BA,QAAQ,OAAQ,KAChBD,OAXI,EAaX,CAfgBE,EAAAL,GAAA,mBAwBhB,MAAMM,OAAgDC,IACtD,IAAA,MAAYC,GAAWC,MAAYC,OAAOC,QAAQ9B,IAChD,IAAA,MAAW+B,KAASH,GAAS,CAC3B,MAAMI,EAAab,GAAgBY,GAE/BC,IAAeP,GAAqBQ,IAAID,IAC1CP,GAAqBS,IAAIF,EAAYL,GAEzC,CAOF,MAAMQ,GAA6C,IAAIC,IAxEX,CAC1C,YACA,WACA,YACA,OACA,eACA,eACA,cACA,cACA,cACA,0BACA,yBACA,yBACA,gBACA,gBACA,aACA,eACA,eACA,gBACA,cACA,YACA,WACA,UACA,UAkDmBC,IAAKC,GAAMnB,GAAgBmB,IAAIC,OAAOC,UASpD,SAASC,GAAmBC,GACjC,IAAKA,GAAoC,iBAAfA,EACxB,OAAO,KAGT,MAAMV,EAAab,GAAgBuB,GACnC,OAAKV,GAIEP,GAAqBkB,IAAIX,IAHvB,IAIX,CAKO,SAASY,GAAiBxB,GAC/B,IAAKA,GAA4B,iBAAXA,EACpB,OAAO,EAGT,MAAMY,EAAab,GAAgBC,GACnC,OAAOe,GAA8BF,IAAID,EAC3C,CAiCO,SAASa,GAAmBC,GACjC,IAAKC,MAAMC,QAAQF,GACjB,MAAO,CAAA,EAGT,MAAMG,EAA0C,CAAA,EAEhD,IAAA,MAAW7B,KAAU0B,EACd1B,GAA4B,iBAAXA,IAKlBwB,GAAiBxB,GAGnB6B,EAAS7B,GAAUrB,GAGnBkD,EAAS7B,GAAUqB,GAAmBrB,IAI1C,OAAO6B,CACT,CAuDO,SAASC,KAKd,OAHmBrB,OAAOsB,KAAKnD,IAGboD,MACpB,CAMO,SAASC,KACd,MAAMC,EAASJ,KAEf,MAAO,CAEL,CACEK,MAAOxD,GACPyD,MAAO,kDAGNF,EAAOjB,IAAKoB,IAAA,CACbF,MAAOE,EACPD,MAAOC,EAAMlC,QAAQ,KAAM,KAAKA,QAAQ,QAAUmC,GAAMA,EAAEC,kBAGhE,CCrkBO,SAASC,GAAcC,GAC5B,IAAKA,GAAgC,iBAAbA,EACtB,MAAO,CAAE5D,WAAY,GAAIC,UAAW,IAGtC,MAAM4D,EAAYD,EAASvC,OAAOyC,MAAM,OAExC,OAAyB,IAArBD,EAAUE,QAAoC,KAApBH,EAASvC,OAE9B,CAAErB,WAAY,GAAIC,UAAW,IACN,IAArB4D,EAAUE,OAGZ,CAAE/D,WAAY,GAAIC,UAAW4D,EAAU,IAKvC,CACL7D,WAAY6D,EAAU,GACtB5D,UAAW4D,EAAUG,MAAM,GAAGC,KAAK,KAGzC,CAUA,SAASC,GAAiBrB,GACxB,MAAMG,EAAWJ,GAAmBC,GAEpC,OAAOA,EAAQT,IAAKjB,IAClB,IAAKA,EAAQ,OAAOA,EAGpB,OAFe6B,EAAS7B,IAEPA,GAErB,CAUO,SAASgD,GAAetB,EAAmBuB,GAChD,MAAMC,EAAqBH,GAAiBrB,GAE5C,OAAOuB,EAAShC,IAAKkC,IACnB,MAAMC,EAAe,CAAA,EAmBrB,OAjBA1B,EAAQ2B,QAAQ,CAACC,EAAgBC,KAC/B,MAAMC,EAAoBN,EAAmBK,GACvCE,EAAWN,EAAII,GAGfpB,EAAQuB,GAAiBD,GAG/B,GAAID,IAAsB7E,GAAwB,CAChD,MAAME,WAAEA,EAAAC,UAAYA,GAAc0D,GAAcL,GAAS,IACzDiB,EAAQvE,WAAa6E,GAAiB7E,GACtCuE,EAAQtE,UAAY4E,GAAiB5E,EACvC,MACEsE,EAAQI,GAAqBrB,IAI1BiB,GAEX,CAWO,SAASO,GACdjC,EACAuB,EACAW,GAEA,OAAOX,EAAShC,IAAKkC,IACnB,MAAMC,EAAe,CAAA,EAoBrB,OAlBA1B,EAAQ2B,QAAQ,CAACC,EAAgBC,KAC/B,MAAMM,EAAcD,EAAeN,GAC7BG,EAAWN,EAAII,GAGfpB,EAAQuB,GAAiBD,GAG/B,GAAII,IAAgBlF,GAAwB,CAC1C,MAAME,WAAEA,EAAAC,UAAYA,GAAc0D,GAAcL,GAAS,IACzDiB,EAAQvE,WAAa6E,GAAiB7E,GACtCuE,EAAQtE,UAAY4E,GAAiB5E,EACvC,MAAW+E,IACTT,EAAQS,GAAe1B,KAKpBiB,GAEX,CAcO,SAASU,GAAgBC,GAI9B,IAAKpC,MAAMC,QAAQmC,IAAYA,EAAQnB,OAAS,EAC9C,MAAM,IAAIoB,MAAM,4CAIlB,MAAMtC,EAAUqC,EAAQ,GAMxB,MAAO,CAAEE,SADQjB,GAAetB,EAFfqC,EAAQlB,MAAM,IAGZnB,UACrB,CCvIO,SAASwC,IAAgBC,UAC9BA,EAAY,GAAAC,aACZA,EAAAC,UACAA,EAAAC,gBACAA,IAEA,MAAMC,EAAcC,GAAAA,OAAe,IAE5BC,EAAUC,GAAeC,YAAiB,CAC/CC,MAAO,SAGHC,EAAQC,GAAAA,YAAY,KACxBJ,EAAY,CACVE,MAAO,SAETL,EAAYQ,SAAW,GACtB,IAEGC,EAAWF,GAAAA,YACdG,IACCP,EAAY,CACVE,MAAO,YAGT,MAAMM,EAAWX,EAAYQ,QAC7BI,GAAAA,MAAcF,EAAM,CAClBjF,QAAQ,EACRoF,gBAAgB,EAChBC,QAA2Bf,EAAkB,EAC7C,cAAMgB,CAASC,GACb,GAAIhB,EAAYQ,UAAYG,EAC1B,OAGF,IAAIM,EACA9D,EACJ,IAGE,MAAM+D,EAAc3B,GAAgByB,EAAQG,MAC5CF,EAAkBC,EAAYxB,SAC9BvC,EAAU+D,EAAY/D,OACxB,OAASiE,GAKP,YAJAjB,EAAY,CACVE,MAAO,QACPe,MAAOA,aAAiB3B,MAAQ2B,EAAQ,IAAI3B,MAAM4B,OAAOD,KAG7D,CAGA,GAAItB,GAAaC,EAAiB,CAEhC,MAAMuB,EAAeN,EAAQG,KAAiB7C,MAAM,GAKpD,OAJAwB,EAAU,CAAEyB,KAAMN,EAAiB9D,UAASmE,qBAC5CnB,EAAY,CACVE,MAAO,QAGX,CAEA,IAAKR,EAKH,YAJAM,EAAY,CACVE,MAAO,QACPe,MAAO,IAAI3B,MAAM,wCAKrBU,EAAY,CACVE,MAAO,UACPmB,SAAUP,EAAgB5C,OAC1BoD,WAAYT,EAAQU,OAAOrD,OAC3BsD,YAAa,EACbC,cAAe,OAGjB,IAAIC,EAAY,EAChB,IAAA,IAASC,EAAI,EAAGA,EAAIb,EAAgB5C,OAAQyD,GAAKlC,EAAW,CAI1D,MAAMmC,EAAQd,EAAgB3C,MAAMwD,EAAGA,EAAIlC,GAC3C,IACE,MAAMoC,EAAQC,KAAKC,YACbrC,EAAakC,GAEnBF,GADgBI,KAAKC,MAAQF,EAG7B,MAAMG,EAAWN,GAAaC,EAAIC,EAAM1D,QACxC8B,EAAaiC,IACX,GAAuB,YAAnBA,EAAS/B,MAAqB,CAChC,MAAMsB,EAAcS,EAAST,YAAcI,EAAM1D,OACjD,MAAO,IACF+D,EACHT,cACAC,cAAeO,GAAYlB,EAAgB5C,OAASsD,GAExD,CACA,OAAOS,GAEX,OAAShB,GAEPjB,EAAaiC,GACQ,YAAnBA,EAAS/B,MACL,IACK+B,EACHX,WAAYW,EAASX,WAAaM,EAAM1D,QAE1C+D,EAER,CACF,CAEAjC,EAAaiC,GACQ,YAAnBA,EAAS/B,MACL,IACK+B,EACH/B,MAAO,WACPuB,cAAe,MAEjBQ,EAER,EACA,KAAAhB,CAAMA,GACJjB,EAAY,CACVE,MAAO,QACPe,SAEJ,EACAiB,eAAe,KAGnB,CAACzC,EAAWC,EAAcC,EAAWC,IAGvC,OAAOuC,GAAAA,QACL,KAAA,CACEpC,WACAO,WACAH,UAEF,CAACJ,EAAUO,EAAUH,GAEzB,CC5KO,SAASiC,GAAwB1D,GACtC,MAAM2D,EAAa3D,EAAQrE,mBAAqB6G,OAAOxC,EAAQrE,mBAAmBmB,OAC5E8G,EAAe5D,EAAQvE,YAAc+G,OAAOxC,EAAQvE,YAAYqB,OAChE+G,EAAc7D,EAAQtE,WAAa8G,OAAOxC,EAAQtE,WAAWoB,OAEnE,SAAU6G,GAAeC,GAAiBC,EAC5C,CAOO,SAASC,GAA4B9D,GAC1C,MAAM4D,EAAe5D,EAAQvE,YAAc+G,OAAOxC,EAAQvE,YAAYqB,OAChE+G,EAAc7D,EAAQtE,WAAa8G,OAAOxC,EAAQtE,WAAWoB,OAC7DiH,EAAUH,GAAgBC,EAE1BG,EACHhE,EAAQnE,YAAc2G,OAAOxC,EAAQnE,YAAYiB,QACjDkD,EAAQlE,YAAc0G,OAAOxC,EAAQlE,YAAYgB,QACjDkD,EAAQjE,aAAeyG,OAAOxC,EAAQjE,aAAae,OAEhDmH,EACHjE,EAAQhE,YAAcwG,OAAOxC,EAAQhE,YAAYc,QACjDkD,EAAQ/D,YAAcuG,OAAOxC,EAAQ/D,YAAYa,QACjDkD,EAAQ9D,aAAesG,OAAOxC,EAAQ9D,aAAaY,OAEtD,SAAUiH,GAAYC,GAAaC,EACrC,CAUO,SAASC,GACdrD,EACAsD,EAAkC,CAChCC,oCAAoC,EACpCC,kCAAkC,IAGpC,MAAMC,MAAyB1G,IAe/B,MAAO,CACL2G,oBAd0B1D,EAAShD,IAAI,CAACmC,EAASG,KACjD,MAAMqE,EAAc,IAAKxE,GASzB,OANI0D,GAAwBc,IAAgBL,EAAUC,qCACpDI,EAAY/I,WAAa,UACzB+I,EAAY9I,UAAY,UACxB4I,EAAmBG,IAAItE,IAGlBqE,IAKPE,gBAAiBJ,EAAmBK,KACpCC,cAAe5H,EAACmD,GAAkBmE,EAAmB7G,IAAI0C,GAA1C,iBAEnB,CAQO,SAAS0E,GAA4BhE,GAC1C,MAAMiE,EAAoBjE,EAAShD,IAAI,CAACmC,EAASG,KAC/C,MAAM4E,EAASC,EAAoBC,UAAUjF,GAC7C,MAAO,CACLG,QACAH,UACAkF,QAASH,EAAOG,QAChB3C,MAAOwC,EAAOG,QAAU,KAAOH,EAAOxC,SAmB1C,MAAO,CAAE4C,WAfUL,EAChB/G,OAAQqH,GAAMA,EAAEF,SAChBrH,IAAKuH,IAAA,IAAYA,EAAEpF,QAASqF,cAAeD,EAAEjF,SAa3BmF,OAXNR,EACZ/G,OAAQqH,IAAOA,EAAEF,SACjBrH,IAAKuH,IAAA,CACJC,cAAeD,EAAEjF,MACjBmC,KAAM8C,EAAEpF,QACR6C,OAAQuC,EAAE7C,MAAOgD,OAAO1H,IAAK2H,IAAA,CAC3BvG,MAAOuG,EAAMC,KAAK/F,KAAK,KACvBgG,QAASF,EAAME,cAKvB,CCrFO,SAASC,KACd,MAAMC,GAAA,IAAYxC,MAAOyC,eACjBvD,KAAMwD,GAAaC,IACrBC,EAAeC,IAIfC,EAAqBzC,GAAAA,QACzB,QAAUvG,IAEV,CAAC8I,IAEGG,EAAmBzE,GAAAA,YACvB0E,MAAOC,EAAiBpE,GAAU,IAChCA,EACIqE,GAA0BD,GAC1BE,GACE,gBACAL,EACAG,EACCG,IAAA,CACCA,OACAC,YAAA,IAAgBrD,MAAOyC,cACvBa,SAAUZ,GAAUa,KAEtBX,GAER,CAACE,EAAoBJ,GAAUa,GAAIX,IAM/BY,EAAYnD,GAAAA,QAAQ,QAAUvG,IAAoB,CAAC8I,IACnDa,EAAUnF,GAAAA,YACd0E,MAAOC,EAAiBpE,GAAU,IAChCA,EACI6E,GAAiBT,GACjBE,GACE,OACAK,EACAP,EACCG,IAAA,CACCA,OACAO,MAAO,SAETf,GAER,CAACY,EAAWZ,IAmOd,OAhOqBtE,GAAAA,YACnB0E,MAAOlD,EAA8B8D,EAAyB,MAC5D,MAAM/E,QAAEA,GAAU,EAAAgF,WAAOA,cAAYC,EAAc,EAAAC,qBAAGA,GAAyBH,EACzEI,MAAgBhE,KAChBP,EAAwB,GAC9B,IAAIwE,EAAe,EACfC,EAAe,EACnB,MAAMC,EAAiBrE,EAAM1D,OAGzByH,GACFA,EAAW,EAAGM,GAIhB,MAAMhD,oBAAEA,GAAwBL,GAAgChB,EAAOiE,IAGjEhC,WAAEA,EAAAG,OAAYA,GAAWT,GAA4BN,GAG3De,EAAOrF,QAASuH,IACd3E,EAAO4E,KAAK,CACV1H,IAAKmH,EAAcM,EAAQnC,cAC3B/C,KAAMkF,EAAQlF,KACdO,OAAQ2E,EAAQ3E,WAKpB,IAAI6E,EAAoBvC,EACxB,IAAKgC,GAAsB9C,iCAAkC,CAC3D,MAAMsD,MAAsB/J,IAC5B8J,EAAoBvC,EAAWpH,OAAQiC,IACjC8D,GAA4B9D,KAC9B2H,EAAgBlD,IAAIzE,EAAQqF,gBACrB,IAIXiC,EAAeK,EAAgBhD,IACjC,CAGA,MAAOiD,EAAepL,SAAcqL,QAAQC,IAAI,CAC9C3B,EACEuB,EACG7J,IAAKmC,GAAYA,EAAQrE,mBAAmBmB,QAC5CiB,OAAQyI,KAA2BA,GACtCvE,GAEF4E,EACEa,EAAkBK,QAAS/H,GAAYgI,GAAUhI,EAAQxD,OACzDyF,YAKkB4F,QAAQI,WAC5BP,EAAkB7J,IAAIuI,MAAO8B,EAAa/H,KACxC,MAAMgI,EAAYjB,EAAcgB,EAAY7C,cACtC+C,EAA0B,IAE1B3M,WACJA,EAAAC,UACAA,EAAAU,OACAA,EAAAD,MACAA,EAAAN,WACAA,EAAAC,WACAA,EAAAC,YACAA,EAAAC,WACAA,EAAAC,WACAA,EAAAC,YACAA,EAAAI,WACAA,EAAAC,UACAA,EAAAZ,kBACAA,EACAa,KAAM6L,EAAA5L,aACNA,EAAAC,MACAA,GACEwL,EAGEI,EAAiB9F,OAAO7G,GAAqB,IAAImB,OACjDyL,EAAeX,EAAczJ,IAAImK,GASvC,IARIA,GAAmBC,GAAc5B,IAAO1E,GAC1CmG,EAAUX,KAAK,CACbxI,MAAO,oBACPyG,QAAS,0CAA0C4C,KACnDvJ,MAAOuJ,IAIPF,EAAU5I,OAAS,EACrB,MAAO,CACL2I,YACAjD,SAAS,EACTrC,OAAQuF,EACR9F,KAAM4F,GAIV,IACE,MAAMM,EAAQ,CACZ,CAAEzJ,MAAOlD,EAAY4M,KAAM,QAC3B,CAAE1J,MAAOjD,EAAY2M,KAAM,QAC3B,CAAE1J,MAAOhD,EAAa0M,KAAM,UAC5B1K,OAAO,EAAGgB,WAAYA,GAElB2J,EAAQ,CACZ,CAAE3J,MAAO/C,EAAYyM,KAAM,QAC3B,CAAE1J,MAAO9C,EAAYwM,KAAM,QAC3B,CAAE1J,MAAO7C,EAAauM,KAAM,UAC5B1K,OAAO,EAAGgB,WAAYA,GAElB4J,EAAUX,GAAUK,GACvBxK,IAAK2I,GAAShK,EAAK2B,IAAIqI,IACvBzI,OAAQ6K,KAAsBA,GAE3BC,EAAiB,CACrBpN,aACAC,YACAU,SACAD,QACAqM,QACAE,QACApM,WAAYA,EACPwM,EAAgBxM,IAAauJ,eAAiBD,EAC/CA,EACJrJ,UAAWA,EAAauM,EAAgBvM,IAAYsJ,eAAiBD,EAASA,EAC9EpJ,KAAMyF,EAAU,GAAK0G,EAAQ9K,IAAK+K,GAAQA,EAAIjC,IAC9CD,SAAUZ,GAAUa,GACpBlK,eACAC,QACAqM,gBAAiBR,GAAc5B,GAC/BtK,YAAQ,GAcV,OAXI4F,QACI+D,EAAagD,OAAO,WAAY,CACpC1G,KAAMuG,EACNI,KAAM,CAAEC,QAAQ,WAGZlD,EAAagD,OAAO,WAAY,CACpC1G,KAAMuG,IAIH,CAAEV,YAAWjD,SAAS,EAC/B,OAAS3C,GAEP,MAAM4G,EAA4B,GAClC,GAAI5G,aAAiB6G,GACnB7G,EAAMgD,OAAOtF,QAASuF,IACpB2D,EAAY1B,KAAK,CACfxI,MAAOuG,EAAMC,KAAK/F,KAAK,KACvBgG,QAASF,EAAME,iBAGrB,GAAWnD,EAAM8G,MAAMxG,OACrB,IAAA,MAAY5D,EAAOyG,KAAYrI,OAAOC,QAAQiF,EAAM8G,KAAKxG,QACvDsG,EAAY1B,KAAK,CAAExI,QAAOyG,QAASlD,OAAOkD,UAG5CyD,EAAY1B,KAAK,CACfxI,MAAO,UACPyG,QAASnD,EAAMmD,SAAW,yCAG9B,MAAO,CAAEyC,YAAWjD,SAAS,EAAOrC,OAAQsG,EAAa7G,KAAM4F,EACjE,CAAA,QACMjB,GACFA,EAAW9G,EAAQ,EAAImF,EAAO9F,OAAQ+H,EAE1C,MAKItH,QAAS8E,IACf,GAAsB,cAAlBA,EAAOuE,OAAwB,CACjC,MAAMvK,EAAQgG,EAAOhG,MACjBA,EAAMmG,QACRmC,IAEAxE,EAAO4E,KAAK,CACV1H,IAAKhB,EAAMoJ,UACX7F,KAAMvD,EAAMuD,KACZO,OAAQ9D,EAAM8D,QAGpB,MAEEA,EAAO4E,KAAK,CACV1H,IAAK,EACLuC,KAAM,CAAA,EACNO,OAAQ,CACN,CACE5D,MAAO,aACPyG,QAASX,EAAOwE,QAAQ7D,SAAW,iCAO7C,MAAM8D,MAAcpG,KAYpB,MAXoB,CAClBmE,iBACAF,eACAC,eACAmC,YAAa5G,EAAOrD,OACpBqD,SACA6G,SAAUF,EAAQG,UAAYvC,EAAUuC,UACxCvC,YACAoC,YAKJ,CAACxD,EAAcG,EAAkBU,EAASf,GAAUa,GAAIf,GAI5D,CJ+IgB5I,EAAAiB,GAAA,sBAgBAjB,EAAAoB,GAAA,oBAwCApB,EAAAqB,GAAA,sBA+EArB,EAAA0B,GAAA,sBAYA1B,EAAA6B,GAAA,gCCtjBA7B,EAAAoC,GAAA,iBAiCPpC,EAAA2C,GAAA,oBAmBO3C,EAAA4C,GAAA,kBAoCA5C,EAAAuD,GAAA,8BA0CAvD,EAAA0D,GAAA,mBCvHA1D,EAAA8D,GAAA,gBC3BA9D,EAAA0G,GAAA,2BAaA1G,EAAA8G,GAAA,+BA0BA9G,EAAAkH,GAAA,mCAmCAlH,EAAA6H,GAAA,+BC1DA7H,EAAA2I,GAAA,oBAsRhB,MAAMY,GAAwBvJ,EAAAoJ,eAC5BwD,EACAC,EACAxD,EACAyD,EACA9D,GAEA,MAAM+D,EAAe,IAAI,IAAInM,IAAIyI,EAAMxI,IAAK2I,GAASA,EAAK1J,UACpDkN,EAAsBD,EAAahM,OAAQyI,IAAUqD,EAAMpM,IAAI+I,IAGrE,GAAIwD,EAAoBxK,OAAS,EAAG,CAClC,MAAMyK,QAAiBjE,EAAakE,QAAQN,EAAU,CACpD7L,OAAQ,CACN,UAAW,IAAIiM,EAAoBnM,IAAK2I,GAAS,IAAIA,MAAS9G,KAAK,SAErEyK,WAAY,CAAEC,KAAM,EAAGC,QAASN,EAAavK,QAC7CZ,KAAM,CAAEK,MAAO,KAAMqL,MAAO,SAE9B,IAAA,MAAWC,KAAUN,EAAS3H,KAC5BuH,EAAMnM,IAAI6M,EAAO/D,KAAK1J,OAAQyN,EAElC,CAcA,aAXM1C,QAAQC,IACZkC,EAAoBnM,IAAIuI,MAAOI,IAC7B,GAAIqD,EAAMpM,IAAI+I,GAAO,OACrB,MAAMyD,QAAiBjE,EAAagD,OAAOY,EAAU,CACnDtH,KAAMwH,EAActD,KAEtBqD,EAAMnM,IAAI8I,EAAMyD,EAAS3H,SAKtByH,EAAaS,OAAO,CAACC,EAAKjE,KAC/BiE,EAAI/M,IAAI8I,EAAMqD,EAAM1L,IAAIqI,IACjBiE,GACN,IAAIvN,IACT,EAxC8B,yBA0CxB8K,KAAaxL,GACjBA,GACI+C,MAAM,MACN1B,IAAK+K,GAAgBA,EAAI9L,SACzBiB,OAAQ6K,GAAgBA,IAAQ,GAJpB,aAUZtC,WAAmCD,IACvC,MAAM0D,EAAe,IAAI,IAAInM,IAAIyI,EAAMxI,IAAK2I,GAASA,EAAK1J,UACpDiI,MAAa7H,IAInB,IAAA,MAAWsJ,KAAQuD,EACjBhF,EAAOrH,IAAI8I,EAAM,CACfG,GAAI,eAAeH,IACnBA,OACAC,YAAA,IAAgBrD,MAAOyC,gBAI3B,OAAOd,GAdyB,6BAqB5B+B,WAA0BT,IAC9B,MAAM0D,EAAe,IAAI,IAAInM,IAAIyI,EAAMxI,IAAK2I,GAASA,EAAK1J,UACpDiI,MAAa7H,IAInB,IAAA,MAAWsJ,KAAQuD,EACjBhF,EAAOrH,IAAI8I,EAAM,CACfG,GAAI,eAAeH,IACnBA,OACAO,MAAO,SAIX,OAAOhC,GAdgB,oBCxSlB,SAAS2F,IAAqBzI,QACnCA,EAAA0I,WACAA,EAAAC,SACAA,EAAAC,QACAA,EAAAC,gBACAA,EAAAC,cACAA,IAEA,MAAOC,EAAkBC,GAAuB1J,YAAS,CACvDqG,eAAe,EACfpL,MAAM,EACNqG,QAAQ,EACRqI,UAAU,EACVC,YAAY,EACZC,8BAA8B,EAC9BC,4BAA4B,EAC5BC,gBAAgB,KAIXnE,EAAsBoE,GAA2BhK,YAA+B,CACrF6C,oCAAoC,EACpCC,kCAAkC,IAG9BmH,IAAiBC,IACrBR,EAAqBS,IAAA,IAChBA,EACHD,CAACA,IAAWC,EAAKD,OAHC,iBA0ChBE,EAvBqB3O,EAAA,IACCiF,EAAQ2J,WAAW/N,IAAI,CAACkC,EAAKI,KACrD,IAEE,OADA0L,EAAcC,MAAM/L,GACb,CAAEA,IAAKI,EAAQ,EAAG4L,OAAO,EAClC,OAASxJ,GACP,OAAIA,aAAiByJ,GACZ,CACLjM,IAAKI,EAAQ,EACb4L,OAAO,EACPlJ,OAAQN,EAAMgD,OAAO1H,IAAK2H,IAAA,CACxBvG,MAAOuG,EAAMC,KAAK/F,KAAK,KACvBgG,QAASF,EAAME,YAId,CAAE3F,IAAKI,EAAQ,EAAG4L,OAAO,EAAOlJ,OAAQ,GACjD,IAjBuB,qBAuBFoJ,GACnBC,EAAeP,EAAiB5N,OAAQqH,GAAMA,EAAE2G,OAAOvM,OAGvD2M,EAAgBlK,EAAQxD,SAASV,OAAQqO,GAAmB,OAAbA,EAAEC,QACjDf,EAAiBrJ,EAAQxD,SAASV,OAAQqO,GAAmB,OAAbA,EAAEC,QAGlDC,EAAwBzN,KAGxB0N,MAAwBrP,IACxBsP,MAAuB5O,IAE7BqE,EAAQxD,SAASwB,QAASwM,IACxB,GAAIA,EAAQJ,QAA6B,kCAAnBI,EAAQJ,OAA4C,CACxE,MAAMK,EAAQH,EAAkBpO,IAAIsO,EAAQJ,SAAW,EACvDE,EAAkB7O,IAAI+O,EAAQJ,OAAQK,EAAQ,GAE1CA,EAAQ,EAAI,GACdF,EAAiB/H,IAAIgI,EAAQJ,OAEjC,IAGF,MAAMM,EAAgBH,EAAiB7H,KAAO,EAE9C,SACEiI,KAAC,MAAA,CAAIC,UAAU,sBAEbC,SAAA,CAAAF,EAAAA,KAACG,IAAMC,QAAS/K,EAAQgL,UAAY,cAAgB,UAAWJ,UAAU,OACvEC,SAAA,CAAAI,EAAAA,IAACC,GAAA,CAAWN,UAAU,0BACnBC,SAAA7K,EAAQgL,UACPL,EAAAA,KAAAQ,EAAAA,SAAA,CACEN,SAAA,GAAAI,IAACG,GAAA,CAAcR,UAAU,YAAY,qBAIvCD,EAAAA,KAAAQ,EAAAA,SAAA,CACEN,SAAA,GAAAI,IAACI,GAAA,CAAYT,UAAU,YAAY,6BAKxCU,GAAA,CAAiBV,UAAU,OAC1BC,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,sBACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAF,KAAC,OAAA,CAAKC,UAAU,0BACdC,SAAA,GAAAI,IAACM,GAAA,CAAKX,UAAU,cAChBK,IAAC,SAAA,CAAQJ,SAAA7K,EAAQwL,aAAoB,gCAEtCxL,EAAQyL,UAAY,GACnBd,EAAAA,KAAC,OAAA,CAAKC,UAAU,uCACdC,SAAA,GAAAI,IAACS,GAAA,CAAYd,UAAU,cACvBK,IAAC,SAAA,CAAQJ,SAAA7K,EAAQyL,YAAmB,+BAIxCzL,EAAQ2L,iBAAiBpO,OAAS,GAAKyC,EAAQ4L,QAAQrO,OAAS,IAChEoN,EAAAA,KAAC,MAAA,CAAIC,UAAU,kCACZC,SAAA,CAAA7K,EAAQ2L,iBAAiBpO,OAAS,GACjCoN,EAAAA,KAAC,OAAA,CAAKC,UAAU,0BACdC,SAAA,GAAAI,IAACY,GAAA,CAAUjB,UAAU,YACpB5K,EAAQ2L,iBAAiBpO,OAAO,wBAGpCyC,EAAQ4L,QAAQrO,OAAS,GACxBoN,EAAAA,KAAC,OAAA,CAAKC,UAAU,0BACdC,SAAA,GAAAI,IAACa,GAAA,CAAIlB,UAAU,YACd5K,EAAQ4L,QAAQrO,OAAO,0BAUrCmN,GACCC,EAAAA,KAACG,GAAA,CAAMC,QAAQ,cACbF,SAAA,GAAAI,IAACG,GAAA,CAAcR,UAAU,cACzBK,IAACC,IAAWL,SAAA,sCACZI,MAACK,GAAA,CACCT,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,sBACbC,SAAA,GAAAI,IAAC,KAAEJ,SAAA,wGAIHI,IAAC,KAAA,CAAGL,UAAU,wBACXC,SAAAvO,MAAMyP,KAAKxB,GAAkB3O,IAAKwO,KACjCO,KAAC,KAAA,CACCE,SAAA,GAAAI,IAAC,UAAQJ,SAAAT,IAAgB,cAAYE,EAAkBpO,IAAIkO,GAAQ,WAD5DA,cAWpBF,EAAc3M,OAAS,KACtBoN,KAACqB,EAAA,CACCnB,SAAA,CAAAF,OAACsB,EAAA,CACCpB,SAAA,GAAAI,IAACiB,GAAUrB,SAAA,2BACVsB,EAAA,CACEtB,SAAA,CAAAX,EAAc3M,OAAO,cAAqC,IAAzB2M,EAAc3M,OAAe,IAAM,GAAG,oBAEvE8L,EAAe9L,OAAS,GACvB,MAAM8L,EAAe9L,gBAA0C,IAA1B8L,EAAe9L,OAAe,IAAM,2BAG/E0N,EAAAA,IAACmB,EAAA,CACCvB,SAAAF,EAAAA,KAAC0B,GAAA,CACCxB,SAAA,CAAAI,EAAAA,IAACqB,GAAA,CACCzB,gBAAC0B,GAAA,CACC1B,SAAA,GAAAI,IAACuB,IAAU3B,SAAA,eACXI,EAAAA,IAACuB,IAAU5B,UAAU,mBACnBC,eAAC4B,GAAA,CAAW7B,UAAU,wBAExBK,IAACuB,IAAU3B,SAAA,gBACXI,IAACuB,IAAU3B,SAAA,4BAGd6B,GAAA,CACE7B,SAAAX,EAActO,IAAI,CAAC4O,EAAStM,KAE3B,MAAMyO,EAAiB7D,GAAetN,IAAIgP,EAAQoC,QAI5CC,EACe,2CAAnBrC,EAAQJ,OACJ9Q,GACAkR,EAAQJ,QAAU,iBAExB,OACEO,EAAAA,KAAC4B,GAAA,CAAqB3B,UAAW+B,EAAiB,oBAAsB,GACtE9B,SAAA,GAAAF,KAACmC,GAAA,CAAUlC,UAAU,0CAClBC,SAAA,CAAAL,EAAQoC,OACRD,GACC1B,EAAAA,IAAC8B,EAAA,CAAMhC,QAAQ,YAAYH,UAAU,eAAeC,SAAA,cAKxDI,EAAAA,IAAC6B,IAAUlC,UAAU,cACnBC,eAAC4B,GAAA,CAAW7B,UAAU,8CAExBK,IAAC6B,IACEjC,SAAAhC,EACC8B,EAAAA,KAACqC,EAAA,CACClQ,MAAO+P,EACPI,gBAAgBnQ,IAEd+L,EACE2B,EAAQoC,OACE,mBAAV9P,EAA6B,KAAOA,IAJzB,iBAQf+N,SAAA,CAAAI,EAAAA,IAACiC,GAActC,UAAU,SACvBC,eAACsC,EAAA,CAAYC,YAAY,0BAE1BC,EAAA,CACCxC,SAAA,CAAAI,EAAAA,IAACqC,EAAA,CAAWxQ,MAAM,iBAAiB+N,SAAA,iBAClCR,EAAsBzO,IAAK2R,GAC1BtC,EAAAA,IAACqC,EAAA,CAA8BxQ,MAAOyQ,EAAOzQ,MAC1C+N,SAAA0C,EAAOxQ,OADOwQ,EAAOzQ,oBAO7BiQ,EAAA,CAAMhC,QAAQ,UAAUH,UAAU,oBAChCC,SAAAL,EAAQJ,aAIfa,IAAC6B,GAAA,CAAUlC,UAAU,uDAClBC,SAAAL,EAAQgD,eAAevC,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,UA3CrD3M,eAuD5BmL,EAAe9L,OAAS,GACvB0N,EAAAA,IAACwC,GAAA,CAAYC,KAAM3E,EAAiBM,eAClCwB,SAAAF,EAAAA,KAACqB,EAAA,CAAKpB,UAAU,eACdC,SAAA,GAAAI,IAAC0C,GAAA,CAAmBC,SAAO,EACzB/C,SAAAF,EAAAA,KAACsB,EAAA,CACCrB,UAAU,iBACViD,QAAS9S,EAAA,IAAMwO,EAAc,kBAApB,WAETsB,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACS,GAAA,CAAYd,UAAU,kCACvBK,EAAAA,IAACiB,EAAA,CAAUtB,UAAU,wBAAwBC,SAAA,oBAC7CI,EAAAA,IAAC8B,EAAA,CAAMhC,QAAQ,YAAaF,WAAetN,YAE5CwL,EAAiBM,eAChB4B,MAAC6C,GAAA,CAAUlD,UAAU,cAErBK,IAAC8C,GAAA,CAAYnD,UAAU,iBAG3BK,IAACkB,GAAgBtB,SAAA,0EAKrBI,EAAAA,IAAC+C,GAAA,CACCnD,SAAAI,MAACmB,EAAA,CACCvB,gBAACwB,GAAA,CACCxB,SAAA,CAAAI,EAAAA,IAACqB,GAAA,CACCzB,gBAAC0B,GAAA,CACC1B,SAAA,GAAAI,IAACuB,IAAU3B,SAAA,iBACXI,IAACuB,IAAU3B,SAAA,sBAGfI,EAAAA,IAACyB,IACE7B,SAAAxB,EAAezN,IAAI,CAAC4O,EAAStM,WAC3BqO,GAAA,CACC1B,SAAA,CAAAI,EAAAA,IAAC6B,GAAA,CAAUlC,UAAU,0CAClBC,SAAAL,EAAQoC,eAEVE,GAAA,CAAUlC,UAAU,uDAClBC,SAAAL,EAAQgD,aAAe,QALbtP,wBAkB9BuP,GAAA,CAAYC,KAAM3E,EAAiBG,WAClC2B,gBAACmB,EAAA,CACCnB,SAAA,CAAAI,MAAC0C,GAAA,CAAmBC,SAAO,EACzB/C,SAAAI,MAACgB,GAAWrB,UAAU,iBAAiBiD,QAAS9S,EAAA,IAAMwO,EAAc,cAApB,WAC9CsB,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,CAAAF,OAAC,MAAA,CACCE,SAAA,GAAAI,IAACiB,GAAUrB,SAAA,+BACVsB,EAAA,CAAgBtB,SAAA,CAAA,sCACqBZ,EAAa,kBAGpDlB,EAAiBG,WAChB+B,MAAC6C,GAAA,CAAUlD,UAAU,cAErBK,IAAC8C,GAAA,CAAYnD,UAAU,mBAK/BK,EAAAA,IAAC+C,IACCnD,SAAAI,EAAAA,IAACmB,EAAA,CACCvB,eAAC,MAAA,CAAID,UAAU,kBACbC,SAAAF,EAAAA,KAAC0B,GAAA,CACCxB,SAAA,CAAAI,EAAAA,IAACqB,GAAA,CACCzB,gBAAC0B,GAAA,CACC1B,SAAA,CAAAI,EAAAA,IAACuB,GAAA,CAAU5B,UAAU,OAAOC,SAAA,UAC5BI,IAACuB,IAAU3B,SAAA,WACXI,IAACuB,IAAU3B,SAAA,YACXI,IAACuB,IAAU3B,SAAA,mBACXI,IAACuB,IAAU3B,SAAA,gBAGfI,EAAAA,IAACyB,GAAA,CACE7B,SAAA7K,EAAQ2J,WAAWnM,MAAM,EAAG,GAAG5B,IAAI,CAACkC,EAAKI,KACxC,MAAM+P,EAAavE,EAAiBxL,GACpC,cACGqO,GAAA,CACC1B,SAAA,CAAAI,MAAC6B,GAAA,CACCjC,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,0BACZC,SAAA,CAAA3M,EAAQ,EACR+P,GAAYnE,MACXmB,MAACI,GAAA,CAAYT,UAAU,2BAEvBK,IAACS,GAAA,CAAYd,UAAU,kCAI7BK,EAAAA,IAAC6B,GAAA,CAAWjC,SAAA/M,EAAIyG,MAAQ,GAAGzG,EAAItE,cAAcsE,EAAIrE,cACjDwR,EAAAA,IAAC6B,IAAUlC,UAAU,oBAClBC,WAAItE,QAAQ,IAAIA,OAAS,MAE5B0E,EAAAA,IAAC6B,GAAA,CAAWjC,SAAA/M,EAAIpE,mBAAqB,MACrCuR,EAAAA,IAAC6B,GAAA,CACCjC,SAAAI,EAAAA,IAAC8B,EAAA,CAAMhC,QAAQ,UAAUH,UAAU,UAChCC,SAAAoD,GAAYnE,MAAQ,QAAU,mBAlBtB5L,qBAiChC8B,EAAQ2L,iBAAiBpO,OAAS,GACjC0N,EAAAA,IAACwC,IAAYC,KAAM3E,EAAiBpD,cAClCkF,SAAAF,EAAAA,KAACqB,EAAA,CACCnB,SAAA,GAAAI,IAAC0C,GAAA,CAAmBC,SAAO,EACzB/C,SAAAF,EAAAA,KAACsB,EAAA,CAAWrB,UAAU,iBAAiBiD,QAAS9S,EAAA,IAAMwO,EAAc,iBAApB,WAC9CsB,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACY,GAAA,CAAUjB,UAAU,cACrBK,IAACiB,GAAUrB,SAAA,4BACVkC,EAAA,CAAMhC,QAAQ,YAAaF,SAAA7K,EAAQ2L,iBAAiBpO,YAEtDwL,EAAiBpD,cAChBsF,MAAC6C,GAAA,CAAUlD,UAAU,cAErBK,IAAC8C,GAAA,CAAYnD,UAAU,iBAG3BK,IAACkB,GAAgBtB,SAAA,6DAGrBI,IAAC+C,IACCnD,WAAAI,IAACmB,EAAA,CACCvB,eAAC,MAAA,CAAID,UAAU,uBACZC,SAAA7K,EAAQ2L,iBAAiB/P,IAAI,CAACsS,EAAKhQ,IAClC+M,EAAAA,IAAC8B,EAAA,CAAkBhC,QAAQ,UACxBF,YADS3M,eAYzB8B,EAAQ4L,QAAQrO,OAAS,GACxB0N,EAAAA,IAACwC,IAAYC,KAAM3E,EAAiBxO,KAClCsQ,SAAAF,EAAAA,KAACqB,EAAA,CACCnB,SAAA,GAAAI,IAAC0C,GAAA,CAAmBC,SAAO,EACzB/C,SAAAF,EAAAA,KAACsB,EAAA,CAAWrB,UAAU,iBAAiBiD,QAAS9S,EAAA,IAAMwO,EAAc,QAApB,WAC9CsB,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACa,GAAA,CAAIlB,UAAU,cACfK,IAACiB,GAAUrB,SAAA,mBACVkC,EAAA,CAAMhC,QAAQ,YAAaF,SAAA7K,EAAQ4L,QAAQrO,YAE7CwL,EAAiBxO,KAChB0Q,MAAC6C,GAAA,CAAUlD,UAAU,cAErBK,IAAC8C,GAAA,CAAYnD,UAAU,iBAG3BK,IAACkB,GAAgBtB,SAAA,oDAGrBI,IAAC+C,IACCnD,WAAAI,IAACmB,EAAA,CACCvB,eAAC,MAAA,CAAID,UAAU,uBACZC,SAAA7K,EAAQ4L,QAAQhQ,IAAI,CAAC+K,EAAKzI,IACzB+M,EAAAA,IAAC8B,EAAA,CAAkBhC,QAAQ,YACxBF,YADS3M,eAYzB8B,EAAQY,OAAOrD,OAAS,GACvB0N,EAAAA,IAACwC,GAAA,CAAYC,KAAM3E,EAAiBnI,OAClCiK,SAAAF,OAACqB,EAAA,CAAKpB,UAAU,wBACdC,SAAA,GAAAI,IAAC0C,GAAA,CAAmBC,SAAO,EACzB/C,SAAAF,EAAAA,KAACsB,EAAA,CAAWrB,UAAU,iBAAiBiD,QAAS9S,EAAA,IAAMwO,EAAc,UAApB,WAC9CsB,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACS,GAAA,CAAYd,UAAU,6BACvBK,EAAAA,IAACiB,EAAA,CAAUtB,UAAU,mBAAmBC,SAAA,4BACvCkC,EAAA,CAAMhC,QAAQ,cAAeF,SAAA7K,EAAQY,OAAOrD,YAE9CwL,EAAiBnI,OAChBqK,MAAC6C,GAAA,CAAUlD,UAAU,cAErBK,IAAC8C,GAAA,CAAYnD,UAAU,iBAG3BK,IAACkB,GAAgBtB,SAAA,sEAKpBmD,GAAA,CACCnD,WAAAI,IAACmB,GACCvB,WAAAF,KAAC,MAAA,CAAIC,UAAU,qCACZC,SAAA,CAAA7K,EAAQY,OAAOpD,MAAM,EAAG,IAAI5B,IAAI,CAAC0E,EAAOpC,IACvCyM,EAAAA,KAAC,MAAA,CAECC,UAAU,+DAEVC,SAAA,GAAAI,IAACS,GAAA,CAAYd,UAAU,yDACtB,MAAA,CACCC,SAAA,GAAAF,KAAC,OAAA,CAAKC,UAAU,cAAcC,SAAA,CAAA,OAAKvK,EAAMxC,OACxCwC,EAAMtD,OACL2N,OAAC,OAAA,CAAKC,UAAU,wBAAwBC,SAAA,CAAA,KAAGvK,EAAMtD,MAAM,OACvD,KACCsD,EAAMmD,aATNvF,IAaR8B,EAAQY,OAAOrD,OAAS,IACvBoN,EAAAA,KAAC,MAAA,CAAIC,UAAU,iDAAiDC,SAAA,CAAA,WACrD7K,EAAQY,OAAOrD,OAAS,GAAG,8BAWnDyC,EAAQiJ,SAAS1L,OAAS,GACzB0N,EAAAA,IAACwC,GAAA,CAAYC,KAAM3E,EAAiBE,SAClC4B,SAAAF,OAACqB,EAAA,CAAKpB,UAAU,oBACdC,SAAA,GAAAI,IAAC0C,GAAA,CAAmBC,SAAO,EACzB/C,SAAAF,EAAAA,KAACsB,EAAA,CAAWrB,UAAU,iBAAiBiD,QAAS9S,EAAA,IAAMwO,EAAc,YAApB,WAC9CsB,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACG,GAAA,CAAcR,UAAU,yBACzBK,EAAAA,IAACiB,EAAA,CAAUtB,UAAU,eAAeC,SAAA,aACpCI,EAAAA,IAAC8B,GAAMhC,QAAQ,UAAUH,UAAU,8BAChCC,SAAA7K,EAAQiJ,SAAS1L,YAGrBwL,EAAiBE,SAChBgC,MAAC6C,GAAA,CAAUlD,UAAU,cAErBK,IAAC8C,GAAA,CAAYnD,UAAU,iBAG3BK,IAACkB,GAAgBtB,SAAA,wEAKpBmD,GAAA,CACCnD,WAAAI,IAACmB,GACCvB,WAAAF,KAAC,MAAA,CAAIC,UAAU,qCACZC,SAAA,CAAA7K,EAAQiJ,SAASzL,MAAM,EAAG,IAAI5B,IAAI,CAACuS,EAASjQ,IAC3CyM,EAAAA,KAAC,MAAA,CAECC,UAAU,2DAEVC,SAAA,GAAAI,IAACG,GAAA,CAAcR,UAAU,qDACxB,MAAA,CACCC,SAAA,GAAAF,KAAC,OAAA,CAAKC,UAAU,cAAcC,SAAA,CAAA,OAAKsD,EAAQrQ,OAC1CqQ,EAAQnR,OACP2N,OAAC,OAAA,CAAKC,UAAU,wBAAwBC,SAAA,CAAA,KAAGsD,EAAQnR,MAAM,OACzD,KACCmR,EAAQ1K,aATRvF,IAaR8B,EAAQiJ,SAAS1L,OAAS,IACzBoN,EAAAA,KAAC,MAAA,CAAIC,UAAU,iDAAiDC,SAAA,CAAA,WACrD7K,EAAQiJ,SAAS1L,OAAS,GAAG,gCAWrDyC,EAAQmJ,8BAAgCnJ,EAAQmJ,6BAA6B5L,OAAS,GACrF0N,EAAAA,IAACwC,GAAA,CAAYC,KAAM3E,EAAiBI,6BAClC0B,SAAAF,EAAAA,KAACqB,EAAA,CAAKpB,UAAU,oBACdC,SAAA,GAAAI,IAAC0C,GAAA,CAAmBC,SAAO,EACzB/C,SAAAF,EAAAA,KAACsB,EAAA,CACCrB,UAAU,iBACViD,QAAS9S,EAAA,IAAMwO,EAAc,gCAApB,WAETsB,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACY,GAAA,CAAUjB,UAAU,yBACrBK,EAAAA,IAACiB,EAAA,CAAUtB,UAAU,eAAeC,SAAA,yCAGpCI,EAAAA,IAAC8B,GAAMhC,QAAQ,UAAUH,UAAU,8BAChCC,SAAA7K,EAAQmJ,6BAA6B5L,YAGzCwL,EAAiBI,6BAChB8B,MAAC6C,GAAA,CAAUlD,UAAU,cAErBK,IAAC8C,GAAA,CAAYnD,UAAU,iBAG3BK,IAACkB,GAAgBtB,SAAA,gEAKrBI,MAAC+C,GAAA,CACCnD,SAAAF,EAAAA,KAACyB,EAAA,CAAYxB,UAAU,YACrBC,SAAA,CAAAF,OAACG,GAAA,CACCD,SAAA,GAAAI,IAACmD,GAAA,CAAWxD,UAAU,cACtBK,IAACC,IAAWL,SAAA,sCACZI,IAACK,IAAiBT,SAAA,wLAOpBF,KAAC,MAAA,CAAIC,UAAU,8BACbC,SAAA,CAAAI,EAAAA,IAACoD,GAAA,CACC3J,GAAG,+BACH4J,QAASpJ,EAAqB/C,mCAC9BoM,gBAAiBxT,EAACuT,GAChBhF,EAAyBG,IAAA,IACpBA,EACHtH,oCAAgD,IAAZmM,KAHvB,qBAOnB3D,EAAAA,KAAC6D,EAAA,CACCC,QAAQ,+BACR7D,UAAU,6FACXC,SAAA,CAAA,wCACuC,IACrC7K,EAAQmJ,6BAA6B5L,OAAO,yBAIjDoN,KAAC,MAAA,CAAIC,UAAU,qCACZC,SAAA,CAAA7K,EAAQmJ,6BAA6B3L,MAAM,EAAG,IAAI5B,IAAI,CAACsS,EAAKhQ,IAC3DyM,EAAAA,KAAC,MAAA,CAECC,UAAU,2DAEVC,SAAA,GAAAI,IAACY,GAAA,CAAUjB,UAAU,qDACpB,MAAA,CACCC,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,cAAeC,SAAAqD,EAAIxU,sBACnCiR,KAAC,OAAA,CAAKC,UAAU,wBAAwBC,SAAA,CAAA,SAAOqD,EAAIpQ,IAAI,YANpDI,IAUR8B,EAAQmJ,6BAA6B5L,OAAS,IAC7CoN,EAAAA,KAAC,MAAA,CAAIC,UAAU,iDAAiDC,SAAA,CAAA,WACrD7K,EAAQmJ,6BAA6B5L,OAAS,GAAG,wBAWzEyC,EAAQoJ,4BAA8BpJ,EAAQoJ,2BAA2B7L,OAAS,GACjF0N,EAAAA,IAACwC,GAAA,CAAYC,KAAM3E,EAAiBK,2BAClCyB,SAAAF,EAAAA,KAACqB,EAAA,CAAKpB,UAAU,oBACdC,SAAA,GAAAI,IAAC0C,GAAA,CAAmBC,SAAO,EACzB/C,SAAAF,EAAAA,KAACsB,EAAA,CACCrB,UAAU,iBACViD,QAAS9S,EAAA,IAAMwO,EAAc,8BAApB,WAETsB,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACM,GAAA,CAAKX,UAAU,yBAChBK,EAAAA,IAACiB,EAAA,CAAUtB,UAAU,eAAeC,SAAA,oCACpCI,EAAAA,IAAC8B,GAAMhC,QAAQ,UAAUH,UAAU,8BAChCC,SAAA7K,EAAQoJ,2BAA2B7L,YAGvCwL,EAAiBK,2BAChB6B,MAAC6C,GAAA,CAAUlD,UAAU,cAErBK,IAAC8C,GAAA,CAAYnD,UAAU,iBAG3BK,IAACkB,GAAgBtB,SAAA,2DAGrBI,MAAC+C,GAAA,CACCnD,SAAAF,EAAAA,KAACyB,EAAA,CAAYxB,UAAU,YACrBC,SAAA,CAAAF,OAACG,GAAA,CACCD,SAAA,GAAAI,IAACG,GAAA,CAAcR,UAAU,cACzBK,IAACC,IAAWL,SAAA,yBACZI,IAACK,IAAiBT,SAAA,oMAOpBF,KAAC,MAAA,CAAIC,UAAU,8BACbC,SAAA,CAAAI,EAAAA,IAACoD,GAAA,CACC3J,GAAG,+BACH4J,QAASpJ,EAAqB9C,iCAC9BmM,gBAAiBxT,EAACuT,GAChBhF,EAAyBG,IAAA,IACpBA,EACHrH,kCAA8C,IAAZkM,KAHrB,qBAOnB3D,EAAAA,KAAC6D,EAAA,CACCC,QAAQ,+BACR7D,UAAU,6FACXC,SAAA,CAAA,gBACe7K,EAAQoJ,2BAA2B7L,OAAO,2BAI5DoN,KAAC,MAAA,CAAIC,UAAU,qCACZC,SAAA,CAAA7K,EAAQoJ,2BAA2B5L,MAAM,EAAG,IAAI5B,IAAI,CAACmC,EAASG,IAC7DyM,EAAAA,KAAC,MAAA,CAECC,UAAU,2DAEVC,SAAA,GAAAI,IAACM,GAAA,CAAKX,UAAU,qDACf,MAAA,CACCC,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,cAAeC,SAAA9M,EAAQwG,OACtCxG,EAAQrE,mBACPiR,OAAC,OAAA,CAAKC,UAAU,wBACbC,SAAA,CAAA,IAAI,MACD9M,EAAQrE,uBAGhBiR,KAAC,OAAA,CAAKC,UAAU,wBAAwBC,SAAA,CAAA,SAAO9M,EAAQD,IAAI,YAZxDI,IAgBR8B,EAAQoJ,2BAA2B7L,OAAS,IAC3CoN,EAAAA,KAAC,MAAA,CAAIC,UAAU,iDAAiDC,SAAA,CAAA,WACrD7K,EAAQoJ,2BAA2B7L,OAAS,GAAG,0BAWxEoN,KAAC+D,EAAA,CAAa9D,UAAU,QACtBC,SAAA,CAAAI,MAAC0D,EAAA,CAAO5D,QAAQ,UAAU8C,QAASlF,EAAUkC,SAAA,WAG5C7K,EAAQ4O,sBAAwB,GAAKhG,UACnC+F,EAAA,CAAO5D,QAAQ,UAAU8C,QAASjF,EAASiC,SAAA,CAAA,oBACxB7K,EAAQ4O,sBAAsB,iBAGpDjE,EAAAA,KAACgE,EAAA,CACC5D,QAAQ,UACR8C,QAAS9S,EAAA,IAAM2N,EAAWxD,GAAjB,WACT2J,SAAiC,IAAvB7O,EAAQwL,YAAoBd,EACvCG,SAAA,CAAA,oBACmB7K,EAAQwL,WAAW,qBAK/C,CCpxBO,SAASsD,IAAoBpB,KAClCA,EAAAqB,QACAA,EAAAC,QACAA,EAAAlM,OACAA,EAAAmM,WACAA,GAAa,IAEb,MAAMC,EACJpM,EAAOwC,eAAiB,EAAI6J,KAAKC,MAAOtM,EAAOsC,aAAetC,EAAOwC,eAAkB,KAAO,EAE1F0F,EAAYlI,EAAO0E,YAAc,GAAK1E,EAAOuC,aAAe,EAC5DgK,EAAavM,EAAOsC,eAAiBtC,EAAOwC,eAG5CgK,IAAkBC,IACtB,MAAMC,EAAUL,KAAKM,MAAOF,EAAK,IAAQ,IACnCG,EAAUP,KAAKM,MAAOF,EAAA,IAAoB,IAC1CI,EAAQR,KAAKM,MAAMF,EAAA,MAEzB,OAAII,EAAQ,EACH,GAAGA,MAAUD,MAAYF,KAE9BE,EAAU,EACL,GAAGA,MAAYF,KAEjB,GAAGA,MAXW,kBAcjBI,EAAuB7U,EAAA,KAE3B,MAAM8U,EAAa,CACjB,CACE,MACA,gBACA,aACA,YACA,eACA,QACA,eACA,eACA,gBACA,eACA,eACA,gBACA,eACA,YAEC/M,EAAOlC,OAAOhF,IAAK0E,GAAU,CAC9BA,EAAMxC,IAAIgS,WACVxP,EAAMM,OAAOhF,IAAKmU,GAAM,GAAGA,EAAE/S,UAAU+S,EAAEtM,WAAWhG,KAAK,MACzD6C,EAAMD,KAAK7G,YAAc,GACzB8G,EAAMD,KAAK5G,WAAa,GACxB6G,EAAMD,KAAK3G,mBAAqB,GAChC4G,EAAMD,KAAKnG,OAAS,GACpBoG,EAAMD,KAAKzG,YAAc,GACzB0G,EAAMD,KAAKxG,YAAc,GACzByG,EAAMD,KAAKvG,aAAe,GAC1BwG,EAAMD,KAAKtG,YAAc,GACzBuG,EAAMD,KAAKrG,YAAc,GACzBsG,EAAMD,KAAKpG,aAAe,GAC1BqG,EAAMD,KAAK7F,cAAgB,GAC3B8F,EAAMD,KAAK5F,OAAS,MAGrBmB,IAAKkC,GAAQA,EAAIlC,IAAKoU,GAAS,IAAIzP,OAAOyP,GAAMlV,QAAQ,KAAM,UAAU2C,KAAK,MAC7EA,KAAK,MAGFwS,EAAO,IAAIC,KAAK,CAACL,GAAa,CAAErJ,KAAM,4BACtC2J,EAAOC,SAASC,cAAc,KAC9BC,EAAMC,IAAIC,gBAAgBP,GAChCE,EAAKM,aAAa,OAAQH,GAC1BH,EAAKM,aAAa,WAAY,kBAAA,IAAqBtP,MAAOyC,cAActG,MAAM,KAAK,UACnF6S,EAAKO,MAAMC,WAAa,SACxBP,SAAShJ,KAAKwJ,YAAYT,GAC1BA,EAAKU,QACLT,SAAShJ,KAAK0J,YAAYX,IAhDC,wBAmD7B,OACElF,EAAAA,IAAC8F,GAAOrD,OAAYsD,aAAcjC,EAChClE,SAAAF,EAAAA,KAACsG,GAAA,CAAcrG,UAAU,uDACvBC,SAAA,CAAAF,OAACuG,GAAA,CACCrG,SAAA,CAAAI,MAACkG,GAAA,CAAYvG,UAAU,0BACpBC,SAAAwE,EACC1E,EAAAA,KAAAQ,WAAA,CACEN,SAAA,GAAAI,IAACmG,GAAA,CAAaxG,UAAU,yBAAyB,mCAGjDI,IACFL,KAAAQ,EAAAA,SAAA,CACEN,SAAA,GAAAI,IAACG,GAAA,CAAcR,UAAU,yBAAyB,kCAIpDD,EAAAA,KAAAQ,EAAAA,SAAA,CACEN,SAAA,GAAAI,IAACmG,GAAA,CAAaxG,UAAU,yBAAyB,+BAKtDyG,GAAA,CAAkBxG,SAAA,CAAA,aACN/H,EAAOwC,eAAegM,iBAAiB,eAAa,IAC9DhC,EAAexM,EAAO2E,kBAI3BkD,KAAC,MAAA,CAAIC,UAAU,wCAEbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,wCACbC,SAAA,CAAAI,EAAAA,IAAC,OAAIL,UAAU,wBACbC,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,CAAAF,OAAC,MAAA,CACCE,SAAA,CAAAI,EAAAA,IAAC,IAAA,CAAEL,UAAU,gCAAgCC,SAAA,qBAC5C,IAAA,CAAED,UAAU,sCACVC,SAAA/H,EAAOsC,aAAakM,wBAGzBrG,IAACmG,GAAA,CAAaxG,UAAU,iDAI3B,MAAA,CAAIA,UAAU,wBACbC,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,CAAAF,OAAC,MAAA,CACCE,SAAA,CAAAI,EAAAA,IAAC,IAAA,CAAEL,UAAU,gCAAgCC,SAAA,kBAC5C,IAAA,CAAED,UAAU,sCACVC,SAAA/H,EAAOuC,aAAaiM,wBAGzBrG,IAACG,GAAA,CAAcR,UAAU,iDAI5B,MAAA,CAAIA,UAAU,wBACbC,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,CAAAF,OAAC,MAAA,CACCE,SAAA,CAAAI,EAAAA,IAAC,IAAA,CAAEL,UAAU,gCAAgCC,SAAA,iBAC5C,IAAA,CAAED,UAAU,oCACVC,SAAA/H,EAAO0E,YAAY8J,wBAGxBrG,IAACsG,GAAA,CAAE3G,UAAU,8CAMnBD,KAAC,MAAA,CAAIC,UAAU,YACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,sBAAsBC,SAAA,mBACtCF,KAAC,OAAA,CAAKC,UAAU,gCAAiCC,SAAA,CAAAqE,EAAY,YAE/DjE,IAAC,MAAA,CAAIL,UAAU,4CACbC,SAAAI,EAAAA,IAAC,MAAA,CACCL,UAAW,0BACTsE,GAAe,GAAK,aAAeA,GAAe,GAAK,aAAe,YAExEwB,MAAO,CAAEc,MAAO,GAAGtC,eAMzBvE,KAAC,MAAA,CAAIC,UAAU,kCACbC,SAAA,GAAAF,KAAC,KAAA,CAAGC,UAAU,sCACZC,SAAA,GAAAI,IAACwG,GAAA,CAAM7G,UAAU,YAAY,2BAG/BD,KAAC,MAAA,CAAIC,UAAU,iCACbC,SAAA,CAAAF,OAAC,MAAA,CACCE,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,oBAAuB,UAC9D,OAAA,CAAKD,UAAU,cAAeC,SAAAyE,EAAexM,EAAO2E,sBAEtD,MAAA,CACCoD,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,sBAAyB,UAChE,OAAA,CAAKD,UAAU,cACbC,SAAA/H,EAAO2E,SAAW,EACf,GAAG0H,KAAKC,MAAOtM,EAAOwC,eAAiBxC,EAAO2E,SAAY,oBAC1D,WAGP3E,EAAOqC,WACNwF,EAAAA,KAAC,MAAA,CACCE,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,gBAAmB,UAC1D,OAAA,CAAKD,UAAU,cAAeC,SAAA/H,EAAOqC,UAAUuM,0BAGnD5O,EAAOyE,SACNoD,EAAAA,KAAC,MAAA,CACCE,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,kBAAqB,UAC5D,OAAA,CAAKD,UAAU,cAAeC,SAAA/H,EAAOyE,QAAQmK,gCAOrD1G,GAAalI,EAAOlC,OAAOrD,OAAS,GACnCoN,OAAC,MAAA,CAAIC,UAAU,kCACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,GAAAF,KAAC,KAAA,CAAGC,UAAU,sCACZC,SAAA,GAAAI,IAACS,GAAA,CAAYd,UAAU,YAAY,qBAChB9H,EAAOlC,OAAOrD,OAAO,SAE1C0N,IAAC,MAAA,CAAIL,UAAU,aACbC,SAAAF,EAAAA,KAACgE,EAAA,CACC5D,QAAQ,UACRrI,KAAK,KACLmL,QAAS+B,EACThF,UAAU,QAEVC,SAAA,GAAAI,IAAC0G,GAAA,CAAS/G,UAAU,YAAY,iBAMtCK,EAAAA,IAAC,OAAIL,UAAU,yCACZC,WAAOjK,OAAOhF,IAAK0E,GAClBqK,EAAAA,KAAC,MAAA,CAECC,UAAU,yEAEVC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,CAAAF,EAAAA,KAACoC,EAAA,CAAMhC,QAAQ,UAAUH,UAAU,UAAUC,SAAA,CAAA,OACtCvK,EAAMxC,SAEb6M,KAAC,OAAA,CAAKC,UAAU,sBACbC,SAAA,CAAAvK,EAAMD,KAAK7G,YAAc,kBAAmB,IAC5C8G,EAAMD,KAAK5G,WAAa,yBAG7BwR,IAAC,KAAA,CAAGL,UAAU,0DACXC,SAAAvK,EAAMM,OAAOhF,IAAI,CAACgW,EAAY1T,MAC7ByM,KAAC,KAAA,CACCE,SAAA,GAAAF,KAAC,OAAA,CAAKC,UAAU,2BACbC,SAAA,CAAA+G,EAAW5U,MAAMlC,QAAQ,KAAM,KAAK,OAC/B,IACP8W,EAAWnO,QACXmO,EAAW9U,OACV6N,OAAC,OAAA,CAAKC,UAAU,oCAAoCC,SAAA,CAAA,UAC1CtK,OAAOqR,EAAW9U,OAAO,UAP9BoB,QAdRoC,EAAMxC,WAkCpBgF,EAAOuC,aAAe,KACrBsF,KAACG,GAAA,CACCD,SAAA,GAAAI,IAACG,GAAA,CAAcR,UAAU,cACzBK,IAACC,IAAWL,SAAA,wBACXS,GAAA,CACET,SAAA,CAAA/H,EAAOuC,aAAa,IAA0B,IAAxBvC,EAAOuC,aAAqB,UAAY,YAAY,0KAQnF4F,MAACyD,EAAA,CACC7D,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,oCACbC,SAAA,CAAAI,MAAC,MAAA,CAAIL,UAAU,aACZC,SAAAG,GAAalI,EAAOlC,OAAOrD,OAAS,GACnCoN,OAACgE,GAAO5D,QAAQ,UAAU8C,QAAS+B,EAAsBhF,UAAU,QACjEC,SAAA,GAAAI,IAAC4G,GAAA,CAASjH,UAAU,YAAY,+BAKtCD,KAAC,MAAA,CAAIC,UAAU,aACZC,SAAA,CAAAoE,GAAcjE,GACbL,EAAAA,KAACgE,EAAA,CACC5D,QAAQ,UACR8C,QAAS9S,EAAA,KACPiU,MACAD,KAFO,WAITnE,UAAU,QAEVC,SAAA,GAAAI,IAAC6G,GAAA,CAAUlH,UAAU,YAAY,kBAIrCK,EAAAA,IAAC0D,EAAA,CAAOd,QAASkB,EAAShE,QAASsE,EAAa,UAAY,UACzDxE,SAAAwE,EAAa,OAAS,sBAQvC,CD9QgBtU,EAAA0N,GAAA,wBC/BA1N,EAAA+T,GAAA,uBCHT,SAASiD,GAAwBtR,GACtC,MAAMkF,MAAoBhK,IAE1B,IAAA,MAAWmC,KAAO2C,EAChB,GAAI3C,EAAIpE,kBAAmB,CACzB,MAAMsY,EAAUlU,EAAIpE,kBAAkBmB,OAClCmX,GACFrM,EAAcnD,IAAIwP,EAEtB,CAGF,OAAO1V,MAAMyP,KAAKpG,EACpB,CAoBO,SAASsM,GAAexR,GAC7B,MAAMlG,MAAWoB,IAEjB,IAAA,MAAWmC,KAAO2C,EAChB,GAAI3C,EAAIvD,KAAM,CACZ,MAAMmM,EAAU5I,EAAIvD,KAAK+C,MAAM,KAC/B,IAAA,MAAWqJ,KAAOD,EAAS,CACzB,MAAMsL,EAAUrL,EAAI9L,OAChBmX,GACFzX,EAAKiI,IAAIwP,EAEb,CACF,CAGF,OAAO1V,MAAMyP,KAAKxR,EACpB,CAgDO,SAAS2X,GACdzR,GAEA,MAAMP,EAAmC,GAEzC,IAAA,IAAShC,EAAQ,EAAGA,EAAQuC,EAAKlD,OAAQW,IAAS,CAChD,MAAMJ,EAAM2C,EAAKvC,GACbuD,GAAwB3D,IAC1BoC,EAAQsF,KAAK,CACX9L,kBAAmB6G,OAAOzC,EAAIpE,mBAAmBmB,OACjDiD,IAAKI,EAnIwB,GAsInC,CAEA,OAAOgC,CACT,CAsBO,SAASiS,GACd1R,GAEA,MAAMP,EAAqC,GAE3C,IAAA,IAAShC,EAAQ,EAAGA,EAAQuC,EAAKlD,OAAQW,IAAS,CAChD,MAAMJ,EAAM2C,EAAKvC,GACjB,GAAI2D,GAA4B/D,GAAM,CAEpC,MAAMT,EAAsB,GACxBS,EAAItE,YAAc+G,OAAOzC,EAAItE,YAAYqB,QAC3CwC,EAAUmI,KAAKjF,OAAOzC,EAAItE,YAAYqB,QAEpCiD,EAAIrE,WAAa8G,OAAOzC,EAAIrE,WAAWoB,QACzCwC,EAAUmI,KAAKjF,OAAOzC,EAAIrE,WAAWoB,QAEvC,MAAM0J,EAAOlH,EAAUE,OAAS,EAAIF,EAAUI,KAAK,KAAO,UAE1DyC,EAAQsF,KAAK,CACXjB,OACA7K,kBAAmBoE,EAAIpE,kBAAoB6G,OAAOzC,EAAIpE,mBAAmBmB,OAAS,GAClFiD,IAAKI,EApLwB,GAsLjC,CACF,CAEA,OAAOgC,CACT,CC7IO,SAASkS,KAEd,MAAOC,EAAYC,GAAiBhT,GAAAA,SAAmB,KAChDkB,EAAa+R,GAAkBjT,GAAAA,SAAkB,KACjDwJ,EAAe0J,GAAoBlT,GAAAA,SAAqC,IAAIrE,KAG7EwX,EAAiBtT,GAAAA,OAAiB,IAIxCuT,GAAAA,UAAU,KAENL,EAAW9U,OAAS,IACnBkV,EAAe/S,QAAQnC,SAAW8U,EAAW9U,SAC3C8U,EAAWM,MAAM,CAACC,EAAG5R,IAAM4R,IAAMH,EAAe/S,QAAQsB,OAG3DwR,EAAiB,IAAIvX,KACrBwX,EAAe/S,QAAU2S,IAE1B,CAACA,IAMJ,MAAM7V,EAAWgF,GAAAA,QAAuC,KACtD,GAA0B,IAAtB6Q,EAAW9U,OAAc,MAAO,CAAA,EAEpC,MAAMsV,EAAezW,GAAmBiW,GAClCS,EAA+C,CAAA,EAOrD,OALAT,EAAWrU,QAASrD,IAElBmY,EAAcnY,GAAUmO,EAAc5M,IAAIvB,IAAWkY,EAAalY,KAG7DmY,GACN,CAACT,EAAYvJ,IAMVlK,EAAW4C,GAAAA,QAA+B,IACzC6Q,EAAW9U,QAAWiD,EAAYjD,OAGhCe,GAA2B+T,EAAY7R,EAAahE,GAFlD,GAGR,CAAC6V,EAAY7R,EAAahE,IAOvBuW,EAActT,GAAAA,YAAY,CAACuT,EAAmBxU,KAClDgU,EAAkB/I,IAChB,MAAMwJ,EAAO,IAAIhY,IAAIwO,GAOrB,OANoB,OAAhBjL,GAAwC,KAAhBA,EAE1ByU,EAAKC,OAAOF,GAEZC,EAAKxX,IAAIuX,EAAWxU,GAEfyU,KAER,IAMGE,EAAa1T,GAAAA,YAAY,CAACpD,EAAmBoE,KACjD6R,EAAcjW,GACdkW,EAAe9R,IACd,IAMGjB,EAAQC,GAAAA,YAAY,KACxB+S,EAAiB,IAAIvX,KACrBqX,EAAc,IACdC,EAAe,IACfE,EAAe/S,QAAU,IACxB,IAEH,MAAO,CACLlD,WACA4W,UAAWtK,EACXlK,WACAvC,QAASgW,EACTU,cACAI,aACA3T,QACA6T,QAAShB,EAAW9U,OAAS,EAEjC,CDzHgBxC,EAAAgX,GAAA,2BAiCAhX,EAAAkX,GAAA,kBAgEAlX,EAAAmX,GAAA,oCAsCAnX,EAAAoX,GAAA,kCClHApX,EAAAqX,GAAA,oBCVT,MAAMkB,GAAgD,CAC3DhO,eAAgB,EAChBF,aAAc,EACdC,aAAc,EACdmC,YAAa,EACb5G,OAAQ,GACRuE,UAAW,MAsUN,SAASoO,GAAYzW,GAC1B,MAAM,IAAI6B,MAAM,yCAAyC6U,KAAKC,UAAU3W,KAC1E,CA4BO,SAAS4W,GACdnU,GAMA,MACiB,kBAAfA,EAAMoU,MACS,YAAfpU,EAAMoU,MACS,YAAfpU,EAAMoU,MACS,cAAfpU,EAAMoU,IAEV,CAKO,SAASC,GAAWrU,GACzB,MAAsB,aAAfA,EAAMoU,MAAsC,UAAfpU,EAAMoU,IAC5C,CAKO,SAASE,GACdtU,GAEA,MAAsB,YAAfA,EAAMoU,MAAqC,cAAfpU,EAAMoU,IAC3C,CAqBO,SAASG,GAAkBvU,GAChC,MAAO,CAELwU,YAA4B,YAAfxU,EAAMoU,KAEnBK,WAA2B,aAAfzU,EAAMoU,KAElBM,YAA4B,cAAf1U,EAAMoU,KAEnBO,UAA0B,YAAf3U,EAAMoU,KAEjBQ,SAAyB,UAAf5U,EAAMoU,KAEhBD,QAASA,GAAQnU,GAEjBqU,WAAYA,GAAWrU,GAEvBsU,aAAcA,GAAatU,GAE/B,CC9bO,SAAS6U,KACd,MAAO,CAAET,KAAM,OACjB,CAmBO,SAASU,GAAoB9U,EAAoB+U,GAEtD,GAAoB,UAAhBA,EAAO9N,KACT,MAvBK,CAAEmN,KAAM,QA2Bf,OAAQpU,EAAMoU,MACZ,IAAK,OACH,OAAOY,GAAgBhV,EAAO+U,GAEhC,IAAK,gBACH,OAAOE,GAAwBjV,EAAO+U,GAExC,IAAK,UACH,OAAOG,GAAmBlV,EAAO+U,GAEnC,IAAK,UACH,OAAOI,GAAmBnV,EAAO+U,GAEnC,IAAK,YACH,OAAOK,GAAqBpV,EAAO+U,GAErC,IAAK,WACH,OAAOM,GAAoBrV,GAE7B,IAAK,QACH,OAAOsV,GAAiBtV,GAE1B,QAEE,OAAOgU,GAAYhU,GAEzB,CAUA,SAASgV,GAAgBhV,EAAwB+U,GAC/C,MACO,gBADCA,EAAO9N,KAEJ,CACLmN,KAAM,gBACN/T,KAAM0U,EAAOQ,QAAQlV,KACrBmV,iBAAkBT,EAAOQ,QAAQC,iBACjCC,mBAAoBV,EAAOQ,QAAQE,oBAK9BzV,CAEb,CASA,SAASiV,GACPjV,EACA+U,GAEA,OAAQA,EAAO9N,MACb,IAAK,gBACH,MAAO,CACLmN,KAAM,UACN/T,KAAML,EAAMK,MAGhB,IAAK,aACH,MAlGG,CAAE+T,KAAM,QAoGb,IAAK,cAEH,MAAO,CACLA,KAAM,gBACN/T,KAAM0U,EAAOQ,QAAQlV,KACrBmV,iBAAkBT,EAAOQ,QAAQC,iBACjCC,mBAAoBV,EAAOQ,QAAQE,oBAGvC,QACE,OAAOzV,EAEb,CASA,SAASkV,GAAmBlV,EAA2B+U,GACrD,OAAQA,EAAO9N,MACb,IAAK,mBACH,MAAO,CACLmN,KAAM,UACN/T,KAAML,EAAMK,KACZqV,YAAaX,EAAOQ,QAAQG,YAC5B/P,qBAAsB,CACpB/C,oCAAoC,EACpCC,kCAAkC,IAIxC,IAAK,iBACH,MAAO,CACLuR,KAAM,QACNrT,MAAOgU,EAAOQ,QAAQxU,MACtB4U,aAAc,WAGlB,IAAK,SACH,MA9IG,CAAEvB,KAAM,QAgJb,QACE,OAAOpU,EAEb,CAUA,SAASmV,GAAmBnV,EAA2B+U,GACrD,OAAQA,EAAO9N,MACb,IAAK,eACH,MAAO,CACLmN,KAAM,YACN/T,KAAML,EAAMK,KACZuV,SAAU,CACR1K,MAAO,EACP2K,MAAOd,EAAOQ,QAAQO,eAExBC,YAAa,IACRhC,GACHnO,cAAehE,MAEjBoU,UAAW,GAGf,IAAK,iBACH,MAAO,IACFhW,EACH0V,YAAaX,EAAOQ,QAAQG,aAGhC,IAAK,gCACH,MAAO,IACF1V,EACH2F,qBAAsBoP,EAAOQ,QAAQ5S,WAGzC,IAAK,SACH,MA3LG,CAAEyR,KAAM,QA6Lb,QACE,OAAOpU,EAEb,CAWA,SAASoV,GAAqBpV,EAA6B+U,GACzD,OAAQA,EAAO9N,MACb,IAAK,kBACH,MAAO,IACFjH,EACH4V,SAAU,IACL5V,EAAM4V,SACT1K,MAAO6J,EAAOQ,QAAQrK,QAI5B,IAAK,oBAAqB,CACxB,MAAM+K,eAAEA,eAAgBC,EAAAC,aAAcA,EAAAC,YAAcA,cAAaC,EAAA9W,UAAaA,GAC5EwV,EAAOQ,QAET,MAAO,IACFvV,EACH+V,YAAa,IACR/V,EAAM+V,YACThQ,eAAgB/F,EAAM+V,YAAYhQ,eAAiBkQ,EACnDpQ,aAAc7F,EAAM+V,YAAYlQ,aAAeqQ,EAC/CpQ,aAAc9F,EAAM+V,YAAYjQ,aAAeqQ,EAC/ClO,YAAajI,EAAM+V,YAAY9N,YAAcmO,EAC7C/U,OAAQ,IAAIrB,EAAM+V,YAAY1U,UAAWgV,IAE3CL,UAAWhW,EAAMgW,UAAYzW,EAEjC,CAEA,IAAK,kBAAmB,CACtB,MAAMyI,MAAcpG,KACdgE,EAAY5F,EAAM+V,YAAYnQ,WAAaoC,EAC3CE,EAAWF,EAAQG,UAAYvC,EAAUuC,UAa/C,MAAO,CACLiM,KAAM,WACN7Q,OAb2B,CAC3BwC,eAAgB/F,EAAM+V,YAAYhQ,eAClCF,aAAc7F,EAAM+V,YAAYlQ,aAChCC,aAAc9F,EAAM+V,YAAYjQ,aAChCmC,YAAajI,EAAM+V,YAAY9N,YAC/B5G,OAAQrB,EAAM+V,YAAY1U,OAC1B6G,WACAtC,YACAoC,WAOJ,CAEA,IAAK,gBACH,MAAO,CACLoM,KAAM,QACNrT,MAAOgU,EAAOQ,QAAQxU,MACtB4U,aAAc,aAGlB,IAAK,SACH,MAtQG,CAAEvB,KAAM,QAwQb,QACE,OAAOpU,EAEb,CAMA,SAASqV,GAAoBrV,EAA4BsW,GAEvD,OAAOtW,CACT,CAMA,SAASsV,GAAiBtV,EAAyBsW,GAEjD,OAAOtW,CACT,CAUO,SAASuW,GAAoBC,GAClC,MAAO,CAILC,cACEpW,EACAmV,EAAyC,GACzCC,EAA+B,MAE/Be,EAAS,CACPvP,KAAM,cACNsO,QAAS,CAAElV,OAAMmV,mBAAkBC,yBAP3B,cAcZiB,UAAWlb,EAAA,KACTgb,EAAS,CAAEvP,KAAM,gBADR,aAOX0P,aAAcnb,EAAA,KACZgb,EAAS,CAAEvP,KAAM,mBADL,gBAOd2P,kBAAkBlB,IAChBc,EAAS,CAAEvP,KAAM,mBAAoBsO,QAAS,CAAEG,kBADjC,mBAOjBmB,gBAAgB9V,IACdyV,EAAS,CAAEvP,KAAM,iBAAkBsO,QAAS,CAAExU,YADjC,iBAOf+V,gBAAgBpB,IACdc,EAAS,CAAEvP,KAAM,iBAAkBsO,QAAS,CAAEG,kBADjC,iBAOfqB,6BAA6BpU,IAI3B6T,EAAS,CAAEvP,KAAM,gCAAiCsO,QAAS,CAAE5S,gBAJnC,8BAU5BqU,cAAclB,IACZU,EAAS,CAAEvP,KAAM,eAAgBsO,QAAS,CAAEO,oBADjC,eAObmB,iBAAiB/L,IACfsL,EAAS,CAAEvP,KAAM,kBAAmBsO,QAAS,CAAErK,YADjC,kBAOhBgM,mBAAmB3B,IAYjBiB,EAAS,CAAEvP,KAAM,oBAAqBsO,aAZtB,oBAkBlB4B,eAAgB3b,EAAA,KACdgb,EAAS,CAAEvP,KAAM,qBADH,kBAOhBmQ,eAAerW,IACbyV,EAAS,CAAEvP,KAAM,gBAAiBsO,QAAS,CAAExU,YADjC,gBAOdsW,OAAQ7b,EAAA,KACNgb,EAAS,CAAEvP,KAAM,YADX,UAORhH,MAAOzE,EAAA,KACLgb,EAAS,CAAEvP,KAAM,WADZ,SAIX,CAyCO,SAASqQ,KACd,MAAOtX,EAAOwW,GAAYe,GAAAA,WAAWzC,QAAqB,EAAWD,IAG/D2C,EAAqB5X,GAAAA,OAA+B,MAMpD6X,EAAwBvX,GAAAA,YAAY,KAEpCsX,EAAmBrX,SACrBqX,EAAmBrX,QAAQuX,QAG7BF,EAAmBrX,QAAU,IAAIwX,gBAC1BH,EAAmBrX,SACzB,IAKGyX,EAAwB1X,GAAAA,YAAY,KACpCsX,EAAmBrX,UACrBqX,EAAmBrX,QAAQuX,QAC3BF,EAAmBrX,QAAU,OAE9B,IAMG0X,EAAY3X,GAAAA,YAAY,IACrBsX,EAAmBrX,SAAS2X,OAAOC,UAAW,EACpD,IAMGC,EAAiB9X,GAAAA,YAAY,IAC1BsX,EAAmBrX,SAAS2X,QAAU,KAC5C,IAGH3E,GAAAA,UAAU,IACD,KACDqE,EAAmBrX,UACrBqX,EAAmBrX,QAAQuX,QAC3BF,EAAmBrX,QAAU,OAGhC,IAGH,MAAM8X,EAAUhW,GAAAA,QAAQ,KACtB,MAAMiW,EAAc3B,GAAoBC,GAExC,MAAO,IACF0B,EAMHvB,aAAcnb,EAAA,KACZic,IACAS,EAAYvB,gBAFA,gBASdK,cAAclB,IACZ2B,IACAS,EAAYlB,YAAYlB,IAFb,eASbuB,OAAQ7b,EAAA,KACNoc,IACAM,EAAYb,UAFN,UASRpX,MAAOzE,EAAA,KACLoc,IACAM,EAAYjY,SAFP,WAKR,CAACwX,EAAuBG,IAGrBO,EAAQlW,GAAAA,QAAQ,IAAMsS,GAAkBvU,GAAQ,CAACA,IAEvD,MAAO,CACLA,QACAiY,UACAE,QACA3B,WAEA4B,YAAaJ,IACbH,YACAG,iBAEJ,CDjOgBxc,EAAAwY,GAAA,eA8BAxY,EAAA2Y,GAAA,WAkBA3Y,EAAA6Y,GAAA,cAOA7Y,EAAA8Y,GAAA,gBAyBA9Y,EAAA+Y,GAAA,qBC3aA/Y,EAAAqZ,GAAA,sBAqBArZ,EAAAsZ,GAAA,uBA2CPtZ,EAAAwZ,GAAA,mBAuBAxZ,EAAAyZ,GAAA,2BAmCAzZ,EAAA0Z,GAAA,sBAoCA1Z,EAAA2Z,GAAA,sBA8CA3Z,EAAA4Z,GAAA,wBAsEA5Z,EAAA6Z,GAAA,uBASA7Z,EAAA8Z,GAAA,oBAaO9Z,EAAA+a,GAAA,uBAkKA/a,EAAA8b,GAAA,uMC9cT,MAAMe,GAAN,MAGL,WAAAC,CAAYC,GAFZC,GAAAC,KAAQ,UAGNA,KAAKF,OAASA,CAChB,CAOA,UAAAG,GACE,MAAM1Y,EAAQyY,KAAKE,WACb9W,EAAMD,KAAKC,MAGX+W,EAAgB5Y,EAAM6Y,SAAStc,OAAQuc,GAASjX,EAAMiX,EAAOL,KAAKF,OAAOQ,UAE/E,OAAIH,EAAc5a,OAASya,KAAKF,OAAOS,cAErCJ,EAAc3S,KAAKpE,GACnB4W,KAAKQ,SAAS,CACZJ,SAAUD,EACVM,aAAcN,EAAc,MAEvB,EAIX,CAOA,YAAAO,GACE,MAAMnZ,EAAQyY,KAAKE,WACb9W,EAAMD,KAAKC,MACX+W,EAAgB5Y,EAAM6Y,SAAStc,OAAQuc,GAASjX,EAAMiX,EAAOL,KAAKF,OAAOQ,UAC/E,OAAOnJ,KAAKwJ,IAAI,EAAGX,KAAKF,OAAOS,YAAcJ,EAAc5a,OAC7D,CAOA,YAAAqb,GACE,MAAMrZ,EAAQyY,KAAKE,WACnB,GAA8B,IAA1B3Y,EAAM6Y,SAAS7a,OAAc,OAAO,EAExC,MAAM6D,EAAMD,KAAKC,MACXyX,EAAgBtZ,EAAM6Y,SAAS,GACrC,OAAOjJ,KAAKwJ,IAAI,EAAGX,KAAKF,OAAOQ,UAAYlX,EAAMyX,GACnD,CAOA,qBAAAC,GACE,MAAMvJ,EAAKyI,KAAKY,eAChB,GAAW,IAAPrJ,EAAU,MAAO,MAErB,MAAMG,EAAUP,KAAK4J,KAAKxJ,EAAK,KAC/B,GAAIG,EAAU,GAAI,MAAO,GAAGA,WAAiBA,EAAU,EAAI,IAAM,KAEjE,MAAMC,EAAQR,KAAK4J,KAAKrJ,EAAU,IAClC,MAAO,GAAGC,SAAaA,EAAQ,EAAI,IAAM,IAC3C,CAKA,KAAAnQ,GACEwZ,eAAeC,WAAWjB,KAAKF,OAAOoB,WACxC,CAKQ,QAAAhB,GACN,IACE,MAAMiB,EAASH,eAAeI,QAAQpB,KAAKF,OAAOoB,YAClD,GAAIC,EACF,OAAO3F,KAAK3J,MAAMsP,EAEtB,OAASpJ,GAET,CAEA,MAAO,CAAEqI,SAAU,GAAIK,aAActX,KAAKC,MAC5C,CAKQ,QAAAoX,CAASjZ,GACf,IACEyZ,eAAeK,QAAQrB,KAAKF,OAAOoB,WAAY1F,KAAKC,UAAUlU,GAChE,OAASwQ,GAET,CACF,GA1G6BhV,EAAA6c,GAAA,qBAAxB,IAAM0B,GAAN1B,GAqHA,MAAM2B,GAAuB,IAAID,GAAkB,CACxDf,YAAa,GACbD,SAAU,MACVY,WAAY,8BAO2B,IAAII,GAAkB,CAC7Df,YAAa,GACbD,SAAU,MACVY,WAAY,mCCtJd,MAEaM,KAAaC,IACxB,MAAMC,SACJA,EAAAC,aACAA,EACAC,OAAAA,EAAAA,MACA7c,EAAA8c,WACAA,EACAtV,KAAMuV,EACNC,OAAQC,EACRC,SAAUC,EAAArQ,MACVA,EAAAlC,SACAA,EAAAiF,OACAA,EAAAuN,SACAA,EAAAC,SACAA,EAAAvL,SACAA,EAAAwL,OAEAA,EAAAC,QACAA,EAAAC,QACAA,EAAAC,SACAA,GAAW,EAAAzV,QACXA,EAAU,CAAA,EAAA8F,SAEVA,EAAAD,UACAA,EACA6P,WAAYC,EAEZC,SAAUC,EAAAC,oBACVA,EAAAzN,YAEAA,EAAA0N,cACAA,EAAgB,+BAAAC,YAChBA,EAAc,8BAAAC,WACdA,KACGC,GACDxB,GACIyB,OAAQC,GAAepW,EACzBqW,EAAYC,IAGZC,IAAiB1b,IACrB,KAAMA,aAAgB2b,MACpB,OAAO3b,EAUT,MANyC,CACvC4b,QAAS5b,EACT6b,IAHclL,IAAIC,gBAAgB5Q,GAIlC1F,MAAO0F,EAAK2E,OATM,iBAehBmX,IAAkBC,GACjBA,EAIDrf,MAAMC,QAAQof,GACTA,EAAM/f,IAAI0f,GAGZA,EAAcK,GAPZnB,EAAW,GAAK,KAFJ,mBAYjB9V,GACJA,EACA1H,OAAOid,SAAEA,EAAAF,OAAUA,EAAAjd,MAAQA,OAAOyH,GAAAqX,WAClCA,GACEC,EAAS,CACXnC,WACAC,eACAC,OAAQA,GAAU8B,EAClB3e,QACA8c,aACAtV,KAAMuV,EACNC,OAAQC,EACRC,SAAUC,EACVrQ,MAAOA,GAAS6R,EAChB/T,WACAiF,SACAuN,WACAC,WACAvL,aAEI8M,EAAQ7e,EAASR,MAAMC,QAAQO,GAASA,EAAQ,CAACA,GAAU,GAE3Doe,EAASngB,EAAA,CAAC+gB,EAAiBC,EAAgCC,KAC/D,MAAMC,EAAezB,EAAW,IAAImB,KAAUG,GAAY,IAAIA,GAE1DtB,GACFP,EAASgC,GACTlC,MAEAE,EAASgC,EAAa,IACtBlC,KAGEoB,GACFA,EAAWW,EAAUC,EAAeC,IAZzB,UAgBTrB,EAAW5f,EAAC6E,GAAcuE,UAC9B,GAAI0W,EACF,UACQA,EAAoBjb,EAC5B,CAAA,MACE,MACF,CAGF,GAAI4a,EAAU,CACZ,MAAM0B,EAAgBP,EAAM7f,OAAQqgB,IAAeC,EAAaD,EAAWvc,IAC3Eqa,EAASiC,GACTnC,GACF,MACEE,EAAS,MACTF,IAGEa,GACFA,EAAahb,IAnBA,YAuBXyc,EACJxR,GAAYyR,GAAAA,eAAeC,GAAAA,SAASC,KAAK3R,IACpC0R,GAAAA,SAASC,KAAK3R,QACf,GAEA4R,aAAEA,EAAAC,cAAcA,EAAAC,eAAeA,GAAmBC,GAAY,CAClEvC,SACAC,QAASA,GAzIiB,QA0I1BC,UACAC,WACA3L,SAAUA,GAAYuL,EAEtByC,YAAYjd,GACNA,EAAK2E,KAAKhH,OAAS,IACd,CAAEuf,KAAM,gBAAiBrZ,QAAS,mCAEvC,eAAesZ,KAAKnd,EAAK2E,MACpB,CAAEuY,KAAM,gBAAiBrZ,QAAS,wCAEpC,KAPE,gBASRsB,EACHmW,WAGF,OACEvQ,EAAAA,KAACqS,GAAA,CACCtY,KACAH,OACAqG,UAAWqS,GAAG,SAAUrS,MACpBsS,GAAuBjC,GAE3BpQ,SAAA,CAAAI,EAAAA,IAACkS,GAAA,CACC1O,QAAS/J,EACTkG,UAAWiE,GAAYuL,EAAW,iBAAmB,iBAErDvP,WAAAI,IAACmS,EAAA,CAAWrgB,QAAc6P,SAAgBjF,WAAoBiU,iBAGhEjR,EAAAA,KAAC,MAAA,IACK8R,EAAa,CACf7R,UAAWqS,GACT,mFACA,gGACApO,GAAYuL,EACR,8BACA,iDAENiD,KAAM,SACN,aAAyBjC,EAAXZ,EAAqBM,EAA2BC,GAC9DuC,SAAUzO,GAAYuL,GAAW,EAAK,IAGxCvP,SAAA,CAAAI,EAAAA,IAAC,QAAA,CACCvG,KACAH,UACImY,EAAc,IACbhC,MAINtN,IAEGoN,EACFvP,EAAAA,IAAC,IAAA,CAAEL,UAAU,UAAWC,SAAAuQ,EAAUN,KAElC7P,MAAC,IAAA,CAAEL,UAAU,UAAWC,SAAAuQ,EAAUL,SAIrC4B,EAAepf,OAAS,GACvB0N,EAAAA,IAAC,KAAA,CACCoS,KAAK,QACL,YAAU,SACVzS,UAAU,+CAETC,SAAA8R,EAAe/gB,IAAI,EAAGgE,OAAMgB,mBAC1B,KAAA,CACEiK,SAAA,CAAAjL,EAAK2E,KAAK,KAAG3D,EAAOhF,IAAKmU,GAAMA,EAAEtM,SAAShG,KAAK,QADzCmC,EAAK2E,SAOpB0G,MAACsS,IAAgB1D,qBAChB2D,GAAA,IAEA3S,SACE,MAAA,CAAID,UAAU,+BACZC,SAAA8Q,EAAM/f,IAAI,CAACgE,EAAW1B,IACrB+M,EAAAA,IAACwS,GAAA,CAEC7d,OACA+a,SAAUA,EAAS/a,GACnBob,aAEAnQ,WAAAI,IAACyS,EAAA,CAAsB5gB,MAAO8C,EAAOiL,SAAAwR,KALhCne,UA3NM,aAkQZuf,KAAoBhE,IAC/B,MAAM7O,UACJA,EAAAC,SACAA,EAAAjL,KAEAA,EAAA+a,SACAA,EACAK,WAAY2C,EAAaC,MAEtB3C,GACDxB,EAEE2B,EAAYC,IAYlB,OAVA3I,GAAAA,UAAU,IACD,KACL,MAAM1S,EAAUJ,EAAK4b,QAAU5b,EAAK4b,QAAQxb,QAAUJ,EAAKI,QAEvDA,GACF6d,OAAOtN,IAAIuN,gBAAgB9d,IAG9B,CAACJ,IAGF+K,EAAAA,KAAC,OAAIC,UAAWqS,GAAG,sBAAuBrS,MAAgBqQ,EACxDpQ,SAAA,CAAAI,EAAAA,IAAC0D,EAAA,CACC5D,QAAQ,QACRrI,KAAK,OACLkI,UAAU,kDACViD,QAAS8M,EACT,aAAYS,EAAU,oBACtBlhB,MAAOkhB,EAAU,oBAEjBvQ,SAAAI,EAAAA,IAAC0S,EAAA,CAAW/S,UAAU,cAEvBC,MApCyB,oBCvQnBkT,KACXtE,IAEA,MAAM7O,UACJA,EAAAoT,MACAA,EAAA9jB,MACAA,EAAAuhB,IACAA,EAAArR,OACAA,EAAA6T,SACAA,EAAAtE,aACAA,EAAA/M,OACAA,EAAAtE,OACAA,EAEAvL,MAAOmhB,EACPC,SAAUC,EACVC,OAAQC,EACRC,UAAWC,EACXC,aAAcC,EACdC,cAAeC,EACfC,gBAAiBC,EACjBnX,SAAUoX,KACP9D,GACDxB,EACEuF,EAAcC,EAAc,CAAEtF,eAAc/M,SAAQtE,WACpD4W,EACJD,EAAc,IACTxF,EAEH7M,OAAQ1S,KACN4V,YAAc5V,EACdkhB,EAAYC,IAElB,OAAmB,MAAf2D,GAAwB1iB,MAAMC,QAAQyiB,IAAuC,IAAvBA,EAAYzhB,OAC/DygB,QAKF,MAAA,CAAIpT,UAAWqS,GAAG,eAAgBrS,MAAgBqQ,EAChDpQ,SAAiB,iBAAVmT,EAAqB5C,EAAU4C,EAAO,CAAEmB,EAAGnB,IAAWA,IALzD,KAUP1hB,MAAMC,QAAQyiB,KAEd/T,IAAC,KAAA,CAAGL,UAAWqS,GAAG,eAAgBrS,MAAgBqQ,EAC/CpQ,SAAAmU,EAAYpjB,IAAI,CAACgE,EAAM1B,KACtB,MAAMkhB,EAAiBllB,EAAQgC,GAAI0D,EAAM1F,EAAOA,GAASA,EACnDmlB,EAAW5D,EAAMvf,GAAI0D,EAAM6b,EAAKvhB,GAASA,EAE/C,aACG,KAAA,CACC2Q,SAAAI,EAAAA,IAAC,IAAA,CACCqU,KAAMD,EACNnlB,MAAOklB,EACPhV,SACA6T,WAEApQ,QAAS9S,EAACgV,GAAMA,EAAEwP,kBAAT,WAER1U,SAAAuU,KATIlhB,OAmBjB+M,MAAC,OAAIL,UAAWqS,GAAG,eAAgBrS,MAAgBqQ,EACjDpQ,SAAAI,EAAAA,IAAC,IAAA,CACCqU,KAAMN,GAAalP,WACnB5V,MAAOglB,EACP9U,SACA6T,WAEApQ,QAAS9S,EAACgV,GAAMA,EAAEwP,kBAAT,WAER1U,SAAAqU,OAjFgB,aCuBnBM,GAAa,4DAA4DC,mBC3ChE,wpBDoDR,SAASC,IAAoBhS,KAAEA,EAAAqB,QAAMA,IAC1C,MAAM4Q,EAAUC,IACVC,EAAmBnc,MAMjBnE,MAAOugB,EAAatI,QAASuI,EAAA3I,UAAeA,GAAcP,MAMhEra,SAAUwjB,EACV5M,UAAWtK,EACXlK,SAAUqhB,EACV5jB,QAASgW,EACTU,YAAamN,EAAA/M,WACbA,EACA3T,MAAO2gB,EACP9M,QAAS+M,GACPhO,KAKEpT,EAAYS,GAAAA,YACfY,IAGC,MAAMI,KAAEA,EAAApE,QAAMA,EAASmE,YAAa5C,GAAayC,EAG7CzC,GACFuV,EAAW9W,EAASuB,GAItB,MAAMuL,EAA+B+I,GAAiCzR,GAChE2I,EAA6B+I,GAA+B1R,GAG5DjE,EAAWH,EAAQT,IAAI,CAACjB,EAAQuD,KACpC,MAAMmiB,EAAiBrkB,GAAmBrB,GACpC2lB,EAAankB,GAAiBxB,GAKpC,IAAI4lB,EAAa,EACbF,EAAgBE,EAAa,EACxBD,IAAYC,EAAa,IAOlC,MAAO,CACL3T,OAAQjS,GAAU,UAClByP,OAdAiW,IAAmBC,EAAa,yCAA2C,MAe3EC,aACA/S,YARkB5P,IAAW,KAAKM,GAChCqC,OAAO3C,EAAS,GAAGM,IAAQsiB,UAAU,EAAG,SACxC,KAUAxgB,EAAuB,CAC3BxD,WACAmN,WAAYlJ,EAAKjD,MAAM,EAAG,GAC1BgO,WAAY/K,EAAKlD,OACjBkO,UAAW,EACXgV,UAAWhgB,EAAKlD,OAChBqD,OAAQ,GACRqI,SAAU,GACV0C,iBAAkBoG,GAAwBtR,GAC1CmL,QAASqG,GAAexR,GACxBuK,WAAW,EACX4D,sBAAuBpS,EAASV,OAAQqO,GAAMA,EAAEoW,WAAa,GAAKpW,EAAEoW,WAAa,IAC9EhjB,OACH4L,+BACAC,8BAIF2W,EAAc5J,gBAAgBnW,IAEhC,CAACmT,EAAY4M,IAMTW,EAAqBlf,GAAAA,QAA4B,KAErD,GAAyB,YAArBse,EAAYnM,OAAuByM,EACrC,MAA4B,YAArBN,EAAYnM,KAAqBmM,EAAY7K,YAAc,KAIpE,MAAM9L,EAA+B+I,GAAiC+N,GAChE7W,EAA6B+I,GAA+B8N,GAG5DU,EAAkBtO,EAAWzW,IAAKjB,IACtC,MAAMyP,EAAS4V,EAAerlB,GAG9B,IAAI4lB,EAAa,EACbzX,EAActN,IAAIb,GACpB4lB,EAAa,EACJnW,IAAW9Q,GACpBinB,EAAa,GACJnW,IACTmW,EAAa,GAIf,MAAMK,EAAeX,EAAoB,GACzC,IAAIzS,EACJ,GAAIoT,EAEF,GACExW,IAAW9Q,IACA,2CAAX8Q,EACA,CAGAoD,EAAc,CAFAoT,EAAyB,YAAK,GAC/BA,EAAwB,WAAK,IACd9kB,OAAOC,SAAS0B,KAAK,KAAK+iB,UAAU,EAAG,GACrE,MAAWpW,GAAUwW,EAAaxW,KAChCoD,EAAcjN,OAAOqgB,EAAaxW,IAASoW,UAAU,EAAG,KAI5D,MAAO,CACL5T,OAAQjS,GAAU,UAClByP,OACEA,IAAW9Q,GAAyB,yCAA2C8Q,EACjFmW,aACA/S,iBAKEvE,EAAoC,GACpC4X,EAAezlB,OAAO0lB,OAAOd,GAC7Be,EAAmBF,EAAaG,SAAS1nB,IACzC2nB,EAAuBJ,EAAaG,SAAS,cAC7CE,EAAsBL,EAAaG,SAAS,aAiBlD,OAfID,GAAoBE,GACtBhY,EAASzD,KAAK,CACZ1H,IAAK,EACL2F,QACE,kIAGFsd,GAAoBG,GACtBjY,EAASzD,KAAK,CACZ1H,IAAK,EACL2F,QACE,gIAIC,CACLjH,SAAUmkB,EACVhX,WAAYsW,EAAoBziB,MAAM,EAAG,GACzCgO,WAAYyU,EAAoB1iB,OAChCkO,UAAW,EACXgV,UAAWR,EAAoB1iB,OAC/BqD,OAAQ,GACRqI,WACA0C,iBAAkBoG,GAAwBkO,GAC1CrU,QAASqG,GAAegO,GACxBjV,WAAW,EACX4D,sBAAuB+R,EAAgB7kB,OAAQqO,GAAMA,EAAEoW,WAAa,GAAKpW,EAAEoW,WAAa,IACrFhjB,OACH4L,+BACAC,+BAED,CAAC6W,EAAqBD,EAAgB3N,EAAY+N,EAAetX,EAAegX,KAMjF1gB,SAAU+hB,EAAAxhB,SACVA,EACAH,MAAO4hB,GACLviB,GAAkC,CACpCG,YACAC,gBAAiB,IACjBoiB,WAAYC,OAWRviB,EAAeU,GAAAA,YACnB0E,MAAOlD,EAA8BiE,KACnC,GAAyB,cAArB4a,EAAYnM,KAEhB,IACE,MAAM7Q,QAAe+c,EAAiB5e,EAAO,CAC3CjB,SAAS,EACTiF,YAAa6a,EAAYvK,UAAY,EACrCrQ,uBACAF,WAAYjK,EAAA,OAAA,gBAMdglB,EAActJ,iBAAiB,CAC7BjB,eAAgB1S,EAAOwC,eACvBmQ,aAAc3S,EAAOsC,aACrBsQ,aAAc5S,EAAOuC,aACrBsQ,YAAa7S,EAAO0E,YACpBoO,YAAa9S,EAAOlC,OACpB9B,UAAWmC,EAAM1D,QAErB,OAAS+C,GACP,MAAMihB,EAAejhB,EAAMmD,SAAW,qDAChC+d,EAAgB1B,EAAYvK,UAAY,EAGxCK,EAAc3U,EAAMrF,IAAI,CAACqK,EAAa/H,KAAA,CAC1CJ,IAAK0jB,EAAgBtjB,EACrBmC,KAAM4F,EACNrF,OAAQ,CAAC,CAAE5D,MAAO,mBAAoByG,QAAS8d,OAGjDxB,EAActJ,iBAAiB,CAC7BjB,eAAgBvU,EAAM1D,OACtBkY,aAAc,EACdC,aAAc,EACdC,YAAa1U,EAAM1D,OACnBqY,cACA9W,UAAWmC,EAAM1D,QAErB,GAEF,CAACsiB,EAAkBC,EAAaC,IAM5B0B,EAAwBhiB,GAAAA,YAC5B0E,MAAOjC,IAEL,IAAKqX,GAAqBtB,aAAc,CACtC,MAAMyJ,EAAYnI,GAAqBT,wBACjC6I,EAAYpI,GAAqBb,eAOvC,YANAkJ,MACE,2CACcD,8CACYD,+FAI9B,CAGA3B,EAAczJ,2BAA2BpU,GAGzC6d,EAAcxJ,YAAY0J,EAAoB1iB,QAI9C,IAAA,IAASyD,EAAI,EAAGA,EAAIif,EAAoB1iB,OAAQyD,GAD9B,GAC8C,CAE9D,GAAIoW,IAEF,OAGF,MAAMnW,EAAQgf,EAAoBziB,MAAMwD,EAAGA,EAR3B,UASVjC,EAAakC,EAAOiB,GAC1B6d,EAAcvJ,eAAexV,EAAIC,EAAM1D,OACzC,CAGI6Z,MAKJ2I,EAAcrJ,iBACdiJ,MAEF,CAACM,EAAqBlhB,EAAc4gB,EAASI,EAAe3I,IAMxDyK,EAAmBpiB,GAAAA,YACvB0E,MAAOvE,IACL,IAAKA,EAEH,YADAmgB,EAAcvgB,QAKhB,MAAMyO,QAAmB6T,GAAgBliB,GAEpCqO,EAAWnE,QAASmE,EAAWrN,OAMpCmf,EAAc/J,WAAWpW,EAAM,GAAIqO,EAAWhF,UAAY,IALxD8W,EAAc/J,WAAWpW,EAAMqO,EAAWrN,OAAQ,KAOtD,CAACmf,IAMGxJ,EAAc9W,GAAAA,YAAY,KACL,kBAArBqgB,EAAYnM,OAGhBoM,EAAc7J,eAGdvW,EAASmgB,EAAYlgB,QACpB,CAACkgB,EAAaC,EAAepgB,IAK1BoiB,EAAsBtiB,GAAAA,YAAY,KACtCsgB,EAAcnJ,SACdwK,IACAjB,KACC,CAACJ,EAAeqB,EAAsBjB,IAKnC6B,EAAcviB,GAAAA,YAAY,KAC9B2hB,IACAjB,IACAJ,EAAcvgB,QACduP,KACC,CAACqS,EAAsBjB,EAAoBJ,EAAehR,IAKvDkT,EAAcxiB,GAAAA,YACjBsQ,IACCA,EAAEmS,iBACFF,KAEF,CAACA,IAWGG,EAA0BpnB,EAAA,KAC9B,MAAMga,EACiB,kBAArB+K,EAAYnM,KAA2BmM,EAAY/K,iBAAmB,GAClEC,EACiB,kBAArB8K,EAAYnM,KAA2BmM,EAAY9K,mBAAqB,GACpEoN,EAAoC,kBAArBtC,EAAYnM,KAA2BmM,EAAYlgB,KAAO,KACzEsU,EAAiC,YAArB4L,EAAYnM,MAAgD,YAA1BwN,EAAgB5hB,MAEpE,OACEoL,EAAAA,KAAAQ,WAAA,CACEN,SAAA,CAAAI,MAACH,GAAA,CACCD,SAAAF,EAAAA,KAACW,GAAA,CAAiBV,UAAU,sBAAsBC,SAAA,CAAA,sDAEhDI,MAAC0D,EAAA,CAAOf,SAAO,EAAC7C,QAAQ,UAAUrI,KAAK,KACrCmI,WAAAI,IAACoX,IAAKC,GAAI9C,GAAYvB,SAAU,0BAA2BpT,wCAOjEI,EAAAA,IAACuO,GAAA,CACC5M,OAAO,MACP7P,MAAM,WACNsd,OAAQ,CAAE,WAAY,CAAC,SACvBJ,SAAU4H,EAEVhX,eAACkT,GAAA,CAAUnR,OAAO,MAAM1S,MAAM,QAAQkQ,OAAO,aAI9C2K,EAAiBxX,OAAS,GACzB0N,EAAAA,IAACH,IAAMC,QAAQ,cACbF,gBAACS,GAAA,CACCT,SAAA,CAAAI,EAAAA,IAAC,MAAA,CAAIL,UAAU,qBAAqBC,SAAA,4BACpCI,EAAAA,IAAC,KAAA,CAAGL,UAAU,2BACXC,WAAiBjP,IAAI,CAAC0E,EAAOiiB,UAC3B,KAAA,CAAc1X,SAAAvK,EAAMmD,SAAZ8e,WAQlBvN,EAAmBzX,OAAS,GAC3B0N,MAACH,GAAA,CACCD,gBAACS,GAAA,CACCT,SAAA,CAAAI,EAAAA,IAAC,MAAA,CAAIL,UAAU,qBAAqBC,SAAA,cACpCI,EAAAA,IAAC,KAAA,CAAGL,UAAU,2BACXC,WAAmBjP,IAAI,CAACuS,EAASoU,IAChCtX,EAAAA,IAAC,KAAA,CAAcJ,SAAAsD,GAANoU,aAQnBtX,IAAC,MAAA,CAAIL,UAAU,gCACbC,SAAAF,EAAAA,KAACgE,EAAA,CACCd,QAAS0I,EACT1H,UAAWuT,GAAgBlO,GAAaa,EAAiBxX,OAAS,EAEjEsN,SAAA,CAAAqJ,IAAYjJ,IAACuX,GAAA,CAAQ5X,UAAU,8BAAiC,KAAK,kBAhEhD,2BA2E1B6X,QACJ9X,OAAC,MAAA,CAAIC,UAAU,2DACbC,SAAA,GAAAI,IAACuX,GAAA,CAAQ5X,UAAU,wCACnBK,EAAAA,IAAC,IAAA,CAAEL,UAAU,wBAAwBC,SAAA,8BACpC8D,EAAA,CAAO5D,QAAQ,QAAQ8C,QAASmU,EAAanX,SAAA,cAJxB,qBAcpB6X,EAAsB3nB,EAAA,KAC1B,GAAyB,cAArB+kB,EAAYnM,KAAsB,OAAO,KAE7C,MAAMwB,SAAEA,EAAAG,YAAUA,GAAgBwK,EAC5B6C,EAAkBxN,EAASC,MAAQ,EAAKD,EAAS1K,MAAQ0K,EAASC,MAAS,IAAM,EAEvF,aACGpJ,EAAA,CAAKpB,UAAU,oBACdC,SAAAF,EAAAA,KAACyB,EAAA,CAAYxB,UAAU,iBAErBC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACuX,GAAA,CAAQ5X,UAAU,sCACnBK,EAAAA,IAAC,OAAA,CAAKL,UAAU,cAAcC,SAAA,+BAEhCI,IAAC,MAAA,CAAIL,UAAU,UACbC,SAAAI,EAAAA,IAAC0D,EAAA,CACC5D,QAAQ,QACRrI,KAAK,KACLmL,QAASoU,EACTrX,UAAU,4EACXC,SAAA,yBAOLF,KAAC,MAAA,CAAIC,UAAU,YACbC,SAAA,CAAAI,EAAAA,IAAC2X,GAAA,CAAS9lB,MAAO6lB,EAAiB/X,UAAU,UAC5CD,KAAC,MAAA,CAAIC,UAAU,qDACbC,SAAA,CAAAF,OAAC,OAAA,CAAKE,SAAA,CAAA,cACQsK,EAAS1K,MAAM,OAAK0K,EAASC,MAAM,sBAEhD,OAAA,CAAMvK,SAAA,CAAAsE,KAAKC,MAAMuT,GAAiB,wBAKvChY,KAAC,MAAA,CAAIC,UAAU,6CACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,YACbC,SAAA,CAAAI,EAAAA,IAAC,IAAA,CAAEL,UAAU,sBAAsBC,SAAA,cACnCI,EAAAA,IAAC,IAAA,CAAEL,UAAU,kCAAmCC,WAASJ,UACzDE,KAAC,IAAA,CAAEC,UAAU,gCAAgCC,SAAA,CAAA,MAAIsK,EAASC,MAAM,oBAGlEzK,KAAC,MAAA,CAAIC,UAAU,YACbC,SAAA,CAAAI,EAAAA,IAAC,IAAA,CAAEL,UAAU,sBAAsBC,SAAA,iBAClC,IAAA,CAAED,UAAU,sCAAuCC,SAAAyK,EAAY1U,OAAOrD,SACvE0N,EAAAA,IAAC,IAAA,CAAEL,UAAU,gCAAgCC,SAAA,wBAG/CF,KAAC,MAAA,CAAIC,UAAU,YACbC,SAAA,CAAAI,EAAAA,IAAC,IAAA,CAAEL,UAAU,sBAAsBC,SAAA,YACnCI,EAAAA,IAAC,IAAA,CAAEL,UAAU,kCAAmCC,WAAYzF,eAC5D6F,EAAAA,IAAC,IAAA,CAAEL,UAAU,gCAAgCC,SAAA,qBAKjDI,IAACH,IAAMF,UAAU,kCACfC,eAACS,GAAA,CAAiBV,UAAU,UAAUC,SAAA,iEA7DpB,uBAyEtBgY,EAAkB9nB,EAAA,IACtB4P,EAAAA,KAAAQ,EAAAA,SAAA,CACEN,SAAA,CAAAI,EAAAA,IAACH,IAAMC,QAAQ,cACbF,SAAAI,MAACK,GAAA,CAAiBT,8FAIpBI,IAAC,MAAA,CAAIL,UAAU,gCACbC,SAAAI,EAAAA,IAAC0D,EAAA,CAAO5D,QAAQ,UAAU8C,QAASmU,EAAanX,SAAA,eAR9B,mBAoBlBiY,EAA0B/nB,EAAA,KAC9B,OAAQ+kB,EAAYnM,MAClB,IAAK,OACL,IAAK,gBACH,OAAOwO,IAET,IAAK,UACH,OAAOM,IAET,IAAK,YACH,OAAOC,IAET,IAAK,QACH,OAAOG,IAET,IAAK,UACL,IAAK,WAEH,OAAO,KAET,QAEE,OAAOtP,GAAYuM,KAtBO,2BA+B1BiD,EAAiBrV,GAA6B,YAArBoS,EAAYnM,MAA2C,aAArBmM,EAAYnM,KACvEqP,EAAoBtV,GAA6B,YAArBoS,EAAYnM,MAAsB+M,EAC9DuC,EAAmBvV,GAA6B,aAArBoS,EAAYnM,KAE7C,OACEhJ,EAAAA,KAAAQ,WAAA,CAEEN,SAAA,CAAAI,MAAC8F,EAAA,CAAOrD,KAAMqV,EAAgB/R,aAAcgR,EAC1CnX,SAAAI,MAACgG,GAAA,CAAcrG,UAAU,YACvBC,SAAAF,EAAAA,KAACuY,EAAA,CAAKtY,UAAU,sBACdC,SAAA,CAAAF,OAACuG,GAAA,CACCrG,SAAA,GAAAI,IAACkG,IAAYtG,SAAA,sBACbI,IAACoG,IAAkBxG,SAAA,2DAIrBI,EAAAA,IAAC,MAAA,CAAIL,UAAU,0BAA2BC,sBAMtBmY,GAAqBtC,GAC7CzV,EAAAA,IAAC8F,EAAA,CAAOrD,MAAM,EAAMsD,aAAc+Q,EAChClX,SAAAF,EAAAA,KAACsG,GAAA,CAAcrG,UAAU,0CACvBC,SAAA,GAAAF,KAACuG,GAAA,CAAatG,UAAU,0BACtBC,SAAA,GAAAI,IAACkG,IAAYtG,SAAA,qBACbI,IAACoG,IAAkBxG,SAAA,gEAIrBI,IAAC,MAAA,CAAIL,UAAU,8BACbC,SAAAI,EAAAA,IAACxC,GAAA,CACCzI,QAAS0gB,EACThY,WAAY+Y,EACZ9Y,SAAUoZ,EACVlZ,gBAAiBqX,EACjBpX,yBAQTma,GAAyC,aAArBnD,EAAYnM,MAC/B1I,EAAAA,IAAC6D,GAAA,CACCpB,MAAM,EACNqB,QAASiT,EACTlf,OAAQgd,EAAYhd,OACpBmM,YAAY,MAKtB,CApoBgBlU,EAAA2kB,GAAA,uBE/CT,MAAMyD,GAAsBpoB,EAAA,KACjC,MAAOqoB,EAAWC,GAAgB/jB,GAAAA,UAAS,GAErCgkB,EAAkBvoB,EAAA,KACtBsoB,GAAa,IADS,mBAIlBE,EAAmBxoB,EAAA,KACvBsoB,GAAa,IADU,oBAIzB,OACE1Y,EAAAA,KAAAQ,WAAA,CACEN,SAAA,CAAAF,EAAAA,KAACgE,EAAA,CACC5D,QAAQ,UACR8C,QAASyV,EACT1Y,UAAU,yCAEVC,SAAA,CAAAI,EAAAA,IAACuY,GAAA,IAAS,aAEZvY,EAAAA,IAACyU,GAAA,CAAoBhS,KAAM0V,EAAWrU,QAASwU,QApBlB,uBCDtBE,GAAe1oB,EAAA,KAC1B,MAAM2oB,EAAeC,KACrB,OACEhZ,EAAAA,KAAC,MAAA,CACCC,UAAU,kDACV8F,MAAO,CACLkT,OAAQ,iBAAiBF,QAG3B7Y,SAAA,CAAAI,EAAAA,IAAC,MAAA,CAAIwQ,IAAI,kBAAkBoI,IAAI,wBAC/BlZ,KAAC,MAAA,CAAIC,UAAU,mCACbC,SAAA,CAAAI,EAAAA,IAAC,KAAA,CAAGL,UAAU,oBAAoBC,SAAA,sBAClCI,EAAAA,IAAC,IAAA,CAAEL,UAAU,iDAAiDC,SAAA,8CAIhEF,KAAC,MAAA,CAAIC,UAAU,sBACbC,SAAA,GAAAI,IAAC6Y,EAAA,CAAa/mB,MAAM,sBACnBomB,GAAA,CAAA,UAlBmB,gBCmBfY,GAAoBhpB,EAAA,KAC/B,MAAQsF,KAAMwD,GAAaC,KACrBkgB,aAAEA,EAAAC,WAAcA,GAAeC,KAE7B7jB,KAAM8jB,GAAaC,EAAW,OAAQ,CAC5Clc,WAAY,CAAEC,KAAM,EAAGC,QAAS,IAChCzL,KAAM,CAAEK,MAAO,OAAQqL,MAAO,UAKxBhI,KAAMgkB,GAAsBD,EAAW,gBAAiB,CAC9Dlc,WAAY,CAAEC,KAAM,EAAGC,QAAS,KAChCzL,KAAM,CAAEK,MAAO,OAAQqL,MAAO,OAC9BvM,OAAQ,CAAEwoB,WAAY,QAIlBC,IAA4BznB,IAChC,GAAc,QAAVA,EAAiB,CAEnB,MAAQgK,gBAAiBqY,KAAMlE,GAAS+I,GAAgB,CAAA,EACxDC,EAAWhJ,EACb,MACEgJ,EAAW,IACND,EACHld,gBAAiB0d,OAAO1nB,MARG,4BAc3B2nB,EAAmBT,GAAcld,gBACnCvG,OAAOyjB,EAAald,iBACpB,MAEJ,OACE6D,EAAAA,KAAC,MAAA,CAAIC,UAAU,sBAAsB,gBAAc,kBAEjDC,SAAA,CAAAI,EAAAA,IAACyZ,GACC7Z,SAAAI,EAAAA,IAAC0Z,EAAA,CAAY/X,OAAO,IAAIQ,YAAY,2BAItCzC,KAAC,MAAA,CAAIC,UAAU,sBACbC,SAAA,CAAAF,EAAAA,KAACia,GAAA,CAAe7nB,MAAM,gBAAgB8nB,WAAOpT,GAAA,CAAM7G,UAAU,YAC3DC,SAAA,CAAAI,EAAAA,IAAC6Z,GAAA,CACCla,UAAU,yBACV7N,MAAM,QACND,MAAO,CACL,gBAAiBioB,KAAiBnhB,cAClC,qBAAiB,KAGrBqH,EAAAA,IAAC6Z,GAAA,CACCla,UAAU,yBACV7N,MAAM,YACND,MAAO,CACL,gBAAiBkoB,GAAY,IAAI7jB,MAAQyC,cACzC,qBAAiB,KAGrBqH,EAAAA,IAAC6Z,GAAA,CACCla,UAAU,yBACV7N,MAAM,mBACND,MAAO,CACL,qBAAiB,EACjB,gBAAiBkoB,GAAY,IAAI7jB,MAAQyC,iBAG7CqH,EAAAA,IAAC6Z,GAAA,CACCla,UAAU,yBACV7N,MAAM,oBACND,MAAO,CACL,qBAAiB,EACjB,gBAAiBmoB,GAAa,IAAI9jB,MAAQyC,iBAG9CqH,EAAAA,IAAC6Z,GAAA,CACCla,UAAU,yBACV7N,MAAM,oBACND,MAAO,CACL,qBAAiB,EACjB,gBAAiBooB,GAAUD,GAAa,IAAI9jB,OAAYyC,oBAK9DqH,EAAAA,IAAC2Z,GAAA,CAAe7nB,MAAM,OAAO8nB,OAAM5Z,IAACa,GAAA,CAAIlB,UAAU,YAC/CC,SAAAsZ,GACCA,EAASvoB,IAAK0M,GACZ2C,EAAAA,IAAC6Z,GAAA,CACCK,aAAW,EACXva,UAAU,yBAEV7N,MACEkO,EAAAA,IAAC8B,EAAA,CACChC,QAAQ,YACRH,UAAWqS,GACT,qCACAmI,GAAiB9c,GAAQxD,QAG1B+F,SAAAvC,GAAQ/D,OAGbzH,MAAO,CAAEvC,KAAM+N,EAAO5D,KAZjB4D,EAAO5D,OAiBpBuG,MAAC2Z,GAAA,CAAe7nB,MAAM,eAAe8nB,KAAM5Z,EAAAA,IAACY,GAAA,CAAUjB,UAAU,YAC9DC,SAAAF,EAAAA,KAACqC,EAAA,CAAOlQ,MAAO2nB,EAAkBxX,cAAesX,EAC9C1Z,SAAA,CAAAI,EAAAA,IAACiC,EAAA,CACCtC,UAAU,8DACV,aAAW,yBAEXC,SAAAI,EAAAA,IAACkC,EAAA,CAAYC,YAAY,0BAE3BzC,KAAC0C,EAAA,CAAczC,UAAU,WACvBC,SAAA,GAAAI,IAACqC,EAAA,CAAWxQ,MAAM,MAAM8N,UAAU,WAChCC,eAAC,OAAA,CAAKD,UAAU,wBAAwBC,SAAA,wBAEzCwZ,GAAmBzoB,IAAKsS,KACvBjD,IAACqC,GAAwBxQ,MAAOyD,OAAO2N,EAAIxJ,IAAKkG,UAAU,WACxDC,SAAAI,MAAC,OAAA,CAAKL,UAAU,WAAW1Q,MAAOgU,EAAI3J,KACnCsG,SAAAqD,EAAI3J,QAFQ2J,EAAIxJ,eAU7BuG,IAAC2Z,IAAeC,OAAM5Z,IAACoa,IAAMza,UAAU,YAAc7N,MAAM,kBACzD8N,SAAAI,EAAAA,IAAC6Z,GAAA,CACCla,UAAU,yBACV7N,MAAO,KACPD,MAAO,CAAE2H,SAAUZ,GAAUa,eA1IR,qBCa1B,SAAS4gB,IAAkBhd,OAAEA,EAAAid,KAAQA,EAAAC,aAAMA,IAChD,MAAOC,GAAUC,IACXC,EAASC,IAGTC,UAAoBxlB,IACxB,UACQolB,EAAO,WAAY,CACvB/gB,GAAI4D,EAAO5D,GACXrE,OACAylB,aAAcxd,IAEhBqd,EAAO,+BAAgC,CAAEnf,KAAM,YAC/Cgf,KACF,OAASllB,GACPqlB,EAAO,yBAA0B,CAAEnf,KAAM,SAE3C,GAZiB,cAenB,MAAa,SAAT+e,QAEC7H,EAAA,CAAsB5gB,MAAOwL,EAC5BuC,SAAAI,EAAAA,IAACiY,EAAA,CAAKxe,GAAG,uBAAuBqhB,SAAUF,EAAYvd,SACpDuC,SAAAI,EAAAA,IAAC,OAAIL,UAAU,YACbC,eAACmb,GAAA,CAAA,eASRtI,EAAA,CAAsB5gB,MAAOwL,EAC5BuC,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,YAEbC,SAAA,CAAAI,EAAAA,IAACgb,IAAa/rB,MAAM,WAClB2Q,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,CAAAI,EAAAA,IAACib,GAAA,MACDvb,KAAC,MAAA,CAAIC,UAAU,SACbC,SAAA,GAAAF,KAAC,KAAA,CAAGC,UAAU,wBACXC,SAAA,CAAAvC,EAAO9O,WAAW,IAAE8O,EAAO7O,aAE7B6O,EAAOnO,QAAU8Q,EAAAA,IAAC,KAAEL,UAAU,gCAAiCC,WAAO1Q,SACtEmO,EAAOpO,OAAS+Q,EAAAA,IAAC,KAAEL,UAAU,gCAAiCC,WAAO3Q,kBAM5E+Q,IAACgb,IAAa/rB,MAAM,WAClB2Q,eAACmB,EAAA,CACCnB,SAAAF,EAAAA,KAACyB,EAAA,CAAYxB,UAAU,gBACpBC,SAAA,CAAAvC,EAAOxB,iBACN6D,OAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACY,GAAA,CAAUjB,UAAU,iCACrBK,EAAAA,IAACkb,GAAA,CAAevZ,OAAO,kBAAkBwZ,UAAU,gBAAgBjW,KAAK,OACtEtF,SAAAI,EAAAA,IAACob,GAAA,CAAUzZ,OAAO,OAAOhC,UAAU,qBAIxCtC,EAAOge,YACN3b,OAAC,MAAA,CAAIC,UAAU,UACbC,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,iBACxCI,EAAAA,IAAC,OAAA,CAAKL,UAAU,cAAeC,WAAOyb,gBAGzChe,EAAOpO,OACNyQ,OAAC,MAAA,CAAIC,UAAU,UACbC,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,YACxCI,EAAAA,IAAC,OAAA,CAAKL,UAAU,cAAeC,WAAO3Q,wBAQ/C+rB,GAAA,CAAa/rB,MAAM,eAClB2Q,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,YAEZC,SAAA,CAAAvC,EAAO/B,OAAS+B,EAAO/B,MAAMhJ,OAAS,SACpCgpB,GAAA,CAAW3Z,OAAO,QACjB/B,WAAAI,IAACub,IAAgB5b,UAAU,iBACzBC,SAAAF,OAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAACwb,GAAA,CAAK7b,UAAU,mCAChBK,IAACyb,GAAA,CAAW9Z,OAAO,UACnB3B,EAAAA,IAACob,GAAA,CAAUzZ,OAAO,OAAOhC,UAAU,yCAO1CtC,EAAO7B,OAAS6B,EAAO7B,MAAMlJ,OAAS,GACrC0N,EAAAA,IAACsb,GAAA,CAAW3Z,OAAO,QACjB/B,eAAC2b,GAAA,CAAgB5b,UAAU,iBACzBC,SAAAF,OAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAAC0b,GAAA,CAAM/b,UAAU,mCACjBK,IAACob,GAAA,CAAUzZ,OAAO,WAClB3B,EAAAA,IAACob,GAAA,CAAUzZ,OAAO,OAAOhC,UAAU,yCAO1CtC,EAAO9N,cACNmQ,OAAC,MAAA,CAAIC,UAAU,0BACbC,SAAA,GAAAI,IAAC2b,GAAA,CAAShc,UAAU,iCACpBK,EAAAA,IAAC,IAAA,CACCqU,KAAMhX,EAAO9N,aACb4P,OAAO,SACPyc,IAAI,sBACJjc,UAAU,uCACXC,SAAA,mCASRob,GAAA,CAAa/rB,MAAM,UAClB2Q,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,YACbC,SAAA,GAAAF,KAAC,MAAA,CAAIC,UAAU,UACbC,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,cACxCI,EAAAA,IAAC6b,GAAA,CACCla,OAAO,aACP7H,QAAS,CAAEgiB,KAAM,UAAWC,MAAO,OAAQC,IAAK,kBAIpDtc,KAAC,MAAA,CAAIC,UAAU,UACbC,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,sBACxCI,EAAAA,IAAC6b,GAAA,CACCla,OAAO,YACP7H,QAAS,CAAEgiB,KAAM,UAAWC,MAAO,OAAQC,IAAK,kBAIpDtc,KAAC,MAAA,CAAIC,UAAU,UACbC,SAAA,CAAAI,EAAAA,IAAC,OAAA,CAAKL,UAAU,wBAAwBC,SAAA,iBACxCI,EAAAA,IAACkb,IAAevZ,OAAO,WAAWwZ,UAAU,QAC1Cvb,WAAAI,IAACic,iBAOR5e,EAAO/N,MAAQ+N,EAAO/N,KAAKgD,OAAS,SAClC0oB,GAAA,CAAa/rB,MAAM,OAClB2Q,SAAAI,EAAAA,IAAC,OAAIL,UAAU,uBACZC,WAAOtQ,KAAKqB,IAAKurB,GAChBlc,EAAAA,IAACkb,GAAA,CAEC7d,OAAQ,CAAE8e,OAAQD,GAClBva,OAAO,SACPwZ,UAAU,OACVjW,MAAM,EAENtF,SAAAI,EAAAA,IAAC8B,GAAMhC,QAAQ,UACbF,eAACwb,GAAA,CAAUzZ,OAAO,YAPfua,QAgBd7e,EAAO7N,OACNwQ,EAAAA,IAACgb,GAAA,CAAa/rB,MAAM,QAClB2Q,SAAAI,EAAAA,IAACe,GACCnB,SAAAI,EAAAA,IAACmB,EAAA,CAAYxB,UAAU,MACrBC,SAAAI,MAAC,KAAEL,UAAU,8BAA+BC,WAAOpQ,kBAQnE,CC5MO,SAAS4sB,IAAgB/e,OAAEA,EAAAid,KAAQA,IACxC,aACG7H,EAAA,CAAsB5gB,MAAOwL,EAC5BuC,SAAAF,EAAAA,KAAC,MAAA,CAAIC,UAAU,YAEbC,SAAA,CAAAI,EAAAA,IAACqc,GAAA,CACCld,OAAO,aACPgc,UAAU,eACVzpB,KAAM,CAAEK,MAAO,aAAcqL,MAAO,QAEpCwC,SAAAI,EAAAA,IAACsc,GAAA,CAAcnB,UAAU,qBAI1B,MAAA,CAAIxb,UAAU,iDACZC,SAAS,SAAT0a,EACG,wCACA,oEAKd,CDJgBxqB,EAAAuqB,GAAA,qBClBAvqB,EAAAssB,GAAA,mBCLT,MAAMG,GAAgBzsB,EAAA,EAAG0sB,gBAC9B,MAAOC,EAAcC,GAAmBroB,GAAAA,UAAS,IAE3Ce,KAAEA,EAAAunB,UAAMA,EAAAtnB,MAAWA,UAAOunB,GAAYzD,EAA2B,aAAc,CACnFtoB,OAAQ,CAAEgsB,WAAYL,GACtB9qB,KAAM,CAAEK,MAAO,aAAcqL,MAAO,QACpCH,WAAY,CAAEC,KAAM,EAAGC,QAAS2f,MAI5BC,EAAwC,iBAAdP,EAAyBQ,SAASR,EAAW,IAAMA,EAEnF,GAAIG,EACF,OACE3c,EAAAA,IAAC,MAAA,CAAIL,UAAU,YACZC,UAAC,EAAG,EAAG,GAAGjP,IAAKoF,GACd2J,EAAAA,KAAC,MAAA,CAAYC,UAAU,sCACrBC,SAAA,GAAAI,IAACid,GAAA,CAAStd,UAAU,oBACpBK,IAACid,GAAA,CAAStd,UAAU,sBACpBK,IAACid,GAAA,CAAStd,UAAU,gBAHZ5J,MAUlB,GAAIV,EACF,OAAO2K,EAAAA,IAAC,MAAA,CAAIL,UAAU,oCAAoCC,SAAA,8BAG5D,MAAMsd,EAAa9nB,GAAQ,GAE3B,SACEsK,KAAC,MAAA,CAAIC,UAAU,YAEbC,SAAA,CAAAI,EAAAA,IAAC,MAAA,CAAIL,UAAU,mBACbC,WAAAF,KAACgE,EAAA,CAAO5D,QAAQ,UAAUH,UAAU,aAAaiD,cAAe8Z,GAAgB,GAAtB,WACxD9c,SAAA,GAAAI,IAACmd,GAAA,CAAKxd,UAAU,YAAY,oBAKT,IAAtBud,EAAW5qB,OACV0N,EAAAA,IAAC,OAAIL,UAAU,yCAAyCC,SAAA,+BAExDI,EAAAA,IAAC,MAAA,CAAIL,UAAU,YACZC,SAAAsd,EAAWvsB,IAAKysB,GACfpd,EAAAA,IAACqd,IAAwCD,YAAbA,EAAS3jB,OAM3CuG,EAAAA,IAACsd,GAAA,CACC7a,KAAMga,EACN1W,aAAc2W,EACda,cAAe,CAAEf,UAAWO,GAC5BlQ,OAAQ,CACN2Q,wBAAwB,EACxBC,gBAAgB,GAElBC,UAAW5tB,EAAA,KACT8sB,KADS,mBA7DU,iBCGtB,SAASe,IAA2BtgB,OAAEA,IAE3C,MAAQjI,KAAMiG,EAAAuiB,UAAcA,GAAcC,EACxC,gBACA,CAAEpkB,GAAI4D,EAAOxB,iBACb,CAAEiiB,UAAWzgB,EAAOxB,kBAItB,IAAKwB,EAAOxB,iBAAmB+hB,IAAcviB,EAC3C,OAAO,KAGT,MAAM0iB,EAAc,CAAC1gB,EAAO9O,WAAY8O,EAAO7O,WAAWqC,OAAOC,SAAS0B,KAAK,KAE/E,OACEkN,EAAAA,KAAC,MAAA,CAAI,aAAW,oBAAoBC,UAAU,0CAE5CC,SAAA,CAAAF,EAAAA,KAAC0X,GAAA,CACCC,GAAI,uBAAuBhc,EAAa5B,KACxCkG,UAAU,gKACV1Q,MAAOoM,EAAa/B,KAEpBsG,SAAA,GAAAI,IAACY,GAAA,CAAUjB,UAAU,qBACpBtE,EAAa/B,UAGhB0G,IAACge,GAAA,CAAare,UAAU,6CAExBD,KAAC,OAAA,CAAKC,UAAU,+EACdC,SAAA,GAAAI,IAACM,GAAA,CAAKX,UAAU,qBACfoe,GAAe,YAAY1gB,EAAO5D,UAI3C,CCxBO,SAASwkB,IAAiBC,SAC/BA,EAAAC,OACAA,EAAA7D,KACAA,EAAAxW,QACAA,EAAAyW,aACAA,IAGA,MAAM6D,EAA2B,CAC/B,CACEC,IAAK,UACLvsB,MAAO,UACPwsB,UAAWjE,GACXT,KAAM2E,IAER,CACEF,IAAK,aACLvsB,MAAO,aACPwsB,UAAWxuB,EAAA,EAAGuN,YAAa2C,EAAAA,IAACuc,GAAA,CAAcC,UAAWnf,EAAO5D,KAAjD,aACXmgB,KAAM4E,GACNC,gBAAiB3uB,EAACuN,GAAoBA,EAAOqhB,cAA5B,oBAEnB,CACEL,IAAK,QACLvsB,MAAO,QACPwsB,UAAWlC,GACXxC,KAAM+E,GACNF,gBAAiB3uB,EAACuN,GAAoBA,EAAOuhB,SAA5B,qBAKfC,IAAkBxhB,GACf,GAAGA,EAAO9O,cAAc8O,EAAO7O,YADjB,kBAIvB,OACEwR,EAAAA,IAAC8e,GAAA,CACCpiB,SAAS,WACTwhB,WACAC,SACAra,UACAwW,OACAC,eACAwE,KAAMX,EACNY,qBAAsBH,EACtBI,oBAAqBtB,GACrBuB,gBAAiBC,GAGvB,CCkBO,SAASC,IAAmBhjB,OAAEA,IAEnC,IAAKA,EACH,OAAO4D,EAAAA,IAAC8B,EAAA,CAAMnC,UAAU,6BAA6BC,SAAA,OAGvD,MAOM9N,MAAEA,EAAA6N,UAAOA,GAPsD,CACnE0f,KAAM,CAAEvtB,MAAO,OAAQ6N,UAAW,YAClC2f,KAAM,CAAExtB,MAAO,OAAQ6N,UAAW,aAClC4f,IAAK,CAAEztB,MAAO,MAAO6N,UAAW,YAChC,cAAe,CAAE7N,MAAO,WAAY6N,UAAW,aAGbvD,IAAW,CAC7CtK,MAAOsK,EAAOojB,OAAO,GAAGvtB,cAAgBmK,EAAO7J,MAAM,GACrDoN,UAAW,YAGb,aAAQmC,EAAA,CAAMnC,UAAW,qBAAqBA,IAAcC,SAAA9N,GAC9D,CFlGgBhC,EAAA6tB,GAAA,8BCWA7tB,EAAAmuB,GAAA,oBCoEAnuB,EAAAsvB,GAAA,sBClFT,MAAMK,GAAiBC,GACjBC,GAAoBC,GCL1B,SAASC,GACdC,EACAvkB,GAEA,OAAOukB,GAAQC,KAAMjb,GAAMA,EAAEvJ,OAASA,IAAO1J,KAC/C,CAEO,SAASmuB,GACdC,EACA1kB,GAEA,OAAO0kB,GAAQF,KAAMnvB,GAAMA,EAAE2K,OAASA,IAAO1J,KAC/C,CAEO,SAASquB,GAAuBJ,GAKrC,MAAO,CACLnxB,WAAYkxB,GAAmBC,EAAQ,QACvClxB,WAAYixB,GAAmBC,EAAQ,QACvCjxB,YAAagxB,GAAmBC,EAAQ,SAE5C,CAEO,SAASK,GAAuBF,GAKrC,MAAO,CACLnxB,WAAYkxB,GAAmBC,EAAQ,QACvClxB,WAAYixB,GAAmBC,EAAQ,QACvCjxB,YAAagxB,GAAmBC,EAAQ,SAE5C,CApCgBnwB,EAAA+vB,GAAA,sBAOA/vB,EAAAkwB,GAAA,sBAOAlwB,EAAAowB,GAAA,0BAYApwB,EAAAqwB,GAAA,0BCrBhB,MAAMC,KAAkBvuB,IACtB,GAAIA,QAAuC,MAAO,GAClD,MAAMwuB,EAAM/qB,OAAOzD,GAEnB,MADwB,CAAC,IAAK,IAAK,IAAK,IAAK,KAAM,MAC/ByuB,KAAMC,GAASF,EAAIG,WAAWD,IACzC,KAAKF,IAEPA,GAPc,kBAkCVI,GAAqC3wB,EAAAoJ,MAAOwnB,EAASC,KAChE,MAAMC,QAAcD,EAA0BD,EAAS,WAAY,SAC7DpxB,QAAaqxB,EAAyBD,EAAS,OAAQ,QACvDhmB,QAAsBimB,EAC1BD,EACA,kBACA,iBAyBIG,EAtB+BH,EAAQ/vB,IAAKmC,IAAA,CAChDvE,WAAYuE,EAAQvE,WACpBC,UAAWsE,EAAQtE,UACnBU,OAAQ4D,EAAQ5D,OAChBD,MAAO6D,EAAQ7D,MACfR,kBAAmBqE,EAAQ+I,gBACvBnB,EAAc5H,EAAQ+I,kBAAkBvC,UACxC,KACD4mB,GAAuBptB,EAAQwI,UAC/B6kB,GAAuBrtB,EAAQ0I,OAClCrM,OAAQ2D,EAAQ3D,OAChBC,WAAY0D,EAAQ1D,WACpBC,UAAWyD,EAAQzD,UACnBC,KAAMwxB,GAAoBhuB,EAAQxD,KAAMA,GACxCC,aAAcuD,EAAQvD,aACtBqxB,MAAOG,GAAgBjuB,EAAQ0G,SAAWonB,EAAM9tB,EAAQ0G,UAAY,MACpE6hB,WAAYvoB,EAAQuoB,YAAc,GAClC5hB,GAAI3G,EAAQ2G,GACZD,SAAU1G,EAAQ0G,SAClBqC,gBAAiB/I,EAAQ+I,mBAGGlL,IAAKkC,GACjC1C,OAAO6wB,YAAY7wB,OAAOC,QAAQyC,GAAKlC,IAAI,EAAE0tB,EAAKxsB,KAAW,CAACwsB,EAAK+B,GAAevuB,OAGpF,OAAOovB,EACLJ,EACA,CACEK,aAAc,IACdC,UAAW,QAEb,CAACC,EAAmBC,KAClB,GAAID,EACF,MAAM,IAAI1tB,MAAM,sBAAsB0tB,EAAI5oB,WAE5C8oB,EAAYD,EAAK,eA7C2B,mBCjClD,SAASE,GAAgB1vB,GACvB,IAAKA,GAA0B,iBAAVA,EAAoB,OAAOyD,OAAOzD,GAEvD,MAAM2vB,EAAO,IAAItrB,KAAKrE,GACtB,OAAI4vB,MAAMD,EAAK/kB,WAAmBnH,OAAOzD,GAErC6vB,GAAQF,GAAc,QACtBG,GAAWH,GAAc,YACzBI,GAAYJ,GAAc,aACvB7S,GAAO6S,EAAM,cACtB,CAVS1xB,EAAAyxB,GAAA,mBAqBF,MAAMM,GAAwBC,EAAqB,CACxD,CACEzD,IAAK,OACLvsB,MAAO,MACPyJ,KAAM,cACN4f,UAAW,QAEb,CACEkD,IAAK,kBACLvsB,MAAO,eACPyJ,KAAM,YACN4f,UAAW,iBAEb,CACEkD,IAAK,gBACLvsB,MAAO,iBACPyJ,KAAM,aACNwmB,YAAaR,GAEbS,aAAc,mBAEhB,CACE3D,IAAK,gBACLvsB,MAAO,kBACPyJ,KAAM,aACNwmB,YAAaR,GACbS,aAAc,mBAEhB,CACE3D,IAAK,WACLvsB,MAAO,QACPyJ,KAAM,YACN4f,UAAW,WCrCF8G,GAAcnyB,EAAA,KACzB,MAAQsF,KAAMwD,EAAU+jB,UAAWuF,GAAsBrpB,KACnDspB,YAAEA,SAAahE,EAAA7D,KAAQA,EAAA8H,cAAMA,iBAAeC,EAAAC,WAAgBA,GAChEC,KAMF,OAFAC,EAAiB,YAEbN,QACMO,EAAA,IAEL7pB,EAKH8G,EAAAA,KAAAQ,WAAA,CACEN,SAAA,GAAAI,IAAC,MAAA,CAAI,gBAAc,gBACjBJ,SAAAF,EAAAA,KAACgjB,EAAA,CACCzzB,OAAO,EACPsd,cAAUoW,GAAA,IACVxlB,QAAS,GACTzL,KAAM,CAAEK,MAAO,YAAaqL,MAAO,QACnCwlB,SAAUnC,GAEV7gB,SAAA,GAAAI,IAAC6iB,GAAA,CAAkBT,gBAA8BU,gBAAiB3E,UACjE4E,EAAA,CAAA,QAGL/iB,EAAAA,IAACie,GAAA,CACCC,SAAUiE,EACVhE,SACA7D,OACAxW,QAASue,EACT9H,aAAc+H,IAEhBtiB,EAAAA,IAACgjB,GAAA,CAAoBC,QAAQ,WAAWC,SAAS,mBAxB5C,MAbgB,eA0CrBL,GAAoB/yB,EAAA,EACxBsyB,gBACAU,sBAKA,MAAM1tB,KAAEA,EAAAunB,UAAMA,EAAA5D,aAAWA,GAAiBE,KAIpCkK,aAAEA,GAAiBC,EAA0B,CACjDC,WAAW5pB,GAAO2oB,EAAc7I,OAAO9f,GAAK,QAAlC,YACVqkB,SAAUgF,IAGNQ,EAAavK,GAAgB5oB,OAAOsB,KAAKsnB,GAAczmB,OAAS,EAGtE,OAAIqqB,EAEA3c,EAAAA,IAACujB,EAAA,CAAmB7mB,SAAS,WAAW8mB,sBAAkB1K,GAAA,CAAA,GACxDlZ,SAAAI,EAAAA,IAACyiB,EAAA,CAAA,KAKFrtB,GAAM9C,QAAWgxB,EAKpB5jB,EAAAA,KAAAQ,WAAA,CACEN,SAAA,CAAAF,OAAC6jB,GAAmB7mB,SAAS,WAAW8mB,gBAAiBxjB,EAAAA,IAAC8Y,OACxDlZ,SAAA,GAAAI,IAACyjB,EAAA,CAAcC,aAAc7B,KAC7BniB,EAAAA,KAACikB,EAAA,CACCC,aAAanqB,GAAO2oB,EAAc7I,OAAO9f,GAAK,QAAlC,cACZ0pB,eAGAvjB,SAAA,CAAAI,EAAAA,IAAC6jB,GAAA,CACC/xB,MAAM,GACNohB,UAAU,EACV4Q,OAAQh0B,EAACuN,GAAoB2C,EAAAA,IAACib,IAAO5d,SAAgBkJ,MAAO,GAAIoS,OAAQ,KAAhE,UACRjF,cAAc,uBACdE,gBAAgB,yBAIlB5T,EAAAA,IAAC6jB,GAAA,CACC/xB,MAAM,OACNshB,OAAO,aACP0Q,SAASzmB,GAAoBoiB,GAAepiB,EAAO9O,WAAY8O,EAAO7O,WAA9D,YAIVwR,EAAAA,IAAC6jB,GAAA,CACC/xB,MAAM,OACNshB,OAAO,QACP0Q,SAASzmB,GAAoBsiB,GAAkBtiB,EAAOpO,MAAOoO,EAAOge,YAA5D,UACR3H,cAAc,uBACdE,gBAAgB,yBAIlB5T,EAAAA,IAACkb,GAAA,CACCvZ,OAAO,kBACPwZ,UAAU,gBACVrpB,MAAM,eACNoT,MAAM,EACNgO,UAAQ,EAERtT,SAAAI,EAAAA,IAACob,GAAA,CAAUzZ,OAAO,WAIpB3B,EAAAA,IAAC6jB,GAAA,CACC/xB,MAAM,SACNohB,UAAU,EACV4Q,OAAQh0B,EAACuN,SAAqB+hB,GAAA,CAAmBhjB,OAAQiB,EAAOjB,SAAxD,YAIV4D,EAAAA,IAAC6jB,GAAA,CACC/xB,MAAM,QACNohB,UAAU,EACV4Q,OAAQh0B,EAACuN,GAAoBA,EAAOuhB,UAAY,EAAxC,UACRtL,UAAU,SACVI,cAAc,uBACdE,gBAAgB,yBAIlB5T,EAAAA,IAAC6b,GAAA,CACCla,OAAO,YACP7P,MAAM,gBACNohB,UAAQ,EACR6Q,UAAU,EACVrQ,cAAc,uBACdE,gBAAgB,qCAIrBoQ,EAAA,CAAA,YA3EKxL,GAAA,KA5Bc,qBA4GpBmK,GAAqB7yB,EAAA,IACzB4P,EAAAA,KAACukB,GAAA,CACCrkB,SAAA,GAAAI,IAAC,OAAA,CAAK,gBAAc,mBAClBJ,SAAAI,EAAAA,IAACkkB,EAAA,CAAWtyB,OAAQ,CAAC,aAAc,YAAa,iBAYlDoO,EAAAA,IAAC,QAAK,gBAAc,qBAClBJ,eAACukB,EAAA,CAAavB,SAAUnC,aAEzB,OAAA,CAAK,gBAAc,qBAClB7gB,SAAAI,EAAAA,IAAC6Y,WAnBoB"}