var e=Object.defineProperty,t=(t,i)=>e(t,"name",{value:i,configurable:!0});import{j as i,U as a,l as r,A as o,B as n,E as s,i as l,at as c,J as p}from"./chunk-ByJg_QQB.js";import{c as d,u as m,a as u}from"./chunk-JxeXaC9i.js";import{aq as h,ar as g,a7 as f,V as x,W as j,B as y,X as C,s as k,D as v,e as b,f as w,g as S,h as _,d as N,p as O,as as z,C as D,a as A}from"../assets/index-BoLku8RR.js";import{C as L}from"./chunk-BM66RvuK.js";import{F as P}from"./chunk-DpghI3EP.js";import{F as T}from"./chunk-C0lbEKTL.js";import{O as F}from"./chunk-nZ5rfQld.js";import{d as B,r as E}from"./chunk-1NZFT-6z.js";import{af as I,f as W,g as R,T as V}from"./chunk-Bc6KM1xM.js";import{T as M,a as q,b as G,c as K,d as U,e as H}from"./chunk-D_rprtX5.js";import{g as J,b as Q}from"./chunk-CFj7NhUg.js";import"./chunk-DwAffUXc.js";import"./chunk-knA4lag3.js";import"./chunk-Tyyhsnez.js";import"./chunk-XoqkUGE_.js";import"./chunk-CRKBdUTG.js";import"./chunk-6VRQ4sAj.js";import"./chunk-D6FmavVW.js";import"./chunk-nUtrHAIa.js";import"./chunk-CMQLDEz_.js";import"./chunk-C_u3nriX.js";import"./chunk-BLkgKceb.js";import"./chunk-DRZQUu5H.js";import"./chunk-C5fZsuMg.js";import"./chunk-B8xrZQJc.js";import"./chunk-DhfTvo06.js";import"./chunk-B9H_70fs.js";import"./chunk-C4sNritB.js";import"./chunk-DsNwAyt-.js";import"./chunk-CypxJXwf.js";import"./chunk-B0BZInrb.js";import"./chunk-CIlS_x6D.js";import"./chunk-X0dz3Jmp.js";import"./chunk-IswQf-N3.js";import"./chunk-D62ZQQIe.js";const X=[{popover:{title:"Create an Opportunity",description:"This form captures a new deal in your sales pipeline. Let me walk you through each field.",align:"center"}},{element:'[data-tutorial="opp-name"]',popover:{title:"Opportunity Name",description:'Give this deal a clear name. Convention: "[Customer] - [Principal] - [Context]" e.g., "ABC Restaurant - Sysco Authorization"',side:"bottom"}},{element:'[data-tutorial="opp-customer"]',popover:{title:"Customer Organization",description:'Select the customer (Operator or Distributor) pursuing this deal. Use the "+" button to create a new customer inline.',side:"right"}},{element:'[data-tutorial="opp-principal"]',popover:{title:"Principal Organization",description:"Which Principal (manufacturer) does this opportunity represent? Each opportunity is linked to exactly one Principal.",side:"left"}},{element:'[data-tutorial="opp-stage"]',popover:{title:"Pipeline Stage",description:"Track progress: New Lead → Initial Outreach → Sample/Visit → Feedback → Demo → Closed Won/Lost",side:"bottom"}},{element:'[data-tutorial="opp-priority"]',popover:{title:"Priority Level",description:"Set urgency: Low, Medium, High, or Critical. Helps prioritize your weekly focus.",side:"bottom"}},{element:'[data-tutorial="opp-close-date"]',popover:{title:"Estimated Close Date",description:"When do you expect this deal to close? This drives pipeline forecasting.",side:"bottom"}},{element:'[data-tutorial="opp-account-manager"]',popover:{title:"Account Manager",description:"Assign the team member responsible for this opportunity (defaults to you).",side:"right"}},{element:'[data-tutorial="opp-distributor"]',popover:{title:"Distributor Organization",description:"Optional: If this deal involves a specific distributor, select it here. Shows authorization warnings if not authorized.",side:"left"}},{element:'[data-tutorial="opp-contacts"]',popover:{title:"Related Contacts",description:"Link key people involved in this deal. Contacts are filtered by the selected Customer Organization.",side:"top"}},{element:'[data-tutorial="opp-products"]',popover:{title:"Products",description:"Add products from the Principal's catalog. At least one product is required. Add notes for each product.",side:"top"}},{element:'[data-tutorial="opp-section-classification"]',popover:{title:"Classification Section",description:"Optional fields for tracking how opportunities are sourced and categorized.",side:"top"}},{element:'[data-tutorial="opp-lead-source"]',popover:{title:"Lead Source",description:'Where did this lead come from? Examples: "Referral", "Trade Show", "Cold Call", "Website Inquiry".',side:"right"}},{element:'[data-tutorial="opp-campaign"]',popover:{title:"Campaign",description:'Link this opportunity to a marketing campaign for tracking ROI. Example: "Q4 2025 Trade Show".',side:"left"}},{element:'[data-tutorial="opp-section-details"]',popover:{title:"Additional Details",description:"Optional fields for context, planning, and notes.",side:"top"}},{element:'[data-tutorial="opp-description"]',popover:{title:"Description",description:"Summarize what this opportunity is about - the products, customer needs, or deal context.",side:"bottom"}},{element:'[data-tutorial="opp-next-action"]',popover:{title:"Next Action",description:"What's the next step to move this deal forward? Keep it specific and actionable.",side:"right"}},{element:'[data-tutorial="opp-next-action-date"]',popover:{title:"Next Action Date",description:"When should the next action be completed? This helps with task planning and follow-ups.",side:"left"}},{element:'[data-tutorial="opp-save-btn"]',popover:{title:"Create Opportunity",description:"Click to create the opportunity. Similar name detection will warn if a duplicate might exist.",side:"top"}},{popover:{title:"Ready to Create!",description:"You now know all the fields. Fill out the required fields (*) and click Create Opportunity.",align:"center"}}];function Y(){const e=B(),a=E.useRef(null),[r,o]=E.useState(!1),n="/opportunities/create"===e.pathname;E.useEffect(()=>()=>{a.current&&(a.current.destroy(),a.current=null)},[]);const s=E.useCallback(async()=>{a.current&&(a.current.destroy(),a.current=null);const e=h(X),i=e.find(e=>e.element);if(i?.element)try{await g(i.element,3e3)}catch{}const r={showProgress:!0,animate:!0,smoothScroll:!0,allowClose:!0,allowKeyboardControl:!0,overlayColor:"rgba(0, 0, 0, 0.75)",popoverClass:"tutorial-popover",showButtons:["next","previous","close"],nextBtnText:"Next",prevBtnText:"Back",doneBtnText:"Got it!",steps:e.map(e=>({element:e.element,popover:{title:e.popover.title,description:e.popover.description,side:e.popover.side,align:e.popover.align}})),onDestroyed:t(()=>{o(!1),a.current=null},"onDestroyed")};try{a.current=f(r),o(!0),a.current.drive()}catch(n){o(!1),a.current=null}},[]);return!n||r?null:i.jsx("div",{className:"fixed bottom-4 left-4 z-50",children:i.jsxs(x,{children:[i.jsx(j,{asChild:!0,children:i.jsx(y,{variant:"default",size:"icon",onClick:s,className:"h-11 w-11 rounded-full shadow-lg bg-primary text-primary-foreground hover:scale-105 transition-transform","aria-label":"Start form tutorial",children:i.jsx(I,{className:"h-5 w-5"})})}),i.jsx(C,{side:"right",children:i.jsx("p",{children:"Learn about this form"})})]})})}function Z(e,t){const i=e.toLowerCase().trim(),a=t.toLowerCase().trim();if(i===a)return 0;if(0===i.length)return a.length;if(0===a.length)return i.length;const r=i.length,o=a.length;let n=Array.from({length:o+1},(e,t)=>t),s=new Array(o+1);for(let l=1;l<=r;l++){s[0]=l;for(let e=1;e<=o;e++){const t=i[l-1]===a[e-1]?0:1;s[e]=Math.min(n[e]+1,s[e-1]+1,n[e-1]+t)}[n,s]=[s,n]}return n[o]}function $(e,t){const{name:i,threshold:a=3,excludeId:r}=t;if(!i||0===i.trim().length)return{hasSimilar:!1,matches:[]};const o=i.toLowerCase().trim(),n=e.filter(e=>(void 0===r||e.id!==r)&&!(!e.name||0===e.name.trim().length)).map(e=>({id:e.id,name:e.name,distance:Z(o,e.name),stage:e.stage,customer_organization_name:e.customer_organization_name,principal_organization_name:e.principal_organization_name})).filter(e=>e.distance<=a&&e.distance>0).sort((e,t)=>e.distance-t.distance);return{hasSimilar:n.length>0,matches:n}}t(Y,"OpportunityCreateFormTutorial"),t(Z,"levenshteinDistance"),t($,"findSimilarOpportunities");const ee=3;function te(e={}){const{threshold:t=ee,excludeId:i,disabled:r=!1}=e,[o,n]=E.useState(!1),[s,l]=E.useState(""),[c,p]=E.useState([]),[d,m]=E.useState(!1),{data:u=[],isLoading:h}=a("opportunities",{pagination:{page:1,perPage:1e3},sort:{field:"name",order:"ASC"},filter:{"deleted_at@is":null,"stage@not_in":["closed_won","closed_lost"]}},{enabled:!r,staleTime:3e5}),g=E.useMemo(()=>u.map(e=>({id:e.id,name:e.name,stage:e.stage,customer_organization_name:e.customer_organization_name,principal_organization_name:e.principal_organization_name})),[u]),f=E.useCallback(e=>{if(r||d||!e||0===e.trim().length)return{hasSimilar:!1,matches:[]};const a=$(g,{name:e,threshold:t,excludeId:i});return a.hasSimilar&&(l(e),p(a.matches),n(!0)),a},[r,d,g,t,i]),x=E.useCallback(()=>{n(!1)},[]),j=E.useCallback(()=>{m(!0),n(!1)},[]),y=E.useCallback(()=>{m(!1),p([]),l("")},[]);return{checkForSimilar:f,showDialog:o,closeDialog:x,confirmCreate:j,proposedName:s,similarOpportunities:c,isLoading:h,hasConfirmed:d,resetConfirmation:y}}t(te,"useSimilarOpportunityCheck");const ie={name:"Opportunity Name",customer_organization_id:"Customer Organization",principal_organization_id:"Principal Organization",stage:"Stage",priority:"Priority",estimated_close_date:"Est. Close Date",account_manager_id:"Account Manager",distributor_organization_id:"Distributor Organization",contact_ids:"Contacts",lead_source:"Lead Source",campaign:"Campaign",description:"Description",next_action:"Next Action",next_action_date:"Next Action Date",decision_criteria:"Decision Criteria",notes:"Notes"},ae=t(({mode:e})=>{const{errors:t}=d(),a=Object.keys(t||{}).length>0;return i.jsxs("div",{className:"flex flex-col gap-4",children:[a&&i.jsx(P,{errors:t,fieldLabels:ie,defaultExpanded:Object.keys(t).length<=3}),i.jsx(F,{mode:e})]})},"OpportunityInputs");function re({checkForSimilar:e,hasConfirmed:t,resetConfirmation:a,label:l="Create Opportunity",className:c}){const p=r(),h=m(),g=o(),{dirtyFields:f,isValidating:x,isSubmitting:j}=d(),C=E.useRef(null),v=u({control:h.control,name:"name"});E.useEffect(()=>{null!==C.current&&C.current!==v&&a(),C.current=v},[v,a]);const b=Object.keys(f).length>0,w=n(),S=!b&&null==w||x||j,_=E.useCallback(async e=>{let t;g?.save&&(t=await g.save(e,{})),null!=t&&s(t,h.setError)},[h.setError,g]),N=E.useCallback(async i=>{i.preventDefault(),i.stopPropagation();const a=h.getValues().name;if(!t&&a&&a.trim().length>0){if(e(a).hasSimilar)return}await h.handleSubmit(_)(i)},[h,t,e,_]),O=p(l,{_:l});return i.jsxs(y,{type:"button",variant:"default",disabled:S,onClick:N,"data-tutorial":"opp-save-btn",className:k("h-11 min-w-[160px]",S?"opacity-50 cursor-not-allowed":"cursor-pointer",c),children:[j?i.jsx(W,{className:"mr-2 h-4 w-4 animate-spin"}):i.jsx(R,{className:"mr-2 h-4 w-4"}),O]})}function oe(e){return 1===e?"Very Similar":2===e?"Similar":"Somewhat Similar"}function ne(e){return 1===e?"destructive":2===e?"warning":"secondary"}function se({open:e,onClose:a,onConfirm:r,proposedName:o,similarOpportunities:n,isLoading:s=!1}){return i.jsx(v,{open:e,onOpenChange:t(e=>!e&&a(),"onOpenChange"),children:i.jsxs(b,{className:"sm:max-w-2xl",children:[i.jsxs(w,{children:[i.jsxs(S,{className:"flex items-center gap-2 text-warning",children:[i.jsx(V,{className:"h-5 w-5"}),"Similar Opportunities Found"]}),i.jsxs(_,{className:"text-muted-foreground",children:["The opportunity name ",i.jsxs("strong",{className:"text-foreground",children:['"',o,'"']})," is similar to ",n.length," existing"," ",1===n.length?"opportunity":"opportunities",". Please review before proceeding to avoid duplicates."]})]}),i.jsx("div",{className:"max-h-64 overflow-y-auto rounded-md border border-border",children:i.jsxs(M,{children:[i.jsx(q,{children:i.jsxs(G,{children:[i.jsx(K,{className:"w-[40%]",children:"Name"}),i.jsx(K,{className:"w-[20%]",children:"Stage"}),i.jsx(K,{className:"w-[20%]",children:"Principal"}),i.jsx(K,{className:"w-[20%] text-right",children:"Similarity"})]})}),i.jsx(U,{children:n.map(e=>i.jsxs(G,{className:"hover:bg-muted/50",children:[i.jsx(H,{className:"font-medium",children:e.name}),i.jsx(H,{children:i.jsx("span",{className:"inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium",style:{backgroundColor:Q(e.stage),color:"var(--text-on-color)"},children:J(e.stage)})}),i.jsx(H,{className:"text-muted-foreground",children:e.principal_organization_name||"—"}),i.jsx(H,{className:"text-right",children:i.jsx(N,{variant:ne(e.distance),children:oe(e.distance)})})]},e.id))})]})}),i.jsxs("p",{className:"text-sm text-muted-foreground",children:[i.jsx("strong",{children:"Tip:"})," If this is a different opportunity, consider making the name more distinct (e.g., add a date, product name, or campaign identifier)."]}),i.jsxs(O,{className:"flex-col gap-2 sm:flex-row sm:justify-end",children:[i.jsx(y,{type:"button",variant:"outline",onClick:a,disabled:s,className:"h-11 min-w-[120px]",children:"Go Back"}),i.jsx(y,{type:"button",variant:"default",onClick:r,disabled:s,className:"h-11 min-w-[150px]",children:s?"Creating...":"Create Anyway"})]})]})})}t(re,"OpportunityCreateSaveButton"),t(oe,"getSimilarityLabel"),t(ne,"getSimilarityVariant"),t(se,"SimilarOpportunitiesDialog");const le=t(()=>{const{data:e}=l(),{checkForSimilar:t,showDialog:a,closeDialog:r,confirmCreate:o,proposedName:n,similarOpportunities:s,hasConfirmed:d,resetConfirmation:m}=te(),u={...z.partial().parse({}),opportunity_owner_id:e?.id,account_manager_id:e?.id,contact_ids:[],products_to_sync:[]};return i.jsxs(c,{redirect:"show",children:[i.jsx("div",{className:"bg-muted px-6 py-6",children:i.jsx("div",{className:"max-w-4xl mx-auto create-form-card",children:i.jsx(p,{defaultValues:u,children:i.jsx(D,{children:i.jsx(A,{children:i.jsx(ce,{checkForSimilar:t,hasConfirmed:d,resetConfirmation:m})})})})})}),i.jsx(se,{open:a,onClose:r,onConfirm:o,proposedName:n,similarOpportunities:s}),i.jsx(Y,{})]})},"OpportunityCreate"),ce=t(({checkForSimilar:e,hasConfirmed:t,resetConfirmation:a})=>{const{errors:r}=d();return i.jsxs(i.Fragment,{children:[i.jsx(P,{errors:r}),i.jsx(ae,{mode:"create"}),i.jsx(T,{children:i.jsxs("div",{className:"flex flex-row gap-2 justify-end",children:[i.jsx(L,{}),i.jsx("div",{"data-tutorial":"opp-save-btn",children:i.jsx(re,{checkForSimilar:e,hasConfirmed:t,resetConfirmation:a})})]})})]})},"OpportunityFormContent");export{le as OpportunityCreate,le as default};
