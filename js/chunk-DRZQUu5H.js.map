{"version":3,"file":"chunk-DRZQUu5H.js","sources":["../../src/components/admin/autocomplete-array-input.tsx"],"sourcesContent":["import * as React from \"react\";\nimport { X } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Command, CommandGroup, CommandItem, CommandList } from \"@/components/ui/command\";\nimport { FormControl, FormError, FormField, FormLabel } from \"@/components/admin/form\";\nimport { Command as CommandPrimitive } from \"cmdk\";\nimport type { ChoicesProps, InputProps } from \"ra-core\";\nimport {\n  useChoices,\n  useChoicesContext,\n  useGetRecordRepresentation,\n  useInput,\n  useTranslate,\n  FieldTitle,\n  useEvent,\n} from \"ra-core\";\nimport { InputHelperText } from \"./input-helper-text\";\nimport { useCallback } from \"react\";\n\nexport const AutocompleteArrayInput = (\n  props: Omit<InputProps, \"source\"> &\n    Partial<Pick<InputProps, \"source\">> &\n    ChoicesProps & {\n      className?: string;\n      disableValue?: string;\n      filterToQuery?: (searchText: string) => any;\n      translateChoice?: boolean;\n      placeholder?: string;\n      inputText?: React.ReactNode | ((option: any | undefined) => React.ReactNode);\n    }\n) => {\n  const { filterToQuery = DefaultFilterToQuery, inputText } = props;\n  const {\n    allChoices = [],\n    source,\n    resource,\n    isFromReference,\n    setFilters,\n  } = useChoicesContext(props);\n  const { id, field, isRequired } = useInput({ ...props, source });\n  const translate = useTranslate();\n  const { placeholder = translate(\"ra.action.search\", { _: \"Search...\" }) } = props;\n\n  const getRecordRepresentation = useGetRecordRepresentation(resource);\n  const { getChoiceText, getChoiceValue } = useChoices({\n    optionText: props.optionText ?? (isFromReference ? getRecordRepresentation : \"name\"),\n    optionValue: props.optionValue ?? \"id\",\n    disableValue: props.disableValue,\n    translateChoice: props.translateChoice ?? !isFromReference,\n  });\n\n  const inputRef = React.useRef<HTMLInputElement>(null);\n  const [open, setOpen] = React.useState(false);\n\n  const handleUnselect = useEvent((choice: any) => {\n    field.onChange(field.value.filter((v: any) => v !== getChoiceValue(choice)));\n  });\n\n  const handleKeyDown = useEvent((e: React.KeyboardEvent<HTMLDivElement>) => {\n    const input = inputRef.current;\n    if (input) {\n      if (e.key === \"Delete\" || e.key === \"Backspace\") {\n        if (input.value === \"\") {\n          field.onChange(field.value.slice(0, -1));\n        }\n      }\n      // This is not a default behavior of the <input /> field\n      if (e.key === \"Escape\") {\n        input.blur();\n      }\n    }\n  });\n\n  const availableChoices = allChoices.filter(\n    (choice) => !field.value.includes(getChoiceValue(choice))\n  );\n  const selectedChoices = allChoices.filter((choice) =>\n    field.value.includes(getChoiceValue(choice))\n  );\n  const [filterValue, setFilterValue] = React.useState(\"\");\n\n  const getInputText = useCallback(\n    (selectedChoice: any) => {\n      if (typeof inputText === \"function\") {\n        return inputText(selectedChoice);\n      }\n      if (inputText !== undefined) {\n        return inputText;\n      }\n      return getChoiceText(selectedChoice);\n    },\n    [inputText, getChoiceText]\n  );\n\n  return (\n    <FormField className={props.className} id={id} name={field.name}>\n      {props.label !== false && (\n        <FormLabel>\n          <FieldTitle\n            label={props.label}\n            source={props.source ?? source}\n            resource={resource}\n            isRequired={isRequired}\n          />\n        </FormLabel>\n      )}\n      <FormControl>\n        <Command\n          onKeyDown={handleKeyDown}\n          shouldFilter={!isFromReference}\n          className=\"overflow-visible bg-transparent\"\n        >\n          <div className=\"group rounded-md bg-transparent dark:bg-input/30 border border-input px-3 py-1.75 text-sm transition-all ring-offset-background focus-within:border-ring focus-within:ring-ring/50 focus-within:ring-[3px] aria-invalid:border-destructive aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40\">\n            <div className=\"flex flex-wrap gap-1\">\n              {selectedChoices.map((choice) => (\n                <Badge key={getChoiceValue(choice)} variant=\"outline\">\n                  {getInputText(choice)}\n                  <button\n                    className=\"ml-1 rounded-full outline-none ring-offset-background focus:ring-2 focus:ring-ring focus:ring-offset-2\"\n                    onKeyDown={(e) => {\n                      if (e.key === \"Enter\") {\n                        handleUnselect(choice);\n                      }\n                    }}\n                    onMouseDown={(e) => {\n                      e.preventDefault();\n                      e.stopPropagation();\n                    }}\n                    onClick={(e) => {\n                      e.preventDefault();\n                      handleUnselect(choice);\n                    }}\n                  >\n                    <span className=\"sr-only\">\n                      {translate(\"ra.action.remove\", {\n                        _: \"Remove\",\n                      })}\n                    </span>\n                    <X className=\"h-3 w-3\" />\n                  </button>\n                </Badge>\n              ))}\n              {/* Avoid having the \"Search\" Icon by not using CommandInput */}\n              <CommandPrimitive.Input\n                ref={inputRef}\n                value={filterValue}\n                onValueChange={(filter) => {\n                  setFilterValue(filter);\n                  // We don't want the ChoicesContext to filter the choices if the input\n                  // is not from a reference as it would also filter out the selected values\n                  if (isFromReference) {\n                    setFilters(filterToQuery(filter), undefined, true);\n                  }\n                }}\n                onBlur={() => setOpen(false)}\n                onFocus={() => setOpen(true)}\n                placeholder={placeholder}\n                className=\"ml-2 flex-1 bg-transparent outline-none placeholder:text-muted-foreground\"\n              />\n            </div>\n          </div>\n          <div className=\"relative\">\n            <CommandList>\n              {open && availableChoices.length > 0 ? (\n                <div className=\"absolute top-2 z-10 w-full rounded-md border bg-popover text-popover-foreground shadow-md outline-none animate-in\">\n                  <CommandGroup className=\"h-full overflow-auto\">\n                    {availableChoices.map((choice) => {\n                      return (\n                        <CommandItem\n                          key={getChoiceValue(choice)}\n                          onMouseDown={(e) => {\n                            e.preventDefault();\n                            e.stopPropagation();\n                          }}\n                          onSelect={() => {\n                            setFilterValue(\"\");\n                            if (isFromReference) {\n                              setFilters(filterToQuery(\"\"));\n                            }\n                            field.onChange([...field.value, getChoiceValue(choice)]);\n                          }}\n                          className=\"cursor-pointer\"\n                        >\n                          {getChoiceText(choice)}\n                        </CommandItem>\n                      );\n                    })}\n                  </CommandGroup>\n                </div>\n              ) : null}\n            </CommandList>\n          </div>\n        </Command>\n      </FormControl>\n      <InputHelperText helperText={props.helperText} />\n      <FormError />\n    </FormField>\n  );\n};\n\nconst DefaultFilterToQuery = (searchText: string) => ({ q: searchText });\n"],"names":["AutocompleteArrayInput","props","filterToQuery","DefaultFilterToQuery","inputText","allChoices","source","resource","isFromReference","setFilters","useChoicesContext","id","field","isRequired","useInput","translate","useTranslate","placeholder","_","getRecordRepresentation","useGetRecordRepresentation","getChoiceText","getChoiceValue","useChoices","optionText","optionValue","disableValue","translateChoice","inputRef","React.useRef","open","setOpen","React.useState","handleUnselect","useEvent","choice","onChange","value","filter","v","handleKeyDown","e","input","current","key","slice","blur","availableChoices","includes","selectedChoices","filterValue","setFilterValue","getInputText","useCallback","selectedChoice","jsxs","FormField","className","name","children","label","jsx","FormLabel","FieldTitle","FormControl","Command","onKeyDown","shouldFilter","map","Badge","variant","onMouseDown","preventDefault","stopPropagation","onClick","X","CommandPrimitive","Input","ref","onValueChange","onBlur","__name","onFocus","CommandList","length","CommandGroup","CommandItem","onSelect","InputHelperText","helperText","FormError","searchText","q"],"mappings":"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"}