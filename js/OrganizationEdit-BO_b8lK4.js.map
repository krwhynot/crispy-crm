{"version":3,"file":"OrganizationEdit-BO_b8lK4.js","sources":["../../src/atomic-crm/organizations/PrincipalChangeWarning.tsx","../../src/atomic-crm/organizations/OrganizationEdit.tsx"],"sourcesContent":["import { useRecordContext, useGetList } from \"ra-core\";\nimport { AlertCircle, Package } from \"lucide-react\";\nimport {\n  AlertDialog,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport type { Organization } from \"../types\";\n\ninterface Product {\n  id: number;\n  name: string;\n  sku: string;\n  principal_id: number;\n}\n\ninterface PrincipalChangeWarningProps {\n  open: boolean;\n  onClose: () => void;\n  onConfirm: () => void;\n  newType: string;\n}\n\nexport const PrincipalChangeWarning = ({ open, onClose, newType }: PrincipalChangeWarningProps) => {\n  const record = useRecordContext<Organization>();\n\n  // Fetch products for this principal\n  const { data: products, isLoading } = useGetList<Product>(\n    \"products\",\n    {\n      filter: { principal_id: record?.id },\n      pagination: { page: 1, perPage: 100 },\n      sort: { field: \"name\", order: \"ASC\" },\n    },\n    {\n      enabled: open && !!record?.id,\n    }\n  );\n\n  const productCount = products?.length || 0;\n\n  return (\n    <AlertDialog open={open} onOpenChange={onClose}>\n      <AlertDialogContent className=\"max-w-2xl\">\n        <AlertDialogHeader>\n          <div className=\"flex items-center gap-2\">\n            <AlertCircle className=\"h-6 w-6 text-destructive\" />\n            <AlertDialogTitle>Cannot Change Organization Type</AlertDialogTitle>\n          </div>\n          <AlertDialogDescription className=\"space-y-4\">\n            <p className=\"text-base\">\n              <strong>{record?.name}</strong> is currently a <strong>Principal</strong> with{\" \"}\n              <strong>\n                {productCount} product{productCount !== 1 ? \"s\" : \"\"}\n              </strong>{\" \"}\n              assigned.\n            </p>\n            <p>\n              You cannot change this organization to <strong>{newType}</strong> while products are\n              still assigned. Please reassign or remove these products first:\n            </p>\n\n            {isLoading ? (\n              <div className=\"text-center py-4 text-muted-foreground\">Loading products...</div>\n            ) : productCount > 0 ? (\n              <ScrollArea className=\"h-[300px] rounded-md border p-4\">\n                <div className=\"space-y-2\">\n                  {products?.map((product) => (\n                    <div\n                      key={product.id}\n                      className=\"flex items-start gap-3 p-3 rounded-lg bg-muted/50 hover:bg-muted transition-colors\"\n                    >\n                      <Package className=\"w-4 h-4 mt-0.5 text-muted-foreground\" />\n                      <div className=\"flex-1 min-w-0\">\n                        <p className=\"font-medium text-sm\">{product.name}</p>\n                        <p className=\"text-xs text-muted-foreground\">SKU: {product.sku}</p>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </ScrollArea>\n            ) : (\n              <div className=\"text-center py-4 text-muted-foreground\">No products found</div>\n            )}\n\n            <div className=\"bg-warning/10 border border-warning/20 rounded-md p-3\">\n              <p className=\"text-sm font-medium\">ðŸ’¡ To change this organization type:</p>\n              <ol className=\"text-sm text-muted-foreground mt-2 ml-4 list-decimal space-y-1\">\n                <li>Go to the Products page</li>\n                <li>Reassign these {productCount} products to a different principal</li>\n                <li>Return here to change the organization type</li>\n              </ol>\n            </div>\n          </AlertDialogDescription>\n        </AlertDialogHeader>\n\n        <AlertDialogFooter>\n          <Button variant=\"outline\" onClick={onClose}>\n            Close\n          </Button>\n        </AlertDialogFooter>\n      </AlertDialogContent>\n    </AlertDialog>\n  );\n};\n","import { useState } from \"react\";\nimport { EditBase, Form, useRecordContext, useNotify } from \"ra-core\";\n\nimport { OrganizationInputs } from \"./OrganizationInputs\";\nimport { PrincipalChangeWarning } from \"./PrincipalChangeWarning\";\n\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { ResponsiveGrid } from \"@/components/design-system\";\nimport { OrganizationAside } from \"./OrganizationAside\";\nimport { FormToolbar } from \"../layout/FormToolbar\";\nimport type { Organization } from \"../types\";\n\nconst OrganizationEdit = () => {\n  const [showWarning, setShowWarning] = useState(false);\n  const [attemptedType, setAttemptedType] = useState<string>(\"\");\n\n  return (\n    <EditBase\n      actions={false}\n      redirect=\"show\"\n      mutationOptions={{\n        onMutate: async (variables) => {\n          // Check if trying to change FROM principal\n          const { data, previousData } = variables as {\n            data: Partial<Organization>;\n            previousData: Organization;\n          };\n\n          if (\n            previousData?.organization_type === \"principal\" &&\n            data?.organization_type &&\n            data.organization_type !== \"principal\"\n          ) {\n            // Attempt to change from principal - need to validate\n            setAttemptedType(data.organization_type);\n            setShowWarning(true);\n            // Cancel the mutation by throwing\n            throw new Error(\"PRINCIPAL_VALIDATION_REQUIRED\");\n          }\n        },\n      }}\n      transform={(values) => {\n        // add https:// before website if not present\n        if (values.website && !values.website.startsWith(\"http\")) {\n          values.website = `https://${values.website}`;\n        }\n        return values;\n      }}\n    >\n      <OrganizationEditContent\n        showWarning={showWarning}\n        setShowWarning={setShowWarning}\n        attemptedType={attemptedType}\n      />\n    </EditBase>\n  );\n};\n\nconst OrganizationEditContent = ({\n  showWarning,\n  setShowWarning,\n  attemptedType,\n}: {\n  showWarning: boolean;\n  setShowWarning: (show: boolean) => void;\n  attemptedType: string;\n}) => {\n  const record = useRecordContext<Organization>();\n  const notify = useNotify();\n\n  const handleWarningClose = () => {\n    setShowWarning(false);\n    // Reset form field back to principal\n    if (record) {\n      // The form will automatically revert since the mutation was cancelled\n      notify(\"Organization type change cancelled. Please reassign products first.\", {\n        type: \"warning\",\n      });\n    }\n  };\n\n  return (\n    <>\n      <ResponsiveGrid variant=\"dashboard\" className=\"mt-2\">\n        <main role=\"main\" aria-label=\"Edit organization\">\n          <Form className=\"flex flex-col gap-4\">\n            <Card>\n              <CardContent>\n                <OrganizationInputs />\n                <FormToolbar />\n              </CardContent>\n            </Card>\n          </Form>\n        </main>\n\n        <aside aria-label=\"Organization information\">\n          <OrganizationAside link=\"show\" />\n        </aside>\n      </ResponsiveGrid>\n\n      <PrincipalChangeWarning\n        open={showWarning}\n        onClose={handleWarningClose}\n        onConfirm={() => {\n          // Not allowing confirmation - must reassign products first\n          handleWarningClose();\n        }}\n        newType={attemptedType}\n      />\n    </>\n  );\n};\n\nexport { OrganizationEdit };\nexport default OrganizationEdit;\n"],"names":["PrincipalChangeWarning","__name","open","onClose","newType","record","useRecordContext","data","products","isLoading","useGetList","filter","principal_id","id","pagination","page","perPage","sort","field","order","enabled","productCount","length","jsx","AlertDialog","onOpenChange","children","jsxs","AlertDialogContent","className","AlertDialogHeader","AlertCircle","AlertDialogTitle","AlertDialogDescription","name","ScrollArea","map","product","Package","sku","AlertDialogFooter","Button","variant","onClick","OrganizationEdit","showWarning","setShowWarning","useState","attemptedType","setAttemptedType","EditBase","actions","redirect","mutationOptions","onMutate","variables","previousData","organization_type","Error","transform","values","website","startsWith","OrganizationEditContent","notify","useNotify","handleWarningClose","type","Fragment","ResponsiveGrid","role","Form","Card","CardContent","OrganizationInputs","FormToolbar","OrganizationAside","link","onConfirm"],"mappings":"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"}