{"version":3,"file":"PipelineDrillDownSheet-DbnBWeWk.js","sources":["../../src/atomic-crm/dashboard/v3/hooks/usePrincipalOpportunities.ts","../../src/atomic-crm/dashboard/v3/components/PipelineDrillDownSheet.tsx"],"sourcesContent":["import { useMemo } from \"react\";\nimport { useGetList } from \"react-admin\";\nimport type { OpportunityApiResponse } from \"../types\";\nimport { parseDateSafely } from \"@/lib/date-utils\";\n\n/**\n * Opportunity summary for drill-down display\n */\nexport interface OpportunitySummary {\n  id: number;\n  name: string;\n  stage: string;\n  amount: number;\n  probability: number;\n  lastActivityDate: Date | null;\n  expectedCloseDate: Date | null;\n}\n\ninterface UsePrincipalOpportunitiesOptions {\n  principalId: number | null;\n  enabled?: boolean;\n}\n\n/**\n * Hook to fetch opportunities for a specific principal (organization)\n *\n * Used by the Pipeline Drill-Down feature to show opportunities\n * when clicking on a principal row in the pipeline table.\n */\nexport function usePrincipalOpportunities({\n  principalId,\n  enabled = true,\n}: UsePrincipalOpportunitiesOptions) {\n  // Fetch opportunities filtered by principal organization\n  // Note: Uses opportunities_summary view (via getDatabaseResource)\n  // - Filter: principal_organization_id (not organization_id)\n  // - Sort: estimated_close_date (not expected_close_date)\n  const {\n    data: rawOpps = [],\n    isPending: loading,\n    error,\n  } = useGetList<OpportunityApiResponse>(\n    \"opportunities\",\n    {\n      filter: {\n        principal_organization_id: principalId,\n      },\n      sort: { field: \"estimated_close_date\", order: \"ASC\" },\n      pagination: { page: 1, perPage: 50 },\n    },\n    {\n      enabled: enabled && !!principalId,\n      staleTime: 5 * 60 * 1000, // 5 minutes\n    }\n  );\n\n  // Map to summary format\n  // Note: Database field is estimated_close_date (not expected_close_date)\n  const opportunities = useMemo(\n    () =>\n      rawOpps.map((opp) => ({\n        id: opp.id,\n        name: opp.name || \"Unnamed Opportunity\",\n        stage: opp.stage || \"Unknown\",\n        amount: opp.amount || 0,\n        probability: opp.probability || 0,\n        lastActivityDate: parseDateSafely(opp.last_activity_date),\n        expectedCloseDate: parseDateSafely(opp.estimated_close_date),\n      })),\n    [rawOpps]\n  );\n\n  return { opportunities, loading, error: error as Error | null };\n}\n","import { useNavigate } from \"react-router-dom\";\nimport { format } from \"date-fns\";\nimport {\n  Sheet,\n  SheetContent,\n  SheetHeader,\n  SheetTitle,\n  SheetDescription,\n} from \"@/components/ui/sheet\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { ExternalLink, TrendingUp, Calendar, DollarSign } from \"lucide-react\";\nimport {\n  usePrincipalOpportunities,\n  type OpportunitySummary,\n} from \"../hooks/usePrincipalOpportunities\";\n\ninterface PipelineDrillDownSheetProps {\n  /** Principal (organization) ID to show opportunities for */\n  principalId: number | null;\n  /** Principal name for display */\n  principalName: string;\n  /** Whether the sheet is open */\n  isOpen: boolean;\n  /** Close handler */\n  onClose: () => void;\n}\n\n/**\n * Slide-over sheet showing opportunities for a selected principal.\n *\n * Features:\n * - Fetches opportunities filtered by organization_id\n * - Shows stage, amount, probability, and dates\n * - Links to full opportunity detail page\n * - Built-in accessibility via Radix Dialog (focus trap, ESC to close)\n */\nexport function PipelineDrillDownSheet({\n  principalId,\n  principalName,\n  isOpen,\n  onClose,\n}: PipelineDrillDownSheetProps) {\n  const navigate = useNavigate();\n  const { opportunities, loading, error } = usePrincipalOpportunities({\n    principalId,\n    enabled: isOpen && !!principalId,\n  });\n\n  const handleViewOpportunity = (opportunityId: number) => {\n    // Navigate to opportunity list with view parameter to open slide-over\n    navigate(`/opportunities?view=${opportunityId}`);\n    onClose();\n  };\n\n  const getStageColor = (stage: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" => {\n    const stageLower = stage.toLowerCase();\n    // Check for \"lost\" first since \"Closed Lost\" contains both \"closed\" and \"lost\"\n    if (stageLower.includes(\"lost\")) return \"destructive\";\n    if (stageLower.includes(\"won\") || stageLower.includes(\"closed\")) return \"default\";\n    if (stageLower.includes(\"negotiat\") || stageLower.includes(\"proposal\")) return \"secondary\";\n    return \"outline\";\n  };\n\n  const formatCurrency = (amount: number) => {\n    return new Intl.NumberFormat(\"en-US\", {\n      style: \"currency\",\n      currency: \"USD\",\n      minimumFractionDigits: 0,\n      maximumFractionDigits: 0,\n    }).format(amount);\n  };\n\n  const totalPipeline = opportunities.reduce((sum, opp) => sum + opp.amount, 0);\n  const weightedPipeline = opportunities.reduce(\n    (sum, opp) => sum + opp.amount * (opp.probability / 100),\n    0\n  );\n\n  return (\n    <Sheet open={isOpen} onOpenChange={(open) => !open && onClose()}>\n      <SheetContent\n        side=\"right\"\n        className=\"w-[480px] max-w-[90vw] p-0 flex flex-col\"\n        // Note: role=\"dialog\" and aria-modal=\"true\" are set automatically by Radix\n        // aria-labelledby is auto-wired to SheetTitle's id by Radix\n      >\n        {/* Header */}\n        <SheetHeader className=\"border-b border-border px-6 py-4\">\n          <SheetTitle id=\"drill-down-title\" className=\"text-lg font-semibold\">\n            {principalName}\n          </SheetTitle>\n          <SheetDescription>\n            {loading\n              ? \"Loading opportunities...\"\n              : `${opportunities.length} ${opportunities.length === 1 ? \"opportunity\" : \"opportunities\"}`}\n          </SheetDescription>\n        </SheetHeader>\n\n        {/* Summary Stats */}\n        {!loading && opportunities.length > 0 && (\n          <div className=\"border-b border-border px-6 py-3 bg-muted/30\">\n            <div className=\"flex items-center justify-between text-sm\">\n              <div className=\"flex items-center gap-2\">\n                <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-muted-foreground\">Total Pipeline:</span>\n                <span className=\"font-semibold\">{formatCurrency(totalPipeline)}</span>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\n                <span className=\"text-muted-foreground\">Weighted:</span>\n                <span className=\"font-semibold\">{formatCurrency(weightedPipeline)}</span>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Content */}\n        <ScrollArea className=\"flex-1\">\n          <div className=\"p-4 space-y-3\">\n            {loading ? (\n              // Loading skeleton\n              <>\n                {[1, 2, 3].map((i) => (\n                  <div key={i} className=\"p-4 border rounded-lg space-y-2\">\n                    <Skeleton className=\"h-5 w-3/4\" />\n                    <Skeleton className=\"h-4 w-1/2\" />\n                    <Skeleton className=\"h-4 w-1/4\" />\n                  </div>\n                ))}\n              </>\n            ) : error ? (\n              // Error state\n              <div className=\"text-center py-8\">\n                <p className=\"text-destructive\">Failed to load opportunities</p>\n                <p className=\"text-sm text-muted-foreground mt-1\">{error.message}</p>\n              </div>\n            ) : opportunities.length === 0 ? (\n              // Empty state\n              <div className=\"text-center py-8\">\n                <p className=\"text-muted-foreground\">No opportunities found for this principal</p>\n              </div>\n            ) : (\n              // Opportunity list\n              opportunities.map((opp) => (\n                <OpportunityCard\n                  key={opp.id}\n                  opportunity={opp}\n                  onView={() => handleViewOpportunity(opp.id)}\n                  getStageColor={getStageColor}\n                  formatCurrency={formatCurrency}\n                />\n              ))\n            )}\n          </div>\n        </ScrollArea>\n      </SheetContent>\n    </Sheet>\n  );\n}\n\n/**\n * Individual opportunity card within the drill-down list\n */\nfunction OpportunityCard({\n  opportunity,\n  onView,\n  getStageColor,\n  formatCurrency,\n}: {\n  opportunity: OpportunitySummary;\n  onView: () => void;\n  getStageColor: (stage: string) => \"default\" | \"secondary\" | \"destructive\" | \"outline\";\n  formatCurrency: (amount: number) => string;\n}) {\n  return (\n    <div\n      className=\"p-4 border border-border rounded-lg hover:bg-muted/50 transition-colors cursor-pointer group\"\n      onClick={onView}\n      onKeyDown={(e) => {\n        if (e.key === \"Enter\" || e.key === \" \") {\n          e.preventDefault();\n          onView();\n        }\n      }}\n      role=\"button\"\n      tabIndex={0}\n      aria-label={`View ${opportunity.name}`}\n    >\n      {/* Header: Name + Stage */}\n      <div className=\"flex items-start justify-between gap-2\">\n        <h3 className=\"font-medium text-foreground line-clamp-1\">{opportunity.name}</h3>\n        <Badge variant={getStageColor(opportunity.stage)} className=\"shrink-0\">\n          {opportunity.stage}\n        </Badge>\n      </div>\n\n      {/* Amount and Probability */}\n      <div className=\"mt-2 flex items-center gap-4 text-sm\">\n        <span className=\"font-semibold text-foreground\">{formatCurrency(opportunity.amount)}</span>\n        <span className=\"text-muted-foreground\">{opportunity.probability}% probability</span>\n      </div>\n\n      {/* Dates */}\n      <div className=\"mt-2 flex items-center gap-4 text-xs text-muted-foreground\">\n        {opportunity.expectedCloseDate && (\n          <div className=\"flex items-center gap-1\">\n            <Calendar className=\"h-3 w-3\" />\n            <span>Close: {format(opportunity.expectedCloseDate, \"MMM d, yyyy\")}</span>\n          </div>\n        )}\n        {opportunity.lastActivityDate && (\n          <div className=\"flex items-center gap-1\">\n            <span>Last activity: {format(opportunity.lastActivityDate, \"MMM d\")}</span>\n          </div>\n        )}\n      </div>\n\n      {/* View link (visible on hover) */}\n      <div className=\"mt-3 opacity-0 group-hover:opacity-100 transition-opacity\">\n        <Button variant=\"link\" size=\"sm\" className=\"h-auto p-0 text-primary\">\n          <ExternalLink className=\"h-3 w-3 mr-1\" />\n          View Details\n        </Button>\n      </div>\n    </div>\n  );\n}\n"],"names":["usePrincipalOpportunities","principalId","enabled","data","rawOpps","isPending","loading","error","useGetList","filter","principal_organization_id","sort","field","order","pagination","page","perPage","staleTime","opportunities","useMemo","map","opp","id","name","stage","amount","probability","lastActivityDate","parseDateSafely","last_activity_date","expectedCloseDate","estimated_close_date","PipelineDrillDownSheet","principalName","isOpen","onClose","navigate","useNavigate","handleViewOpportunity","opportunityId","getStageColor","stageLower","toLowerCase","includes","formatCurrency","Intl","NumberFormat","style","currency","minimumFractionDigits","maximumFractionDigits","format","totalPipeline","reduce","sum","weightedPipeline","jsx","Sheet","open","onOpenChange","__name","children","jsxs","SheetContent","side","className","SheetHeader","SheetTitle","SheetDescription","length","DollarSign","TrendingUp","ScrollArea","Fragment","i","Skeleton","message","OpportunityCard","opportunity","onView","onClick","onKeyDown","e","key","preventDefault","role","tabIndex","Badge","variant","Calendar","Button","size","ExternalLink"],"mappings":"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"}