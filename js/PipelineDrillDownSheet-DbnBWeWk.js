var e=Object.defineProperty,s=(s,t)=>e(s,"name",{value:t,configurable:!0});import{U as t,j as a}from"./chunk-ByJg_QQB.js";import{q as i,aa as r,ac as n,ad as o,ae as l,af as c,x as d,S as m,d as p,B as u}from"../assets/index-BoLku8RR.js";import{r as x,e as h}from"./chunk-1NZFT-6z.js";import{b4 as j,O as g,a8 as f,E as y}from"./chunk-Bc6KM1xM.js";import{d as N}from"./chunk-DwAffUXc.js";import"./chunk-JxeXaC9i.js";import"./chunk-knA4lag3.js";import"./chunk-Tyyhsnez.js";import"./chunk-XoqkUGE_.js";import"./chunk-CRKBdUTG.js";function b({principalId:e,enabled:s=!0}){const{data:a=[],isPending:r,error:n}=t("opportunities",{filter:{principal_organization_id:e},sort:{field:"estimated_close_date",order:"ASC"},pagination:{page:1,perPage:50}},{enabled:s&&!!e,staleTime:3e5});return{opportunities:x.useMemo(()=>a.map(e=>({id:e.id,name:e.name||"Unnamed Opportunity",stage:e.stage||"Unknown",amount:e.amount||0,probability:e.probability||0,lastActivityDate:i(e.last_activity_date),expectedCloseDate:i(e.estimated_close_date)})),[a]),loading:r,error:n}}function v({principalId:e,principalName:t,isOpen:i,onClose:p}){const u=h(),{opportunities:x,loading:f,error:y}=b({principalId:e,enabled:i&&!!e}),N=s(e=>{u(`/opportunities?view=${e}`),p()},"handleViewOpportunity"),v=s(e=>{const s=e.toLowerCase();return s.includes("lost")?"destructive":s.includes("won")||s.includes("closed")?"default":s.includes("negotiat")||s.includes("proposal")?"secondary":"outline"},"getStageColor"),C=s(e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),"formatCurrency"),k=x.reduce((e,s)=>e+s.amount,0),D=x.reduce((e,s)=>e+s.amount*(s.probability/100),0);return a.jsx(r,{open:i,onOpenChange:s(e=>!e&&p(),"onOpenChange"),children:a.jsxs(n,{side:"right",className:"w-[480px] max-w-[90vw] p-0 flex flex-col",children:[a.jsxs(o,{className:"border-b border-border px-6 py-4",children:[a.jsx(l,{id:"drill-down-title",className:"text-lg font-semibold",children:t}),a.jsx(c,{children:f?"Loading opportunities...":`${x.length} ${1===x.length?"opportunity":"opportunities"}`})]}),!f&&x.length>0&&a.jsx("div",{className:"border-b border-border px-6 py-3 bg-muted/30",children:a.jsxs("div",{className:"flex items-center justify-between text-sm",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(j,{className:"h-4 w-4 text-muted-foreground"}),a.jsx("span",{className:"text-muted-foreground",children:"Total Pipeline:"}),a.jsx("span",{className:"font-semibold",children:C(k)})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(g,{className:"h-4 w-4 text-muted-foreground"}),a.jsx("span",{className:"text-muted-foreground",children:"Weighted:"}),a.jsx("span",{className:"font-semibold",children:C(D)})]})]})}),a.jsx(d,{className:"flex-1",children:a.jsx("div",{className:"p-4 space-y-3",children:f?a.jsx(a.Fragment,{children:[1,2,3].map(e=>a.jsxs("div",{className:"p-4 border rounded-lg space-y-2",children:[a.jsx(m,{className:"h-5 w-3/4"}),a.jsx(m,{className:"h-4 w-1/2"}),a.jsx(m,{className:"h-4 w-1/4"})]},e))}):y?a.jsxs("div",{className:"text-center py-8",children:[a.jsx("p",{className:"text-destructive",children:"Failed to load opportunities"}),a.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:y.message})]}):0===x.length?a.jsx("div",{className:"text-center py-8",children:a.jsx("p",{className:"text-muted-foreground",children:"No opportunities found for this principal"})}):x.map(e=>a.jsx(w,{opportunity:e,onView:s(()=>N(e.id),"onView"),getStageColor:v,formatCurrency:C},e.id))})})]})})}function w({opportunity:e,onView:t,getStageColor:i,formatCurrency:r}){return a.jsxs("div",{className:"p-4 border border-border rounded-lg hover:bg-muted/50 transition-colors cursor-pointer group",onClick:t,onKeyDown:s(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())},"onKeyDown"),role:"button",tabIndex:0,"aria-label":`View ${e.name}`,children:[a.jsxs("div",{className:"flex items-start justify-between gap-2",children:[a.jsx("h3",{className:"font-medium text-foreground line-clamp-1",children:e.name}),a.jsx(p,{variant:i(e.stage),className:"shrink-0",children:e.stage})]}),a.jsxs("div",{className:"mt-2 flex items-center gap-4 text-sm",children:[a.jsx("span",{className:"font-semibold text-foreground",children:r(e.amount)}),a.jsxs("span",{className:"text-muted-foreground",children:[e.probability,"% probability"]})]}),a.jsxs("div",{className:"mt-2 flex items-center gap-4 text-xs text-muted-foreground",children:[e.expectedCloseDate&&a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx(f,{className:"h-3 w-3"}),a.jsxs("span",{children:["Close: ",N(e.expectedCloseDate,"MMM d, yyyy")]})]}),e.lastActivityDate&&a.jsx("div",{className:"flex items-center gap-1",children:a.jsxs("span",{children:["Last activity: ",N(e.lastActivityDate,"MMM d")]})})]}),a.jsx("div",{className:"mt-3 opacity-0 group-hover:opacity-100 transition-opacity",children:a.jsxs(u,{variant:"link",size:"sm",className:"h-auto p-0 text-primary",children:[a.jsx(y,{className:"h-3 w-3 mr-1"}),"View Details"]})})]})}s(b,"usePrincipalOpportunities"),s(v,"PipelineDrillDownSheet"),s(w,"OpportunityCard");export{v as PipelineDrillDownSheet};
